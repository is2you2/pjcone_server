"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[5502],{5502:(xt,N,_)=>{_.r(N),_.d(N,{MinimalChatPageModule:()=>vt});var P=_(177),j=_(4341),f=_(5374),w=_(9858),x=_(467),D=_(92),S=_(482),B=_(8326),T=_(5402),t=_(3953),E=_(9347),F=_(5547),U=_(345),V=_(3656),O=_(8065),X=_(4234),J=_(9900),H=_(755),Y=_(4237),L=_(7476),W=_(3307);const Q=["MinimalChatServer"],z=["minimalchat_input"];function q(l,h){if(1&l&&(t.j41(0,"ion-select-option",33),t.EFF(1),t.k0s()),2&l){const a=h.$implicit;t.Y8G("value",a),t.R7$(),t.JRh(a.info.name)}}function K(l,h){if(1&l){const a=t.RV6();t.j41(0,"ion-item")(1,"ion-select",30,1),t.bIt("ionChange",function(i){t.eBV(a);const s=t.XpG(2);return t.Njj(s.SelectAddressTarget(i))}),t.j41(3,"ion-select-option",31),t.EFF(4),t.k0s(),t.DNE(5,q,2,2,"ion-select-option",32),t.k0s()()}if(2&l){const a=t.XpG(2);t.R7$(),t.Y8G("label",a.lang.text.AddGroup.SelectServer),t.R7$(3),t.JRh(a.lang.text.voidDraw.InternalConn),t.R7$(),t.Y8G("ngForOf",a.ServerList)}}function Z(l,h){if(1&l){const a=t.RV6();t.j41(0,"ion-item")(1,"ion-input",34),t.mxI("ngModelChange",function(i){t.eBV(a);const s=t.XpG(2);return t.DH7(s.UserInputCustomAddress,i)||(s.UserInputCustomAddress=i),t.Njj(i)}),t.k0s(),t.j41(2,"ion-icon",35),t.bIt("click",function(){t.eBV(a);const i=t.XpG(2);return t.Njj(i.global.open_custom_site(i.UserInputCustomAddress))}),t.k0s()()}if(2&l){const a=t.XpG(2);t.R7$(),t.Y8G("label",a.lang.text.voidDraw.InputAddress),t.R50("ngModel",a.UserInputCustomAddress)}}function tt(l,h){1&l&&(t.j41(0,"div",36),t.EFF(1," Ctrl + Enter "),t.k0s())}function et(l,h){if(1&l){const a=t.RV6();t.j41(0,"div",9),t.DNE(1,K,6,3,"ion-item",14)(2,Z,3,2,"ion-item",14),t.j41(3,"ion-item")(4,"ion-input",26),t.mxI("ngModelChange",function(i){t.eBV(a);const s=t.XpG();return t.DH7(s.client.JoinedChannel,i)||(s.client.JoinedChannel=i),t.Njj(i)}),t.k0s()(),t.j41(5,"div"),t.DNE(6,tt,2,0,"div",27),t.j41(7,"ion-item",28),t.bIt("click",function(){t.eBV(a);const i=t.XpG();return t.Njj(i.init_joinChat())}),t.j41(8,"ion-label",29),t.EFF(9),t.k0s()()()()}if(2&l){const a=t.XpG();t.R7$(),t.Y8G("ngIf",a.ServerList.length),t.R7$(),t.Y8G("ngIf",a.NeedInputCustomAddress),t.R7$(2),t.Y8G("label",a.lang.text.voidDraw.ChannelIdAddress),t.R50("ngModel",a.client.JoinedChannel),t.R7$(2),t.Y8G("ngIf",a.global.ShowHint),t.R7$(3),t.JRh(a.lang.text.voidDraw.ConnectToAddress)}}function it(l,h){if(1&l){const a=t.RV6();t.j41(0,"div")(1,"img",37),t.bIt("click",function(){t.eBV(a);const i=t.XpG();return t.Njj(i.copy_qr_address())}),t.k0s(),t.j41(2,"ion-item",28),t.bIt("click",function(){t.eBV(a);const i=t.XpG();return t.Njj(i.copy_qr_address(i.client.JoinedChannel))}),t.j41(3,"ion-label",38),t.EFF(4),t.k0s()()()}if(2&l){const a=t.XpG();t.R7$(),t.Y8G("src",a.QRCodeSRC,t.B4B),t.R7$(3),t.JRh(a.client.JoinedChannel)}}function nt(l,h){if(1&l&&(t.j41(0,"span"),t.EFF(1),t.k0s()),2&l){const a=t.XpG().$implicit;t.Aen("color: #"+a.color),t.R7$(),t.JRh(" "+a.text)}}function at(l,h){if(1&l&&(t.j41(0,"b"),t.EFF(1),t.k0s()),2&l){const a=t.XpG(2).$implicit;t.R7$(),t.SpI("",a.target,":")}}function st(l,h){if(1&l&&(t.j41(0,"span"),t.EFF(1),t.k0s()),2&l){const a=t.XpG().$implicit;t.R7$(),t.JRh(a.text)}}function lt(l,h){if(1&l){const a=t.RV6();t.j41(0,"a",43),t.bIt("click",function(){t.eBV(a);const i=t.XpG().$implicit,s=t.XpG(4);return t.Njj(s.nakama.open_url_link(i.text))}),t.EFF(1),t.k0s()}if(2&l){const a=t.XpG().$implicit;t.Y8G("href",a.text,t.B4B),t.R7$(),t.JRh(a.text)}}function ot(l,h){if(1&l&&(t.j41(0,"span"),t.DNE(1,st,2,1,"span",14)(2,lt,2,2,"a",42),t.k0s()),2&l){const a=h.$implicit;t.R7$(),t.Y8G("ngIf",!a.href),t.R7$(),t.Y8G("ngIf",a.href)}}function rt(l,h){if(1&l&&(t.j41(0,"span"),t.DNE(1,ot,3,2,"span",16),t.k0s()),2&l){const a=t.XpG(2).$implicit;t.Aen(a.isSystem?"color: var(--miniranchat-system-text)":""),t.R7$(),t.Y8G("ngForOf",a.text)}}function ct(l,h){if(1&l&&(t.j41(0,"span"),t.EFF(1),t.k0s()),2&l){const a=t.XpG(3).$implicit;t.R7$(),t.SpI(" ",a.Progress," ")}}function ht(l,h){if(1&l){const a=t.RV6();t.j41(0,"span")(1,"span",44),t.bIt("click",function(){t.eBV(a);const i=t.XpG(2).$implicit,s=t.XpG();return t.Njj(s.open_file_viewer(i.file.info))}),t.EFF(2),t.k0s(),t.DNE(3,ct,2,1,"span",14),t.k0s()}if(2&l){const a=t.XpG(2).$implicit,e=t.XpG();t.R7$(2),t.JRh(e.lang.text.ChatRoom.attachments+": "+a.file.info.filename),t.R7$(),t.Y8G("ngIf",a.Progress)}}function dt(l,h){if(1&l&&(t.j41(0,"span",41)(1,"span"),t.DNE(2,at,2,1,"b",14),t.k0s(),t.DNE(3,rt,2,3,"span",39)(4,ht,4,2,"span",14),t.k0s()),2&l){const a=t.XpG().$implicit;t.R7$(),t.Aen("color: #"+a.color),t.R7$(),t.Y8G("ngIf",a.target),t.R7$(),t.Y8G("ngIf",a.text),t.R7$(),t.Y8G("ngIf",a.file)}}function ut(l,h){if(1&l&&(t.j41(0,"p"),t.DNE(1,nt,2,3,"span",39)(2,dt,5,5,"span",40),t.k0s()),2&l){const a=h.$implicit;t.R7$(),t.Y8G("ngIf",!a.target),t.R7$(),t.Y8G("ngIf",a.target)}}function mt(l,h){if(1&l&&t.nrm(0,"ion-icon",51),2&l){const a=t.XpG().$implicit;t.Y8G("name",a.icon||"close-circle")}}function _t(l,h){if(1&l&&t.nrm(0,"img",52),2&l){const a=t.XpG().$implicit;t.Y8G("src","assets/icon/"+a.icon_img,t.B4B)("alt",a.title)}}function gt(l,h){if(1&l){const a=t.RV6();t.j41(0,"div",47)(1,"div",48),t.bIt("click",function(){const i=t.eBV(a).$implicit;return t.Njj(i.act())})("contextmenu",function(){const i=t.eBV(a).$implicit;return t.Njj(i.context?i.context():null)}),t.DNE(2,mt,1,1,"ion-icon",49)(3,_t,1,2,"img",50),t.j41(4,"div"),t.EFF(5),t.k0s()()()}if(2&l){const a=h.$implicit;t.R7$(),t.Aen("cursor: "+(a.cursor||"pointer")+";"),t.Y8G("hidden",a.isHide),t.R7$(),t.Y8G("ngIf",a.icon),t.R7$(),t.Y8G("ngIf",a.icon_img),t.R7$(2),t.JRh(a.name)}}function pt(l,h){if(1&l&&(t.j41(0,"div",45),t.DNE(1,gt,6,6,"div",46),t.k0s()),2&l){const a=t.XpG();t.R7$(),t.Y8G("ngForOf",a.extended_buttons)}}const ft=[{path:"",component:(()=>{var l;class h{constructor(e,i,s,o,n,d,c,r,u,m,C,p,y,v,A){var M,g=this;this.client=e,this.noti=i,this.title=s,this.navCtrl=o,this.route=n,this.router=d,this.statusBar=c,this.lang=r,this.global=u,this.p5toast=m,this.indexed=C,this.alertCtrl=p,this.nakama=y,this.floatButton=v,this.p5loading=A,this.Header="simplechat",this.iconColor="d8d8d8",this.lnId=12,this.req_refreshed=!1,this.open_this=M=>{this.noti.Current==this.Header?window.focus():this.client.RejoinGroupChat()},this.ShowExtMenus=!1,this.useVoiceRecording=!1,this.extended_buttons=[{icon:"document-attach-outline",name:this.lang.text.ChatRoom.attachments,act:(M=(0,x.A)(function*(){g.new_attach({detail:{value:"load"}})}),function(){return M.apply(this,arguments)}),context:()=>(this.new_attach({detail:{value:"link"}}),!1)},{icon_img:"voidDraw.png",name:this.lang.text.ChatRoom.voidDraw,act:()=>{this.new_attach({detail:{value:"image"}})}},{icon:"reader-outline",name:this.lang.text.ChatRoom.newText,act:()=>{this.new_attach({detail:{value:"text"}})}},{icon:"camera-outline",name:this.lang.text.ChatRoom.Camera,act:()=>{this.new_attach({detail:{value:"camera"}})}},{icon:"mic-circle-outline",name:this.lang.text.ChatRoom.Voice,act:function(){var M=(0,x.A)(function*(){if(g.useVoiceRecording=!g.useVoiceRecording,g.useVoiceRecording){if(g.global.useVoiceRecording&&"SquareRecording"!=g.global.useVoiceRecording)return void g.p5toast.show({text:g.lang.text.GlobalAct[g.global.useVoiceRecording]});(yield T.R.hasAudioRecordingPermission()).value?(g.global.useVoiceRecording="SquareRecording",g.extended_buttons[4].icon="stop-circle-outline",g.extended_buttons[4].name=g.lang.text.ChatRoom.VoiceStop,g.p5loading.toast(g.lang.text.ChatRoom.StartVRecord),yield T.R.startRecording(),g.CreateFloatingVoiceTimeHistoryAddButton()):(g.useVoiceRecording=!1,g.extended_buttons[4].icon="mic-circle-outline",yield T.R.requestAudioRecordingPermission())}else yield g.StopAndSaveVoiceRecording()});return function(){return M.apply(this,arguments)}}()},{icon:"trash-outline",name:this.lang.text.MinimalChat.TrashChat,act:()=>{this.client.userInput.logs.length=0,this.client.userInput.logs.push({color:S.ud?"bbb":"444",text:this.lang.text.MinimalChat.TrashChatLog,isSystem:!0}),this.ShowExtMenus=!1}}],this.NeedInputCustomAddress=!1,this.JoinedQuick=!1,this.UserInputCustomAddress=void 0,this.WaitingLoaded=!1}ToggleExtMenu(e){this.ShowExtMenus=null!=e?e:!this.ShowExtMenus,setTimeout(()=>{this.auto_scroll_down()},0)}CreateFloatingVoiceTimeHistoryAddButton(){this.floatButton.RemoveFloatButton("sqaure-record"),this.floatButton.AddFloatButton("sqaure-record","mic-outline").mouseClicked(()=>{this.p5toast.show({text:`${this.lang.text.GlobalAct.SquareRecording}`})})}StopAndSaveVoiceRecording(){var e=this;return(0,x.A)(function*(){e.floatButton.RemoveFloatButton("sqaure-record");const i="minimal_chat";e.p5loading.update({id:i,message:e.lang.text.AddPost.SavingRecord});try{let s=yield e.global.StopAndSaveVoiceRecording();yield e.SendAttachAct({target:{files:[s]}})}catch{}e.p5loading.remove(i),e.extended_buttons[4].icon="mic-circle-outline",e.extended_buttons[4].name=e.lang.text.ChatRoom.Voice})()}ngOnInit(){var e=this;this.global.StoreShortCutAct("minimal-chat-init"),this.route.queryParams.subscribe(function(){var i=(0,x.A)(function*(s){const o=e.router.getCurrentNavigation().extras.state;yield new Promise(n=>setTimeout(n,100)),o&&(e.client.MyUserName=o.name,e.client.JoinedChannel=o.channel||e.client.JoinedChannel,e.JoinedQuick=o.quick,o.address&&(e.UserInputCustomAddress=o.address,e.init_joinChat()))});return function(s){return i.apply(this,arguments)}}()),this.global.windowOnFocusAct.minimalchat=()=>{this.lnId&&this.noti.ClearNoti(this.lnId),this.noti.Current=this.Header},this.header_title=this.lang.text.MinimalChat.header_title_group,this.minimal_chat_log=document.getElementById("minimal_chat_div"),this.minimal_chat_log.onscroll=i=>{this.minimal_chat_log.scrollHeight==this.minimal_chat_log.scrollTop+this.minimal_chat_log.clientHeight&&this.scroll_down()},this.ServerList=this.client.nakama.get_all_online_server(),setTimeout(()=>{this.MinimalChatServer?(this.MinimalChatServer.value=this.ServerList[0]||"local",this.SelectAddressTarget({detail:{value:this.MinimalChatServer.value}})):this.NeedInputCustomAddress=!0},0),this.client.cacheAddress&&this.CreateQRCode(),setTimeout(()=>{this.CreateDrop()},100)}ionViewWillEnter(){this.noti.Current=this.Header,this.WaitingLoaded=!0,this.DomMinimalChatInput=document.getElementById("minimalchat_input").childNodes[1].childNodes[1].childNodes[1],this.client.RemoveFloatButton(),this.DomMinimalChatInput.onpaste=e=>{let i=[];for(const s of e.clipboardData.files)i.push({file:s});if(1==i.length)return this.SendAttachAct({target:{files:[i[0].file]}}),!1},this.client.IsConnected&&this.focus_on_input()}AddShortCut(){this.global.p5KeyShortCut.EnterAct=e=>{e.ctrlKey?"idle"==this.client.status&&this.init_joinChat():document.activeElement==this.DomMinimalChatInput?this.scroll_down():setTimeout(()=>{this.focus_on_input()},0)},this.global.p5KeyShortCut.Escape=()=>{this.navCtrl.pop()}}new_attach(e){var i=this;return(0,x.A)(function*(){switch(e.detail.value){case"camera":try{let n=yield i.global.from_camera("tmp_files/square/",{display_name:i.client.MyUserName},"minimal_chat");n&&i.TrySendingAttach(n)}catch{}i.AddShortCut(),i.auto_scroll_down(100);break;case"text":let s=i.global.TextEditorNewFileName();i.global.PageDismissAct["minimal-textedit"]=n=>{if(n.data){let d=i.global.TextEditorAfterAct(n.data,{display_name:i.client.MyUserName});i.TrySendingAttach(d),i.auto_scroll_down()}delete i.global.PageDismissAct["minimal-textedit"]},i.global.ActLikeModal("ionic-viewer",{info:{content:{is_new:"text",type:"text/plain",viewer:"text",filename:s}},noEdit:!0,dismiss:"minimal-textedit"});break;case"image":i.global.PageDismissAct["minimal-image"]=function(){var n=(0,x.A)(function*(d){if(d.data){let c=yield i.global.voidDraw_fileAct_callback(d,"tmp_files/square/",{display_name:i.client.MyUserName});i.TrySendingAttach(c)}delete i.global.PageDismissAct["minimal-image"]});return function(d){return n.apply(this,arguments)}}(),i.global.ActLikeModal("void-draw",{dismiss:"minimal-image"});break;case"load":i.SelectAttach(),i.AddShortCut();break;case"link":let o;try{try{let r=yield i.global.GetValueFromClipboard();switch(r.type){case"text/plain":o=r.value;break;case"image/png":return void i.SendAttachAct({target:{files:[r.value]}});case"error":throw r.value}}catch(r){throw r}try{let r=i.global.Base64ToBlob(o),u=o.split(";")[0].split(":")[1],m=new File([r],`${i.lang.text.ChatRoom.FileLink}.${u.split("/").pop()}`,{type:u});throw i.SendAttachAct({target:{files:[m]}}),"done"}catch(r){if("done"===r)throw r}try{if(0!=o.indexOf("http:")&&0!=o.indexOf("https:"))throw"\uc62c\ubc14\ub978 \uc6f9 \uc8fc\uc18c\uac00 \uc544\ub2d8"}catch(r){throw r}let n={};n.url=o,n.content_related_creator=[],n.content_related_creator.push({user_id:i.client.uuid,timestamp:(new Date).getTime(),display_name:i.client.MyUserName,various:"link"}),n.content_creator={user_id:i.client.uuid,timestamp:(new Date).getTime(),display_name:i.client.MyUserName,various:"link"};let d=n.url.split(".");n.file_ext=d.pop().split("?").shift(),n.filename=decodeURIComponent(`${d.pop().split("/").pop()||i.lang.text.ChatRoom.ExternalLinkFile}.${n.file_ext}`),i.global.set_viewer_category_from_ext(n),n.type="",n.typeheader=n.viewer,i.client.send(JSON.stringify({type:"file",info:n,name:i.client.MyUserName}))}catch(n){throw"done"==n?n:`\uc778\uc2dd \ubd88\uac00\ub2a5\ud55c URL \uc815\ubcf4: ${n}`}}})()}CreateDrop(){var e=this;let i=document.getElementById("p5Drop_chatroom");this.p5canvas=new B(s=>{s.setup=()=>{let r=s.createCanvas(i.clientWidth,i.clientHeight);r.parent(i),s.pixelDensity(.1),r.drop(u=>{let m=s.millis();d<m-400?(n=!1,c.length=0,c.push(u)):(n=!0,c.push(u)),d=m,clearTimeout(o),o=setTimeout((0,x.A)(function*(){const C="minimal_chat";n?e.alertCtrl.create({header:e.lang.text.ChatRoom.MultipleSend,message:`${e.lang.text.ChatRoom.CountFile}: ${c.length}`,buttons:[{text:e.lang.text.ChatRoom.Send,handler:()=>{!function(){var y=(0,x.A)(function*(){e.p5loading.update({id:C,progress:0});for(let v=0,A=c.length;v<A;v++)e.p5loading.update({id:C,progress:v/A}),yield e.SendAttachAct({target:{files:[c[v].file]}},C);e.p5loading.remove(C)});return function(){return y.apply(this,arguments)}}()()}}]}).then(p=>{e.global.StoreShortCutAct("minimal-multiple-send"),e.global.p5KeyShortCut.Escape=()=>{p.dismiss()},p.onDidDismiss().then(()=>{e.global.RestoreShortCutAct("minimal-multiple-send")}),p.present()}):(e.p5loading.update({id:C}),yield e.SendAttachAct({target:{files:[u.file]}}),e.p5loading.remove(C))}),400)})};let o,n=!1,d=0,c=[];s.mouseMoved=r=>{r.dataTransfer?(i.style.pointerEvents="all",i.style.backgroundColor="#0008"):(i.style.pointerEvents="none",i.style.backgroundColor="transparent")}})}CreateQRCode(){var e=this;return(0,x.A)(function*(){if(e.JoinedQuick)return;e.QRCodeSRC="";let i=yield e.global.GetHeaderAddress();e.QRCodeTargetString=`${i}?group_dedi=${e.client.cacheAddress},${e.client.JoinedChannel||"public"}`,e.QRCodeSRC=e.global.readasQRCodeFromString(e.QRCodeTargetString.replace(/ /g,"%20")),e.focus_on_input()})()}SelectAddressTarget(e){"local"===(this.header_title=this.lang.text.MinimalChat.header_title_group,this.title.setTitle(this.lang.text.MinimalChat.WebTitle_group),e.detail.value)?(this.client.cacheServerInfo=void 0,this.UserInputCustomAddress="",this.NeedInputCustomAddress=!0):(this.client.cacheServerInfo=e.detail.value.info,this.UserInputCustomAddress=`${this.client.cacheServerInfo.useSSL?"wss":"ws"}://${this.client.cacheServerInfo.address}:${this.client.cacheServerInfo.square_port||12013}`,this.NeedInputCustomAddress=!1)}init_joinChat(){var e=this;this.client.status="custom",this.Header="simplechat",this.noti.ClearNoti(this.lnId),document.getElementById("favicon").setAttribute("href","assets/icon/simplechat.png");try{if(!this.client.client||this.client.client.readyState!=this.client.client.OPEN&&!this.client.p5OnDediMessage){this.client.userInput.logs.length=0;let o={color:S.ud?"bbb":"444",text:this.lang.text.MinimalChat.joinChat_group,isSystem:!0};this.client.userInput.logs.push(o),this.client.userInput.last_message=o;let n=this.UserInputCustomAddress.split("://"),d=n.pop().split(":"),c=n.pop();c?c+=":":c=this.global.checkProtocolFromAddress(d[0])?"wss:":"ws:",this.client.initialize(`${c}//${d[0]}`,d[1])}const s=[{title:this.lang.text.MinimalChat.Noti_Reply,action:"sq_reply",type:"text"}];this.client.funcs.onmessage=o=>{try{let n=JSON.parse(o);this.client.JoinedChannel||(this.client.JoinedChannel=n.channel),this.client.uuid||(this.client.uuid=n.uid);let d=this.client.uuid==n.uid,c=d?this.client.MyUserName||this.lang.text.MinimalChat.name_me:n.name||this.lang.text.MinimalChat.name_stranger_group,r=n.uid?(n.uid.replace(/[^5-79a-b]/g,"")+"abcdef").substring(0,6):S.ud?"888888":"444444";if(this.client.p5OnDediMessage&&this.client.p5OnDediMessage(r),n.msg){let m=n.msg.split(" "),C=[],p="";for(let v=0,A=m.length;v<A;v++)0==m[v].indexOf("http://")||0==m[v].indexOf("https://")?(C.push({text:" "+p+" "}),p="",C.push({href:!0,text:m[v]})):p+=" "+m[v];p&&C.push({text:" "+p});let y={color:r,text:C,target:c,isMe:d};this.client.userInput.logs.push(y),this.client.userInput.last_message=y}else if(n.type)switch(n.type){case"join":let m={color:r,text:[{text:" "+this.lang.text.MinimalChat.user_join_comment}],target:c,isSystem:!0};this.client.userInput.logs.push(m),this.client.userInput.last_message=m;break;case"leave":let C={color:r,text:[{text:" "+this.lang.text.MinimalChat.user_out_comment}],target:c,isSystem:!0};this.client.userInput.logs.push(C),this.client.userInput.last_message=C;break;case"file":let p={color:r,file:n,target:c,isMe:d};if(this.client.userInput.logs.push(p),this.client.userInput.last_message=p,!n.info.url){let y=n.info;this.client.DownloadPartManager[n.uid]||(this.client.DownloadPartManager[n.uid]={}),this.client.DownloadPartManager[n.uid][n.temp_id]||(this.client.DownloadPartManager[n.uid][n.temp_id]=p),p.Progress=y.partsize}break;case"part":return this.client.DownloadPartManager[n.uid][n.temp_id].Progress--,void this.indexed.checkIfFileExist(n.path).then(y=>{y||this.indexed.saveBase64ToUserPath(","+n.part,`${n.path}_${n.index}`)});case"EOF":return void this.indexed.checkIfFileExist(n.path).then(function(){var y=(0,x.A)(function*(v){v?e.indexed.removeFileFromUserPath(`${n.path}.history`):(yield new Promise(function(){var A=(0,x.A)(function*(g,M){let I=[],G=0;for(let R=0,k=n.partsize;R<k;R++)try{let b=yield e.indexed.GetFileInfoFromDB(`${n.path}_${R}`);G+=b.contents.length,I[R]=b}catch(b){console.log("\ud30c\uc77c \ubcd1\ud569\ud558\uae30 \uc624\ub958: ",b);break}try{let R=new Int8Array(G),k=0;for(let b=0,$=I.length;b<$;b++)R.set(I[b].contents,k),k+=I[b].contents.length;yield e.indexed.saveInt8ArrayToUserPath(R,n.path);for(let b=0,$=n.partsize;b<$;b++)e.indexed.removeFileFromUserPath(`${n.path}_${b}`);yield e.indexed.removeFileFromUserPath(`${n.path}.history`)}catch(R){console.log("\ud30c\uc77c \ucd5c\uc885 \uc800\uc7a5\ud558\uae30 \uc624\ub958: ",R),M()}g(void 0)});return function(g,M){return A.apply(this,arguments)}}()),delete e.client.DownloadPartManager[n.uid][n.temp_id].Progress,delete e.client.DownloadPartManager[n.uid][n.temp_id])});return function(v){return y.apply(this,arguments)}}())}let u="certified";if(n.count&&(this.client.ConnectedNow=n.count),n.msg)this.noti.PushLocal({id:this.lnId,title:c,body:n.msg,actions_wm:s,smallIcon_ln:"simplechat"},this.Header,this.open_this);else if(n.type)switch(n.type){case"join":this.noti.PushLocal({id:this.lnId,title:this.lang.text.MinimalChat.user_join,body:c+` | ${this.lang.text.MinimalChat.user_join_comment}`,actions_wm:s,smallIcon_ln:"simplechat"},this.Header,this.open_this);break;case"leave":u="pending",this.noti.PushLocal({id:this.lnId,title:this.lang.text.MinimalChat.user_out,body:c+` | ${this.lang.text.MinimalChat.user_out_comment}`,actions_wm:s,smallIcon_ln:"simplechat"},this.Header,this.open_this);break;case"file":this.noti.PushLocal({id:this.lnId,title:c,body:this.lang.text.MinimalChat.user_send_attach,actions_wm:s,smallIcon_ln:"simplechat"},this.Header,this.open_this)}this.statusBar.settings.dedicated_groupchat=u,setTimeout(()=>{this.statusBar.settings.dedicated_groupchat==u&&(this.statusBar.settings.dedicated_groupchat="online")},250)}catch{}this.auto_scroll_down()},this.client.funcs.onclose=o=>{this.WebSocketOnCloseAct()},this.client.funcs.onopen=o=>{this.CreateQRCode(),this.statusBar.settings.dedicated_groupchat="online",this.client.send(JSON.stringify({name:this.client.MyUserName,type:"join",channel:this.client.JoinedChannel||"public"})),this.client.funcs.onclose=d=>{this.statusBar.settings.dedicated_groupchat="missing",setTimeout(()=>{this.statusBar.settings.dedicated_groupchat="offline"},1500);let c=this.lang.text.MinimalChat.cannot_join,r={color:"faa",text:c,isSystem:!0};this.client.userInput.logs.push(r),this.client.userInput.last_message=r,this.noti.PushLocal({id:this.lnId,title:c,actions_wm:s,smallIcon_ln:"simplechat"},this.Header,this.open_this),this.client.p5OnDediMessage&&this.client.p5OnDediMessage("ff0000")}}}catch(s){console.log("\uad11\uc7a5 \ucc44\ub110 \uc811\uc18d \uc2e4\ud328: ",s),this.WebSocketOnCloseAct()}}WebSocketOnCloseAct(){this.statusBar.settings.dedicated_groupchat="missing",setTimeout(()=>{this.statusBar.settings.dedicated_groupchat="offline"},1500);let e={color:"faa",text:this.lang.text.MinimalChat.failed_to_join,isSystem:!0};this.client.userInput.logs.push(e),this.client.userInput.last_message=e,this.noti.PushLocal({id:this.lnId,title:this.lang.text.MinimalChat.failed_to_join,smallIcon_ln:"simplechat"},this.Header,this.open_this),this.client.p5OnDediMessage&&this.client.p5OnDediMessage("ff0000"),this.client.disconnect()}copy_qr_address(e=this.QRCodeTargetString){this.global.WriteValueToClipboard("text/plain",e,"minimal_chat")}SelectAttach(){document.getElementById("minimal_chat_file").click()}SendAttachAct(e,i){var s=this;return(0,x.A)(function*(){let o=e.target.files[0],n={};n.blob=o,n.filename=o.name,n.size=o.size,n.file_ext=o.name.split(".").pop(),n.type=o.type,s.global.set_viewer_category(n),n.content_related_creator=[{user_id:s.client.uuid,timestamp:(new Date).getTime(),display_name:s.client.MyUserName,various:"loaded"}],n.content_creator={user_id:s.client.uuid,timestamp:(new Date).getTime(),display_name:s.client.MyUserName,various:"loaded"},yield s.TrySendingAttach(n,i)})()}TrySendingAttach(e,i){var s=this;return(0,x.A)(function*(){let o=`${Date.now()}`,n={type:"file",info:e,temp_id:o,name:s.client.MyUserName};try{let d;try{d=`${s.client.cacheServerInfo.useSSL?"https":"http"}://${s.client.cacheServerInfo.address}:${s.client.cacheServerInfo.apache_port||9002}`}catch(m){console.log("\ub300\uc0c1 \uc8fc\uc18c \uc0dd\uc131 \uc624\ub958: ",m)}const c=(new Date).getTime(),r=`tmp_${s.client.JoinedChannel||"public"}_${s.client.uuid}`;e.override_name=`${r.replace(/\//g,"_")}_${c}_${e.filename}`,e.override_path="",e.override_filename=e.override_name;let u=yield s.global.try_upload_to_user_custom_fs(e,r,i,s.lang.text.MinimalChat.header_title_group,d);if(!u)throw"\ubd84\ud560 \uc804\uc1a1 \uc2dc\ub3c4 \ud544\uc694";e.url=u,delete e.blob,s.client.send(JSON.stringify(n)),s.focus_on_input()}catch{if(e.url){let u=yield fetch(e.url);if(u.ok){let m=yield u.blob();e.blob=m}}e.path=`tmp_files/sqaure/${o}.${e.file_ext}`,yield s.indexed.saveBlobToUserPath(e.blob,e.path);let c=yield s.indexed.GetFileInfoFromDB(e.path);e.partsize=Math.ceil(e.size/S.xM),delete e.blob,s.client.send(JSON.stringify(n)),s.focus_on_input();for(let u=0;u<e.partsize;u++){yield new Promise(p=>setTimeout(p,s.global.WebsocketRetryTerm));let m=s.global.req_file_part_base64(c,u,e.path);s.client.send(JSON.stringify({type:"part",path:e.path,index:u,part:m,temp_id:o}))}yield new Promise(u=>setTimeout(u,s.global.WebsocketRetryTerm)),s.client.send(JSON.stringify({type:"EOF",path:e.path,partsize:e.partsize,temp_id:o}))}})()}WaitingCurrent(){var e=this;return(0,x.A)(function*(){for(;!e.WaitingLoaded;)yield new Promise(i=>setTimeout(i,0));return!0})()}open_file_viewer(e){var i=this;let s=[];for(let o=0,n=this.client.userInput.logs.length;o<n;o++)try{this.client.userInput.logs[o].file.info.filename&&s.push({content:JSON.parse(JSON.stringify(this.client.userInput.logs[o].file.info))})}catch{}this.global.PageDismissAct["minimal-ionic-viewer"]=function(){var o=(0,x.A)(function*(n){if(n.data)switch(n.data.type){case"image":let d=[];if(n.data.msg.content.content_related_creator&&(d=[...n.data.msg.content.content_related_creator]),n.data.msg.content.content_creator){let c=!1;for(let r=0,u=d.length;r<u;r++)if(d[r].user_id==n.data.msg.content.content_creator.user_id){c=!0;break}c||d.push(n.data.msg.content.content_creator)}return i.global.PageDismissAct["minimal-ionic-viewer-edit"]=c=>{if(c.data){i.p5loading.remove(c.data.loadingCtrl);let r=c.data.img;i.indexed.saveBase64ToUserPath(r,`tmp_files/sqaure/${c.data.name}`);let m=i.global.Base64ToBlob(r,"image/png");m.name=c.data.name,i.SendAttachAct({target:{files:[m]}})}delete i.global.PageDismissAct["minimal-ionic-viewer-edit"]},yield i.WaitingCurrent(),void i.global.ActLikeModal("void-draw",{path:n.data.path||e.path,width:n.data.width,height:n.data.height,type:n.data.filetype,isDarkMode:n.data.isDarkMode,scrollHeight:n.data.scrollHeight,dismiss:"minimal-ionic-viewer-edit"});case"text":n.data.blob.name=i.global.TextEditorNewFileName(),n.data.path=`tmp_files/texteditor/${n.data.blob.name}`,i.SendAttachAct({target:{files:[n.data.blob]}})}delete i.global.PageDismissAct["minimal-ionic-viewer"]});return function(n){return o.apply(this,arguments)}}(),this.global.ActLikeModal("ionic-viewer",{info:{content:e},isOfficial:"local",path:e.path,relevance:s,dismiss:"minimal-ionic-viewer"})}ionViewDidEnter(){this.AddShortCut(),setTimeout(()=>{this.scroll_down()},0)}scroll_down(){this.minimal_chat_log.scrollTo({top:this.minimal_chat_log.scrollHeight,behavior:"smooth"})}focus_on_input(e){"DesktopPWA"==D.aH&&this.minimalchat_input.setFocus(),this.auto_scroll_down(e)}auto_scroll_down(e){setTimeout(()=>{let i=this.minimal_chat_log.scrollHeight;i<this.minimal_chat_log.scrollTop+this.minimal_chat_log.clientHeight+120&&this.minimal_chat_log.scrollTo({top:i,behavior:"smooth"})},e||0)}send(e){this.statusBar.settings.dedicated_groupchat="certified",setTimeout(()=>{"certified"==this.statusBar.settings.dedicated_groupchat&&(this.statusBar.settings.dedicated_groupchat="online")},250);let i={msg:e||this.client.userInput.text};i.msg.trim()&&(this.ToggleExtMenu(!1),i.name=this.client.MyUserName,this.client.send(JSON.stringify(i)),this.client.userInput.text="",this.focus_on_input())}quit_chat(){this.client.funcs.onclose=()=>{this.statusBar.settings.dedicated_groupchat="missing",setTimeout(()=>{this.statusBar.settings.dedicated_groupchat="offline"},1500);let e={color:S.ud?"ffa":"884",text:this.lang.text.MinimalChat.leave_chat_group,isSystem:!0};this.client.userInput.logs.push(e),this.client.userInput.last_message=e,this.minimal_chat_log.scrollTo({top:this.minimal_chat_log.scrollHeight,behavior:"smooth"})},this.UserInputCustomAddress="",this.noti.ClearNoti(this.lnId),"idle"==this.client.status&&this.navCtrl.pop(),this.indexed.GetFileListFromDB("tmp_files/sqaure").then(e=>e.forEach(i=>this.indexed.removeFileFromUserPath(i))),this.client.disconnect(),this.client.DownloadPartManager={}}ionViewWillLeave(){this.WaitingLoaded=!1,this.title.setTitle("Project: Cone"),document.getElementById("favicon").setAttribute("href","assets/icon/favicon.png"),this.noti.Current="",this.client.IsConnected&&this.client.CreateRejoinButton(),delete this.global.p5KeyShortCut.EnterAct,delete this.global.p5KeyShortCut.Escape,this.useVoiceRecording&&this.StopAndSaveVoiceRecording()}ngOnDestroy(){this.p5loading.update({id:"minimal_chat",forceEnd:0},!0),this.global.RestoreShortCutAct("minimal-chat-init"),this.route.queryParams.unsubscribe(),delete this.global.windowOnFocusAct.minimalchat,this.minimal_chat_log.onscroll=null,this.DomMinimalChatInput.onpaste=null,this.p5canvas&&this.p5canvas.remove()}}return(l=h).\u0275fac=function(e){return new(e||l)(t.rXU(E.z),t.rXU(F.r),t.rXU(U.hE),t.rXU(V.q9),t.rXU(w.nX),t.rXU(w.Ix),t.rXU(O.j),t.rXU(X.y),t.rXU(S.z3),t.rXU(J.G),t.rXU(H.n),t.rXU(f.hG),t.rXU(Y.X),t.rXU(L.u),t.rXU(W.f))},l.\u0275cmp=t.VBU({type:l,selectors:[["app-minimal-chat"]],viewQuery:function(e,i){if(1&e&&(t.GBs(Q,5),t.GBs(z,5)),2&e){let s;t.mGM(s=t.lsd())&&(i.MinimalChatServer=s.first),t.mGM(s=t.lsd())&&(i.minimalchat_input=s.first)}},decls:36,vars:12,consts:[["minimalchat_input",""],["MinimalChatServer",""],[1,"ion-no-border"],["slot","start",3,"click"],["defaultHref",""],["slot","end",2,"margin","8px 16px"],["scrollY","false"],["id","p5Drop_chatroom",2,"position","absolute","width","100%","height","100%","display","flex","pointer-events","none","z-index","500"],[2,"display","flex","flex-direction","column","height","100%"],[2,"flex","0 1 auto"],["button",""],[1,"ion-text-right",3,"ngModelChange","label","placeholder","ngModel"],["style","flex: 0 1 auto;",4,"ngIf"],["id","minimal_chat_div",1,"main",2,"flex","1 1 auto"],[4,"ngIf"],[2,"user-select","text"],[4,"ngFor","ngForOf"],["id","input_table",2,"width","100%"],["expand","block","fill","clear",3,"click"],["name","exit"],[2,"width","100%"],["id","minimalchat_input","type","text",3,"ionFocus","keyup.enter","ngModelChange","placeholder","ngModel"],["name","add-outline"],["hidden","","type","file","id","minimal_chat_file","accept","*",3,"change"],["name","send"],["style","height: 240px; overflow-x: hidden; overflow-y: auto; scroll-behavior: smooth; text-align: center; background-color: var(--chatroom-background);",4,"ngIf"],["placeholder","public",1,"ion-text-right",3,"ngModelChange","label","ngModel"],["class","shortcut_hint",4,"ngIf"],["button","",3,"click"],[1,"ion-text-center"],["value","local",2,"pointer-events","none",3,"ionChange","label"],["value","local"],[3,"value",4,"ngFor","ngForOf"],[3,"value"],["placeholder","(wss://)0.0.0.0",1,"ion-text-right",3,"ngModelChange","label","ngModel"],["slot","end","name","open-outline",3,"click"],[1,"shortcut_hint"],["alt","QRCode",2,"width","100%","height","auto","cursor","copy",3,"click","src"],["disabled","","color","medium",1,"ion-text-center"],[3,"style",4,"ngIf"],["class","default_text",4,"ngIf"],[1,"default_text"],["target","_system","onclick","return false;",3,"href","click",4,"ngIf"],["target","_system","onclick","return false;",3,"click","href"],[1,"file_attach_box",3,"click"],[2,"height","240px","overflow-x","hidden","overflow-y","auto","scroll-behavior","smooth","text-align","center","background-color","var(--chatroom-background)"],["style","display: inline-block;",4,"ngFor","ngForOf"],[2,"display","inline-block"],[1,"ext_button",3,"click","contextmenu","hidden"],["slot","icon-only","style","width: 36px; height: 36px;",3,"name",4,"ngIf"],["class","ext_icon_img",3,"src","alt",4,"ngIf"],["slot","icon-only",2,"width","36px","height","36px",3,"name"],[1,"ext_icon_img",3,"src","alt"]],template:function(e,i){if(1&e){const s=t.RV6();t.j41(0,"ion-header",2)(1,"ion-toolbar")(2,"ion-buttons",3),t.bIt("click",function(){return t.eBV(s),t.Njj(i.navCtrl.pop())}),t.nrm(3,"ion-back-button",4),t.k0s(),t.j41(4,"ion-title"),t.EFF(5),t.k0s(),t.j41(6,"div",5),t.EFF(7),t.k0s()()(),t.j41(8,"ion-content",6),t.nrm(9,"div",7),t.j41(10,"div",8)(11,"div",9)(12,"ion-item",10)(13,"ion-input",11),t.mxI("ngModelChange",function(n){return t.eBV(s),t.DH7(i.client.MyUserName,n)||(i.client.MyUserName=n),t.Njj(n)}),t.k0s()()(),t.DNE(14,et,10,6,"div",12),t.j41(15,"div",13),t.DNE(16,it,5,2,"div",14),t.j41(17,"div",15),t.DNE(18,ut,3,2,"p",16),t.k0s()()()(),t.j41(19,"ion-footer")(20,"table",17)(21,"tr")(22,"td")(23,"ion-button",18),t.bIt("click",function(){return t.eBV(s),t.Njj(i.quit_chat())}),t.nrm(24,"ion-icon",19),t.k0s()(),t.j41(25,"td",20)(26,"ion-input",21,0),t.bIt("ionFocus",function(){return t.eBV(s),t.Njj(i.focus_on_input(120))})("keyup.enter",function(){return t.eBV(s),t.Njj(i.send())}),t.mxI("ngModelChange",function(n){return t.eBV(s),t.DH7(i.client.userInput.text,n)||(i.client.userInput.text=n),t.Njj(n)}),t.k0s()(),t.j41(28,"td")(29,"ion-button",18),t.bIt("click",function(){return t.eBV(s),t.Njj(i.ToggleExtMenu())}),t.nrm(30,"ion-icon",22),t.k0s(),t.j41(31,"input",23),t.bIt("change",function(n){return t.eBV(s),t.Njj(i.SendAttachAct(n))}),t.k0s()(),t.j41(32,"td")(33,"ion-button",18),t.bIt("click",function(){return t.eBV(s),t.Njj(i.send())}),t.nrm(34,"ion-icon",24),t.k0s()()()(),t.DNE(35,pt,2,1,"div",25),t.k0s()}2&e&&(t.R7$(5),t.JRh(i.header_title),t.R7$(2),t.Lme("",i.lang.text.MinimalChat.concurrent_users,": ",i.client.ConnectedNow,""),t.R7$(6),t.Y8G("label",i.lang.text.Profile.name_placeholder)("placeholder",i.lang.text.Profile.noname_user),t.R50("ngModel",i.client.MyUserName),t.R7$(),t.Y8G("ngIf","idle"==i.client.status),t.R7$(2),t.Y8G("ngIf",i.QRCodeSRC&&!i.JoinedQuick&&"idle"!=i.client.status),t.R7$(2),t.Y8G("ngForOf",i.client.userInput.logs),t.R7$(8),t.Y8G("placeholder",i.lang.text.MinimalChat.input_placeholder),t.R50("ngModel",i.client.userInput.text),t.R7$(9),t.Y8G("ngIf",i.ShowExtMenus))},dependencies:[P.Sq,P.bT,j.BC,j.vS,f.Jm,f.QW,f.W9,f.M0,f.eU,f.iq,f.$w,f.uz,f.he,f.Nm,f.Ip,f.BC,f.ai,f.Je,f.Gw,f.el],styles:[".main[_ngcontent-%COMP%]{width:100%;padding:8px;overflow-x:hidden;overflow-y:auto;scroll-behavior:smooth}p[_ngcontent-%COMP%]{margin:8px 0 0}.default_text[_ngcontent-%COMP%]{color:var(--miniranchat-default-text)}.bottom_thumbnail[_ngcontent-%COMP%]{width:100%;max-width:100vw;height:-moz-fit-content;height:fit-content;max-height:96px;transform:translateY(-100%);position:absolute;background:var(--chatroom-last-msg-viewer-bg);padding:8px;overflow:hidden}ion-button[_ngcontent-%COMP%]{--padding-start: 12px;--padding-end: 12px}.file_attach_box[_ngcontent-%COMP%]{margin-left:8px;padding:2px 8px;border-radius:6px;background-color:#8888;cursor:pointer}"]}),h})()}];let Ct=(()=>{var l;class h{}return(l=h).\u0275fac=function(e){return new(e||l)},l.\u0275mod=t.$C({type:l}),l.\u0275inj=t.G2t({imports:[w.iI.forChild(ft),w.iI]}),h})(),vt=(()=>{var l;class h{}return(l=h).\u0275fac=function(e){return new(e||l)},l.\u0275mod=t.$C({type:l}),l.\u0275inj=t.G2t({imports:[P.MD,j.YN,f.bv,Ct]}),h})()}}]);