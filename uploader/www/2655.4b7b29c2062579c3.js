"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[2655],{2655:(Ue,ge,y)=>{y.r(ge),y.d(ge,{VoidDrawPageModule:()=>Le});var te=y(177),fe=y(4341),k=y(5374),K=y(9858),x=y(467),pe=y(8326),Z=y(92),ie=y(4237),a=y(3953),ye=y(4234),be=y(3656),Se=y(482),Re=y(755),ke=y(9900),De=y(4020);const xe=["RemoteDraw"],_e=["AddrQRShare"];function Ae(u,I){if(1&u&&(a.j41(0,"ion-select-option",12),a.EFF(1),a.k0s()),2&u){const C=I.$implicit;a.Y8G("value",C),a.R7$(),a.JRh(C.info.name)}}function Te(u,I){if(1&u){const C=a.RV6();a.j41(0,"img",18),a.bIt("click",function(){a.eBV(C);const t=a.XpG(2);return a.Njj(t.copy_address(t.SelectedAddress))}),a.k0s()}if(2&u){const C=a.XpG(2);a.Y8G("src",C.QRCodeSRC,a.B4B)}}function Ie(u,I){if(1&u){const C=a.RV6();a.j41(0,"div",13)(1,"div",14),a.DNE(2,Te,1,1,"img",15),a.j41(3,"ion-item",16),a.bIt("click",function(){a.eBV(C);const t=a.XpG();return a.Njj(t.copy_address(t.QRNavParams.channel))}),a.j41(4,"ion-label",17),a.EFF(5),a.k0s()()()()}if(2&u){const C=a.XpG();a.R7$(2),a.Y8G("ngIf",C.QRCodeSRC),a.R7$(3),a.JRh(C.QRNavParams.channel)}}const We=[{path:"",component:(()=>{var u;class I{constructor(o,t,i,e,n,p,l,m,D,b,w){this.lang=o,this.alertCtrl=t,this.loadingCtrl=i,this.global=e,this.indexed=n,this.nakama=p,this.p5toast=l,this.webrtc=m,this.router=D,this.route=b,this.navCtrl=w,this.isMobile=!1,this.p5DrawingStack=[],this.isCropMode=!1,this.ServerList=[],this.isDrawServerCreated=!1,this.ReadyToShareAct=!1,this.RemoteBackgroundImage="",this.WillLeaveHere=!1,this.WithoutSave=!0}ngOnDestroy(){this.route.queryParams.unsubscribe(),this.global.PageDismissAct[this.navParams.dismiss]&&this.global.PageDismissAct[this.navParams.dismiss]({}),this.p5ActualCanvas&&(this.p5ActualCanvas.remove(),this.p5ActualCanvas=null),this.p5ImageCanvas&&(this.p5ImageCanvas.remove(),this.p5ImageCanvas=null),this.p5voidDraw&&this.p5voidDraw.remove(),this.IceWebRTCWsClient&&this.IceWebRTCWsClient.close(),this.CancelRemoteAct()}ngOnInit(){var o=this;this.route.queryParams.subscribe(function(){var t=(0,x.A)(function*(i){try{const e=o.router.getCurrentNavigation().extras.state;if(!e)throw"\ud398\uc774\uc9c0 \ubcf5\uadc0";o.navParams=e||{},yield new Promise(n=>setTimeout(n,100)),o.create_new_canvas({width:e.width,height:e.height,path:e.path}),e.remote&&setTimeout(()=>{o.CreateRemoteLocalClient(e.remote.address,e.remote.channel)},1e3)}catch(e){console.log("\uadf8\ub9bc\ud310 \uc815\ubcf4 \ubc1b\uc9c0 \ubabb\ud568: ",e)}});return function(i){return t.apply(this,arguments)}}())}ionViewDidEnter(){var o=this;return(0,x.A)(function*(){o.global.StoreShortCutAct("void-draw"),o.AddShortCut(),o.mainLoading=yield o.loadingCtrl.create({message:o.lang.text.voidDraw.UseThisImage}),o.isMobile="DesktopPWA"!=Z.aH})()}AddShortCut(){delete this.global.p5KeyShortCut.Digit,this.global.p5KeyShortCut.HistoryAct=o=>{switch(o){case"Z":this.p5history_act(-1);break;case"X":this.p5history_act(1);break;case"C":this.isCropMode?this.p5apply_crop():this.p5change_color();break;case"V":this.p5set_line_weight()}},this.global.p5KeyShortCut.AddAct=()=>{this.ClickRemoteAddButton()},this.global.p5KeyShortCut.SKeyAct=()=>{this.open_crop_tool()},this.global.p5KeyShortCut.DeleteAct=()=>{this.isCropMode?this.p5apply_crop():this.dismiss_draw()},this.global.p5KeyShortCut.FKeyAct=()=>{},this.global.p5KeyShortCut.Escape=()=>{this.isDrawServerCreated?this.CancelRemoteAct():this.navCtrl.pop()}}CancelRemoteAct(){this.ReadyToShareAct=!1,this.RemoteLoadingCtrl&&this.RemoteLoadingCtrl.dismiss(),this.isDrawServerCreated=!1,this.p5SetDrawable(!0),this.webrtc.close_webrtc(!1)}create_new_canvas(o){o.width=o.width||432,o.height=o.height||432,this.p5ActualCanvas&&(this.p5ActualCanvas.remove(),this.p5ActualCanvas=null),this.p5ImageCanvas&&(this.p5ImageCanvas.remove(),this.p5ImageCanvas=null),this.p5voidDraw&&this.p5voidDraw.remove(),this.create_p5voidDraw(o)}create_p5voidDraw(o){var t=this;let i=document.getElementById("voidDraw");this.isCropMode=!1,this.p5voidDraw=new pe(e=>{let n,p,l,m,D,b,w,E,oe,W=e.createColorPicker("#000"),ae=Math.min(o.width,o.height)/100,re=1;e.setup=(0,x.A)(function*(){W.style("position","absolute"),e.pixelDensity(1),e.noLoop(),e.noFill(),e.imageMode(e.CENTER),m=e.createCanvas(i.clientWidth,i.clientHeight),m.parent(i),P.x=e.width/2,P.y=e.height/2,t.p5set_line_weight=()=>{t.alertCtrl.create({header:t.lang.text.voidDraw.changeWeight,inputs:[{label:t.lang.text.voidDraw.weight,name:"weight",placeholder:`${re}`,type:"number"}],buttons:[{text:t.lang.text.voidDraw.apply,handler:h=>{h.weight&&(re=Number(h.weight))}}]}).then(h=>{O=!1,h.onWillDismiss().then(()=>{O=!0}),h.present()})},t.p5change_color=()=>{W.elt.click()},t.p5save_image=()=>{new pe(h=>{h.setup=()=>{let _=h.createCanvas(n.width,n.height);h.pixelDensity(1),l&&h.image(l,0,0),n&&h.image(n,0,0);let N=_.elt.toDataURL("image/png").replace("image/png","image/octet-stream");t.navParams.dismiss&&t.global.PageDismissAct[t.navParams.dismiss]({data:{name:`voidDraw_${h.year()}-${h.nf(h.month(),2)}-${h.nf(h.day(),2)}_${h.nf(h.hour(),2)}-${h.nf(h.minute(),2)}-${h.nf(h.second(),2)}.png`,img:N,loadingCtrl:t.mainLoading}}),t.navCtrl.pop(),h.remove()}})},t.p5history_act=(h,_=!1)=>{switch(L=e.min(e.max(0,L+h),t.p5DrawingStack.length),h){case 1:t.p5DrawingStack.length&&(w.style.fill="var(--ion-color-dark)"),L==t.p5DrawingStack.length&&(E.style.fill="var(--ion-color-medium)"),U(n,t.p5DrawingStack[L-1]);break;case-1:t.p5DrawingStack.length&&(E.style.fill="var(--ion-color-dark)"),L<1?(w.style.fill="var(--ion-color-medium)",n.clear(255,255,255,255),e.redraw()):se()}!_&&t.ReadyToShareAct&&t.webrtc.dataChannel.send(JSON.stringify({type:"same",act:"history_act",data:h}))},t.p5open_crop_tool=()=>{t.isCropMode?(t.isCropMode=!1,e.redraw()):(t.isCropMode=!0,d.x=n.width,d.y=n.height,H.x=0,H.y=0,e.redraw()),oe()},t.p5apply_crop=(h=!0)=>{if(h&&t.isMobile&&H.div(S),n.resizeCanvas(d.x,d.y),p=e.createVector(n.width/2,n.height/2),h&&A.sub(H),se(),l.resizeCanvas(d.x,d.y),l.push(),l.background(t.navParams.isDarkMode?26:255),l.translate(A),t.p5BaseImage&&l.image(t.p5BaseImage,0,0),l.pop(),l.redraw(),t.isCropMode=!1,oe(),t.p5SetCanvasViewportInit(),h&&t.ReadyToShareAct){let _=t.p5getCropPos(),N=t.p5getCropSize();t.webrtc.dataChannel.send(JSON.stringify({type:"draw",act:"crop",cropPX:_.x,cropPY:_.y,cropSX:N.x,cropSY:N.y}))}},t.p5SetDrawable=$e,D=e.createElement("table"),D.style("position: absolute; top: 0px;"),D.style(`width: 100%; height: ${T}px;`),D.style("background-color: var(--voidDraw-menu-background);"),D.parent(i);let r=D.elt.insertRow(0),s=r.insertCell(0);s.innerHTML=t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">A</div><ion-icon style="width: 27px; height: 27px" name="wifi-outline"></ion-icon></div>':'<ion-icon style="width: 27px; height: 27px" name="wifi-outline"></ion-icon>',s.style.textAlign="center",s.style.cursor="pointer",s.onclick=()=>{t.ClickRemoteAddButton()};let c=r.insertCell(1);c.innerHTML=t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">S</div><ion-icon style="width: 27px; height: 27px" name="crop"></ion-icon></div>':'<ion-icon style="width: 27px; height: 27px" name="crop"></ion-icon>',c.style.textAlign="center",c.style.cursor="pointer",c.onclick=()=>{t.open_crop_tool()};let f=r.insertCell(2);f.innerHTML=t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">D</div><ion-icon style="width: 27px; height: 27px" name="checkmark"></ion-icon></div>':'<ion-icon style="width: 27px; height: 27px" name="checkmark"></ion-icon>',f.style.textAlign="center",f.style.cursor="pointer",f.onclick=()=>{t.dismiss_draw()},oe=()=>{f.innerHTML=t.isCropMode?t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">D</div><ion-icon style="width: 27px; height: 27px" name="cut-sharp"></ion-icon></div>':'<ion-icon style="width: 27px; height: 27px" name="cut-sharp"></ion-icon>':t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">D</div><ion-icon style="width: 27px; height: 27px" name="checkmark"></ion-icon></div>':'<ion-icon style="width: 27px; height: 27px" name="checkmark"></ion-icon>'},b=e.createElement("table"),b.style("position: absolute; bottom: 0px;"),b.style(`width: 100%; height: ${T}px;`),b.style("background-color: var(--voidDraw-menu-background);"),b.parent(i);let V=b.elt.insertRow(0),B=V.insertCell(0);B.innerHTML=t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">Z</div><ion-icon id="undoIcon" style="width: 27px; height: 27px" name="arrow-undo"></ion-icon></div>':'<ion-icon id="undoIcon" style="width: 27px; height: 27px" name="arrow-undo"></ion-icon>',w=document.getElementById("undoIcon"),w.style.fill="var(--ion-color-medium)",B.style.textAlign="center",B.style.cursor="pointer",B.onclick=()=>{t.p5history_act(-1)};let z=V.insertCell(1);z.innerHTML=t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">X</div><ion-icon id="redoIcon" style="width: 27px; height: 27px" name="arrow-redo"></ion-icon></div>':'<ion-icon id="redoIcon" style="width: 27px; height: 27px" name="arrow-redo"></ion-icon>',E=document.getElementById("redoIcon"),E.style.fill="var(--ion-color-medium)",z.style.textAlign="center",z.style.cursor="pointer",z.onclick=()=>{t.p5history_act(1)};let Y=V.insertCell(2);Y.innerHTML=t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">C</div><ion-icon style="width: 27px; height: 27px" name="color-palette"></ion-icon></div>':'<ion-icon style="width: 27px; height: 27px" name="color-palette"></ion-icon>',W.style("width: 0px; height: 0px; opacity: 0;"),W.parent(Y),W.elt.oninput=()=>{let h=W.color().levels,_=`#${e.hex(h[0],2)}${e.hex(h[1],2)}${e.hex(h[2],2)}`;Y.childNodes[0].style.color=_},o.path&&(W.value("#ff0000"),W.elt.oninput()),Y.style.textAlign="center",Y.style.cursor="pointer",Y.onclick=()=>{W.elt.click()};let Q=V.insertCell(3);if(Q.innerHTML=t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">V</div><ion-icon style="width: 27px; height: 27px" name="pencil"></ion-icon></div>':'<ion-icon style="width: 27px; height: 27px" name="pencil"></ion-icon>',Q.style.textAlign="center",Q.style.cursor="pointer",Q.onclick=()=>{t.change_line_weight()},t.p5SetCanvasViewportInit=()=>{m.hide(),e.resizeCanvas(i.clientWidth,i.clientHeight),j.x=e.width/2,j.y=e.height/2,P.x=0,P.y=0;let h=i.clientHeight-112;S=i.clientWidth/h<n.width/n.height?i.clientWidth/n.width:h/n.height,m.show(),e.redraw()},n=e.createGraphics(o.width,o.height),p=e.createVector(n.width/2,n.height/2),n.pixelDensity(1),n.noLoop(),n.noFill(),t.p5ActualCanvas=n,l=e.createGraphics(o.width,o.height),l.pixelDensity(1),l.noLoop(),l.noFill(),l.background(t.navParams.isDarkMode?26:255),t.p5ImageCanvas=l,o.path){let h=yield t.indexed.loadBlobFromUserPath(o.path,""),_=URL.createObjectURL(h);e.loadImage(_,N=>{t.p5BaseImage=N,l.image(t.p5BaseImage,0,0),l.redraw(),URL.revokeObjectURL(_),t.p5SetCanvasViewportInit()},N=>{console.error("\uadf8\ub9bc\ud310 \ubc30\uacbd \uc774\ubbf8\uc9c0 \ubd88\ub7ec\uc624\uae30 \uc624\ub958: ",N),l.redraw(),URL.revokeObjectURL(_),t.p5SetCanvasViewportInit()})}else l.redraw(),t.p5SetCanvasViewportInit();o.width<o.height&&(ae/=S),t.p5getCropPos=Ve,t.p5setCropPos=ue,t.p5getCropSize=Me,t.p5setCropSize=Oe,t.p5RemoteDrawStart=Be,t.p5RemoteDrawing=Ee,t.p5RemoteDrawingEnd=Xe,t.p5updateRemoteCurve=He,t.p5CancelCurrentDraw=()=>{v=null,e.redraw()},t.navParams.scrollHeight&&ue(0,-t.navParams.scrollHeight)});let P=e.createVector(),S=1,j=e.createVector(0,0),A=e.createVector(),H=e.createVector(),d=e.createVector(),Ve=()=>A,Me=()=>d,ue=(r,s)=>{A.x=r,A.y=s,l.translate(r,s),e.redraw()},Oe=(r,s)=>{d.x=r,d.y=s,l.translate(r,s),e.redraw()};e.draw=()=>{if(e.clear(255,255,255,255),e.push(),e.translate(j),e.scale(S),e.translate(P),e.image(l,0,0),n&&e.image(n,0,0),this.isCropMode)e.push(),e.translate(-n.width/2,-n.height/2),e.translate(H),e.noStroke(),e.fill(0,100),e.rect(0,0,d.x,d.y),e.stroke(255,0,0),e.strokeWeight(8),e.beginShape(e.LINES),e.vertex(0,0),e.vertex(d.x,0),e.vertex(d.x,0),e.vertex(d.x,.8*d.y),e.vertex(0,0),e.vertex(0,d.y),e.vertex(0,d.y),e.vertex(.8*d.x,d.y),e.stroke(255,255,0),e.vertex(.8*d.x,d.y),e.vertex(d.x,d.y),e.vertex(d.x,.8*d.y),e.vertex(d.x,d.y),e.endShape(),e.pop();else{if(g&&g.pos&&g.pos.length){e.push(),e.translate(A),e.stroke(g.color),e.strokeWeight(g.weight),e.beginShape();for(let r=0,s=g.pos.length;r<s;r++)e.curveVertex(g.pos[r].x-p.x,g.pos[r].y-p.y);e.endShape(),e.pop()}if(this.ReadyToShareAct&&v&&v.pos&&v.pos.length){e.push(),e.translate(A),e.stroke(v.color),e.strokeWeight(v.weight),e.beginShape();for(let r=0,s=v.pos.length;r<s;r++)e.curveVertex(v.pos[r].x-p.x,v.pos[r].y-p.y);e.endShape(),e.pop()}}e.pop()},this.p5DrawingStack=[],this.p5ClearCurrentDraw=()=>{g={},this.p5DrawingStack.length=0,L=0,se(),e.redraw()};let L=0,se=()=>{n.clear(255,255,255,255);for(let r=0;r<L;r++)U(n,this.p5DrawingStack[r])},U=(r,s=g)=>{if(s.color){r.push(),r.translate(A),r.stroke(s.color),r.strokeWeight(s.weight),r.beginShape();for(let c=0,f=s.pos.length;c<f;c++)r.curveVertex(s.pos[c].x,s.pos[c].y);r.endShape(),r.pop(),r.redraw(),e.redraw()}},He=r=>{for(let s=0,c=r.length;s<c;s++)U(n,r[s]);L=this.p5DrawingStack.length};e.windowResized=()=>{setTimeout(()=>{this.p5SetCanvasViewportInit()},0)};let g={},v={},Be=r=>{v=r,e.redraw()},Ee=r=>{v&&v.pos&&v.pos.push(r),e.redraw()},Xe=r=>{v.pos.push(r),v.pos.push(r),this.p5DrawingStack.length=L,v&&(this.p5DrawingStack.push(v),U(n,v)),L=this.p5DrawingStack.length,v=null,e.redraw()};const T=56;let ne,$,le,ce,we,G,de,he=0,ee=!1,M=!1;e.mousePressed=r=>{if(O){if(e.mouseY<T||e.mouseY>e.height-T)return void(M=!0);switch(r.which){case 1:this.isCropMode?me():Ce();break;case 3:$=e.createVector(e.mouseX,e.mouseY),G=P.copy(),ne=e.createVector(e.mouseX,e.mouseY);break;case 2:this.p5SetCanvasViewportInit()}}};let me=(r,s)=>{let c=X(r,s),f=H.copy().add(d).sub(e.createVector(n.width/2,n.height/2)),V=c.dist(f),B=.2*e.max(d.x,d.y);ee=V<B,ee?(ce=e.createVector(e.mouseX,e.mouseY),de=d.copy()):le=e.createVector(e.mouseX,e.mouseY).sub(H.mult(S))},Ce=(r,s)=>{w.style.fill="var(--ion-color-dark)",E.style.fill="var(--ion-color-medium)";let c=X(r,s);c.sub(A),c.add(p);let f={x:c.x,y:c.y},V=W.color().levels,B=`#${e.hex(V[0],2)}${e.hex(V[1],2)}${e.hex(V[2],2)}`;g={pos:[],color:B,weight:ae*re},g.pos.push(f),g.pos.push(f),this.ReadyToShareAct&&this.webrtc.dataChannel.send(JSON.stringify({type:"draw",act:"start",data:g})),e.redraw()};e.mouseDragged=r=>{if(O)switch(r.which){case 1:if(this.isCropMode&&!M){let s=e.createVector(e.mouseX,e.mouseY);ee?d=de.copy().add(ce.copy().sub(s).div(-S)):H=le.copy().sub(s).div(-S),e.redraw()}else{let s=X();s.sub(A),s.add(p);let c={x:s.x,y:s.y};g&&g.pos&&g.pos.push(c),this.ReadyToShareAct&&this.webrtc.dataChannel.send(JSON.stringify({type:"draw",act:"moved",data:c})),e.redraw()}break;case 3:ne=e.createVector(e.mouseX,e.mouseY),P=G.copy().add(ne.sub($).div(S)),e.redraw()}},e.mouseWheel=r=>{O&&(e.mouseY<T||e.mouseY>e.height-T?M=!0:(Ye(X()),S*=r.deltaY<0?1.1:.9,e.redraw()))},e.mouseReleased=r=>{if(O){if(1===r.which&&!this.isCropMode&&!M){let s=X();s.sub(A),s.add(p);let c={x:s.x,y:s.y};if(g)try{g.pos.push(c),g.pos.push(c),this.ReadyToShareAct&&this.webrtc.dataChannel.send(JSON.stringify({type:"draw",act:"end",data:c}))}catch{}ve()}M=!1}};let Ye=r=>{j=e.createVector(e.mouseX,e.mouseY),P=r.mult(-1)},X=(r,s)=>{let c=e.createVector(r||e.mouseX,s||e.mouseY);return c.sub(j),c.div(S),c.sub(P),c},R=[],F=!1,O=!0,$e=r=>{O=r};e.touchStarted=r=>{if(O){if(R=r.touches,r.changedTouches[0].clientY<T||r.changedTouches[0].clientY>e.height-T)return void(M=!0);switch(F=!0,R.length){case 1:this.isCropMode?me(r.changedTouches[0].clientX,r.changedTouches[0].clientY-T):Ce(r.changedTouches[0].clientX,r.changedTouches[0].clientY-T);break;case 2:let s=e.createVector(R[0].clientX,R[0].clientY-56),c=e.createVector(R[1].clientX,R[1].clientY-56);he=s.dist(c),$=s.copy().add(c).div(2),G=P.copy(),we=S,g=null,this.ReadyToShareAct&&this.webrtc.dataChannel.send(JSON.stringify({type:"draw",act:"cancel"}));break;default:F=!1,this.p5SetCanvasViewportInit()}}},e.touchMoved=r=>{if(O&&F){switch(R=r.touches,R.length){case 1:if(this.isCropMode&&!M){let s=e.createVector(r.changedTouches[0].clientX,r.changedTouches[0].clientY-T);ee?d=de.copy().add(ce.copy().sub(s).div(-S)):H=le.copy().sub(s).div(-S),e.redraw()}else{let s=X(r.changedTouches[0].clientX,r.changedTouches[0].clientY-T);s.sub(A),s.add(p);let c={x:s.x,y:s.y};g&&g.pos&&g.pos.push(c),this.ReadyToShareAct&&this.webrtc.dataChannel.send(JSON.stringify({type:"draw",act:"moved",data:c})),e.redraw()}break;case 2:{let s=e.createVector(R[0].clientX,R[0].clientY-56),c=e.createVector(R[1].clientX,R[1].clientY-56),f=s.copy().add(c).div(2);S=s.dist(c)/he*we,P=G.copy().add(f.sub($).div(S)),e.redraw()}}return!1}},e.touchEnded=r=>{if(O&&r.changedTouches){switch(R=r.touches,F=!1,R.length){case 0:if(!this.isCropMode&&!M&&g){let s=X(r.changedTouches[0].clientX,r.changedTouches[0].clientY-T);s.sub(A),s.add(p);let c={x:s.x,y:s.y};g.pos.push(c),g.pos.push(c),this.ReadyToShareAct&&this.webrtc.dataChannel.send(JSON.stringify({type:"draw",act:"end",data:c})),ve()}break;case 1:if(!F)return;je(),he=0,g=null}M=!1}};let je=()=>{$=e.createVector(R[0].clientX,R[0].clientY-56),G=P.copy()},ve=()=>{this.p5DrawingStack.length=L,g&&(this.p5DrawingStack.push(g),U(n,g)),L=this.p5DrawingStack.length,$=null,M=!1,g=null,e.redraw()}})}ClickRemoteAddButton(){this.isDrawServerCreated||(this.ServerList=this.nakama.get_all_online_server(),this.ServerList.length?(this.p5SetDrawable(!1),this.RemoteDraw.open()):this.RemoteBridgeServerSelected({detail:{value:"local"}}))}RemoteBridgeServerSelected(o){var t=this;return(0,x.A)(function*(){if(t.isDrawServerCreated)return;let i=o.detail.value;if("local"===i){let e;t.alertCtrl.create({header:t.lang.text.voidDraw.LocalAddrInput,inputs:[{type:"text",placeholder:"(wss://)0.0.0.0"},{type:"text",placeholder:t.lang.text.voidDraw.CreateChannel}],buttons:[{text:t.lang.text.voidDraw.Confirm,handler:l=>{l[0]?(t.InputCustomAddress=l[0],t.p5SetDrawable(!1),e=!0,t.isDrawServerCreated=!0,t.CreateOnMessageLink(),t.CreateOnOpenAct(!1,(0,x.A)(function*(){let m=t.p5getCropPos();t.nakama.VoidDrawInitCallBack=null,yield new Promise(D=>setTimeout(D,t.global.WebsocketRetryTerm)),t.IceWebRTCWsClient.send(JSON.stringify({type:"size",width:t.p5ActualCanvas.width,height:t.p5ActualCanvas.height,cropX:m.x,cropY:m.y}))})),t.CreateRemoteLocalClient(l[0],l[1])):t.p5toast.show({text:t.lang.text.voidDraw.InputAddress})}}]}).then(l=>{l.onWillDismiss().then(()=>{t.p5SetDrawable(!0)}),l.onDidDismiss().then(()=>{!e&&!t.WillLeaveHere&&t.global.RestoreShortCutAct("voiddraw-remote-bridge")}),t.global.StoreShortCutAct("voiddraw-remote-bridge"),l.present()})}else{t.RemoteLoadingCtrl=yield t.loadingCtrl.create({message:t.lang.text.voidDraw.WaitingConnection}),t.RemoteLoadingCtrl.present();let n=i.info.isOfficial,p=i.info.target;t.webrtc.CurrentMatch=t.nakama.self_match[n][p],t.isDrawServerCreated=!0,t.RemoteLoadingCtrl.message=t.lang.text.voidDraw.WebRTC_Waiting,t.webrtc.initialize("data",void 0,{isOfficial:n,target:p}).then(()=>{t.CreateOnMessageLink(),t.CreateOnOpenAct(!1,(0,x.A)(function*(){let l=t.p5getCropPos();t.nakama.VoidDrawInitCallBack=null,yield t.nakama.servers[n][p].socket.sendMatchState(t.nakama.self_match[n][p].match_id,ie.I.VOIDDRAW_INIT,encodeURIComponent(JSON.stringify({type:"size",width:t.p5ActualCanvas.width,height:t.p5ActualCanvas.height,cropX:l.x,cropY:l.y})))})),t.webrtc.CreateOffer(),t.nakama.VoidDrawInitCallBack=l=>{t.create_new_canvas({width:l.width,height:l.height}),t.p5setCropPos(l.cropX,l.cropY),t.p5SetDrawable(!0),t.p5voidDraw.redraw()},t.webrtc.InitReplyCallback=(0,x.A)(function*(){t.CreateOnOpenAct(!0),t.RemoteLoadingCtrl.message=t.lang.text.voidDraw.WebRTC_Offer,t.webrtc.CreateAnswer()}),t.nakama.servers[n][p].socket.sendMatchState(t.nakama.self_match[n][p].match_id,ie.I.WEBRTC_INIT_REQ_SIGNAL,encodeURIComponent(""))})}})()}CreateRemoteLocalClient(o,t){var i=this;let l,e=o.split("://"),n=e.pop().split(":"),p=e.pop();p?p+=":":p=this.global.checkProtocolFromAddress(n[0])?"wss:":"ws:",this.IceWebRTCWsClient=new WebSocket(`${p}//${n[0]}:12013/`),this.AddShortCut(),this.isDrawServerCreated=!0,this.IceWebRTCWsClient.onopen=(0,x.A)(function*(){i.p5toast.show({text:`${i.lang.text.voidDraw.Connected}: ${n[0]}`}),t?(i.IceWebRTCWsClient.send(JSON.stringify({type:"join",channel:t})),yield new Promise(m=>setTimeout(m,i.global.WebsocketRetryTerm)),i.IceWebRTCWsClient.send(JSON.stringify({type:"size_req",channel:t})),i.RemoteLoadingCtrl=yield i.loadingCtrl.create({message:i.lang.text.voidDraw.WaitingConnection}),i.RemoteLoadingCtrl.present(),i.p5SetDrawable(!1)):i.IceWebRTCWsClient.send(JSON.stringify({type:"init"}))}),this.IceWebRTCWsClient.onmessage=function(){var m=(0,x.A)(function*(D){let b,w=JSON.parse(D.data);if(void 0===l)l=w.uid;else if(l==w.uid)return;switch(w.type){case"init_id":i.QRNavParams={address:o,channel:w.id},i.init_gen_qrcode(),i.AddrQRShare.onWillDismiss().then(()=>{i.global.RestoreShortCutAct("voiddraw-remote"),i.p5SetDrawable(!0)}),i.global.StoreShortCutAct("voiddraw-remote"),i.p5SetDrawable(!1),i.AddrQRShare.present(),i.IceWebRTCWsClient.send(JSON.stringify({type:"join",channel:w.id})),b=w.id;break;case"init_req":i.p5SetDrawable(!1),i.RemoteLoadingCtrl.message=i.lang.text.voidDraw.WebRTC_Init,i.webrtc.initialize("data").then((0,x.A)(function*(){i.CreateOnMessageLink(),i.CreateOnOpenAct(!1,(0,x.A)(function*(){i.nakama.VoidDrawInitCallBack=null})),i.webrtc.CreateOffer(),yield new Promise(W=>setTimeout(W,i.global.WebsocketRetryTerm)),i.IceWebRTCWsClient.send(JSON.stringify({type:"socket_react",channel:b,act:"WEBRTC_INIT_REQ_SIGNAL"}))}));break;case"size_req":i.AddrQRShare.dismiss(),i.RemoteLoadingCtrl=yield i.loadingCtrl.create({message:i.lang.text.voidDraw.WaitingConnection}),i.RemoteLoadingCtrl.present();let E=i.p5getCropPos();i.IceWebRTCWsClient.send(JSON.stringify({type:"size",width:i.p5ActualCanvas.width,height:i.p5ActualCanvas.height,cropX:E.x,cropY:E.y,channel:b}));break;case"socket_react":switch(w.act){case"WEBRTC_REPLY_INIT_SIGNAL":i.RemoteLoadingCtrl.message=i.lang.text.voidDraw.WebRTC_Reply,i.nakama.socket_reactive[w.act](w.data_str),"EOL"==w.data_str&&(i.RemoteLoadingCtrl.message=i.lang.text.voidDraw.WebRTC_Offer,i.webrtc.CreateAnswer({client:i.IceWebRTCWsClient,channel:b})),i.RemoteLoadingCtrl.message=i.lang.text.voidDraw.WebRTC_Ice;break;case"WEBRTC_ICE_CANDIDATES":i.nakama.socket_reactive[w.act](w.data_str,{client:i.IceWebRTCWsClient,channel:b}),i.RemoteLoadingCtrl.dismiss(),i.p5SetDrawable(!0),i.IceWebRTCWsClient.send(JSON.stringify({type:"init_end",channel:b}));break;case"WEBRTC_INIT_REQ_SIGNAL":i.nakama.socket_reactive[w.act]({client:i.IceWebRTCWsClient,channel:b});break;case"WEBRTC_RECEIVE_ANSWER":i.nakama.socket_reactive[w.act](w.data_str,{client:i.IceWebRTCWsClient,channel:b})}break;case"size":i.create_new_canvas({width:w.width,height:w.height}),i.p5setCropPos(w.cropX,w.cropY),i.p5SetDrawable(!1),i.p5voidDraw.redraw(),i.RemoteLoadingCtrl.message=i.lang.text.voidDraw.WebRTC_Init,i.webrtc.initialize("data").then(()=>{i.CreateOnOpenAct(!0),i.CreateOnMessageLink(),i.RemoteLoadingCtrl.message=i.lang.text.voidDraw.WebRTC_Offer,i.webrtc.CreateOffer(),i.IceWebRTCWsClient.send(JSON.stringify({type:"init_req"}))});break;case"init_end":i.p5SetDrawable(!0)}});return function(D){return m.apply(this,arguments)}}(),this.IceWebRTCWsClient.onerror=m=>{if(console.log("\uadf8\ub9bc\ud310 \uae30\ub2a5 \uacf5\uc720 \uc5f0\uacb0 \uc624\ub958: ",m),0==this.InputCustomAddress.indexOf("wss://")&&("DesktopPWA"==Z.aH||"MobilePWA"==Z.aH)){let D=this.InputCustomAddress.split("://");this.global.open_link(`https://${D.pop()}:9001`),this.InputCustomAddress=null}this.IceWebRTCWsClient.close(),this.p5toast.show({text:`${this.lang.text.TodoDetail.Disconnected}: ${m}`})},this.IceWebRTCWsClient.onclose=()=>{this.AddrQRShare.dismiss(),this.isDrawServerCreated=!1,this.webrtc.close_webrtc(!1),this.IceWebRTCWsClient.onopen=null,this.IceWebRTCWsClient.onclose=null,this.IceWebRTCWsClient.onmessage=null,this.IceWebRTCWsClient.onerror=null}}CreateOnOpenAct(o=!1,t=(0,x.A)(function*(){})){var i=this;this.webrtc.dataChannelOpenAct=(0,x.A)(function*(){if(i.p5SetDrawable(!0),i.ReadyToShareAct=!0,i.RemoteLoadingCtrl&&i.RemoteLoadingCtrl.dismiss(),i.p5ClearCurrentDraw(),!o&&(t&&(yield t()),i.navParams.path))try{let e=yield i.indexed.loadBlobFromUserPath(i.navParams.path,""),p=(yield i.global.GetBase64ThroughFileReader(e)).match(/(.{1,64})/g);for(let l=0,m=p.length;l<m;l++)yield i.webrtc.dataChannel.send(JSON.stringify({type:"background",act:"part",data:p[l]}));yield i.webrtc.dataChannel.send(JSON.stringify({type:"background",act:"EOF"}))}catch(e){console.log("\ubc30\uacbd \uadf8\ub9bc \uacf5\uc720\ud558\uae30 \uc624\ub958: ",e)}})}CreateOnMessageLink(){this.webrtc.dataChannelOnMsgAct=o=>{let t=JSON.parse(o);switch(t.type){case"drawline":this.p5DrawingStack=t.data,this.p5updateRemoteCurve(t.data),this.p5voidDraw.redraw();break;case"background":switch(t.act){case"part":this.RemoteBackgroundImage+=t.data;break;case"EOF":this.p5voidDraw.loadImage(this.RemoteBackgroundImage,i=>{this.p5BaseImage=i,this.p5ImageCanvas.image(this.p5BaseImage,0,0),this.p5ImageCanvas.redraw(),this.p5SetCanvasViewportInit(),this.RemoteBackgroundImage=""},i=>{console.error("\uadf8\ub9bc\ud310 \ubc30\uacbd \uc774\ubbf8\uc9c0 \ubd88\ub7ec\uc624\uae30 \uc624\ub958: ",i),this.p5ImageCanvas.redraw(),this.p5SetCanvasViewportInit(),this.RemoteBackgroundImage=""})}break;case"draw":switch(t.act){case"start":this.p5RemoteDrawStart(t.data);break;case"moved":this.p5RemoteDrawing(t.data);break;case"cancel":this.p5CancelCurrentDraw();break;case"crop":this.p5setCropPos(t.cropPX,t.cropPY),this.p5setCropSize(t.cropSX,t.cropSY),this.isCropMode=!0,this.p5apply_crop(!1);break;case"end":this.p5RemoteDrawingEnd(t.data)}break;case"same":"history_act"===t.act&&this.p5history_act(t.data,!0)}},this.webrtc.dataChannelOnCloseAct=()=>{this.ReadyToShareAct=!1,this.isDrawServerCreated=!1,this.RemoteLoadingCtrl&&this.RemoteLoadingCtrl.dismiss(),this.p5SetDrawable(!0),this.p5toast.show({text:this.lang.text.TodoDetail.Disconnected}),this.nakama.VoidDrawInitCallBack=null}}change_line_weight(){this.p5set_line_weight()}open_crop_tool(){this.p5open_crop_tool()}dismiss_draw(){this.isCropMode?this.p5apply_crop():(this.mainLoading.present(),this.WithoutSave=!1,this.p5save_image())}ionSelectCancel(){this.p5voidDraw&&this.p5SetDrawable&&!this.isDrawServerCreated&&this.p5SetDrawable(!0)}RemoveShortCut(){this.p5voidDraw&&this.p5SetDrawable&&this.p5SetDrawable(!1),delete this.global.p5KeyShortCut.HistoryAct,delete this.global.p5KeyShortCut.AddAct,delete this.global.p5KeyShortCut.DeleteAct,delete this.global.p5KeyShortCut.SKeyAct,delete this.global.p5KeyShortCut.FKeyAct,delete this.global.p5KeyShortCut.Escape}ionViewWillLeave(){this.WillLeaveHere=!0,this.RemoveShortCut(),this.global.RestoreShortCutAct("void-draw")}ionViewDidLeave(){this.WithoutSave&&this.mainLoading.remove()}init_gen_qrcode(){var o=this;return(0,x.A)(function*(){let t=o.QRNavParams.address;try{let e=t.split("://").pop(),n=`http://${e}:12000/`;const p=new AbortController,l=setTimeout(()=>{p.abort()},500);let m=yield fetch(n,{signal:p.signal});if(clearTimeout(l),!m.ok)throw"\uc8fc\uc18c \uc5c6\uc74c";o.SelectedAddress=`http://${e}:12000${window.sub_path}?voidDraw=${t},${o.QRNavParams.channel}`}catch{o.SelectedAddress=`${Z.d2}pjcone_pwa/?voidDraw=${t},${o.QRNavParams.channel}`}o.QRCodeSRC=o.global.readasQRCodeFromString(o.SelectedAddress.replace(" ","%20"))})()}copy_address(o){this.global.WriteValueToClipboard("text/plain",o)}}return(u=I).\u0275fac=function(o){return new(o||u)(a.rXU(ye.y),a.rXU(k.hG),a.rXU(k.Xi),a.rXU(Se.z3),a.rXU(Re.n),a.rXU(ie.X),a.rXU(ke.G),a.rXU(De.j),a.rXU(K.Ix),a.rXU(K.nX),a.rXU(be.q9))},u.\u0275cmp=a.VBU({type:u,selectors:[["app-void-draw"]],viewQuery:function(o,t){if(1&o&&(a.GBs(xe,5),a.GBs(_e,5)),2&o){let i;a.mGM(i=a.lsd())&&(t.RemoteDraw=i.first),a.mGM(i=a.lsd())&&(t.AddrQRShare=i.first)}},decls:17,vars:4,consts:[["RemoteDraw",""],["AddrQRShare",""],[1,"ion-no-border"],["slot","start"],["defaultHref",""],["oncontextmenu","return false;"],["hidden",""],["value","local",3,"ionChange","ionCancel","label"],["value","local"],[3,"value",4,"ngFor","ngForOf"],["id","voidDraw",1,"full_screen",2,"display","flex","overflow","hidden","background-color","black"],[1,"transparent-modal"],[3,"value"],[2,"display","flex","justify-content","center","align-items","center","height","100%"],[2,"width","400px","height","455px","background-color","var(--chatroom-background)","text-align","center","padding","16px"],["style","width: 100%; height: auto; cursor: copy;","alt","QuickLink",3,"src","click",4,"ngIf"],["button","",3,"click"],[1,"ion-text-center"],["alt","QuickLink",2,"width","100%","height","auto","cursor","copy",3,"click","src"]],template:function(o,t){if(1&o){const i=a.RV6();a.j41(0,"ion-header",2)(1,"ion-toolbar")(2,"ion-title"),a.EFF(3),a.k0s(),a.j41(4,"ion-buttons",3),a.nrm(5,"ion-back-button",4),a.k0s()()(),a.j41(6,"ion-content",5)(7,"div",6)(8,"ion-select",7,0),a.bIt("ionChange",function(n){return a.eBV(i),a.Njj(t.RemoteBridgeServerSelected(n))})("ionCancel",function(){return a.eBV(i),a.Njj(t.ionSelectCancel())}),a.j41(10,"ion-select-option",8),a.EFF(11),a.k0s(),a.DNE(12,Ae,2,2,"ion-select-option",9),a.k0s()(),a.nrm(13,"div",10),a.j41(14,"ion-modal",11,1),a.DNE(16,Ie,6,2,"ng-template"),a.k0s()()}2&o&&(a.R7$(3),a.JRh(t.lang.text.ChatRoom.voidDraw),a.R7$(5),a.Y8G("label",t.lang.text.voidDraw.ConnectToAddress),a.R7$(3),a.JRh(t.lang.text.voidDraw.InternalConn),a.R7$(),a.Y8G("ngForOf",t.ServerList))},dependencies:[te.Sq,te.bT,k.QW,k.W9,k.eU,k.uz,k.he,k.Nm,k.Ip,k.BC,k.ai,k.Sb,k.Je,k.el]}),I})()}];let Pe=(()=>{var u;class I{}return(u=I).\u0275fac=function(o){return new(o||u)},u.\u0275mod=a.$C({type:u}),u.\u0275inj=a.G2t({imports:[K.iI.forChild(We),K.iI]}),I})(),Le=(()=>{var u;class I{}return(u=I).\u0275fac=function(o){return new(o||u)},u.\u0275mod=a.$C({type:u}),u.\u0275inj=a.G2t({imports:[te.MD,fe.YN,k.bv,Pe]}),I})()}}]);