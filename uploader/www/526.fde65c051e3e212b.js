"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[526],{526:(xe,A,_)=>{_.r(A),_.d(A,{PostViewerPageModule:()=>ve});var E=_(177),L=_(4341),w=_(5374),j=_(9858),C=_(467),N=_(8326),U=_(222),t=_(3953),H=_(3656),X=_(4234),B=_(755),Y=_(4237),W=_(7100),J=_(9900),Q=_(3307),z=_(8065);const K=["PostViewMenu"],Z=["QuickPostView"];function q(s,u){1&s&&(t.j41(0,"div",21),t.EFF(1,"Shift + W"),t.k0s())}function ee(s,u){1&s&&(t.j41(0,"div",21),t.EFF(1,"Shift + E"),t.k0s())}function te(s,u){if(1&s){const o=t.RV6();t.j41(0,"div"),t.DNE(1,ee,2,0,"div",18),t.j41(2,"ion-item",19),t.bIt("click",function(){t.eBV(o);const i=t.XpG(3);return t.Njj(i.EditPost())}),t.j41(3,"ion-label"),t.EFF(4),t.k0s()()()}if(2&s){const o=t.XpG(3);t.R7$(),t.Y8G("ngIf",o.global.ShowHint),t.R7$(3),t.JRh(o.lang.text.AddPost.EditTitle)}}function ie(s,u){1&s&&(t.j41(0,"div",21),t.EFF(1,"Shift + D"),t.k0s())}function oe(s,u){if(1&s){const o=t.RV6();t.j41(0,"div"),t.DNE(1,ie,2,0,"div",18),t.j41(2,"ion-item",19),t.bIt("click",function(){t.eBV(o);const i=t.XpG(3);return t.Njj(i.RemovePost())}),t.j41(3,"ion-label"),t.EFF(4),t.k0s()()()}if(2&s){const o=t.XpG(3);t.R7$(),t.Y8G("ngIf",o.global.ShowHint),t.R7$(3),t.JRh(o.lang.text.PostViewer.RemovePost)}}function se(s,u){if(1&s){const o=t.RV6();t.j41(0,"ion-content")(1,"ion-list")(2,"div"),t.DNE(3,q,2,0,"div",18),t.j41(4,"ion-item",19),t.bIt("click",function(){t.eBV(o);const i=t.XpG(2);return t.Njj(i.ToggleFocusMode())}),t.j41(5,"ion-label"),t.EFF(6),t.k0s()()(),t.DNE(7,te,5,2,"div",20)(8,oe,5,2,"div",20),t.k0s()()}if(2&s){const o=t.XpG(2);t.R7$(3),t.Y8G("ngIf",o.global.ShowHint),t.R7$(3),t.JRh(o.lang.text.ContentViewer.FocusMode),t.R7$(),t.Y8G("ngIf",o.isOwner&&o.CurrentIndex>=0),t.R7$(),t.Y8G("ngIf",o.isOwner&&o.CurrentIndex>=0)}}function ne(s,u){1&s&&(t.j41(0,"div",22)(1,"div",23),t.EFF(2,"A"),t.k0s()())}function ae(s,u){if(1&s){const o=t.RV6();t.j41(0,"ion-icon",24),t.bIt("click",function(){t.eBV(o);const i=t.XpG(2);return t.Njj(i.ChangeToAnother(-1))}),t.k0s()}}function re(s,u){if(1&s){const o=t.RV6();t.j41(0,"ion-label",25),t.bIt("click",function(){t.eBV(o);const i=t.XpG(2);return t.Njj(i.FocusOnIndexInput())}),t.EFF(1),t.k0s()}if(2&s){const o=t.XpG(2);t.R7$(),t.JRh(o.CurrentIndex+" / "+o.nakama.posts.length)}}function le(s,u){if(1&s){const o=t.RV6();t.j41(0,"ion-label",26)(1,"input",27),t.bIt("change",function(i){t.eBV(o);const n=t.XpG(2);return t.Njj(n.ChangeRelevanceIndex(i))})("keydown",function(i){t.eBV(o);const n=t.XpG(2);return t.Njj(n.ChangeRelevanceIndex(i))}),t.k0s(),t.EFF(2),t.k0s()}if(2&s){const o=t.XpG(2);t.R7$(),t.Y8G("id",o.RelevancesInputId)("placeholder",o.CurrentIndex),t.R7$(),t.JRh(" / "+o.nakama.posts.length)}}function ce(s,u){1&s&&(t.j41(0,"div",22)(1,"div",28),t.EFF(2,"D"),t.k0s()())}function de(s,u){if(1&s){const o=t.RV6();t.j41(0,"ion-icon",29),t.bIt("click",function(){t.eBV(o);const i=t.XpG(2);return t.Njj(i.ChangeToAnother(1))}),t.k0s()}}function he(s,u){if(1&s){const o=t.RV6();t.j41(0,"ion-header",8)(1,"ion-toolbar")(2,"ion-title"),t.EFF(3),t.k0s(),t.j41(4,"ion-buttons",9),t.nrm(5,"ion-back-button",10),t.k0s(),t.j41(6,"ion-icon",11),t.bIt("click",function(){t.eBV(o);const i=t.XpG();return t.Njj(i.OpenFileMenu())}),t.k0s(),t.j41(7,"ion-popover",12,1),t.DNE(9,se,9,4,"ng-template"),t.k0s(),t.DNE(10,ne,3,0,"div",13)(11,ae,1,0,"ion-icon",14)(12,re,2,1,"ion-label",15)(13,le,3,3,"ion-label",16)(14,ce,3,0,"div",13)(15,de,1,0,"ion-icon",17),t.k0s()()}if(2&s){const o=t.XpG();t.R7$(3),t.JRh(o.lang.text.PostViewer.Title),t.R7$(3),t.Y8G("id",o.postMenuId),t.R7$(),t.Y8G("trigger",o.postMenuId),t.R7$(3),t.Y8G("ngIf",o.global.ShowHint&&o.HavePosts),t.R7$(),t.Y8G("ngIf",o.HavePosts),t.R7$(),t.Y8G("ngIf",o.HavePosts&&!o.CanInputValue),t.R7$(),t.Y8G("ngIf",o.HavePosts&&o.CanInputValue),t.R7$(),t.Y8G("ngIf",o.global.ShowHint&&o.HavePosts),t.R7$(),t.Y8G("ngIf",o.HavePosts)}}function fe(s,u){if(1&s&&t.nrm(0,"img",30),2&s){const o=t.XpG();t.Y8G("src",o.PostInfo.mainImage.MainThumbnail,t.B4B)}}function ge(s,u){1&s&&(t.j41(0,"div",21),t.EFF(1,"Shift + E"),t.k0s())}function ue(s,u){1&s&&(t.j41(0,"div",21),t.EFF(1,"Shift + D"),t.k0s())}function me(s,u){if(1&s){const o=t.RV6();t.j41(0,"table",31)(1,"tr")(2,"td")(3,"div",32),t.DNE(4,ge,2,0,"div",18),t.j41(5,"ion-button",33),t.bIt("click",function(){t.eBV(o);const i=t.XpG();return t.Njj(i.EditPost())}),t.EFF(6),t.k0s()()(),t.j41(7,"td")(8,"div",32),t.DNE(9,ue,2,0,"div",18),t.j41(10,"ion-button",34),t.bIt("click",function(){t.eBV(o);const i=t.XpG();return t.Njj(i.RemovePost())}),t.EFF(11),t.k0s()()()()()}if(2&s){const o=t.XpG();t.R7$(4),t.Y8G("ngIf",o.global.ShowHint),t.R7$(2),t.SpI(" ",o.lang.text.AddPost.EditTitle," "),t.R7$(3),t.Y8G("ngIf",o.global.ShowHint),t.R7$(2),t.SpI(" ",o.lang.text.PostViewer.RemovePost," ")}}function pe(s,u){if(1&s){const o=t.RV6();t.j41(0,"img",40),t.bIt("click",function(){t.eBV(o);const i=t.XpG(2);return t.Njj(i.global.WriteValueToClipboard("text/plain",i.ResultSharedAddress))}),t.k0s()}if(2&s){const o=t.XpG(2);t.Y8G("src",o.QRCodeSRC,t.B4B)}}function _e(s,u){if(1&s){const o=t.RV6();t.j41(0,"div",35),t.bIt("click",function(i){t.eBV(o);const n=t.XpG();return t.Njj(n.CheckIfDismissAct(i))}),t.j41(1,"div",36)(2,"div",37),t.DNE(3,pe,1,1,"img",38),t.j41(4,"ion-item",19),t.bIt("click",function(){t.eBV(o);const i=t.XpG();return t.Njj(i.global.WriteValueToClipboard("text/plain",i.ResultSharedAddress))}),t.j41(5,"ion-label",39),t.EFF(6),t.k0s()()()()()}if(2&s){const o=t.XpG();t.R7$(3),t.Y8G("ngIf",o.QRCodeSRC),t.R7$(3),t.JRh(o.ResultSharedAddress)}}const Pe=[{path:"",component:(()=>{var s;class u{constructor(e,i,n,m,g,p,x,P,I,V,$){this.navCtrl=e,this.lang=i,this.indexed=n,this.nakama=m,this.alertCtrl=g,this.global=p,this.p5toast=x,this.route=P,this.router=I,this.p5loading=V,this.statusBar=$,this.PostInfo={},this.isOwner=!1,this.HavePosts=!1,this.CurrentIndex=1,this.postMenuId="postMenuId",this.DigitShortcutAct=[],this.LastPickedRouter="portal/community/",this.WaitingLoaded=!1,this.BackButtonPressed=!1,this.modelViewers=[],this.ScrollPostId="ScrollPostId",this.FileURLs=[],this.PlayableElements=[],this.IsFocusOnHere=!0,this.RearrangedRelevance=[],this.RearrangedContents=[],this.ModalDismissId="postviewer_modal",this.ContentChanging=!1,this.PostContentId="PostContentId",this.AlreadyHaveGodot=!1,this.CanInputValue=!1,this.RelevancesInputId="RelevancesInputId"}OpenFileMenu(){this.PostViewMenu.onDidDismiss().then(()=>{this.DigitShortcutAct.length=0,this.global.RestoreShortCutAct("postview-menu")}),this.global.StoreShortCutAct("postview-menu"),this.DigitShortcutAct.push(()=>this.ToggleFocusMode()),this.isOwner&&this.CurrentIndex>=0&&(this.DigitShortcutAct.push(()=>this.EditPost()),this.DigitShortcutAct.push(()=>this.RemovePost())),this.PostViewMenu.present()}ToggleFocusMode(){this.PostViewMenu.dismiss(),this.global.ToggleFullScreen()}ngOnInit(){this.postMenuId=`postMenuId_${Date.now()}`,this.ModalDismissId=`postviewer_modal_${Date.now()}`,this.cont=new AbortController,this.route.queryParams.subscribe(e=>{try{const i=this.router.getCurrentNavigation().extras.state;this.PostInfo=i.data,this.LastPickedRouter=this.PostInfo.router,this.ScrollPostId=`ScrollPostId_${Date.now()}`,this.PostContentId=`PostContentId_${Date.now()}`,this.CurrentIndex=i.index}catch{}}),this.RelevancesInputId=`post-viewer_RelevancesInputId_${Date.now}`}WaitingCurrent(){var e=this;return(0,C.A)(function*(){for(;!e.WaitingLoaded;)yield new Promise(i=>setTimeout(i,0))})()}ionViewWillEnter(){this.global.portalHint=!1,this.IsFocusOnHere&&this.initialize(),this.WaitingLoaded=!0,this.global.StoreShortCutAct("post-viewer"),this.IsFocusOnHere=!0}ChangeContentWithKeyInput(){var e=this;if(this.p5canvas){this.ScrollDiv||(this.ScrollDiv=document.getElementById(this.ScrollPostId)),this.p5canvas.keyPressed=function(){var m=(0,C.A)(function*(g){var p,x;if(e.IsFocusOnHere)switch(g.code){case"KeyW":g.shiftKey?e.ToggleFocusMode():e.ScrollDiv.scrollTo({top:e.ScrollDiv.scrollTop-e.ScrollDiv.clientHeight/2,behavior:"smooth"});break;case"KeyS":e.ScrollDiv.scrollTo({top:e.ScrollDiv.scrollTop+e.ScrollDiv.clientHeight/2,behavior:"smooth"});break;case"KeyA":case"ArrowLeft":e.ChangeToAnother(-1);break;case"KeyE":g.shiftKey&&e.EditPost();break;case"KeyD":g.shiftKey&&e.RemovePost();case"ArrowRight":g.shiftKey||e.ChangeToAnother(1);break;case"KeyF":e.OpenFileMenu();break;case"KeyQ":if(!e.RearrangedRelevance.length)return;let P,I,V;e.global.PageDismissAct[e.ModalDismissId]=T=>{e.ExitModalAct(T)};try{V=e.PostInfo.creator_id,P=e.PostInfo.server.isOfficial,I=e.PostInfo.server.target}catch{P="local"}e.IsFocusOnHere=!1,e.global.ActLikeModal(`${e.LastPickedRouter}post-viewer/ionic-viewer`,{info:{...e.RearrangedRelevance[0],sender_id:V},isOfficial:P,target:I,path:e.RearrangedRelevance[0].content.path,relevance:e.RearrangedRelevance,noEdit:!0,dismiss:e.ModalDismissId});break;case"Digit1":case"Digit2":case"Digit3":case"Digit4":case"Digit5":case"Digit6":case"Digit7":case"Digit8":case"Digit9":const $=(Number(g.code.slice(-1))-1+10)%10;null===(p=(x=e.DigitShortcutAct)[$])||void 0===p||p.call(x)}});return function(g){return m.apply(this,arguments)}}();let i=this.p5canvas.createVector(),n={};this.p5canvas.touchStarted=m=>{if(this.IsFocusOnHere&&"changedTouches"in m){for(let p=0,x=m.changedTouches.length;p<x;p++)n[m.changedTouches[p].identifier]=this.p5canvas.createVector(m.changedTouches[p].clientX,m.changedTouches[p].clientY);1===Object.keys(n).length&&(i=n[m.changedTouches[0].identifier].copy())}},this.p5canvas.touchEnded=m=>{if(this.IsFocusOnHere&&"changedTouches"in m){let g;for(let P=0,I=m.changedTouches.length;P<I;P++)g=this.p5canvas.createVector(m.changedTouches[P].clientX,m.changedTouches[P].clientY),delete n[m.changedTouches[P].identifier];let p=Object.keys(n).length;const x=this.p5canvas.max(100,this.p5canvas.min(window.innerWidth/4,200));0===p&&(g.sub(i),g.x>x?this.ChangeToAnother(-1):g.x<-x&&this.ChangeToAnother(1))}}}}ExitModalAct(e){var i=this;return(0,C.A)(function*(){var n;yield i.WaitingCurrent(),e.data&&e.data.share&&i.navCtrl.pop(),i.IsFocusOnHere=!0,e.index<i.RearrangedContents.length&&(null===(n=i.RearrangedContents[e.index].elt)||void 0===n||n.scrollIntoView({block:"center",behavior:"smooth"})),delete i.global.PageDismissAct[i.ModalDismissId]})()}initialize(){if(this.RearrangedRelevance.length=0,this.RearrangedContents.length=0,this.PostInfo.quick&&(this.global.ArcadeWithFullScreen=!0),this.PostInfo.mainImage)try{let e=this.PostInfo.mainImage.url;e||(e=URL.createObjectURL(this.PostInfo.mainImage.blob),setTimeout(()=>{URL.revokeObjectURL(e)},100)),this.PostInfo.mainImage.MainThumbnail=e}catch{}this.create_content();try{this.isOwner="me"==this.PostInfo.creator_id||this.PostInfo.creator_id==this.nakama.servers[this.PostInfo.server.isOfficial][this.PostInfo.server.target].session.user_id,"me"!=this.PostInfo.creator_id&&(this.isOwner=this.isOwner&&"online"==this.statusBar.groupServer[this.PostInfo.server.isOfficial][this.PostInfo.server.target])}catch{this.isOwner=!1}this.isOwner=this.isOwner||this.PostInfo.is_me,this.HavePosts=this.nakama.posts.length>1&&this.CurrentIndex>=0,this.ChangeContentWithKeyInput()}ChangeToAnother(e){var i=this;return(0,C.A)(function*(){var n;if(i.ContentChanging)return;i.ContentChanging=!0;let m=i.CurrentIndex+e;if(m<=0||m>i.nakama.posts.length)return i.ContentChanging=!1,void(yield i.p5loading.update({id:"postviewer",message:`${i.lang.text.ContentViewer.EndOfList}: ${i.CurrentIndex} / ${i.nakama.posts.length}`,progress:1,forceEnd:350}));i.ScrollDiv.scrollTo({top:0}),i.p5canvas&&i.p5canvas.remove(),i.CurrentIndex=m,yield i.p5loading.update({id:"postviewer",message:`${i.lang.text.PostViewer.PreparingPost}: ${null===(n=i.nakama.posts[i.CurrentIndex-1])||void 0===n?void 0:n.title} (${i.CurrentIndex} / ${i.nakama.posts.length})`,progress:null,forceEnd:null}),i.PostInfo=i.nakama.posts[i.CurrentIndex-1],i.CanInputValue=!1,i.initialize()})()}create_content(){var e=this;this.modelViewers.forEach(n=>n.cleanup()),this.modelViewers.length=0;let i=document.getElementById(this.PostContentId);this.p5canvas=new N(n=>{n.setup=(0,C.A)(function*(){n.noCanvas();let g=n.createDiv(`${e.PostInfo.OutSource?'<ion-icon id="title_link" style="cursor: pointer;" slot="start" name="link-outline"></ion-icon> ':""}${e.PostInfo.title}`);e.PostInfo.OutSource&&(document.getElementById("title_link").onclick=(0,C.A)(function*(){e.ResultSharedAddress="",e.ResultSharedAddress=`${yield e.global.GetHeaderAddress()}?postViewer=${e.PostInfo.OutSource}`,e.QRCodeSRC=e.global.readasQRCodeFromString(e.ResultSharedAddress),e.QuickPostView.onDidDismiss().then(()=>{e.global.RestoreShortCutAct("quick-post-view")}),e.global.StoreShortCutAct("quick-post-view"),e.QuickPostView.present()})),g.style("font-size","32px"),g.style("font-weight","bold"),g.parent(i);let P,p=n.createDiv();p.style("color","#888"),n.createDiv(`${e.lang.text.PostViewer.CreateTime}: ${new Date(e.PostInfo.create_time).toLocaleString()}`).parent(p),e.PostInfo.create_time!=e.PostInfo.modify_time&&n.createDiv(`${e.lang.text.PostViewer.ModifyTime}: ${new Date(e.PostInfo.modify_time).toLocaleString()}`).parent(p),p.parent(i);try{P=e.nakama.usernameOverride[e.PostInfo.server.isOfficial][e.PostInfo.server.target][e.PostInfo.creator_id]||e.PostInfo.creator_name}catch{P=e.PostInfo.creator_name}let I=n.createSpan(P);if(I.style("color",`#${e.PostInfo.UserColor}`),I.style("font-weight","bold"),I.style("font-size","17px"),I.style("cursor","pointer"),I.mouseClicked(()=>{if("me"==e.PostInfo.creator_id)e.nakama.open_profile_page();else try{let f=e.PostInfo.server.isOfficial,R=e.PostInfo.server.target,O=e.PostInfo.creator_id;O==e.nakama.servers[f][R].session.user_id?e.nakama.open_profile_page({isOfficial:f,target:R}):e.nakama.open_others_profile({info:{user:e.nakama.load_other_user(O,f,R)},group:{server:{isOfficial:f,target:R}}})}catch(f){e.p5toast.show({text:`${e.lang.text.PostViewer.CannotOpenProfile}: ${(f.statusText?`${f.statusText}(${f.status})`:f.status)||f}`})}}),I.parent(i),e.PostInfo.offlineAct){let f="";switch(e.PostInfo.offlineAct){case"edit":f=e.lang.text.Community.AfterOnline;break;case"remove":f=e.lang.text.Community.WillBeRemove}const R=n.createSpan(` (${f})`);R.style("color: #888; font-weight: normal;"),R.parent(I)}let V=[];if(e.PostInfo.content){var $;let f=(yield U.xI(e.PostInfo.content)).split("\n"),R=[];for(let c=0,y=f.length;c<y;c++){let G=!1,be=f[c].length-1,a=0;try{let d=f[c].indexOf("}</p>");a=Number(f[c].substring(4,d)),G=0==f[c].indexOf("<p>{")&&f[c].indexOf("}</p>")==be-4&&!isNaN(a)}catch{}if(G){if(e.p5loading.update({id:"postviewer",message:`${e.lang.text.PostViewer.PreparingPost}: ${e.PostInfo.attachments[a].filename} (${e.CurrentIndex} / ${e.nakama.posts.length})`,progress:a/e.PostInfo.attachments.length,forceEnd:null}),!Number.isNaN(a)&&!V.includes(a)&&V.push(a),e.PostInfo.server.local)try{if(e.PostInfo.attachments[a].blob)throw"blob \uc900\ube44\ub418\uc5b4\uc788\uc74c";let d=yield e.indexed.loadBlobFromUserPath(e.PostInfo.attachments[a].path,e.PostInfo.attachments[a].type);e.PostInfo.attachments[a].blob=d}catch{}else try{if(e.PostInfo.attachments[a].blob)throw"blob \uc900\ube44\ub418\uc5b4\uc788\uc74c";e.PostInfo.attachments[a].alt_path=`servers/${e.PostInfo.server.isOfficial}/${e.PostInfo.server.target}/posts/${e.PostInfo.creator_id}/${e.PostInfo.id}/[${c}]${e.PostInfo.attachments[c].filename}`;let d=yield e.nakama.sync_load_file(e.PostInfo.attachments[a],e.PostInfo.server.isOfficial,e.PostInfo.server.target,"server_post",e.PostInfo.creator_id,`${e.PostInfo.id}_attach_${a}`,!1);e.PostInfo.attachments[a].blob=d.value}catch{}switch(e.PostInfo.attachments[a].viewer){case"image":{let d=e.PostInfo.attachments[a].url;if(!d)try{d=URL.createObjectURL(e.PostInfo.attachments[a].blob),setTimeout(()=>{URL.revokeObjectURL(d)},100)}catch(l){console.log("\uac8c\uc2dc\ubb3c image \ucca8\ubd80\ud30c\uc77c \ubd88\ub7ec\uc624\uae30 \uc624\ub958: ",l)}let r=n.createP();r.parent(i);let h=n.createImg(d,`${a}`);h.style("cursor","pointer"),h.style("border-radius","16px"),h.attribute("loading","lazy"),h.mouseClicked(()=>{let l,v,b;e.global.PageDismissAct[e.ModalDismissId]=D=>{e.ExitModalAct(D)};try{b=e.PostInfo.creator_id,l=e.PostInfo.server.isOfficial,v=e.PostInfo.server.target}catch{l="local"}e.IsFocusOnHere=!1;let k=JSON.parse(JSON.stringify(e.PostInfo.attachments[a]));k.filename=`[${a}] ${k.filename}`,e.global.ActLikeModal(`${e.LastPickedRouter}post-viewer/ionic-viewer`,{info:{content:k,sender_id:b},isOfficial:l,target:v,path:e.PostInfo.attachments[a].path,relevance:e.RearrangedRelevance,noEdit:!0,dismiss:e.ModalDismissId})}),h.parent(r),f[c]=r}break;case"audio":{let d=e.PostInfo.attachments[a].url;if(!d)try{d=URL.createObjectURL(e.PostInfo.attachments[a].blob),e.FileURLs.push(d)}catch(l){console.log("\uac8c\uc2dc\ubb3c audio \ucca8\ubd80\ud30c\uc77c \ubd88\ub7ec\uc624\uae30 \uc624\ub958: ",l)}let r=n.createP(),h=n.createAudio([d]);h.showControls(),h.elt.onplay=()=>{for(let l=0,v=e.PlayableElements.length;l<v;l++)try{l!=a&&e.PlayableElements[l].pause()}catch{}},h.parent(r),f[c]=r,e.PlayableElements[a]=h.elt}break;case"video":{let d=e.PostInfo.attachments[a].url;if(!d)try{d=URL.createObjectURL(e.PostInfo.attachments[a].blob),e.FileURLs.push(d)}catch(l){console.log("\uac8c\uc2dc\ubb3c video \ucca8\ubd80\ud30c\uc77c \ubd88\ub7ec\uc624\uae30 \uc624\ub958: ",l)}let r=n.createP(),h=n.createVideo([d]);h.style("width","100%"),h.style("height","auto"),h.style("border-radius","16px"),h.showControls(),h.parent(r),f[c]=r,e.PlayableElements[a]=h.elt}break;case"godot":{const d=`PostViewer_godot_pck_${a}`;let r=n.createDiv();r.id(d),r.style("width","100%"),r.style("height","432px"),r.style("margin-top","8px"),f[c]=r,setTimeout(()=>{if(e.AlreadyHaveGodot||e.global.ArcadeLoaded)try{m(r,a),r.mouseClicked(()=>{let h,l,v;e.global.PageDismissAct[e.ModalDismissId]=k=>{e.ExitModalAct(k)};try{v=e.PostInfo.creator_id,h=e.PostInfo.server.isOfficial,l=e.PostInfo.server.target}catch{h="local"}e.IsFocusOnHere=!1;let b=JSON.parse(JSON.stringify(e.PostInfo.attachments[a]));b.filename=`[${a}] ${b.filename}`,e.global.ActLikeModal(`${e.LastPickedRouter}post-viewer/ionic-viewer`,{info:{content:b,sender_id:v},isOfficial:h,target:l,path:e.PostInfo.attachments[a].path,relevance:e.RearrangedRelevance,noEdit:!0,dismiss:e.ModalDismissId})})}catch(h){console.log("\ud504\ub808\uc784 \uc0ad\uc81c \ud589\ub3d9\uc2e4\ud328: ",h)}else e.AlreadyHaveGodot=!0,e.global.CreateGodotIFrameWithDuplicateAct(e.PostInfo.attachments[a],d,{path:`tmp_files/duplicate/${e.PostInfo.attachments[a].filename}`,quit_ionic:()=>{try{m(r,a),r.mouseClicked(()=>{let h,l,v;e.global.PageDismissAct[e.ModalDismissId]=k=>{e.ExitModalAct(k)};try{v=e.PostInfo.creator_id,h=e.PostInfo.server.isOfficial,l=e.PostInfo.server.target}catch{h="local"}e.IsFocusOnHere=!1;let b=JSON.parse(JSON.stringify(e.PostInfo.attachments[a]));b.filename=`[${a}] ${b.filename}`,e.global.ActLikeModal(`${e.LastPickedRouter}post-viewer/ionic-viewer`,{info:{content:b,sender_id:v},isOfficial:h,target:l,path:e.PostInfo.attachments[a].path,relevance:e.RearrangedRelevance,noEdit:!0,dismiss:e.ModalDismissId})})}catch(h){console.log("\ud504\ub808\uc784 \uc0ad\uc81c \ud589\ub3d9\uc2e4\ud328: ",h)}}})},100*a)}break;case"model":{let d=n.createP(),r=n.createDiv();r.style("position","relative"),r.style("width","100%"),r.style("height","432px"),r.style("border-radius","16px"),r.style("overflow","hidden"),r.parent(d),r.hide(),f[c]=d;let h=e.PostInfo.attachments[a].url;if(!h)try{h=URL.createObjectURL(e.PostInfo.attachments[a].blob),e.FileURLs.push(h)}catch(l){console.log("\uac8c\uc2dc\ubb3c video \ucca8\ubd80\ud30c\uc77c \ubd88\ub7ec\uc624\uae30 \uc624\ub958: ",l)}try{const l=yield e.global.load_openmodel_file(r.elt,e.PostInfo.attachments[a],h,n);e.modelViewers.push(l),r.show()}catch(l){e.p5toast.show({text:`${e.lang.text.ContentViewer.CannotOpenText}: ${(l.statusText?`${l.statusText}(${l.status})`:l.status)||l}`}),console.log("\ubaa8\ub378 \ubd88\ub7ec\uc624\uae30 \uc2e4\ud328: ",l)}}break;case"code":case"text":if("text/html"==e.PostInfo.attachments[a].type)try{if(!e.PostInfo.attachments[a].blob||!e.PostInfo.attachments[a].blob.size){if(e.PostInfo.attachments[a].url){const l=yield e.global.downloadWithProgressAsBlob(e.PostInfo.attachments[a].url);e.PostInfo.attachments[a].alt_path=`servers/${e.PostInfo.server.isOfficial}/${e.PostInfo.server.target}/posts/${e.PostInfo.creator_id}/${e.PostInfo.id}/[${a}]${e.PostInfo.attachments[a].filename}`,yield e.indexed.saveBlobToUserPath(l,e.PostInfo.attachments[a].alt_path)}let h=yield e.indexed.loadBlobFromUserPath(e.PostInfo.attachments[a].alt_path||e.PostInfo.attachments[a].path,e.PostInfo.attachments[a].type);e.PostInfo.attachments[a].blob=h}const d=URL.createObjectURL(e.PostInfo.attachments[a].blob);e.FileURLs.push(d);let r=n.createElement("iframe");r.style("width","100%"),r.style("border","0"),r.style("height","432px"),r.style("border-radius","16px"),r.attribute("src",d),f[c]=r;break}catch(d){console.log("HTML \ud30c\uc77c \uc77d\uae30 \uc2e4\ud328: ",d)}default:{let d=n.createDiv();d.parent(i),m(d,a),d.mouseClicked(()=>{let r,h,l;e.global.PageDismissAct[e.ModalDismissId]=b=>{e.ExitModalAct(b)};try{l=e.PostInfo.creator_id,r=e.PostInfo.server.isOfficial,h=e.PostInfo.server.target}catch{r="local"}e.IsFocusOnHere=!1;let v=JSON.parse(JSON.stringify(e.PostInfo.attachments[a]));v.filename=`[${a}] ${v.filename}`,e.global.ActLikeModal(`${e.LastPickedRouter}post-viewer/ionic-viewer`,{info:{content:v,sender_id:l},isOfficial:r,target:h,path:e.PostInfo.attachments[a].path,relevance:e.RearrangedRelevance,noEdit:!0,dismiss:e.ModalDismissId})}),f[c]=d}}}else try{let d=e.global.HTMLDecode(f[c].replace("<p>","").replace("</p>","")),r=JSON.parse(d),l=n.createDiv(`[${r.i}] ${e.PostInfo.attachments[r.i].filename} (${r.t})`);l.style("background-color","#8888"),l.style("width","fit-content"),l.style("height","fit-content"),l.style("border-radius","16px"),l.style("padding","8px 16px"),l.style("margin","8px 0px"),l.style("cursor","pointer"),f[c]=l,R.push(()=>{let v=e.PlayableElements[r.i],b=r.t.split(":"),k=0,D=1;for(let F=b.length-1;F>=0;F--){let we=Number(b.pop());k+=we*D,D*=60}l.mouseClicked(()=>{try{v.currentTime=k,v.play()}catch{}})})}catch{}}const O=(null===($=e.PostInfo.attachments)||void 0===$?void 0:$.length)||0;for(let c=0;c<O;c++)V.includes(c)||V.push(c);for(let c of V){let y=JSON.parse(JSON.stringify(e.PostInfo.attachments[c]));y.filename=`[${c}] ${y.filename}`,e.RearrangedRelevance.push({content:y})}let S=[],M=()=>{if(S.length){let c=S.join("\n"),y=n.createDiv();y.style("width","100%"),y.elt.innerHTML=c,y.parent(i),S.length=0}};for(let c=0,y=f.length;c<y;c++)"string"==typeof f[c]?S.push(f[c]):(M(),f[c].parent(i),e.RearrangedContents.push(f[c]));M();for(let c=0,y=R.length;c<y;c++)R[c]();for(let c of e.modelViewers){var T;null===(T=c.resized)||void 0===T||T.call(c)}}e.ContentChanging=!1,e.p5loading.update({id:"postviewer",message:`${e.lang.text.PostViewer.ReadyToSee}: ${e.PostInfo.title} (${e.CurrentIndex} / ${e.nakama.posts.length})`,progress:1,forceEnd:350})}),n.windowResized=()=>{setTimeout(()=>{for(let p of this.modelViewers){var g;null===(g=p.resized)||void 0===g||g.call(p)}},50)};let m=(g,p)=>{this.PostInfo.attachments[p].blob=null,g.style("width","160px"),g.style("height","112px"),g.style("overflow","hidden"),g.style("background-color","grey"),g.style("margin-top","8px"),g.style("border-radius","8px"),g.style("cursor","pointer");let x=n.createP(this.PostInfo.attachments[p].filename);x.style("margin","0px 4px"),x.style("text-align","start"),x.parent(g);let P=n.createDiv();P.style("background-color","white"),P.style("margin-top","2px"),P.style("position","relative"),P.style("width","100%"),P.style("height","2px"),P.parent(g);let I=n.createSpan(this.lang.text.PostViewer.OpenFromViewer);I.style("margin","2px 4px 0px 4px"),I.style("text-align","start"),I.style("display","grid"),I.parent(g)}})}CheckIfDismissAct(e){"quick_post_link_qr"===e.target.id&&this.QuickPostView.dismiss()}FocusOnIndexInput(){this.CanInputValue=!0,setTimeout(()=>{var e;null===(e=document.getElementById(this.RelevancesInputId))||void 0===e||e.focus()},100)}ChangeRelevanceIndex(e){if("Enter"==e.key){let i=Number(e.target.value||e.target.placeholder);i=Math.max(Math.min(i,this.nakama.posts.length),1),this.ChangeToAnother(i-this.CurrentIndex),setTimeout(()=>{this.CanInputValue=!1},0)}}EditPost(){this.isOwner&&this.CurrentIndex>=0&&(this.PostViewMenu.dismiss(),this.navCtrl.pop(),this.nakama.EditPost(this.PostInfo))}ionViewWillLeave(){this.p5loading.update({id:"postviewer",forceEnd:0},!0),this.WaitingLoaded=!1,this.global.RestoreShortCutAct("post-viewer"),this.IsFocusOnHere=!1}RemovePost(){var e=this;this.isOwner&&this.CurrentIndex>=0&&(this.PostViewMenu.dismiss(),this.alertCtrl.create({header:this.lang.text.PostViewer.RemovePost,message:this.lang.text.ChatRoom.CannotUndone,buttons:[{text:this.lang.text.ChatRoom.Delete,cssClass:"redfont",handler:()=>{!function(){var n=(0,C.A)(function*(){yield e.nakama.RemovePost(e.PostInfo),e.navCtrl.pop()});return function(){return n.apply(this,arguments)}}()()}}]}).then(i=>i.present()))}ngOnDestroy(){var e,i;null===(e=this.PostViewMenu)||void 0===e||e.dismiss(),null===(i=this.QuickPostView)||void 0===i||i.dismiss(),this.global.ToggleFullScreen(!1),this.route.queryParams.unsubscribe(),this.cont.abort("\uac8c\uc2dc\ubb3c \ubdf0\uc5b4 \ubc97\uc5b4\ub0a8"),this.cont=null;for(let n=0,m=this.FileURLs.length;n<m;n++)URL.revokeObjectURL(this.FileURLs[n]);this.modelViewers.forEach(n=>n.cleanup()),this.modelViewers.length=0,this.p5canvas&&this.p5canvas.remove(),this.global.portalHint=!0}}return(s=u).\u0275fac=function(e){return new(e||s)(t.rXU(H.q9),t.rXU(X.y),t.rXU(B.n),t.rXU(Y.X),t.rXU(w.hG),t.rXU(W.z3),t.rXU(J.G),t.rXU(j.nX),t.rXU(j.Ix),t.rXU(Q.f),t.rXU(z.j))},s.\u0275cmp=t.VBU({type:s,selectors:[["app-post-viewer"]],viewQuery:function(e,i){if(1&e&&(t.GBs(K,5),t.GBs(Z,5)),2&e){let n;t.mGM(n=t.lsd())&&(i.PostViewMenu=n.first),t.mGM(n=t.lsd())&&(i.QuickPostView=n.first)}},decls:10,vars:5,consts:[["QuickPostView",""],["PostViewMenu",""],["class","ion-no-border",4,"ngIf"],[2,"height","100%","overflow-y","auto",3,"id"],["style","width: 100%; height: auto;","alt","MainImage","loading","lazy",3,"src",4,"ngIf"],[2,"padding","16px","height","100%","user-select","text",3,"id"],["style","width: 100%; background-color: black;",4,"ngIf"],[1,"transparent-modal"],[1,"ion-no-border"],["slot","start"],["defaultHref","portal/community"],["name","ellipsis-vertical","slot","end",1,"relevance_change",2,"padding-right","16px","width","21px","height","21px",3,"click","id"],["dismissOnSelect","",3,"trigger"],["style","position: relative;","slot","end",4,"ngIf"],["class","relevance_change","style","padding-right: 4px;","slot","end","name","arrow-back-circle-outline",3,"click",4,"ngIf"],["slot","end",3,"click",4,"ngIf"],["slot","end",4,"ngIf"],["class","relevance_change","style","padding-right: 16px; padding-left: 4px;","slot","end","name","arrow-forward-circle-outline",3,"click",4,"ngIf"],["class","shortcut_hint",4,"ngIf"],["button","",3,"click"],[4,"ngIf"],[1,"shortcut_hint"],["slot","end",2,"position","relative"],[1,"shortcut_hint","shortcut_change_viewer",2,"right","-4px"],["slot","end","name","arrow-back-circle-outline",1,"relevance_change",2,"padding-right","4px",3,"click"],["slot","end",3,"click"],["slot","end"],["type","number",2,"width","50px","text-align","right",3,"change","keydown","id","placeholder"],[1,"shortcut_hint","shortcut_change_viewer"],["slot","end","name","arrow-forward-circle-outline",1,"relevance_change",2,"padding-right","16px","padding-left","4px",3,"click"],["alt","MainImage","loading","lazy",2,"width","100%","height","auto",3,"src"],[2,"width","100%","background-color","black"],[2,"position","relative"],["expand","block",3,"click"],["color","danger","expand","block",3,"click"],["id","quick_post_link_qr",1,"OutterModal",3,"click"],[2,"display","flex","justify-content","center","align-items","center"],[2,"width","400px","min-height","455px","background-color","var(--chatroom-background)","text-align","center","padding","16px"],["style","width: 100%; height: auto; cursor: copy; margin-bottom: 8px;","alt","QuickPostViewLink",3,"src","click",4,"ngIf"],[1,"ion-text-center"],["alt","QuickPostViewLink",2,"width","100%","height","auto","cursor","copy","margin-bottom","8px",3,"click","src"]],template:function(e,i){1&e&&(t.DNE(0,he,16,9,"ion-header",2),t.j41(1,"ion-content")(2,"div",3)(3,"div"),t.DNE(4,fe,1,1,"img",4),t.nrm(5,"div",5),t.DNE(6,me,12,4,"table",6),t.k0s()(),t.j41(7,"ion-modal",7,0),t.DNE(9,_e,7,2,"ng-template"),t.k0s()()),2&e&&(t.Y8G("ngIf",!i.global.ArcadeWithFullScreen),t.R7$(2),t.Y8G("id",i.ScrollPostId),t.R7$(2),t.Y8G("ngIf",i.PostInfo.mainImage&&i.PostInfo.mainImage.MainThumbnail),t.R7$(),t.Y8G("id",i.PostContentId),t.R7$(),t.Y8G("ngIf",i.isOwner&&i.CurrentIndex>=0))},dependencies:[E.bT,w.Jm,w.QW,w.W9,w.eU,w.iq,w.uz,w.he,w.nf,w.BC,w.ai,w.Sb,w.CF,w.el]}),u})()},{path:"ionic-viewer",loadChildren:()=>Promise.all([_.e(6042),_.e(4803)]).then(_.bind(_,4803)).then(s=>s.IonicViewerPageModule)}];let Ie=(()=>{var s;class u{}return(s=u).\u0275fac=function(e){return new(e||s)},s.\u0275mod=t.$C({type:s}),s.\u0275inj=t.G2t({imports:[j.iI.forChild(Pe),j.iI]}),u})(),ve=(()=>{var s;class u{}return(s=u).\u0275fac=function(e){return new(e||s)},s.\u0275mod=t.$C({type:s}),s.\u0275inj=t.G2t({imports:[E.MD,L.YN,w.bv,Ie]}),u})()}}]);