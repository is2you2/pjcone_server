"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[526],{526:(q,D,I)=>{I.r(D),I.d(D,{PostViewerPageModule:()=>Q});var U=I(177),j=I(4341),w=I(5374),T=I(9858),_=I(467),S=I(8326),L=I(92),t=I(3953),F=I(3656),E=I(4234),N=I(755),G=I(4237),M=I(482),B=I(9900);function X(l,y){if(1&l){const u=t.RV6();t.j41(0,"ion-icon",10),t.bIt("click",function(){t.eBV(u);const o=t.XpG();return t.Njj(o.ChangeToAnother(-1))}),t.k0s()}}function W(l,y){if(1&l&&(t.j41(0,"ion-label",11),t.EFF(1),t.k0s()),2&l){const u=t.XpG();t.R7$(),t.JRh(u.CurrentIndex+" / "+u.nakama.posts.length)}}function J(l,y){if(1&l){const u=t.RV6();t.j41(0,"ion-icon",12),t.bIt("click",function(){t.eBV(u);const o=t.XpG();return t.Njj(o.ChangeToAnother(1))}),t.k0s()}}function H(l,y){if(1&l&&t.nrm(0,"img",13),2&l){const u=t.XpG();t.Y8G("src",u.PostInfo.mainImage.MainThumbnail,t.B4B)}}function z(l,y){if(1&l){const u=t.RV6();t.j41(0,"ion-footer")(1,"table",14)(2,"tr")(3,"td")(4,"ion-button",15),t.bIt("click",function(){t.eBV(u);const o=t.XpG();return t.Njj(o.EditPost())}),t.EFF(5),t.k0s()(),t.j41(6,"td")(7,"ion-button",16),t.bIt("click",function(){t.eBV(u);const o=t.XpG();return t.Njj(o.RemovePost())}),t.EFF(8),t.k0s()()()()()}if(2&l){const u=t.XpG();t.R7$(5),t.SpI(" ",u.lang.text.AddPost.EditTitle," "),t.R7$(3),t.SpI(" ",u.lang.text.PostViewer.RemovePost," ")}}const Y=[{path:"",component:(()=>{var l;class y{constructor(e,o,c,x,h,P,v,d,p){this.navCtrl=e,this.lang=o,this.indexed=c,this.nakama=x,this.alertCtrl=h,this.global=P,this.p5toast=v,this.route=d,this.router=p,this.PostInfo={},this.isOwner=!1,this.HavePosts=!1,this.CurrentIndex=1,this.WaitingLoaded=!1,this.BackButtonPressed=!1,this.blenderViewers=[],this.FileURLs=[],this.PlayableElements=[],this.IsFocusOnHere=!0,this.ContentChanging=!1}ngOnInit(){this.route.queryParams.subscribe(e=>{try{const o=this.router.getCurrentNavigation().extras.state;this.PostInfo=o.data,this.CurrentIndex=o.index,this.initialize()}catch{}})}WaitingCurrent(){var e=this;return(0,_.A)(function*(){for(;!e.WaitingLoaded;)yield new Promise(o=>setTimeout(o,0))})()}ionViewWillEnter(){this.WaitingLoaded=!0,this.global.StoreShortCutAct("post-viewer"),this.global.p5KeyShortCut.Escape=()=>{this.navCtrl.pop()},this.IsFocusOnHere=!0}ChangeContentWithKeyInput(){var e=this;if(this.p5canvas){this.p5canvas.keyPressed=function(){var h=(0,_.A)(function*(P){if(e.IsFocusOnHere)switch(P.code){case"KeyA":case"ArrowLeft":e.ChangeToAnother(-1);break;case"KeyD":case"ArrowRight":e.ChangeToAnother(1);break;case"KeyQ":let v=[];for(let d=0,p=e.PostInfo.attachments.length;d<p;d++)v.push({content:JSON.parse(JSON.stringify(e.PostInfo.attachments[d]))});if(!v.length)return;e.global.PageDismissAct["post-viewer-image-view"]=function(){var d=(0,_.A)(function*(p){yield e.WaitingCurrent(),p.data&&p.data.share&&e.navCtrl.pop(),delete e.global.PageDismissAct["post-viewer-image-view"]});return function(p){return d.apply(this,arguments)}}(),e.global.ActLikeModal("ionic-viewer",{info:{content:e.PostInfo.attachments[0]},path:e.PostInfo.attachments[0].path,relevance:v,noEdit:!0,dismiss:"post-viewer-image-view"})}});return function(P){return h.apply(this,arguments)}}();let o=this.p5canvas.createVector(),c={};this.p5canvas.touchStarted=h=>{if(this.IsFocusOnHere&&"changedTouches"in h){for(let v=0,d=h.changedTouches.length;v<d;v++)c[h.changedTouches[v].identifier]=this.p5canvas.createVector(h.changedTouches[v].clientX,h.changedTouches[v].clientY);1===Object.keys(c).length&&(o=c[h.changedTouches[0].identifier].copy())}};const x=100;this.p5canvas.touchEnded=h=>{if(this.IsFocusOnHere&&"changedTouches"in h){let P;for(let d=0,p=h.changedTouches.length;d<p;d++)P=this.p5canvas.createVector(h.changedTouches[d].clientX,h.changedTouches[d].clientY),delete c[h.changedTouches[d].identifier];0===Object.keys(c).length&&(P.sub(o),P.x>x?this.ChangeToAnother(-1):P.x<-x&&this.ChangeToAnother(1))}}}}initialize(){if(this.cont&&this.cont.abort(),this.cont=new AbortController,this.PostInfo.mainImage)try{let e=this.PostInfo.mainImage.url;e||(e=URL.createObjectURL(this.PostInfo.mainImage.blob),setTimeout(()=>{URL.revokeObjectURL(e)},100)),this.PostInfo.mainImage.MainThumbnail=e}catch{}this.create_content();try{this.isOwner="me"==this.PostInfo.creator_id||this.PostInfo.creator_id==this.nakama.servers[this.PostInfo.server.isOfficial][this.PostInfo.server.target].session.user_id}catch{this.isOwner=!1}this.HavePosts=this.nakama.posts.length>1&&this.CurrentIndex>=0,this.ChangeContentWithKeyInput()}ChangeToAnother(e){if(this.ContentChanging)return;this.ContentChanging=!0;let o=this.CurrentIndex+e;o<=0||o>this.nakama.posts.length?this.ContentChanging=!1:(this.ScrollDiv||(this.ScrollDiv=document.getElementById("ScrollPost")),this.ScrollDiv.scrollTo({top:0}),this.p5canvas&&this.p5canvas.remove(),this.CurrentIndex=o,this.PostInfo=this.nakama.posts[this.CurrentIndex-1],this.initialize())}create_content(){var e=this;let o=document.getElementById("PostContent");this.p5canvas=new S(c=>{c.setup=(0,_.A)(function*(){c.noCanvas();let h=c.createDiv(`${e.PostInfo.OutSource?'<ion-icon id="title_link" style="cursor: pointer;" slot="start" name="link-outline"></ion-icon> ':""}${e.PostInfo.title}`);e.PostInfo.OutSource&&(document.getElementById("title_link").onclick=(0,_.A)(function*(){let b="",g=e.PostInfo.OutSource,C=g.substring(0,g.indexOf(":8"));try{let V=`${C}:12000${window.sub_path}`;const O=new AbortController,i=setTimeout(()=>{O.abort()},500);let n=yield fetch(V,{signal:O.signal});if(clearTimeout(i),!n.ok)throw"\uc8fc\uc18c \uc5c6\uc74c";b=`${C}:12000${window.sub_path}?postViewer=${e.PostInfo.OutSource}`}catch{b=`${L.d2}pjcone_pwa/?postViewer=${e.PostInfo.OutSource}`}e.global.WriteValueToClipboard("text/plain",b)})),h.style("font-size","32px"),h.style("font-weight","bold"),h.parent(o);let P=c.createDiv();P.style("color","#888"),P.parent(o),c.createDiv(`${e.lang.text.PostViewer.CreateTime}: ${new Date(e.PostInfo.create_time).toLocaleString()}`).parent(P),e.PostInfo.create_time!=e.PostInfo.modify_time&&c.createDiv(`${e.lang.text.PostViewer.ModifyTime}: ${new Date(e.PostInfo.modify_time).toLocaleString()}`).parent(P);let p,d=c.createDiv();d.style("padding-bottom","8px"),d.parent(o);try{p=e.nakama.usernameOverride[e.PostInfo.server.isOfficial][e.PostInfo.server.target][e.PostInfo.creator_id]||e.PostInfo.creator_name}catch{p=e.PostInfo.creator_name}let k=c.createSpan(p);if(k.style("color",`#${e.PostInfo.UserColor}`),k.style("font-weight","bold"),k.style("font-size","17px"),k.style("cursor","pointer"),k.elt.onclick=()=>{if("me"==e.PostInfo.creator_id)e.nakama.open_profile_page();else try{let r=e.PostInfo.server.isOfficial,b=e.PostInfo.server.target,g=e.PostInfo.creator_id;g==e.nakama.servers[r][b].session.user_id?e.nakama.open_profile_page({isOfficial:r,target:b}):e.nakama.open_others_profile({info:{user:e.nakama.load_other_user(g,r,b)},group:{server:{isOfficial:r,target:b}}})}catch(r){e.p5toast.show({text:`${e.lang.text.PostViewer.CannotOpenProfile}: ${r}`})}},k.parent(d),e.PostInfo.server.local)for(let r=0,b=e.PostInfo.attachments.length;r<b;r++)try{let g=yield e.indexed.loadBlobFromUserPath(e.PostInfo.attachments[r].path,e.PostInfo.attachments[r].type);e.PostInfo.attachments[r].blob=g}catch{}else for(let r=0,b=e.PostInfo.attachments.length;r<b;r++)try{e.PostInfo.attachments[r].alt_path=`servers/${e.PostInfo.server.isOfficial}/${e.PostInfo.server.target}/posts/${e.PostInfo.creator_id}/${e.PostInfo.id}/[${r}]${e.PostInfo.attachments[r].filename}`;let g=yield e.nakama.sync_load_file(e.PostInfo.attachments[r],e.PostInfo.server.isOfficial,e.PostInfo.server.target,"server_post",e.PostInfo.creator_id,`${e.PostInfo.id}_attach_${r}`,!1);e.PostInfo.attachments[r].blob=g.value}catch{}if(e.PostInfo.content){let r=e.PostInfo.content.split("\n"),b=[];for(let g=0,C=r.length;g<C;g++){let V=!1,O=r[g].length-1,i=0;try{i=Number(r[g].substring(1,O)),V="["==r[g].charAt(0)&&"]"==r[g].charAt(O)&&!isNaN(i)}catch{}if(V)switch(e.PostInfo.attachments[i].viewer){case"image":{let n=e.PostInfo.attachments[i].url;if(!n)try{n=URL.createObjectURL(e.PostInfo.attachments[i].blob),setTimeout(()=>{URL.revokeObjectURL(n)},100)}catch(s){console.log("\uac8c\uc2dc\ubb3c image \ucca8\ubd80\ud30c\uc77c \ubd88\ub7ec\uc624\uae30 \uc624\ub958: ",s)}let a=c.createImg(n,`${i}`);a.style("cursor","pointer"),a.elt.onclick=()=>{let s=[];for(let f of e.PostInfo.attachments)s.push({content:JSON.parse(JSON.stringify(f))});e.global.PageDismissAct["post-viewer-image-view"]=function(){var f=(0,_.A)(function*(m){yield e.WaitingCurrent(),m.data&&m.data.share&&e.navCtrl.pop(),delete e.global.PageDismissAct["post-viewer-image-view"]});return function(m){return f.apply(this,arguments)}}(),e.global.ActLikeModal("ionic-viewer",{info:{content:e.PostInfo.attachments[i]},path:e.PostInfo.attachments[i].path,relevance:s,noEdit:!0,dismiss:"post-viewer-image-view"})},a.parent(o)}break;case"audio":{let n=e.PostInfo.attachments[i].url;if(!n)try{n=URL.createObjectURL(e.PostInfo.attachments[i].blob),e.FileURLs.push(n)}catch(s){console.log("\uac8c\uc2dc\ubb3c audio \ucca8\ubd80\ud30c\uc77c \ubd88\ub7ec\uc624\uae30 \uc624\ub958: ",s)}let a=c.createAudio([n]);a.showControls(),a.elt.onplay=()=>{for(let s=0,f=e.PlayableElements.length;s<f;s++)try{s!=i&&e.PlayableElements[s].pause()}catch{}},a.parent(o),e.PlayableElements[i]=a.elt}break;case"video":{let n=e.PostInfo.attachments[i].url;if(!n)try{n=URL.createObjectURL(e.PostInfo.attachments[i].blob),e.FileURLs.push(n)}catch(s){console.log("\uac8c\uc2dc\ubb3c video \ucca8\ubd80\ud30c\uc77c \ubd88\ub7ec\uc624\uae30 \uc624\ub958: ",s)}let a=c.createVideo([n]);a.style("width","100%"),a.style("height","auto"),a.showControls(),a.parent(o),e.PlayableElements[i]=a.elt}break;case"godot":{let n=`PostViewer_godot_pck_${i}`,a=c.createDiv();a.id(n),a.style("width","100%"),a.style("height","432px"),a.parent(o),setTimeout((0,_.A)(function*(){let s=!1;if(e.indexed.godotDB)try{yield e.indexed.GetGodotIndexedDB(),yield e.indexed.saveBlobToUserPath(e.PostInfo.attachments[i].blob,`godot/app_userdata/Client/tmp_files/duplicate/${e.PostInfo.attachments[i].filename}`,void 0,e.indexed.godotDB),s=!0}catch(f){console.log("\ub0b4\ubd80 \ud30c\uc77c \uc5c6\uc74c: ",f)}if(yield e.global.CreateGodotIFrame(n,{path:`tmp_files/duplicate/${e.PostInfo.attachments[i].filename}`,url:e.PostInfo.attachments[i].url,quit_ionic:()=>{if(s)try{x(a,i),a.elt.onclick=()=>{let f=[];for(let m of e.PostInfo.attachments)f.push({content:m});e.global.PageDismissAct["post-viewer-file-view"]=()=>{delete e.global.PageDismissAct["post-viewer-file-view"]},e.global.ActLikeModal("ionic-viewer",{info:{content:JSON.parse(JSON.stringify(e.PostInfo.attachments[i]))},path:e.PostInfo.attachments[i].path,relevance:f,noEdit:!0,dismiss:"post-viewer-file-view"})}}catch(f){console.log("\ud504\ub808\uc784 \uc0ad\uc81c \ud589\ub3d9\uc2e4\ud328: ",f)}}},"start_load_pck"),!s){try{let f=yield e.indexed.loadBlobFromUserPath(e.PostInfo.attachments[i].path,"",void 0,e.indexed.ionicDB);yield e.indexed.GetGodotIndexedDB(),yield e.indexed.saveBlobToUserPath(f,`godot/app_userdata/Client/tmp_files/duplicate/${e.PostInfo.attachments[i].filename}`,void 0,e.indexed.godotDB)}catch{}yield e.global.CreateGodotIFrame(n,{path:`tmp_files/duplicate/${e.PostInfo.attachments[i].filename}`,url:e.PostInfo.attachments[i].url,quit_ionic:()=>{try{x(a,i),a.elt.onclick=()=>{let f=[];for(let m of e.PostInfo.attachments)f.push({content:m});e.global.PageDismissAct["post-viewer-file-view"]=()=>{delete e.global.PageDismissAct["post-viewer-file-view"]},e.global.ActLikeModal("ionic-viewer",{info:{content:JSON.parse(JSON.stringify(e.PostInfo.attachments[i]))},path:e.PostInfo.attachments[i].path,relevance:f,noEdit:!0,dismiss:"post-viewer-file-view"})}}catch(f){console.log("\ud504\ub808\uc784 \uc0ad\uc81c \ud589\ub3d9\uc2e4\ud328: ",f)}}},"start_load_pck")}e.PostInfo.attachments[i].url?e.global.godot_window.download_url():e.global.godot_window.start_load_pck()}),100)}break;case"blender":{let n=c.createDiv();n.style("position","relative"),n.style("width","100%"),n.style("height","432px"),n.elt.onwheel=()=>!1,n.elt.oncontextmenu=()=>!1,n.parent(o);let a=e.global.load_blender_file(n.elt,e.PostInfo.attachments[i],()=>{},()=>{},e.cont);e.blenderViewers.push(a)}break;default:{let n=c.createDiv();n.parent(o),x(n,i),n.elt.onclick=()=>{let a=[];for(let s of e.PostInfo.attachments)a.push({content:s});e.global.PageDismissAct["post-viewer-file-view"]=()=>{delete e.global.PageDismissAct["post-viewer-file-view"]},e.global.ActLikeModal("ionic-viewer",{info:{content:JSON.parse(JSON.stringify(e.PostInfo.attachments[i]))},path:e.PostInfo.attachments[i].path,relevance:a,noEdit:!0,dismiss:"post-viewer-file-view"})}}}else try{let n=JSON.parse(r[g]),s=c.createDiv(`[${n.i}] ${e.PostInfo.attachments[n.i].filename} (${n.t})`);s.style("background-color","#8888"),s.style("width","fit-content"),s.style("height","fit-content"),s.style("border-radius","16px"),s.style("padding","8px 16px"),s.style("cursor","pointer"),s.parent(o),b.push(()=>{let f=e.PlayableElements[n.i],m=n.t.split(":"),A=0,$=1;for(let R=m.length-1;R>=0;R--){let Z=Number(m.pop());A+=Z*$,$*=60}s.elt.onclick=()=>{try{f.currentTime=A,f.play()}catch{}}})}catch{let a=c.createDiv();a.parent(o);let s=r[g].split(" "),f="";for(let m=0,A=s.length;m<A;m++)if(0==s[m].indexOf("http:")||0==s[m].indexOf("https:")){c.createSpan(f).parent(a),f="";let R=c.createA(s[m],s[m]);R.attribute("target","_blank"),R.parent(a),f+="&nbsp"}else f+=s[m]+"&nbsp";f&&c.createSpan(f).parent(a)}}for(let g=0,C=b.length;g<C;g++)b[g]()}e.ContentChanging=!1});let x=(h,P)=>{h.style("width","160px"),h.style("height","112px"),h.style("overflow","hidden"),h.style("background-color","grey"),h.style("margin-top","4px"),h.style("border-radius","8px"),h.style("cursor","pointer");let v=c.createP(this.PostInfo.attachments[P].filename);v.style("margin","0px 4px"),v.style("text-align","start"),v.parent(h);let d=c.createDiv();d.style("background-color","white"),d.style("margin-top","2px"),d.style("position","relative"),d.style("width","100%"),d.style("height","2px"),d.parent(h);let p=c.createSpan(this.lang.text.PostViewer.OpenFromViewer);p.style("margin","2px 4px 0px 4px"),p.style("text-align","start"),p.style("display","grid"),p.parent(h)}})}EditPost(){this.nakama.EditPost(this.PostInfo),this.navCtrl.pop()}ionViewWillLeave(){this.WaitingLoaded=!1,delete this.global.p5KeyShortCut.Escape,this.global.RestoreShortCutAct("post-viewer"),this.IsFocusOnHere=!1}RemovePost(){var o,e=this;this.alertCtrl.create({header:this.lang.text.PostViewer.RemovePost,message:this.lang.text.ChatRoom.CannotUndone,buttons:[{text:this.lang.text.ChatRoom.Delete,cssClass:"redfont",handler:(o=(0,_.A)(function*(){yield e.nakama.RemovePost(e.PostInfo),e.navCtrl.pop()}),function(){return o.apply(this,arguments)})}]}).then(o=>o.present())}ngOnDestroy(){this.route.queryParams.unsubscribe(),this.cont.abort();for(let e=0,o=this.FileURLs.length;e<o;e++)URL.revokeObjectURL(this.FileURLs[e]);for(let e=0,o=this.blenderViewers.length;e<o;e++)this.blenderViewers[e].remove();this.p5canvas&&this.p5canvas.remove()}}return(l=y).\u0275fac=function(e){return new(e||l)(t.rXU(F.q9),t.rXU(E.y),t.rXU(N.n),t.rXU(G.X),t.rXU(w.hG),t.rXU(M.z3),t.rXU(B.G),t.rXU(T.nX),t.rXU(T.Ix))},l.\u0275cmp=t.VBU({type:l,selectors:[["app-post-viewer"]],decls:14,vars:6,consts:[[1,"ion-no-border"],["slot","start"],["defaultHref","portal/community"],["class","relevance_change","style","padding-right: 4px;","slot","end","name","arrow-back-circle-outline",3,"click",4,"ngIf"],["slot","end",4,"ngIf"],["class","relevance_change","style","padding-right: 16px; padding-left: 4px;","slot","end","name","arrow-forward-circle-outline",3,"click",4,"ngIf"],["id","ScrollPost"],["style","width: 100%; height: auto;","alt","MainImage",3,"src",4,"ngIf"],["id","PostContent",2,"padding","16px","height","100%"],[4,"ngIf"],["slot","end","name","arrow-back-circle-outline",1,"relevance_change",2,"padding-right","4px",3,"click"],["slot","end"],["slot","end","name","arrow-forward-circle-outline",1,"relevance_change",2,"padding-right","16px","padding-left","4px",3,"click"],["alt","MainImage",2,"width","100%","height","auto",3,"src"],[2,"width","100%","background-color","black"],["expand","block",3,"click"],["color","danger","expand","block",3,"click"]],template:function(e,o){1&e&&(t.j41(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-title"),t.EFF(3),t.k0s(),t.j41(4,"ion-buttons",1),t.nrm(5,"ion-back-button",2),t.k0s(),t.DNE(6,X,1,0,"ion-icon",3)(7,W,2,1,"ion-label",4)(8,J,1,0,"ion-icon",5),t.k0s()(),t.j41(9,"ion-content")(10,"div",6),t.DNE(11,H,1,1,"img",7),t.nrm(12,"div",8),t.k0s()(),t.DNE(13,z,9,2,"ion-footer",9)),2&e&&(t.R7$(3),t.JRh(o.lang.text.PostViewer.Title),t.R7$(3),t.Y8G("ngIf",o.HavePosts),t.R7$(),t.Y8G("ngIf",o.HavePosts),t.R7$(),t.Y8G("ngIf",o.HavePosts),t.R7$(3),t.Y8G("ngIf",o.PostInfo.mainImage&&o.PostInfo.mainImage.MainThumbnail),t.R7$(2),t.Y8G("ngIf",o.isOwner&&o.CurrentIndex>=0))},dependencies:[U.bT,w.Jm,w.QW,w.W9,w.M0,w.eU,w.iq,w.he,w.BC,w.ai,w.el],styles:[".relevance_change[_ngcontent-%COMP%]{width:25px;height:25px}"]}),y})()}];let K=(()=>{var l;class y{}return(l=y).\u0275fac=function(e){return new(e||l)},l.\u0275mod=t.$C({type:l}),l.\u0275inj=t.G2t({imports:[T.iI.forChild(Y),T.iI]}),y})(),Q=(()=>{var l;class y{}return(l=y).\u0275fac=function(e){return new(e||l)},l.\u0275mod=t.$C({type:l}),l.\u0275inj=t.G2t({imports:[U.MD,j.YN,w.bv,K]}),y})()}}]);