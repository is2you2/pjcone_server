"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[4020],{4020:(W,T,h)=>{h.d(T,{j:()=>L});var u=h(467),R=h(8326),w=h(5402),I=h(482),m=h(3953),D=h(9900),x=h(755),N=h(4234),M=h(4237);!function B(){("http:"!=window.location.protocol||0==window.location.host.indexOf("localhost"))&&h.e(925).then(h.t.bind(h,925,23))}();let L=(()=>{var E;class P{constructor(e,t,n,i,r){this.p5toast=e,this.indexed=t,this.lang=n,this.nakama=i,this.global=r,this.OnUse=!1,this.isCallable=!1,this.isConnected=!1,this.JoinInited=!1,this.ReceivedOfferPart="",this.ReceivedAnswerPart="",this.IceCandidates=[],this.StatusText="",this.nakama.WebRTCService=this,this.global.WebRTCService=this}initialize(e,t){var n=this;return(0,u.A)(function*(){if("data"!=e&&"http:"==window.location.protocol&&0!=window.location.host.indexOf("localhost")||"data"!=e&&!(yield w.R.requestAudioRecordingPermission()).value)throw n.lang.text.WebRTCDevManager.SecurityError;if(n.OnUse)throw n.p5toast.show({text:n.lang.text.WebRTCDevManager.AlreadyCalling}),n.lang.text.WebRTCDevManager.AlreadyCalling;if(yield n.close_webrtc(),n.TypeIn=e,"data"!=e){n.createP5_panel();try{var i,r;n.localMedia=document.createElement(e),n.localMedia.id="webrtc_video",n.localMedia.style.width="100%",n.localMedia.style.height="fit-content",n.localMedia.autoplay=!0,"video"==e&&(n.localMedia.playsInline=!0),n.localMedia.muted=!0,document.body.appendChild(n.localMedia),n.remoteMedia=document.createElement(e),n.remoteMedia.id="webrtc_video_remote",n.remoteMedia.style.width="100%",n.remoteMedia.style.height="fit-content",n.remoteMedia.autoplay=!0,"video"==e&&(n.remoteMedia.playsInline=!0),document.body.appendChild(n.remoteMedia);let l,s,a=yield n.getDeviceList(),d=Number(null!==(i=localStorage.getItem("VideoInputDev"))&&void 0!==i?i:NaN),p=Number(null!==(r=localStorage.getItem("AudioInputDev"))&&void 0!==r?r:NaN);for(let c=0,v=a.length,f=0,O=0;c<v&&(!l||!s);c++)!l&&"audioinput"==a[c].kind&&(Number.isNaN(p)?(l=a[c].deviceId,localStorage.setItem("AudioInputDev",`${O}`)):O==p&&(l=a[c].deviceId),O++),!s&&"videoinput"==a[c].kind&&(Number.isNaN(d)?(s=a[c].deviceId,localStorage.setItem("AudioInputDev",`${f}`)):f==d&&(s=a[c].deviceId),f++);t||(t={},"video"==e?(t.video=!0,s&&(t.video={deviceId:s})):t.video=!1,t.audio=!0,l&&(t.audio={deviceId:l})),n.localStream=yield navigator.mediaDevices.getUserMedia(t),n.localMedia.srcObject=n.localStream,n.isCallable=!0}catch(a){console.log("navigator.getUserMedia error: ",a),yield n.close_webrtc(),n.p5toast.show({text:`${n.lang.text.WebRTCDevManager.InitErr}: ${a}`})}}else n.isCallable=!0;yield n.createCall(),n.p5callButton&&(n.p5callButton.elt.disabled=!1),n.StatusText=n.lang.text.InstantCall.Connecting})()}WEBRTC_INIT_REQ_SIGNAL(e){let t=JSON.stringify(this.LocalOffer);this.LocalOfferPartArray=t.match(/(.{1,64})/g),this.WEBRTC_REPLY_INIT_SIGNAL_PART(e)}WEBRTC_REPLY_INIT_SIGNAL_PART(e){if(e.client&&e.client.readyState==e.client.OPEN){let t=this.LocalOfferPartArray.shift();e.client.send(t?JSON.stringify({type:"socket_react",channel:e.channel,act:"WEBRTC_REPLY_INIT_SIGNAL",data_str:t}):JSON.stringify({type:"socket_react",channel:e.channel,act:"WEBRTC_REPLY_INIT_SIGNAL",data_str:"EOL"}))}}WEBRTC_REPLY_INIT_SIGNAL(e,t){"EOL"==e?(this.createRemoteOfferFromAnswer(JSON.parse(this.ReceivedOfferPart)),this.ReceivedOfferPart="",this.InitReplyCallback&&this.InitReplyCallback()):(this.ReceivedOfferPart+=e,t.client&&t.client.readyState==t.client.OPEN&&t.client.send(JSON.stringify({type:"socket_react",channel:t.channel,act:"WEBRTC_REPLY_INIT_SIGNAL_PART"})))}WEBRTC_RECEIVE_ANSWER(e,t){"EOL"==e?(this.ReceiveRemoteAnswer(JSON.parse(this.ReceivedAnswerPart),t),this.ReceivedAnswerPart=""):this.ReceivedAnswerPart+=e}WEBRTC_ICE_CANDIDATES(e,t){this.ReceiveIceCandidate(JSON.parse(e),t)}WEBRTC_NEGOCIATENEEDED(e){"EOL"==e?(this.createRemoteOfferFromAnswer(JSON.parse(this.ReceivedOfferPart)),this.ReceivedOfferPart="",this.CreateAnswer()):this.ReceivedOfferPart+=e}createP5_panel(){var e=this;this.OnUse=!0,this.p5canvas&&(clearTimeout(this.p5waitingAct),this.p5waitingAct=null,this.p5callButton&&this.p5callButton.remove(),this.p5callButton=null,this.p5hangup=null,this.p5canvas.remove()),this.p5canvas=new R(t=>{let n,i,a,l,s,d,p,c,v=1;t.setup=()=>{let o,_=()=>{this.JoinInited?(o.stop(.1),clearTimeout(this.p5waitingAct)):(o&&o.stop(.1),o=new R.Oscillator(380,"sine"),o.start(),o.amp(1,.15),o.amp(0,.75),this.p5waitingAct=setTimeout(()=>{_()},1200))};this.p5waitingAct=setTimeout(()=>{_()},0),this.p5hangup=(C=!1)=>{!this.isConnected&&!C||(o.stop(.1),clearTimeout(this.p5waitingAct),o=new R.Oscillator(380,"sine"),o.start(),o.freq(250,.35),o.amp(1,.15),o.amp(0,.25),o.amp(1,.35),o.amp(0,.45))},t.noCanvas(),n=t.createDiv(),n.id("outterDiv"),n.style("position: absolute; left: 50%; top: 0px; z-index: 1"),n.style("transform: translateX(-50%)"),n.style("width: fit-content; height: fit-content"),n.style("padding: 8px 16px;"),n.style("display: flex; justify-content: center;"),a=t.createDiv(),a.parent(n),a.style("display: flex; justify-content: center;"),a.style("width: fit-content; height: fit-content"),a.style("border-radius: 32px"),a.style("background: var(--toast-background-color)"),a.style("padding: 6px 12px"),i=t.createDiv(),i.parent(a),i.id("webrtc_content"),i.style("display: flex; justify-content: center;"),i.style("flex-direction","column"),i.style("width: fit-content; height: fit-content"),i.style("word-break: break-all"),i.style("background: var(--toast-background-color)"),i.style("border-radius: 32px"),i.style("padding: 6px 12px"),i.style("color: "+(I.ud?"white":"black")),S(),l=t.createDiv(),l.parent(i),l.id("webrtc_content"),l.style("display: flex; justify-content: center;"),l.style("align-self","center"),l.style("width: fit-content; height: fit-content"),this.p5callButton=t.createButton('<ion-icon style="width: 32px; height: 32px;" name="call-outline"></ion-icon>'),this.p5callButton.parent(l),this.p5callButton.style("padding","0px"),this.p5callButton.style("margin","4px"),this.p5callButton.style("border-radius","16px"),this.p5callButton.style("width","40px"),this.p5callButton.style("height","40px"),this.p5callButton.mouseClicked(()=>{this.CreateAnswer()}),this.p5callButton.elt.disabled=!0,this.p5callButton=this.p5callButton,s=t.createButton('<ion-icon style="width: 32px; height: 32px;" name="mic-outline"></ion-icon>'),s.parent(l),s.style("padding","0px"),s.style("margin","4px"),s.style("border-radius","16px"),s.style("width","40px"),s.style("height","40px"),s.mouseClicked(()=>{const C=this.localStream.getAudioTracks();for(let g=0,y=C.length;g<y;g++)C[g].enabled=!1;d.show(),s.hide()}),d=t.createButton('<ion-icon style="width: 32px; height: 32px;" name="mic-off-outline"></ion-icon>'),d.parent(l),d.style("background-color","grey"),d.style("padding","0px"),d.style("margin","4px"),d.style("border-radius","16px"),d.style("width","40px"),d.style("height","40px"),d.mouseClicked(()=>{const C=this.localStream.getAudioTracks();for(let g=0,y=C.length;g<y;g++)C[g].enabled=!0;s.show(),d.hide()}),d.hide(),p=t.createButton('<ion-icon style="width: 32px; height: 32px;" name="settings-outline"></ion-icon>'),p.parent(l),p.style("padding","0px"),p.style("margin","4px"),p.style("border-radius","16px"),p.style("width","40px"),p.style("height","40px"),p.mouseClicked((0,u.A)(function*(){p.elt.disabled=!0;let C=yield e.getDeviceList();e.global.PageDismissAct["webrtc-manage"]=function(){var g=(0,u.A)(function*(y){p.elt.disabled=!1;try{let A={};"video"==e.TypeIn&&y.data.videoinput&&(A.video={deviceId:{exact:y.data.videoinput.deviceId}}),y.data.audioinput&&(A.audio={deviceId:{exact:y.data.audioinput.deviceId}}),e.localStream.getTracks().forEach(b=>b.stop()),e.localStream=yield navigator.mediaDevices.getUserMedia(A),e.localMedia.srcObject=e.localStream,e.PeerConnection.getSenders().forEach(b=>{b.track&&b.replaceTrack(e.localStream.getTracks()[0])}),e.CreateOffer()}catch(A){console.log("\ubbf8\ub514\uc5b4 \uc2a4\ud2b8\ub9bc \ubcc0\uacbd \uc624\ub958: ",A)}e.global.RestoreShortCutAct("webrtc-manage"),delete e.global.PageDismissAct["webrtc-manage"]});return function(y){return g.apply(this,arguments)}}(),e.global.StoreShortCutAct("webrtc-manage"),e.global.ActLikeModal("webrtc-manage-io-dev",{list:JSON.parse(JSON.stringify(C)),typein:e.TypeIn,dismiss:"webrtc-manage"})})),c=t.createButton('<ion-icon style="width: 32px; height: 32px;" name="close-circle-outline"></ion-icon>'),c.parent(l),c.style("background-color","red"),c.style("padding","0px"),c.style("margin","4px"),c.style("border-radius","16px"),c.style("width","40px"),c.style("height","40px"),c.mouseClicked((0,u.A)(function*(){yield e.close_webrtc()}))};let O=!1;t.draw=()=>{v>0&&(v-=.03),S(),this.OnUse||this.p5hangup&&!O&&(this.p5hangup(),n.hide(),setTimeout(()=>{this.OnUse||(clearTimeout(this.p5waitingAct),this.p5waitingAct=null,this.p5callButton.remove(),this.p5callButton=null,this.p5hangup=null,this.p5canvas.remove())},1e3),O=!0)};let S=()=>{let o=t.lerpColor(t.color("#"+(I.ud?"30564e88":"b9543788")),t.color("#ffd94ebb"),v).levels,_=4*v;a.style(`padding: ${_}px ${_}px`),i.style(`padding: ${t.lerp(6,2,v)}px ${t.lerp(12,8,v)}px`),a.style(`background: rgba(${o[0]}, ${o[1]}, ${o[2]}, ${o[3]/255})`)}})}getDeviceList(){return(0,u.A)(function*(){return yield navigator.mediaDevices.enumerateDevices()})()}createCall(){var e=this;return(0,u.A)(function*(){let t;e.isCallable=!1,e.isConnected=!0,e.startTime=window.performance.now();try{let n=yield e.indexed.loadTextFromUserPath("servers/webrtc_server.json");t={},t.iceServers=JSON.parse(n)}catch{}(!t||!t.iceServers||!t.iceServers.length)&&(e.p5toast.show({text:e.lang.text.WebRTCDevManager.NoRegServer}),t=null),e.PeerConnection=new RTCPeerConnection(t),e.PeerConnection.onicecandidate=n=>e.handleConnection(n),e.PeerConnection.oniceconnectionstatechange=n=>{console.log("ICE Connection state: ",e.PeerConnection.iceConnectionState)},e.PeerConnection.onconnectionstatechange=function(){var n=(0,u.A)(function*(i){switch(i.target.connectionState){case"failed":case"disconnected":yield e.close_webrtc();break;case"connected":e.p5waitingAct&&clearTimeout(e.p5waitingAct);break;default:console.log("\uc5f0\uacb0 \uc0c1\ud0dc \ubcc0\uacbd\ub428: ",i.target.connectionState)}});return function(i){return n.apply(this,arguments)}}(),"data"!=e.TypeIn?(e.localStream.getTracks().forEach(n=>e.PeerConnection.addTrack(n,e.localStream)),e.PeerConnection.ontrack=n=>{e.remoteMedia.srcObject=n.streams[0]}):e.createDataChannel(),e.PeerConnection.ondatachannel=n=>{e.dataChannel=n.channel},e.PeerConnection.onnegotiationneeded=function(){var n=(0,u.A)(function*(i){e.JoinInited&&(yield e.PeerConnection.createOffer({offerToReceiveVideo:!0}).then(r=>e.createdOffer(r)).catch(r=>e.setSessionDescriptionError(r)))});return function(i){return n.apply(this,arguments)}}()})()}createDataChannel(e){this.dataChannel=this.PeerConnection.createDataChannel(e),this.createDataChannelListener()}createDataChannelListener(){this.dataChannel.onopen=e=>{this.dataChannelOpenAct&&this.dataChannelOpenAct()},this.dataChannel.onclose=e=>{this.dataChannelOnCloseAct&&this.dataChannelOnCloseAct(),this.dataChannelOpenAct=null,this.dataChannelOnMsgAct=null,this.dataChannelOnCloseAct=null},this.dataChannel.onmessage=e=>{this.dataChannelOnMsgAct&&this.dataChannelOnMsgAct(e.data)}}send(e){try{this.dataChannel.send(e)}catch(t){console.log("WebRTC \uba54\uc2dc\uc9c0 \ubc1c\uc1a1 \uc2e4\ud328: ",t)}}CreateOffer(){this.p5callButton&&this.p5callButton.hide(),this.PeerConnection.createOffer({offerToReceiveVideo:!0}).then(e=>this.createdOffer(e)).catch(e=>this.setSessionDescriptionError(e))}handleConnection(e){let t=e.candidate;t&&this.IceCandidates.push(new RTCIceCandidate(t))}ReceiveIceCandidate(e,t){var n=this;this.ReplyIceCandidate&&clearTimeout(this.ReplyIceCandidate),this.ReplyIceCandidate=setTimeout((0,u.A)(function*(){for(let i=0,r=n.IceCandidates.length;i<r;i++)t.client&&t.client.readyState==t.client.OPEN&&t.client.send(JSON.stringify({type:"socket_react",act:"WEBRTC_ICE_CANDIDATES",channel:t.channel,data_str:JSON.stringify(n.IceCandidates[i])})),yield new Promise(a=>setTimeout(a,n.global.WebsocketRetryTerm));n.IceCandidates.length=0}),800),this.PeerConnection.addIceCandidate(e).then(()=>{console.log("Success to add new ice candidate")}).catch(i=>{console.error("failed to add ice candidate: ",i)})}createdOffer(e){this.LocalOffer=e,this.PeerConnection.setLocalDescription(e).then(()=>{this.setLocalDescriptionSuccess(this.PeerConnection)}).catch(t=>this.setSessionDescriptionError(t))}createRemoteOfferFromAnswer(e){this.PeerConnection.setRemoteDescription(e).then(()=>{this.setRemoteDescriptionSuccess(this.PeerConnection)}).catch(t=>this.setSessionDescriptionError(t))}CreateAnswer(e){this.PeerConnection.createAnswer().then(t=>this.createdAnswer(t,e)).catch(t=>this.setSessionDescriptionError(t))}setLocalDescriptionSuccess(e){this.setDescriptionSuccess(e,"setLocalDescription")}setRemoteDescriptionSuccess(e){this.setDescriptionSuccess(e,"setRemoteDescription")}createdAnswer(e,t){var n=this;return(0,u.A)(function*(){n.p5callButton&&n.p5callButton.hide(),n.LocalAnswer=e,n.PeerConnection.setLocalDescription(e).then(()=>{n.setLocalDescriptionSuccess(n.PeerConnection)}).catch(a=>n.setSessionDescriptionError(a));let r=JSON.stringify(e).match(/(.{1,64})/g);for(let a=0,l=r.length;a<l;a++)t.client&&t.client.readyState==t.client.OPEN&&(t.client.send(JSON.stringify({type:"socket_react",act:"WEBRTC_RECEIVE_ANSWER",channel:t.channel,data_str:r[a]})),yield new Promise(s=>setTimeout(s,n.global.WebsocketRetryTerm)));t.client&&t.client.readyState==t.client.OPEN&&t.client.send(JSON.stringify({type:"socket_react",act:"WEBRTC_RECEIVE_ANSWER",channel:t.channel,data_str:"EOL"})),n.JoinInited=!0})()}ReceiveRemoteAnswer(e,t){var n=this;return(0,u.A)(function*(){n.PeerConnection.setRemoteDescription(e).then(()=>{n.setRemoteDescriptionSuccess(n.PeerConnection)}).catch(i=>n.setSessionDescriptionError(i));for(let i=0,r=n.IceCandidates.length;i<r;i++)t.client&&t.client.readyState==t.client.OPEN&&(t.client.send(JSON.stringify({type:"socket_react",channel:t.channel,act:"WEBRTC_ICE_CANDIDATES",data_str:JSON.stringify(n.IceCandidates[i])})),yield new Promise(a=>setTimeout(a,n.global.WebsocketRetryTerm)));n.IceCandidates.length=0})()}setSessionDescriptionError(e){console.error(`Failed to create session description: ${e}.`)}setDescriptionSuccess(e,t){console.log(`Local ${t} complete.`)}HangUpCall(){var e=this;return(0,u.A)(function*(){e.p5hangup&&e.p5hangup(),e.isCallable=!0,e.isConnected=!1,e.PeerConnection&&(e.PeerConnection.close(),e.PeerConnection.onicecandidate=null,e.PeerConnection.oniceconnectionstatechange=null,e.PeerConnection.onconnectionstatechange=null,e.PeerConnection.ontrack=null,e.PeerConnection.ondatachannel=null,e.PeerConnection.onnegotiationneeded=null),e.PeerConnection=null})()}close_webrtc(e=!1){var t=this;return(0,u.A)(function*(){if(!e||"data"==t.TypeIn){if(t.InitReplyCallback=null,yield t.HangUpCall(),t.localMedia&&t.localMedia.remove(),t.remoteMedia&&t.remoteMedia.remove(),t.OnUse=!1,t.isCallable=!1,t.isConnected=!1,t.localStream&&(t.localStream.getVideoTracks().forEach(n=>n.stop()),t.localStream.getAudioTracks().forEach(n=>n.stop())),t.HangUpCallBack){try{yield t.HangUpCallBack()}catch(n){console.log("\uc804\ud654 \ub04a\uae30 \ucd94\uac00\ub3d9\uc791 \uc624\ub958: ",n)}t.HangUpCallBack=null}t.localMedia=null,t.localStream=null,t.remoteMedia=null,t.LocalOffer=null,t.LocalAnswer=null,t.dataChannel&&(t.dataChannel.onopen=null,t.dataChannel.onclose=null,t.dataChannel.onmessage=null),t.dataChannel=null,t.ReceivedOfferPart="",t.ReceivedAnswerPart="",t.JoinInited=!1,t.IceCandidates.length=0}})()}}return(E=P).\u0275fac=function(e){return new(e||E)(m.KVO(D.G),m.KVO(x.n),m.KVO(N.y),m.KVO(M.X),m.KVO(I.z3))},E.\u0275prov=m.jDH({token:E,factory:E.\u0275fac,providedIn:"root"}),P})()}}]);