"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[6524],{6524:(F,_,o)=>{o.r(_),o.d(_,{InstantCallPageModule:()=>Y});var I=o(177),m=o(4341),c=o(5374),u=o(9858),v=o(467),f=o(5402),b=o(8326),S=o(92),t=o(3953),R=o(482),x=o(4234),P=o(4020),T=o(345),w=o(4237),W=o(9900),y=o(3656);const G=["InstantCallServer"];function k(s,l){1&s&&t.nrm(0,"div",8)}function j(s,l){if(1&s&&(t.j41(0,"ion-select-option",15),t.EFF(1),t.k0s()),2&s){const a=l.$implicit;t.Y8G("value",a),t.R7$(),t.JRh(a.info.name)}}function A(s,l){if(1&s){const a=t.RV6();t.j41(0,"ion-item")(1,"ion-select",12,0),t.bIt("ionChange",function(e){t.eBV(a);const i=t.XpG(2);return t.Njj(i.SelectAddressTarget(e))}),t.j41(3,"ion-select-option",13),t.EFF(4),t.k0s(),t.DNE(5,j,2,2,"ion-select-option",14),t.k0s()()}if(2&s){const a=t.XpG(2);t.R7$(),t.Y8G("label",a.lang.text.AddGroup.SelectServer),t.R7$(3),t.JRh(a.lang.text.voidDraw.InternalConn),t.R7$(),t.Y8G("ngForOf",a.ServerList)}}function N(s,l){if(1&s){const a=t.RV6();t.j41(0,"ion-item")(1,"ion-input",16),t.mxI("ngModelChange",function(e){t.eBV(a);const i=t.XpG(2);return t.DH7(i.UserInputCustomAddress,e)||(i.UserInputCustomAddress=e),t.Njj(e)}),t.k0s(),t.j41(2,"ion-icon",17),t.bIt("click",function(){t.eBV(a);const e=t.XpG(2);return t.Njj(e.global.open_custom_site(e.UserInputCustomAddress))}),t.k0s()()}if(2&s){const a=t.XpG(2);t.R7$(),t.Y8G("label",a.lang.text.voidDraw.InputAddress),t.R50("ngModel",a.UserInputCustomAddress)}}function E(s,l){if(1&s){const a=t.RV6();t.j41(0,"ion-item")(1,"ion-input",18),t.mxI("ngModelChange",function(e){t.eBV(a);const i=t.XpG(2);return t.DH7(i.Port,e)||(i.Port=e),t.Njj(e)}),t.k0s()()}if(2&s){const a=t.XpG(2);t.R7$(),t.Y8G("label",a.lang.text.GroupServer.Port),t.R50("ngModel",a.Port),t.Y8G("placeholder",a.lang.text.Settings.joinDedi_placeholder+" (3478)")}}function U(s,l){if(1&s){const a=t.RV6();t.j41(0,"ion-item")(1,"ion-input",18),t.mxI("ngModelChange",function(e){t.eBV(a);const i=t.XpG(2);return t.DH7(i.Username,e)||(i.Username=e),t.Njj(e)}),t.k0s()()}if(2&s){const a=t.XpG(2);t.R7$(),t.Y8G("label",a.lang.text.WebRTCDevManager.Username),t.R50("ngModel",a.Username),t.Y8G("placeholder",a.lang.text.Settings.joinDedi_placeholder+" (username)")}}function M(s,l){if(1&s){const a=t.RV6();t.j41(0,"ion-item")(1,"ion-input",18),t.mxI("ngModelChange",function(e){t.eBV(a);const i=t.XpG(2);return t.DH7(i.Password,e)||(i.Password=e),t.Njj(e)}),t.k0s()()}if(2&s){const a=t.XpG(2);t.R7$(),t.Y8G("label",a.lang.text.WebRTCDevManager.Credential),t.R50("ngModel",a.Password),t.Y8G("placeholder",a.lang.text.Settings.joinDedi_placeholder+" (password)")}}function $(s,l){if(1&s){const a=t.RV6();t.j41(0,"div",9),t.DNE(1,A,6,3,"ion-item",7)(2,N,3,2,"ion-item",7)(3,E,2,3,"ion-item",7)(4,U,2,3,"ion-item",7)(5,M,2,3,"ion-item",7),t.j41(6,"ion-item",10),t.bIt("click",function(){t.eBV(a);const e=t.XpG();return t.Njj(e.LinkToServer())}),t.j41(7,"ion-label",11),t.EFF(8),t.k0s()()()}if(2&s){const a=t.XpG();t.R7$(),t.Y8G("ngIf",a.ServerList.length),t.R7$(),t.Y8G("ngIf",a.NeedInputCustomAddress),t.R7$(),t.Y8G("ngIf",a.NeedInputCustomAddress),t.R7$(),t.Y8G("ngIf",a.NeedInputCustomAddress),t.R7$(),t.Y8G("ngIf",a.NeedInputCustomAddress),t.R7$(3),t.JRh(a.lang.text.voidDraw.ConnectToAddress)}}function X(s,l){if(1&s){const a=t.RV6();t.j41(0,"ion-item",10),t.bIt("click",function(){t.eBV(a);const e=t.XpG();return t.Njj(e.copy_qr_address())}),t.j41(1,"ion-label",11),t.EFF(2),t.k0s()()}if(2&s){const a=t.XpG();t.R7$(2),t.JRh(a.QRCodeAsString)}}function D(s,l){if(1&s&&(t.j41(0,"div")(1,"div",19),t.nrm(2,"ion-icon",20),t.j41(3,"div")(4,"ion-label",21),t.EFF(5),t.k0s()()()()),2&s){const a=t.XpG();t.R7$(5),t.JRh(a.webrtc.StatusText||a.lang.text.InstantCall.Waiting)}}const V=[{path:"",component:(()=>{var s;class l{constructor(n,e,i,C,h,g,d,r,p){this.global=n,this.lang=e,this.webrtc=i,this.title=C,this.nakama=h,this.router=g,this.route=d,this.p5toast=r,this.navCtrl=p,this.UserInputCustomAddress="",this.NeedInputCustomAddress=!1,this.isCustomServer=!1,this.PageOut=!1,this.CallClosed=!1}ngOnInit(){this.ServerList=this.nakama.get_all_online_server(),setTimeout(()=>{this.InstantCallServer?(this.InstantCallServer.value=this.ServerList[0]||"local",this.SelectAddressTarget({detail:{value:this.InstantCallServer.value}})):this.NeedInputCustomAddress=!0},0),this.route.queryParams.subscribe(n=>{const e=this.router.getCurrentNavigation().extras.state;e&&(this.UserInputCustomAddress=e.address,this.ChannelId=e.channel,this.Port=e.port,this.Username=e.username,this.Password=e.password,this.LinkToServer(!0))}),this.webrtc.StatusText||(this.webrtc.StatusText=this.lang.text.InstantCall.Waiting)}SelectAddressTarget(n){"local"===(this.title.setTitle(this.lang.text.InstantCall.Title),n.detail.value)?(this.UserInputCustomAddress="",this.NeedInputCustomAddress=!0):(this.UserInputCustomAddress=n.detail.value.info.address,this.NeedInputCustomAddress=!1)}LinkToServer(n=!1){var e=this;if(f.R.requestAudioRecordingPermission(),n&&!this.ChannelId)return this.p5toast.show({text:this.lang.text.InstantCall.MissingInfo}),void this.navCtrl.pop();let i=this.UserInputCustomAddress.split("://"),C=i.pop();this.isCustomServer=n||!this.InstantCallServer||"local"==this.InstantCallServer.value,this.isCustomServer&&this.nakama.SaveWebRTCServer({urls:[`stun:${C}:${this.Port||3478}`,`turn:${C}:${this.Port||3478}`],username:this.Username||"username",credential:this.Password||"password"});let g,h=i.pop();h||(h=this.global.checkProtocolFromAddress(C)?"wss":"ws"),this.global.InstantCallWSClient=new WebSocket(`${h}://${C}:12013`),this.global.InstantCallWSClient.onopen=(0,v.A)(function*(){e.global.WaitingConnect=!0,e.p5toast.show({text:e.lang.text.InstantCall.Waiting}),e.ChannelId?(e.global.InstantCallSend(JSON.stringify({type:"join",channel:e.ChannelId})),yield new Promise(d=>setTimeout(d,e.global.WebsocketRetryTerm)),e.webrtc.StatusText=e.lang.text.InstantCall.Connecting,e.global.PeerConnected=!0,e.webrtc.initialize("audio").then(()=>{e.webrtc.HangUpCallBack=()=>{e.global.InstantCallWSClient&&e.global.InstantCallWSClient.close()},e.ShowWaiting(),e.webrtc.CreateOffer(),e.webrtc.StatusText=e.lang.text.InstantCall.Connecting,e.global.PeerConnected=!0,e.global.InstantCallSend(JSON.stringify({type:"init_req"}))})):e.global.InstantCallSend(JSON.stringify({type:"init"}))}),this.global.InstantCallWSClient.onmessage=d=>{let r=JSON.parse(d.data);if(void 0===g)g=r.uid;else if(g==r.uid)return;switch(r.type){case"leave":this.global.InstantCallWSClient.close();break;case"init_id":this.global.InstantCallSend(JSON.stringify({type:"join",channel:r.id})),this.ChannelId=r.id,this.QRCodeAsString=`${S.d2}pjcone_pwa/?instc=${this.UserInputCustomAddress},${this.ChannelId},${this.Port||""},${this.Username||""},${this.Password||""}`;break;case"init_req":this.webrtc.StatusText=this.lang.text.InstantCall.Connecting,this.global.PeerConnected=!0,this.webrtc.initialize("audio").then((0,v.A)(function*(){e.webrtc.HangUpCallBack=()=>{e.global.InstantCallWSClient&&e.global.InstantCallWSClient.close()},e.ShowWaiting(),e.webrtc.CreateOffer(),yield new Promise(p=>setTimeout(p,e.global.WebsocketRetryTerm)),e.global.InstantCallSend(JSON.stringify({type:"socket_react",channel:e.ChannelId,act:"WEBRTC_INIT_REQ_SIGNAL"}))}));break;case"socket_react":switch(r.act){case"WEBRTC_REPLY_INIT_SIGNAL":this.nakama.socket_reactive[r.act](r.data_str),"EOL"==r.data_str&&this.webrtc.CreateAnswer({client:this.global.InstantCallWSClient,channel:this.ChannelId});break;case"WEBRTC_ICE_CANDIDATES":this.nakama.socket_reactive[r.act](r.data_str,{client:this.global.InstantCallWSClient,channel:this.ChannelId}),this.global.InstantCallSend(JSON.stringify({type:"init_end",channel:this.ChannelId})),this.global.InitEnd=!0,this.webrtc.StatusText=this.lang.text.InstantCall.Connected;break;case"WEBRTC_INIT_REQ_SIGNAL":this.nakama.socket_reactive[r.act]({client:this.global.InstantCallWSClient,channel:this.ChannelId});break;case"WEBRTC_RECEIVE_ANSWER":this.nakama.socket_reactive[r.act](r.data_str,{client:this.global.InstantCallWSClient,channel:this.ChannelId})}break;case"init_end":this.global.InitEnd=!0,this.webrtc.StatusText=this.lang.text.InstantCall.Connected}},this.global.InstantCallWSClient.onerror=d=>{console.error("\uc989\uc11d \ud1b5\ud654 \uc6f9\uc18c\ucf13 \uc624\ub958: ",d),this.global.InstantCallWSClient.close()},this.global.InstantCallWSClient.onclose=()=>{this.p5toast.show({text:this.lang.text.InstantCall.CallEnd}),this.global.WaitingConnect=!1,this.global.InitEnd=!1,this.global.PeerConnected=!1,this.global.InstantCallWSClient.onopen=null,this.global.InstantCallWSClient.onclose=null,this.global.InstantCallWSClient.onmessage=null,this.global.InstantCallWSClient.onerror=null,this.global.InstantCallWSClient=null,this.webrtc.close_webrtc(!1),this.CallClosed=!0,this.PageOut||this.navCtrl.pop()}}copy_qr_address(n=this.QRCodeAsString){this.global.WriteValueToClipboard("text/plain",n)}ShowWaiting(){this.QRCodeAsString="",!this.p5canvas&&(this.p5canvas=new b(n=>{let e=document.getElementById("InstantCallCanvasDiv"),i=1;n.setup=()=>{n.pixelDensity(1),n.createCanvas(e.clientWidth,e.clientHeight).parent(e),n.noStroke()};class C{constructor(){this.color={r:0,g:0,b:0},this.size=1,this.targetSize=100,this.opacity=200,this.pos=n.createVector(0,0),this.dir=n.createVector(n.random(-1.4,1.4),n.random(-2,-4)),this.color.r=n.random(0,255),this.color.g=n.random(0,255),this.color.b=n.random(0,255),this.targetSize=n.random(80,150)}display(){this.size<this.targetSize&&(this.size+=6),this.size>this.targetSize&&(this.size=this.targetSize),n.push(),n.fill(this.color.r,this.color.g,this.color.b,this.opacity),n.circle(this.pos.x,this.pos.y,this.size*i),n.pop(),this.pos.add(this.dir),this.dir.y+=.04,this.opacity-=1}}let h=[],g=!0;n.draw=()=>{g&&(h.push(new C),g=!1,setTimeout(()=>{g=!0},500)),n.clear(),n.push(),n.translate(n.width/2,n.height/2);for(let d=h.length-1;d>=0;d--)h[d].display(),h[d].opacity<=0&&h.splice(d,1);n.pop(),this.global.InitEnd&&(i-=.02),i<=0&&n.remove()},n.windowResized=()=>{n.resizeCanvas(e.clientWidth,e.clientHeight)}}))}ionViewWillEnter(){this.PageOut=!1,this.p5canvas&&this.p5canvas.windowResized(),this.global.StoreShortCutAct("instant-call"),this.global.p5KeyShortCut.Escape=()=>{this.navCtrl.pop()},this.CallClosed&&this.navCtrl.pop()}ionViewWillLeave(){this.PageOut=!0,delete this.global.p5KeyShortCut.Escape,this.global.RestoreShortCutAct("instant-call")}ngOnDestroy(){this.p5canvas&&this.p5canvas.remove(),this.isCustomServer&&this.nakama.RemoveWebRTCServer(this.UserInputCustomAddress.split("://").pop()),!this.global.InitEnd&&!this.global.PeerConnected&&this.global.InstantCallWSClient&&this.global.InstantCallWSClient.close(),this.route.queryParams.unsubscribe()}}return(s=l).\u0275fac=function(n){return new(n||s)(t.rXU(R.z3),t.rXU(x.y),t.rXU(P.j),t.rXU(T.hE),t.rXU(w.X),t.rXU(u.Ix),t.rXU(u.nX),t.rXU(W.G),t.rXU(y.q9))},s.\u0275cmp=t.VBU({type:s,selectors:[["app-instant-call"]],viewQuery:function(n,e){if(1&n&&t.GBs(G,5),2&n){let i;t.mGM(i=t.lsd())&&(e.InstantCallServer=i.first)}},decls:11,vars:5,consts:[["InstantCallServer",""],[1,"ion-no-border"],["slot","start"],["defaultHref","portal/arcade"],["id","InstantCallCanvasDiv","style","position: absolute; width: 100%; height: 100%; overflow: hidden; pointer-events: none;",4,"ngIf"],["style","flex: 0 1 auto;",4,"ngIf"],["button","",3,"click",4,"ngIf"],[4,"ngIf"],["id","InstantCallCanvasDiv",2,"position","absolute","width","100%","height","100%","overflow","hidden","pointer-events","none"],[2,"flex","0 1 auto"],["button","",3,"click"],[1,"ion-text-center"],["value","local",2,"pointer-events","none",3,"ionChange","label"],["value","local"],[3,"value",4,"ngFor","ngForOf"],[3,"value"],["placeholder","(wss://)0.0.0.0",1,"ion-text-right",3,"ngModelChange","label","ngModel"],["slot","end","name","open-outline",3,"click"],[1,"ion-text-right",3,"ngModelChange","label","ngModel","placeholder"],[1,"disconnect_info"],["color","medium","name","call-outline",2,"width","60px","height","60px"],["color","medium"]],template:function(n,e){1&n&&(t.j41(0,"ion-header",1)(1,"ion-toolbar")(2,"ion-title"),t.EFF(3),t.k0s(),t.j41(4,"ion-buttons",2),t.nrm(5,"ion-back-button",3),t.k0s()()(),t.j41(6,"ion-content"),t.DNE(7,k,1,0,"div",4)(8,$,9,6,"div",5)(9,X,3,1,"ion-item",6)(10,D,6,1,"div",7),t.k0s()),2&n&&(t.R7$(3),t.JRh(e.lang.text.InstantCall.Title),t.R7$(4),t.Y8G("ngIf",e.global.WaitingConnect),t.R7$(),t.Y8G("ngIf",!e.global.WaitingConnect),t.R7$(),t.Y8G("ngIf",e.QRCodeAsString&&e.global.WaitingConnect),t.R7$(),t.Y8G("ngIf",e.global.WaitingConnect||e.global.InitEnd))},dependencies:[I.Sq,I.bT,m.BC,m.vS,c.QW,c.W9,c.eU,c.iq,c.$w,c.uz,c.he,c.Nm,c.Ip,c.BC,c.ai,c.Je,c.Gw,c.el]}),l})()}];let B=(()=>{var s;class l{}return(s=l).\u0275fac=function(n){return new(n||s)},s.\u0275mod=t.$C({type:s}),s.\u0275inj=t.G2t({imports:[u.iI.forChild(V),u.iI]}),l})(),Y=(()=>{var s;class l{}return(s=l).\u0275fac=function(n){return new(n||s)},s.\u0275mod=t.$C({type:s}),s.\u0275inj=t.G2t({imports:[I.MD,m.YN,c.bv,B]}),l})()}}]);