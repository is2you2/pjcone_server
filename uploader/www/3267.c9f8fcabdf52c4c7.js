"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[3267],{3267:(X,v,c)=>{c.r(v),c.d(v,{GroupDetailPageModule:()=>M});var d=c(177),m=c(4341),u=c(5374),p=c(9858),h=c(467),k=c(92),e=c(3953),G=c(4237),b=c(8065),R=c(755),y=c(4234),O=c(482),$=c(9900),D=c(3656);function F(a,f){if(1&a){const o=e.RV6();e.j41(0,"img",21),e.bIt("click",function(){e.eBV(o);const t=e.XpG(2);return e.Njj(t.copy_startup_address())}),e.k0s()}if(2&a){const o=e.XpG(2);e.Y8G("src",o.QRCodeSRC,e.B4B)}}function j(a,f){if(1&a&&(e.j41(0,"div"),e.DNE(1,F,1,1,"img",20),e.k0s()),2&a){const o=e.XpG();e.R7$(),e.Y8G("ngIf",o.QRCodeSRC)}}function P(a,f){if(1&a&&(e.j41(0,"ion-item",22)(1,"ion-label",23),e.EFF(2),e.k0s()()),2&a){const o=e.XpG();e.R7$(2),e.JRh(o.lang.text.GroupDetail.NotAcceptYet)}}function C(a,f){if(1&a&&(e.j41(0,"ion-item",22)(1,"ion-label",23),e.EFF(2),e.k0s()()),2&a){const o=e.XpG();e.R7$(2),e.JRh(o.lang.text.GroupDetail.MissedGroup)}}function I(a,f){if(1&a&&(e.j41(0,"ion-item-divider")(1,"ion-label"),e.EFF(2),e.k0s()()),2&a){const o=e.XpG();e.R7$(2),e.SpI("",o.lang.text.GroupDetail.Members+" ("+o.info.users.length+"/"+o.info.max_count+")"," ")}}function x(a,f){if(1&a){const o=e.RV6();e.j41(0,"ion-item",24),e.bIt("click",function(){const t=e.eBV(o).$implicit,s=e.XpG();return e.Njj(s.open_user_profile(t))}),e.nrm(1,"div",8),e.j41(2,"div",9),e.nrm(3,"img",10),e.k0s(),e.j41(4,"ion-label",11),e.EFF(5),e.k0s()()}if(2&a){const o=f.$implicit,i=e.XpG();e.R7$(),e.Aen("background-color: "+i.statusBar.colors[o.user.online?"online":"offline"]),e.R7$(2),e.Aen("filter: "+(o.user.online?"grayscale(0) contrast(1);":"grayscale(.9) contrast(1.4);")),e.Y8G("src",o.user.img,e.B4B),e.R7$(2),e.JRh(i.info.info?i.info.info.name||i.nakama.usernameOverride[i.info.info.isOfficial][i.info.info.target][i.info.info.id]||i.info.info.display_name||i.lang.text.ChatRoom.noname_chatroom:i.info.title||i.lang.text.ChatRoom.noname_chatroom)}}function T(a,f){if(1&a){const o=e.RV6();e.j41(0,"ion-item",24),e.bIt("click",function(){e.eBV(o);const t=e.XpG();return e.Njj(t.remove_group())}),e.j41(1,"ion-label",25),e.EFF(2),e.k0s()()}if(2&a){const o=e.XpG();e.R7$(2),e.JRh(o.lang.text.GroupDetail.BreakupGroup)}}function S(a,f){if(1&a){const o=e.RV6();e.j41(0,"ion-item",24),e.bIt("click",function(){e.eBV(o);const t=e.XpG();return e.Njj(t.leave_group())}),e.j41(1,"ion-label",25),e.EFF(2),e.k0s()()}if(2&a){const o=e.XpG();e.R7$(2),e.JRh(o.lang.text.GroupDetail.LeaveGroup)}}const U=[{path:"",component:(()=>{var a;class f{constructor(i,t,s,n,r,l,g,_,E){this.nakama=i,this.statusBar=t,this.indexed=s,this.lang=n,this.global=r,this.p5toast=l,this.route=g,this.router=_,this.navCtrl=E,this.has_admin=!1,this.file_sel_id="",this.need_edit=!1,this.lock_modal_open=!1}ngOnDestroy(){this.route.queryParams.unsubscribe()}ngOnInit(){this.route.queryParams.subscribe(i=>{try{const t=this.router.getCurrentNavigation().extras.state;this.info=t.info,this.file_sel_id=`group_detail_${this.info.id}_${(new Date).getTime()}}`,this.info_orig=JSON.parse(JSON.stringify(t.info)),this.nakama.socket_reactive.group_detail=this,this.QRCodeSRC=this.global.readasQRCodeFromString(`${k.d2}pjcone_pwa/?group=${this.info.name},${this.info.id}`.replace(" ","%20")),this.info.server||(this.info.server=t.server),this.isOfficial=this.info.server.isOfficial,this.target=this.info.server.target;try{this.has_admin=this.info.creator_id==this.nakama.servers[this.isOfficial][this.target].session.user_id}catch(s){console.log("check is admin failed: ",s),this.has_admin=!1}if(this.info.users&&this.info.users.length)for(let s=0,n=this.info.users.length;s<n;s++)this.info.users[s].is_me?(this.info.users[s].user=this.nakama.users.self,this.indexed.loadTextFromUserPath("servers/self/profile.img",(r,l)=>{r&&l&&(this.nakama.users.self.img=l.replace(/"|\\|=/g,""))})):this.info.users[s].user.id?this.info.users[s].user=this.nakama.load_other_user(this.info.users[s].user.id,this.isOfficial,this.target):this.info.users.splice(s,1);try{this.nakama.servers[this.isOfficial][this.target].client.readStorageObjects(this.nakama.servers[this.isOfficial][this.target].session,{object_ids:[{collection:"group_public",key:`group_${this.info.id}`,user_id:this.info.creator_id}]}).then(s=>{s.objects.length?(this.nakama.groups[this.isOfficial][this.target][this.info.id].img=s.objects[0].value.img.replace(/"|=|\\/g,""),this.indexed.saveTextFileToUserPath(s.objects[0].value.img,`servers/${this.isOfficial}/${this.target}/groups/${this.info.id}.img`)):"missing"!=this.info.status&&(delete this.nakama.groups[this.isOfficial][this.target][this.info.id].img,this.indexed.removeFileFromUserPath(`servers/${this.isOfficial}/${this.target}/groups/${this.info.id}.img`))})}catch(s){console.log(s)}}catch(t){console.log("\uadf8\ub8f9 \uc0c1\uc138 \ud398\uc774\uc9c0 \uc9c4\uc785 \uc624\ub958: ",t)}})}ionViewDidEnter(){this.global.p5KeyShortCut.Escape=()=>{this.navCtrl.pop()}}update_from_notification(i){switch(i.code){case-4:case-5:this.update_GroupUsersList(i.server.isOfficial,i.server.target);break;default:console.warn("\uc608\uc0c1\ud558\uc9c0 \ubabb\ud55c \uadf8\ub8f9 \ud589\ub3d9: ",i)}}update_GroupUsersList(i,t){this.nakama.servers[i][t].client.listGroupUsers(this.nakama.servers[i][t].session,this.info.id).then(s=>{let n=[];for(let r=0,l=s.group_users.length;r<l;r++)if(s.group_users[r].user.id==this.nakama.servers[i][t].session.user_id)n.push({state:s.group_users[r].state,user:this.nakama.users.self});else{let g=this.nakama.load_other_user(s.group_users[r].user.id,i,t);this.nakama.save_other_user(s.group_users[r].user,i,t),n.push({state:s.group_users[r].state,user:g})}this.info.users=n})}buttonClickInputFile(){var i=this;return(0,h.A)(function*(){i.has_admin&&(i.info.img?(i.info.img=void 0,i.nakama.servers[i.isOfficial][i.target].client.deleteStorageObjects(i.nakama.servers[i.isOfficial][i.target].session,{object_ids:[{collection:"group_public",key:`group_${i.info.id}`}]}).then(t=>{i.indexed.removeFileFromUserPath(`servers/${i.isOfficial}/${i.target}/groups/${i.info.id}.img`)})):document.getElementById(i.file_sel_id).click())})()}changeImageContextmenu(){var i=this;return function(){var s=(0,h.A)(function*(){if(i.has_admin)if(i.info.img)i.info.img=void 0,i.nakama.servers[i.isOfficial][i.target].client.deleteStorageObjects(i.nakama.servers[i.isOfficial][i.target].session,{object_ids:[{collection:"group_public",key:`group_${i.info.id}`}]}).then(n=>{i.indexed.removeFileFromUserPath(`servers/${i.isOfficial}/${i.target}/groups/${i.info.id}.img`)});else try{let n=yield i.global.GetValueFromClipboard();switch(n.type){case"text/plain":yield i.check_if_clipboard_available(n.value);break;case"image/png":return void i.inputImageSelected({target:{files:[n.value]}})}}catch{document.getElementById(i.file_sel_id).click()}});return function(){return s.apply(this,arguments)}}()(),!1}inputImageSelected(i){var t=this;return(0,h.A)(function*(){let s=yield t.global.GetBase64ThroughFileReader(i.target.files[0]);t.nakama.limit_image_size(s,r=>{t.info.img=r.canvas.toDataURL(),t.announce_update_group_image(t.info.img)}),document.getElementById(t.file_sel_id).value=""})()}announce_update_group_image(i){this.nakama.servers[this.isOfficial][this.target].client.writeStorageObjects(this.nakama.servers[this.isOfficial][this.target].session,[{collection:"group_public",key:`group_${this.info.id}`,value:{img:i},permission_read:2,permission_write:1}]).then(t=>{this.indexed.saveTextFileToUserPath(JSON.stringify(i),`servers/${this.isOfficial}/${this.target}/groups/${this.info.id}.img`)})}check_if_clipboard_available(i){var t=this;return(0,h.A)(function*(){try{if(0!=i.indexOf("http"))throw"URL \uc8fc\uc18c\uac00 \uc544\ub2d8";yield new Promise((s,n)=>{let r=document.createElement("img");r.src=i,r.onload=()=>{t.info.img=i,t.announce_update_group_image(i),r.onload=null,r.onerror=null,r.remove(),s(void 0)},r.onerror=()=>{r.onload=null,r.onerror=null,r.remove(),n()}})}catch{try{if(0!=i.indexOf("data:image"))throw"DataURL \uc8fc\uc18c\uac00 \uc544\ub2d8";t.nakama.limit_image_size(i,n=>{t.info.img=n.canvas.toDataURL(),t.announce_update_group_image(t.info.img)})}catch{throw"\uc0ac\uc6a9\ubd88\uac00 \uc774\ubbf8\uc9c0"}}})()}remove_group(){var i=this;this.need_edit=!1;try{if(this.nakama.servers[this.isOfficial][this.target]){if(this.info.creator_id!=this.nakama.servers[this.isOfficial][this.target].session.user_id)throw this.lang.text.GroupDetail.YouAreNotCreator;"online"==this.info.status?this.nakama.servers[this.isOfficial][this.target].socket.writeChatMessage(this.info.channel_id,{gupdate:"remove"}).then(function(){var t=(0,h.A)(function*(s){let n=yield i.nakama.servers[i.isOfficial][i.target].client.getAccount(i.nakama.servers[i.isOfficial][i.target].session),r=JSON.parse(n.user.metadata);for(let l=0,g=r.is_manager.length;l<g;l++)if(r.is_manager[l]==i.info.id){r.is_manager.splice(l,1);break}r.is_manager.length||delete r.is_manager;try{yield i.nakama.servers[i.isOfficial][i.target].client.rpc(i.nakama.servers[i.isOfficial][i.target].session,"update_user_metadata_fn",{user_id:i.nakama.servers[i.isOfficial][i.target].session.user_id,metadata:r})}catch(l){console.log("\uadf8\ub8f9 \uc0ad\uc81c\uc2dc \uc0dd\uc131\uc790\uc758 \ub9e4\ub2c8\uc800 \uad8c\ud55c \ubc15\ud0c8 \ub3d9\uae30\ud654 \uc624\ub958: ",l)}i.nakama.remove_group_list(i.info,i.isOfficial,i.target),i.after_remove_group()});return function(s){return t.apply(this,arguments)}}()):this.after_remove_group()}else this.navCtrl.pop()}catch(t){console.log("remove_group: ",t),this.p5toast.show({text:t})}}after_remove_group(){var i=this;return(0,h.A)(function*(){i.RemoveGroupFilesFromServer(`${i.info.id}`),i.leave_channel(),i.navCtrl.pop()})()}edit_group(){"online"==this.statusBar.groupServer[this.isOfficial][this.target]&&"missing"!=this.info.status&&this.has_admin&&this.nakama.servers[this.isOfficial][this.target].client.updateGroup(this.nakama.servers[this.isOfficial][this.target].session,this.info.id,{name:this.info.name,lang_tag:this.info.lang_tag,description:this.info.description,open:this.info.open}),this.nakama.groups[this.isOfficial][this.target][this.info.id]=this.info,this.nakama.save_groups_with_less_info()}open_user_profile(i){this.lock_modal_open||(this.lock_modal_open=!0,i.is_me?(this.nakama.open_profile_page({isOfficial:this.isOfficial,target:this.target}),this.lock_modal_open=!1):(this.nakama.open_others_profile({info:i,group:this.info,has_admin:this.has_admin}),this.lock_modal_open=!1))}leave_group(){this.need_edit=!1,"online"==this.info.status?this.after_leave_group(()=>{this.leave_channel(),this.nakama.groups[this.isOfficial][this.target][this.info.id].status="missing",this.nakama.save_groups_with_less_info(()=>this.navCtrl.pop())}):"pending"==this.info.status&&this.after_leave_group(()=>{this.nakama.groups[this.isOfficial][this.target][this.info.id].status="missing",this.nakama.save_groups_with_less_info(()=>this.navCtrl.pop())})}after_leave_group(i=(()=>{})){var t=this;return(0,h.A)(function*(){try{yield t.nakama.servers[t.isOfficial][t.target].client.leaveGroup(t.nakama.servers[t.isOfficial][t.target].session,t.info.id)}catch{}i(),t.RemoveGroupFilesFromServer(`${t.info.id}_${t.nakama.servers[t.isOfficial][t.target].session.user_id}`)})()}RemoveGroupFilesFromServer(i){this.nakama.remove_channel_files(this.isOfficial,this.target,this.info.channel_id);let t=this.nakama.servers[this.isOfficial][this.target].info;try{let s=localStorage.getItem("fallback_fs");if(!s)throw"\uc0ac\uc6a9\uc790 \uc9c0\uc815 \uc11c\ubc84 \uc5c6\uc74c";let n=s.split("://"),r=n.pop().split(":"),l=n.pop();l?l+=":":l=this.global.checkProtocolFromAddress(r[0])?"https:":"http:",this.global.remove_files_from_storage_with_key(`${l}//${r[0]}:${r[1]||9002}/`,i)}catch{}try{this.global.remove_files_from_storage_with_key(`${t.useSSL?"https":"http"}://${t.address}`,i)}catch{}}leave_channel(){try{"missing"!=this.nakama.channels_orig[this.isOfficial][this.target][this.info.channel_id].status&&(this.nakama.channels_orig[this.isOfficial][this.target][this.info.channel_id].status="missing")}catch{}}copy_id(){this.global.WriteValueToClipboard("text/plain",this.info.id)}copy_startup_address(){let i=encodeURI(`https://is2you2.github.io/pjcone_pwa/?group=${this.info.name},${this.info.id}`);this.global.WriteValueToClipboard("text/plain",i)}ionViewWillLeave(){delete this.nakama.socket_reactive.group_detail,this.need_edit=this.info.description!=this.info_orig.description,this.need_edit&&this.edit_group(),delete this.global.p5KeyShortCut.Escape}}return(a=f).\u0275fac=function(i){return new(i||a)(e.rXU(G.X),e.rXU(b.j),e.rXU(R.n),e.rXU(y.y),e.rXU(O.z3),e.rXU($.G),e.rXU(p.nX),e.rXU(p.Ix),e.rXU(D.q9))},a.\u0275cmp=e.VBU({type:a,selectors:[["app-group-detail"]],decls:39,vars:24,consts:[[1,"ion-no-border"],["slot","start"],["defaultHref",""],[4,"ngIf"],["color","warning",4,"ngIf"],[2,"cursor","copy",3,"click"],["text-wrap","","color","medium",1,"ion-text-center"],["button","",3,"click","contextmenu"],[1,"additional_form","status_bar_single"],[1,"additional_form","bg_img_form"],[1,"profile_img",3,"src"],[1,"form_margin"],[1,"server_target"],[1,"form_margin","content"],["hidden","","type","file","accept","image/*",3,"change","id"],[1,"infobox",3,"ngModelChange","disabled","ngModel","placeholder"],[2,"pointer-events","none"],[2,"pointer-events","none",3,"ngModelChange","ngModel"],["button","",3,"click",4,"ngFor","ngForOf"],["button","",3,"click",4,"ngIf"],["style","width: 100%; height: auto; cursor: copy;","alt","Loading",3,"src","click",4,"ngIf"],["alt","Loading",2,"width","100%","height","auto","cursor","copy",3,"click","src"],["color","warning"],[1,"ion-text-center"],["button","",3,"click"],["color","danger",1,"ion-text-center"]],template:function(i,t){1&i&&(e.j41(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-title"),e.EFF(3),e.k0s(),e.j41(4,"ion-buttons",1),e.nrm(5,"ion-back-button",2),e.k0s()()(),e.j41(6,"ion-content"),e.DNE(7,j,2,1,"div",3)(8,P,3,1,"ion-item",4)(9,C,3,1,"ion-item",4),e.j41(10,"ion-item",5),e.bIt("click",function(){return t.copy_id()}),e.j41(11,"ion-label",6),e.EFF(12),e.k0s()(),e.j41(13,"ion-item",7),e.bIt("click",function(){return t.buttonClickInputFile()})("contextmenu",function(){return t.changeImageContextmenu()}),e.nrm(14,"div",8),e.j41(15,"div",9),e.nrm(16,"img",10),e.k0s(),e.j41(17,"ion-label",11)(18,"div")(19,"table")(20,"tr")(21,"td"),e.EFF(22),e.k0s(),e.j41(23,"td",12),e.EFF(24),e.k0s()()()(),e.j41(25,"div",13),e.EFF(26),e.k0s()()(),e.j41(27,"input",14),e.bIt("change",function(n){return t.inputImageSelected(n)}),e.k0s(),e.j41(28,"ion-item-divider")(29,"ion-label"),e.EFF(30),e.k0s()(),e.j41(31,"textarea",15),e.mxI("ngModelChange",function(n){return e.DH7(t.info.description,n)||(t.info.description=n),n}),e.k0s(),e.j41(32,"ion-item",16)(33,"ion-toggle",17),e.mxI("ngModelChange",function(n){return e.DH7(t.info.open,n)||(t.info.open=n),n}),e.EFF(34),e.k0s()(),e.DNE(35,I,3,1,"ion-item-divider",3)(36,x,6,6,"ion-item",18)(37,T,3,1,"ion-item",19)(38,S,3,1,"ion-item",19),e.k0s()),2&i&&(e.R7$(3),e.JRh(t.lang.text.GroupDetail.Title),e.R7$(4),e.Y8G("ngIf","missing"!=t.info.status),e.R7$(),e.Y8G("ngIf","pending"==t.info.status),e.R7$(),e.Y8G("ngIf","missing"==t.info.status),e.R7$(3),e.JRh(t.info.id),e.R7$(2),e.Aen("background-color: "+t.statusBar.colors[t.info.status||"offline"]),e.R7$(2),e.Aen("filter: "+("online"==t.info.status?"grayscale(0) contrast(1);":"grayscale(.9) contrast(1.4);")),e.Y8G("src",t.info.img,e.B4B),e.R7$(6),e.SpI(" ",t.info.name||t.info.title||t.info.display_name," "),e.R7$(2),e.SpI(" ","("+(t.info.server.name||t.info.server.target)+")"," "),e.R7$(2),e.SpI(" ",t.lang.text.AddGroup.ClicktoChangeGroupImg," "),e.R7$(),e.Y8G("id",t.file_sel_id),e.R7$(3),e.JRh(t.lang.text.AddGroup.GroupDetail_placeholder),e.R7$(),e.Y8G("disabled",!t.has_admin),e.R50("ngModel",t.info.description),e.Y8G("placeholder",t.lang.text.GroupDetail.NoDetailGroup),e.R7$(2),e.R50("ngModel",t.info.open),e.R7$(),e.JRh(t.lang.text.GroupDetail.IsOpen),e.R7$(),e.Y8G("ngIf",t.info.users&&t.info.users.length),e.R7$(),e.Y8G("ngForOf",t.info.users),e.R7$(),e.Y8G("ngIf",("online"==t.info.status||"pending"==t.info.status)&&t.has_admin),e.R7$(),e.Y8G("ngIf",("online"==t.info.status||"pending"==t.info.status)&&!t.has_admin))},dependencies:[d.Sq,d.bT,m.me,m.BC,m.vS,u.QW,u.W9,u.eU,u.uz,u.Dg,u.he,u.BC,u.BY,u.ai,u.hB,u.el],styles:[".content[_ngcontent-%COMP%]{color:#888;height:24px;display:table-cell;vertical-align:middle}"]}),f})()}];let B=(()=>{var a;class f{}return(a=f).\u0275fac=function(i){return new(i||a)},a.\u0275mod=e.$C({type:a}),a.\u0275inj=e.G2t({imports:[p.iI.forChild(U),p.iI]}),f})(),M=(()=>{var a;class f{}return(a=f).\u0275fac=function(i){return new(i||a)},a.\u0275mod=e.$C({type:a}),a.\u0275inj=e.G2t({imports:[d.MD,m.YN,u.bv,B]}),f})()}}]);