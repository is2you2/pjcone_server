"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[2655],{2655:(st,Re,y)=>{y.r(Re),y.d(Re,{VoidDrawPageModule:()=>Fe});var le=y(177),Ie=y(4341),R=y(5374),ae=y(9858),V=y(467),xe=y(8326),We=y(92),i=y(3953),Pe=y(4234),Le=y(3656),Ve=y(482),Me=y(755),He=y(4237),Ne=y(9900),Ee=y(4020);const $e=["RemoteDraw"],Oe=["AddrQRShare"];function Be(g,T){1&g&&(i.j41(0,"div",15),i.EFF(1,"Shift + S"),i.k0s())}function Xe(g,T){if(1&g&&(i.j41(0,"ion-select-option",16),i.EFF(1),i.k0s()),2&g){const v=T.$implicit;i.Y8G("value",v),i.R7$(),i.JRh(v.info.name)}}function Ye(g,T){if(1&g){const v=i.RV6();i.j41(0,"img",22),i.bIt("click",function(){i.eBV(v);const t=i.XpG(2);return i.Njj(t.copy_address(t.SelectedAddress))}),i.k0s()}if(2&g){const v=i.XpG(2);i.Y8G("src",v.QRCodeSRC,i.B4B)}}function je(g,T){if(1&g){const v=i.RV6();i.j41(0,"div",17)(1,"div",18),i.DNE(2,Ye,1,1,"img",19),i.j41(3,"ion-item",20),i.bIt("click",function(){i.eBV(v);const t=i.XpG();return i.Njj(t.copy_address(t.SelectedAddress))}),i.j41(4,"ion-label",21),i.EFF(5),i.k0s()()()()}if(2&g){const v=i.XpG();i.R7$(2),i.Y8G("ngIf",v.QRCodeSRC),i.R7$(3),i.JRh(v.SelectedAddress)}}const Ge=[{path:"",component:(()=>{var g;class T{constructor(r,t,l,e,s,m,c,p,k,M,S){this.lang=r,this.alertCtrl=t,this.loadingCtrl=l,this.global=e,this.indexed=s,this.nakama=m,this.p5toast=c,this.webrtc=p,this.router=k,this.route=M,this.navCtrl=S,this.voidDrawId="voidDraw",this.isMobile=!1,this.p5DrawingStack=[],this.isCropMode=!1,this.HasConnectedPeer=!1,this.ServerList=[],this.isDrawServerCreated=!1,this.ReadyToShareAct=!1,this.AlreadyExistServer=!1,this.WillLeaveHere=!1,this.WithoutSave=!0,this.QRNavParams={}}ngOnDestroy(){this.route.queryParams.unsubscribe(),this.global.PageDismissAct[this.navParams.dismiss]&&this.global.PageDismissAct[this.navParams.dismiss]({}),this.p5ActualCanvas&&(this.p5ActualCanvas.remove(),this.p5ActualCanvas=null),!this.AlreadyExistServer&&this.TargetRemoteAddress&&this.nakama.RemoveWebRTCServer(this.TargetRemoteAddress.split("://").pop()),this.p5ImageCanvas&&(this.p5ImageCanvas.remove(),this.p5ImageCanvas=null),this.p5voidDraw&&this.p5voidDraw.remove(),this.IceWebRTCWsClient&&this.IceWebRTCWsClient.close(),this.CancelRemoteAct()}ngOnInit(){var r=this;this.route.queryParams.subscribe(function(){var t=(0,V.A)(function*(l){try{const e=r.router.getCurrentNavigation().extras.state;if(!e)throw"\ud398\uc774\uc9c0 \ubcf5\uadc0";r.navParams=e||{},r.voidDrawId=`voidDraw_${Date.now()}`,r.QueueAfterLoad=()=>{r.create_new_canvas({width:e.width,height:e.height,path:e.path,type:e.type}),e.remote&&setTimeout(()=>{r.Port=e.remote.port,r.username=e.remote.username,r.password=e.remote.password,r.CreateRemoteLocalClient(e.remote.address,e.remote.channel)},1e3)}}catch(e){console.log("\uadf8\ub9bc\ud310 \uc815\ubcf4 \ubc1b\uc9c0 \ubabb\ud568: ",e),r.p5SetDrawable(!0)}});return function(l){return t.apply(this,arguments)}}())}ionViewWillEnter(){this.QueueAfterLoad&&this.QueueAfterLoad(),this.QueueAfterLoad=null}ionViewDidEnter(){var r=this;return(0,V.A)(function*(){r.global.StoreShortCutAct("void-draw"),r.AddShortCut(),r.mainLoading=yield r.loadingCtrl.create({message:r.lang.text.voidDraw.UseThisImage}),r.isMobile="DesktopPWA"!=We.aH})()}AddShortCut(){delete this.global.p5KeyShortCut.Digit,this.global.p5KeyShortCut.HistoryAct=r=>{switch(r){case"Z":this.p5history_act(-1);break;case"X":this.p5history_act(1);break;case"C":this.isCropMode?this.p5apply_crop():this.p5change_color();break;case"V":this.p5set_line_weight()}},this.global.p5KeyShortCut.AddAct=()=>{this.ClickRemoteAddButton()},this.global.p5KeyShortCut.SKeyAct=r=>{r.shiftKey?this.p5save_image(!0):this.open_crop_tool()},this.global.p5KeyShortCut.DeleteAct=()=>{this.isCropMode?this.p5apply_crop():this.dismiss_draw()},this.global.p5KeyShortCut.FKeyAct=()=>{},this.global.p5KeyShortCut.Escape=()=>{this.isDrawServerCreated?this.CancelRemoteAct():this.navCtrl.pop()}}CancelRemoteAct(){this.ReadyToShareAct=!1,this.RemoteLoadingCtrl&&this.RemoteLoadingCtrl.dismiss(),this.isDrawServerCreated=!1,this.p5SetDrawable(!0),this.webrtc.close_webrtc(!1)}create_new_canvas(r){r.width=r.width||432,r.height=r.height||432,this.p5ActualCanvas&&(this.p5ActualCanvas.remove(),this.p5ActualCanvas=null),this.p5ImageCanvas&&(this.p5ImageCanvas.remove(),this.p5ImageCanvas=null),this.p5voidDraw&&this.p5voidDraw.remove(),this.create_p5voidDraw(r)}create_p5voidDraw(r){var t=this;let l=document.getElementById(this.voidDrawId);this.isCropMode=!1,this.p5voidDraw=new xe(e=>{let s,m,c,p,k,M,S,w,B,he,P=e.createColorPicker("#000"),ce=Math.min(r.width,r.height)/100,de=1;e.setup=(0,V.A)(function*(){P.style("position","absolute"),e.pixelDensity(1),e.noLoop(),e.noFill(),e.imageMode(e.CENTER),e.createCanvas(l.clientWidth,l.clientHeight).parent(l),I.x=e.width/2,I.y=e.height/2,t.p5set_line_weight=()=>{t.alertCtrl.create({header:t.lang.text.voidDraw.changeWeight,inputs:[{label:t.lang.text.voidDraw.weight,name:"weight",placeholder:`${de}`,type:"number"}],buttons:[{text:t.lang.text.voidDraw.apply,handler:C=>{C.weight&&(de=Number(C.weight))}}]}).then(C=>{$=!1,C.onWillDismiss().then(()=>{$=!0}),C.present()})},t.p5change_color=()=>{P.elt.click()},t.p5save_image=(C=!1,H=!1)=>{new xe(u=>{u.setup=()=>{let ne=u.createCanvas(s.width,s.height);u.pixelDensity(1),c&&u.image(c,0,0),p&&u.image(p,0,0),s&&u.image(s,0,0);let ye=ne.elt.toDataURL("image/png").replace("image/png","image/octet-stream"),Se=`voidDraw_${u.year()}-${u.nf(u.month(),2)}-${u.nf(u.day(),2)}_${u.nf(u.hour(),2)}-${u.nf(u.minute(),2)}-${u.nf(u.second(),2)}.png`;if(H){let z=t.global.Base64ToBlob(ye,"image/png");t.global.WriteValueToClipboard("image/png",z,"image.png")}else{if(C){t.p5toast.show({text:`${t.lang.text.ContentViewer.DownloadThisFile}: ${Se}`});let z=u.createA(ye,null);z.elt.download=Se,z.hide(),z.parent(l),z.elt.click()}else t.navParams.dismiss&&t.global.PageDismissAct[t.navParams.dismiss]({data:{name:Se,img:ye,loadingCtrl:t.mainLoading}}),t.navCtrl.pop();u.remove()}}})},t.p5history_act=(C,H=!1)=>{switch(L=e.min(e.max(0,L+C),t.p5DrawingStack.length),C){case 1:t.p5DrawingStack.length&&(w.style.fill="var(--ion-color-dark)"),L==t.p5DrawingStack.length&&(B.style.fill="var(--ion-color-medium)"),F(s,t.p5DrawingStack[L-1]);break;case-1:t.p5DrawingStack.length&&(B.style.fill="var(--ion-color-dark)"),L<1?(w.style.fill="var(--ion-color-medium)",s.clear(255,255,255,255),e.redraw()):oe()}!H&&t.ReadyToShareAct&&t.webrtc.dataChannel.send(JSON.stringify({type:"same",act:"history_act",data:C}))},t.p5open_crop_tool=()=>{t.isCropMode?(t.isCropMode=!1,e.redraw()):(t.isCropMode=!0,d.x=s.width,d.y=s.height,O.x=0,O.y=0,e.redraw()),he()},t.p5apply_crop=(C=!0)=>{C&&t.isMobile&&O.div(b),s.resizeCanvas(d.x,d.y),m=e.createVector(s.width/2,s.height/2),C&&x.sub(O),oe(),c.resizeCanvas(d.x,d.y),c.push(),c.background(t.navParams.isDarkMode?26:255),c.translate(x),t.p5BaseImage&&c.image(t.p5BaseImage,0,0),c.pop(),c.redraw(),p.resizeCanvas(d.x,d.y),p.push(),k&&(p.translate(x),p.image(k,re.x,re.y)),p.pop(),p.redraw();let H=p.elt.toDataURL("image/png");if(e.loadImage(H,u=>{re.x=-x.x,re.y=-x.y,k=u,p.image(k,0,0),p.redraw()}),t.isCropMode=!1,he(),t.p5SetCanvasViewportInit(),C&&t.ReadyToShareAct){let u=t.p5getCropPos(),ne=t.p5getCropSize();t.webrtc.dataChannel.send(JSON.stringify({type:"draw",act:"crop",cropPX:u.x,cropPY:u.y,cropSX:ne.x,cropSY:ne.y}))}},t.p5SetDrawable=rt,M=e.createElement("table"),M.style("position: absolute; top: 0px;"),M.style(`width: 100%; height: ${W}px;`),M.style("background-color: var(--voidDraw-menu-background);"),M.parent(l);let o=M.elt.insertRow(0),n=o.insertCell(0);n.innerHTML=t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">A</div><ion-icon style="width: 27px; height: 27px" name="wifi-outline"></ion-icon></div>':'<ion-icon style="width: 27px; height: 27px" name="wifi-outline"></ion-icon>',n.style.textAlign="center",n.style.cursor="pointer",n.onclick=()=>{t.ClickRemoteAddButton()};let A=o.insertCell(1);A.innerHTML=t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">S</div><ion-icon style="width: 27px; height: 27px" name="crop"></ion-icon></div>':'<ion-icon style="width: 27px; height: 27px" name="crop"></ion-icon>',A.style.textAlign="center",A.style.cursor="pointer",A.onclick=()=>{t.open_crop_tool()};let D=o.insertCell(2);D.innerHTML=t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">D</div><ion-icon style="width: 27px; height: 27px" name="checkmark"></ion-icon></div>':'<ion-icon style="width: 27px; height: 27px" name="checkmark"></ion-icon>',D.style.textAlign="center",D.style.cursor="pointer",D.onclick=()=>{t.dismiss_draw()},he=()=>{D.innerHTML=t.isCropMode?t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">D</div><ion-icon style="width: 27px; height: 27px" name="cut-sharp"></ion-icon></div>':'<ion-icon style="width: 27px; height: 27px" name="cut-sharp"></ion-icon>':t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">D</div><ion-icon style="width: 27px; height: 27px" name="checkmark"></ion-icon></div>':'<ion-icon style="width: 27px; height: 27px" name="checkmark"></ion-icon>'},S=e.createElement("table"),S.style("position: absolute; bottom: 0px;"),S.style(`width: 100%; height: ${W}px;`),S.style("background-color: var(--voidDraw-menu-background);"),S.parent(l);let X=S.elt.insertRow(0),ee=X.insertCell(0);ee.innerHTML=t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">Z</div><ion-icon id="undoIcon" style="width: 27px; height: 27px" name="arrow-undo"></ion-icon></div>':'<ion-icon id="undoIcon" style="width: 27px; height: 27px" name="arrow-undo"></ion-icon>',w=document.getElementById("undoIcon"),w.style.fill="var(--ion-color-medium)",ee.style.textAlign="center",ee.style.cursor="pointer",ee.onclick=()=>{t.p5history_act(-1)};let te=X.insertCell(1);te.innerHTML=t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">X</div><ion-icon id="redoIcon" style="width: 27px; height: 27px" name="arrow-redo"></ion-icon></div>':'<ion-icon id="redoIcon" style="width: 27px; height: 27px" name="arrow-redo"></ion-icon>',B=document.getElementById("redoIcon"),B.style.fill="var(--ion-color-medium)",te.style.textAlign="center",te.style.cursor="pointer",te.onclick=()=>{t.p5history_act(1)};let j=X.insertCell(2);j.innerHTML=t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">C</div><ion-icon style="width: 27px; height: 27px" name="color-palette"></ion-icon></div>':'<ion-icon style="width: 27px; height: 27px" name="color-palette"></ion-icon>',P.style("width: 0px; height: 0px; opacity: 0;"),P.parent(j),P.elt.oninput=()=>{let C=P.color().levels,H=`#${e.hex(C[0],2)}${e.hex(C[1],2)}${e.hex(C[2],2)}`;j.childNodes[0].style.color=H},r.path&&(P.value("#ff0000"),P.elt.oninput()),j.style.textAlign="center",j.style.cursor="pointer",j.onclick=()=>{P.elt.click()};let ie=X.insertCell(3);if(ie.innerHTML=t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">V</div><ion-icon style="width: 27px; height: 27px" name="pencil"></ion-icon></div>':'<ion-icon style="width: 27px; height: 27px" name="pencil"></ion-icon>',ie.style.textAlign="center",ie.style.cursor="pointer",ie.onclick=()=>{t.change_line_weight()},t.p5SetCanvasViewportInit=()=>{e.resizeCanvas(l.clientWidth,l.clientHeight),pe=I.copy(),ue=b,me=G.copy(),N=0,ge=!0,e.loop()},s=e.createGraphics(r.width,r.height),m=e.createVector(s.width/2,s.height/2),s.pixelDensity(1),s.noLoop(),s.noFill(),t.p5ActualCanvas=s,c=e.createGraphics(r.width,r.height),c.pixelDensity(1),c.noLoop(),c.noFill(),c.background(t.navParams.isDarkMode?26:255),t.p5ImageCanvas=c,p=e.createGraphics(r.width,r.height),p.pixelDensity(1),p.noLoop(),p.noFill(),p.clear(255,255,255,255),r.path){let C=yield t.indexed.loadBlobFromUserPath(r.path,r.type),H=URL.createObjectURL(C);e.loadImage(H,u=>{t.p5BaseImage=u,c.image(t.p5BaseImage,0,0),c.redraw(),URL.revokeObjectURL(H),setTimeout(()=>{t.p5SetCanvasViewportInit()},100)},u=>{console.error("\uadf8\ub9bc\ud310 \ubc30\uacbd \uc774\ubbf8\uc9c0 \ubd88\ub7ec\uc624\uae30 \uc624\ub958: ",u),c.redraw(),URL.revokeObjectURL(H),setTimeout(()=>{t.p5SetCanvasViewportInit()},100)})}else c.redraw(),setTimeout(()=>{t.p5SetCanvasViewportInit()},100);r.width<r.height&&(ce/=b),t.p5getCropPos=ze,t.p5setCropPos=_e,t.p5getCropSize=Je,t.p5setCropSize=Ke,t.p5RemoteDrawStart=et,t.p5RemoteDrawing=tt,t.p5RemoteDrawingEnd=it,t.p5updateRemoteCurve=qe,t.p5CancelCurrentDraw=()=>{f=null,e.redraw()},t.navParams.scrollHeight&&_e(0,-t.navParams.scrollHeight)});let I=e.createVector(),b=1,G=e.createVector(0,0),x=e.createVector(),re=e.createVector(),O=e.createVector(),d=e.createVector(),ge=!1,N=0,pe=e.createVector(0,0),ue=0,me=e.createVector(0,0),ze=()=>x,Je=()=>d,_e=(a,o)=>{x.x=a,x.y=o,c.translate(a,o),p.translate(a,o),e.redraw()},Ke=(a,o)=>{d.x=a,d.y=o,c.translate(a,o),p.translate(a,o),e.redraw()},U=a=>e.sin(a*e.PI/2);e.draw=()=>{if(ge){N+=.07,N>=1&&(ge=!1,N=1,e.noLoop()),G.x=e.lerp(me.x,e.width/2,U(N)),G.y=e.lerp(me.y,e.height/2,U(N)),I.x=e.lerp(pe.x,0,U(N)),I.y=e.lerp(pe.y,0,U(N));let a=l.clientHeight-112;b=e.lerp(ue,l.clientWidth/a<s.width/s.height?l.clientWidth/s.width:a/s.height,U(N))}if(e.clear(255,255,255,255),e.push(),e.translate(G),e.scale(b),e.translate(I),e.image(c,0,0),e.image(p,0,0),s&&e.image(s,0,0),this.isCropMode)e.push(),e.translate(-s.width/2,-s.height/2),e.translate(O),e.noStroke(),e.fill(0,100),e.rect(0,0,d.x,d.y),e.stroke(255,0,0),e.strokeWeight(8),e.beginShape(e.LINES),e.vertex(0,0),e.vertex(d.x,0),e.vertex(d.x,0),e.vertex(d.x,.8*d.y),e.vertex(0,0),e.vertex(0,d.y),e.vertex(0,d.y),e.vertex(.8*d.x,d.y),e.stroke(255,255,0),e.vertex(.8*d.x,d.y),e.vertex(d.x,d.y),e.vertex(d.x,.8*d.y),e.vertex(d.x,d.y),e.endShape(),e.pop();else{if(h&&h.pos&&h.pos.length){e.push(),e.translate(x),e.stroke(h.color),e.strokeWeight(h.weight),e.beginShape();for(let a=0,o=h.pos.length;a<o;a++)e.curveVertex(h.pos[a].x-m.x,h.pos[a].y-m.y);e.endShape(),e.pop()}if(this.ReadyToShareAct&&f&&f.pos&&f.pos.length){e.push(),e.translate(x),e.stroke(f.color),e.strokeWeight(f.weight),e.beginShape();for(let a=0,o=f.pos.length;a<o;a++)e.curveVertex(f.pos[a].x-m.x,f.pos[a].y-m.y);e.endShape(),e.pop()}}e.pop()},this.p5DrawingStack=[],this.p5ClearCurrentDraw=()=>{h={},this.p5DrawingStack.length=0,L=0,oe(),e.redraw()};let L=0,oe=()=>{s.clear(255,255,255,255);for(let a=0;a<L;a++)F(s,this.p5DrawingStack[a])},F=(a,o=h)=>{if(o.color){a.push(),a.translate(x),a.stroke(o.color),a.strokeWeight(o.weight),a.beginShape();for(let n=0,A=o.pos.length;n<A;n++)a.curveVertex(o.pos[n].x,o.pos[n].y);a.endShape(),a.pop(),a.redraw(),e.redraw()}},qe=a=>{for(let o=0,n=a.length;o<n;o++)F(s,a[o]);L=this.p5DrawingStack.length};e.windowResized=()=>{setTimeout(()=>{this.p5SetCanvasViewportInit()},0)};let h={},f={},et=a=>{f=a,e.redraw()},tt=a=>{f&&f.pos&&f.pos.push(a),e.redraw()},it=a=>{f.pos.push(a),f.pos.push(a),this.p5DrawingStack.length=L,f&&(this.p5DrawingStack.push(f),F(s,f)),L=this.p5DrawingStack.length,f=null,e.redraw()};const W=56;let we,Q,Ce,ve,De,K,be,fe=0,se=!1,E=!1;e.mousePressed=a=>{if($){if(e.mouseY<W||e.mouseY>e.height-W)return void(E=!0);switch(a.which){case 1:this.isCropMode?ke():Ae();break;case 3:Q=e.createVector(e.mouseX,e.mouseY),K=I.copy(),we=e.createVector(e.mouseX,e.mouseY);break;case 2:this.p5SetCanvasViewportInit()}}};let ke=(a,o)=>{let n=Y(a,o),A=O.copy().add(d).sub(e.createVector(s.width/2,s.height/2)),D=n.dist(A),X=.2*e.max(d.x,d.y);se=D<X,se?(ve=e.createVector(e.mouseX,e.mouseY),be=d.copy()):Ce=e.createVector(e.mouseX,e.mouseY).sub(O.mult(b))},Ae=(a,o)=>{w.style.fill="var(--ion-color-dark)",B.style.fill="var(--ion-color-medium)";let n=Y(a,o);n.sub(x),n.add(m);let A={x:n.x,y:n.y},D=P.color().levels,X=`#${e.hex(D[0],2)}${e.hex(D[1],2)}${e.hex(D[2],2)}`;h={pos:[],color:X,weight:ce*de},h.pos.push(A),h.pos.push(A),this.ReadyToShareAct&&this.webrtc.dataChannel.send(JSON.stringify({type:"draw",act:"start",data:h})),e.redraw()};e.mouseDragged=a=>{if($)switch(a.which){case 1:if(this.isCropMode&&!E){let o=e.createVector(e.mouseX,e.mouseY);se?d=be.copy().add(ve.copy().sub(o).div(-b)):O=Ce.copy().sub(o).div(-b),e.redraw()}else{let o=Y();o.sub(x),o.add(m);let n={x:o.x,y:o.y};h&&h.pos&&h.pos.push(n),this.ReadyToShareAct&&this.webrtc.dataChannel.send(JSON.stringify({type:"draw",act:"moved",data:n})),e.redraw()}break;case 3:we=e.createVector(e.mouseX,e.mouseY),I=K.copy().add(we.sub(Q).div(b)),e.redraw()}},e.mouseWheel=a=>{$&&(e.mouseY<W||e.mouseY>e.height-W?E=!0:(at(Y()),b*=a.deltaY<0?1.1:.9,e.redraw()))},e.mouseReleased=a=>{if($){if(1===a.which&&!this.isCropMode&&!E){let o=Y();o.sub(x),o.add(m);let n={x:o.x,y:o.y};if(h)try{h.pos.push(n),h.pos.push(n),this.ReadyToShareAct&&this.webrtc.dataChannel.send(JSON.stringify({type:"draw",act:"end",data:n}))}catch{}Te()}E=!1}};let at=a=>{G=e.createVector(e.mouseX,e.mouseY),I=a.mult(-1)},Y=(a,o)=>{let n=e.createVector(a||e.mouseX,o||e.mouseY);return n.sub(G),n.div(b),n.sub(I),n},_=[],Z=!1,$=!0,rt=a=>{$=a};e.touchStarted=a=>{if($){if(_=a.touches,a.changedTouches[0].clientY<W||a.changedTouches[0].clientY>e.height-W)return void(E=!0);switch(Z=!0,_.length){case 1:this.isCropMode?ke(a.changedTouches[0].clientX,a.changedTouches[0].clientY-W):Ae(a.changedTouches[0].clientX,a.changedTouches[0].clientY-W);break;case 2:let o=e.createVector(_[0].clientX,_[0].clientY-56),n=e.createVector(_[1].clientX,_[1].clientY-56);fe=o.dist(n),Q=o.copy().add(n).div(2),K=I.copy(),De=b,h=null,this.ReadyToShareAct&&this.webrtc.dataChannel.send(JSON.stringify({type:"draw",act:"cancel"}));break;default:Z=!1,this.p5SetCanvasViewportInit()}}},e.touchMoved=a=>{if($&&Z){switch(_=a.touches,_.length){case 1:if(this.isCropMode&&!E){let o=e.createVector(a.changedTouches[0].clientX,a.changedTouches[0].clientY-W);se?d=be.copy().add(ve.copy().sub(o).div(-b)):O=Ce.copy().sub(o).div(-b),e.redraw()}else{let o=Y(a.changedTouches[0].clientX,a.changedTouches[0].clientY-W);o.sub(x),o.add(m);let n={x:o.x,y:o.y};h&&h.pos&&h.pos.push(n),this.ReadyToShareAct&&this.webrtc.dataChannel.send(JSON.stringify({type:"draw",act:"moved",data:n})),e.redraw()}break;case 2:{let o=e.createVector(_[0].clientX,_[0].clientY-56),n=e.createVector(_[1].clientX,_[1].clientY-56),A=o.copy().add(n).div(2);b=o.dist(n)/fe*De,I=K.copy().add(A.sub(Q).div(b)),e.redraw()}}return!1}},e.touchEnded=a=>{if($&&a.changedTouches){switch(_=a.touches,Z=!1,_.length){case 0:if(!this.isCropMode&&!E&&h){let o=Y(a.changedTouches[0].clientX,a.changedTouches[0].clientY-W);o.sub(x),o.add(m);let n={x:o.x,y:o.y};h.pos.push(n),h.pos.push(n),this.ReadyToShareAct&&this.webrtc.dataChannel.send(JSON.stringify({type:"draw",act:"end",data:n})),Te()}break;case 1:if(!Z)return;ot(),fe=0,h=null}E=!1}};let ot=()=>{Q=e.createVector(_[0].clientX,_[0].clientY-56),K=I.copy()},Te=()=>{if(this.p5DrawingStack.length=L,h)if(this.p5DrawingStack.push(h),this.p5DrawingStack.length>20){let a=this.p5DrawingStack.shift();F(p,a);let o=p.elt.toDataURL("image/png");e.loadImage(o,n=>{k=n,p.redraw()}),oe()}else F(s,h);L=this.p5DrawingStack.length,Q=null,E=!1,h=null,e.redraw()}})}ClickRemoteAddButton(){if(!this.isDrawServerCreated){if(this.IceWebRTCWsClient)return this.isDrawServerCreated=!0,this.global.StoreShortCutAct("voiddraw-remote"),this.p5SetDrawable(!1),this.AddrQRShare.onDidDismiss().then(()=>{this.p5SetDrawable(!0),this.isDrawServerCreated=!1,this.global.RestoreShortCutAct("voiddraw-remote"),this.HasConnectedPeer||this.p5SetDrawable(!0)}),void this.AddrQRShare.present();this.ServerList=this.nakama.get_all_online_server(),this.ServerList.length?(this.p5SetDrawable(!1),this.RemoteDraw.open()):(this.p5SetDrawable(!1),this.RemoteBridgeServerSelected({detail:{value:"local"}}))}}RemoteBridgeServerSelected(r){var t=this;return(0,V.A)(function*(){if(t.isDrawServerCreated)return;let l=r.detail.value;if("local"===l){let e;t.alertCtrl.create({header:t.lang.text.voidDraw.LocalAddrInput,inputs:[{type:"text",placeholder:"(wss://)0.0.0.0(:0)"},{type:"text",placeholder:"rtcport:username:password"}],buttons:[{text:t.lang.text.voidDraw.Confirm,handler:s=>{let m=s[1].split(":");t.Port=m[0],t.username=m[1],t.password=m[2],s[0]?(t.InputCustomAddress=s[0],t.p5SetDrawable(!1),e=!0,t.CreateOnMessageLink(),t.CreateRemoteLocalClient(s[0],s[1])):t.p5toast.show({text:t.lang.text.voidDraw.InputAddress})}}]}).then(s=>{s.onWillDismiss().then(()=>{t.p5SetDrawable(!0)}),s.onDidDismiss().then(()=>{!e&&!t.WillLeaveHere&&t.global.RestoreShortCutAct("voiddraw-remote-bridge")}),t.global.StoreShortCutAct("voiddraw-remote-bridge"),s.present()})}else t.InputCustomAddress=`${l.info.useSSL?"wss":"ws"}://${l.info.address}`,t.p5SetDrawable(!1),t.CreateOnMessageLink(),t.CreateRemoteLocalClient(t.InputCustomAddress,r[1],l.info)})()}CreateRemoteLocalClient(r,t,l){var e=this;return(0,V.A)(function*(){let s=r.split("://"),m=s.pop().split(":");e.TargetRemoteAddress=m[0];let p,c=s.pop();c?c+=":":c=e.global.checkProtocolFromAddress(m[0])?"wss:":"ws:",l?e.AlreadyExistServer=!0:yield e.nakama.SaveWebRTCServer({urls:[`stun:${m[0]}:${e.Port||("wss:"==c?5349:3478)}`,`turn:${m[0]}:${e.Port||("wss"==c?5349:3478)}`],username:e.username||"username",credential:e.password||"password"}).then(k=>e.AlreadyExistServer=k),e.IceWebRTCWsClient=new WebSocket(`${c}//${m[0]}:${m[1]||12013}/`),e.AddShortCut(),e.isDrawServerCreated=!0,e.IceWebRTCWsClient.onopen=(0,V.A)(function*(){e.p5toast.show({text:`${e.lang.text.voidDraw.Connected}: ${m[0]}`}),t?(e.IceWebRTCWsClient.send(JSON.stringify({type:"join",channel:t})),yield new Promise(k=>setTimeout(k,e.global.WebsocketRetryTerm)),e.IceWebRTCWsClient.send(JSON.stringify({type:"size_req",channel:t})),e.RemoteLoadingCtrl=yield e.loadingCtrl.create({message:e.lang.text.voidDraw.WaitingConnection}),e.RemoteLoadingCtrl.present()):e.IceWebRTCWsClient.send(JSON.stringify({type:"init"}))}),e.IceWebRTCWsClient.onmessage=function(){var k=(0,V.A)(function*(M){let S;try{let w=JSON.parse(M.data);if(void 0===p)p=w.uid;else if(p==w.uid)return;switch(w.type){case"join":e.HasConnectedPeer=!0,e.p5SetDrawable(!1);break;case"leave":e.HasConnectedPeer=!1,e.p5SetDrawable(!0),e.RemoteLoadingCtrl.dismiss(),e.IceWebRTCWsClient.close();break;case"init_id":e.QRNavParams={address:r,channel:w.id,user_id:w.uid},e.init_gen_qrcode(),e.AddrQRShare.onDidDismiss().then(()=>{e.isDrawServerCreated=!1,e.global.RestoreShortCutAct("voiddraw-remote"),e.HasConnectedPeer||e.p5SetDrawable(!0)}),e.global.StoreShortCutAct("voiddraw-remote"),e.p5SetDrawable(!1),e.AddrQRShare.present(),e.IceWebRTCWsClient.send(JSON.stringify({type:"join",channel:w.id})),S=w.id;break;case"init_req":e.RemoteLoadingCtrl.message=e.lang.text.voidDraw.WebRTC_Init,e.webrtc.initialize("data").then((0,V.A)(function*(){e.webrtc.HangUpCallBack=()=>{e.IceWebRTCWsClient.close()},e.CreateOnMessageLink(),e.CreateOnOpenAct(),e.webrtc.CreateOffer(),yield new Promise(P=>setTimeout(P,e.global.WebsocketRetryTerm)),e.IceWebRTCWsClient.send(JSON.stringify({type:"socket_react",channel:S,act:"WEBRTC_INIT_REQ_SIGNAL"}))}));break;case"size_req":e.AddrQRShare.dismiss(),e.RemoteLoadingCtrl=yield e.loadingCtrl.create({message:e.lang.text.voidDraw.WaitingConnection}),e.RemoteLoadingCtrl.present();let B=e.p5getCropPos();e.IceWebRTCWsClient.send(JSON.stringify({type:"size",width:e.p5ActualCanvas.width,height:e.p5ActualCanvas.height,cropX:B.x,cropY:B.y,channel:S}));break;case"socket_react":switch(w.act){case"WEBRTC_REPLY_INIT_SIGNAL":e.RemoteLoadingCtrl.message=e.lang.text.voidDraw.WebRTC_Reply,e.nakama.socket_reactive[w.act](w.data_str),"EOL"==w.data_str&&(e.RemoteLoadingCtrl.message=e.lang.text.voidDraw.WebRTC_Offer,e.webrtc.CreateAnswer({client:e.IceWebRTCWsClient,channel:S})),e.RemoteLoadingCtrl.message=e.lang.text.voidDraw.WebRTC_Ice;break;case"WEBRTC_ICE_CANDIDATES":e.nakama.socket_reactive[w.act](w.data_str,{client:e.IceWebRTCWsClient,channel:S}),e.RemoteLoadingCtrl.message=e.lang.text.voidDraw.WebRTC_datachannel,e.IceWebRTCWsClient.send(JSON.stringify({type:"init_end",channel:S}));break;case"WEBRTC_INIT_REQ_SIGNAL":e.nakama.socket_reactive[w.act]({client:e.IceWebRTCWsClient,channel:S});break;case"WEBRTC_RECEIVE_ANSWER":e.nakama.socket_reactive[w.act](w.data_str,{client:e.IceWebRTCWsClient,channel:S})}break;case"size":e.create_new_canvas({width:w.width,height:w.height}),e.p5SetDrawable(!1),e.p5setCropPos(w.cropX,w.cropY),e.p5voidDraw.redraw(),e.RemoteLoadingCtrl.message=e.lang.text.voidDraw.WebRTC_Init,e.webrtc.initialize("data").then(()=>{e.webrtc.HangUpCallBack=()=>{e.IceWebRTCWsClient&&e.IceWebRTCWsClient.close()},e.CreateOnOpenAct(),e.CreateOnMessageLink(),e.RemoteLoadingCtrl.message=e.lang.text.voidDraw.WebRTC_Offer,e.webrtc.CreateOffer(),e.IceWebRTCWsClient.send(JSON.stringify({type:"init_req"}))});break;case"init_end":e.RemoteLoadingCtrl.message=e.lang.text.voidDraw.WebRTC_datachannel}}catch{e.IceWebRTCWsClient.close()}});return function(M){return k.apply(this,arguments)}}(),e.IceWebRTCWsClient.onerror=k=>{console.log("\uadf8\ub9bc\ud310 \uae30\ub2a5 \uacf5\uc720 \uc5f0\uacb0 \uc624\ub958: ",k),e.IceWebRTCWsClient.close()},e.IceWebRTCWsClient.onclose=()=>{e.p5toast.show({text:e.lang.text.TodoDetail.Disconnected}),e.RemoteLoadingCtrl&&e.RemoteLoadingCtrl.dismiss(),e.AddrQRShare.dismiss(),e.isDrawServerCreated=!1,e.p5SetDrawable(!0),e.webrtc.close_webrtc(!1),e.IceWebRTCWsClient.onopen=null,e.IceWebRTCWsClient.onclose=null,e.IceWebRTCWsClient.onmessage=null,e.IceWebRTCWsClient.onerror=null,e.IceWebRTCWsClient=null}})()}CreateOnOpenAct(r=(0,V.A)(function*(){})){var t=this;this.webrtc.dataChannelOpenAct=(0,V.A)(function*(){if(t.ReadyToShareAct=!0,t.p5ClearCurrentDraw(),r&&(yield r()),t.RemoteLoadingCtrl.message=t.lang.text.voidDraw.WebRTC_ShareBG,t.navParams.path)try{let l=t.navParams.path.split(".").pop(),e=yield t.indexed.loadBlobFromUserPath(t.navParams.path,""),s=t.InputCustomAddress.split("://"),m=s.pop(),c=s.shift();c=c?"wss"==c?"https:":"http:":t.global.checkProtocolFromAddress(t.InputCustomAddress)?"https":"http";let p=yield t.global.upload_file_to_storage({blob:e,size:e.size,file_ext:l,filename:`voidDrawRemoveImage.${l}`},{user_id:`tmp_${t.QRNavParams.channel}_${t.QRNavParams.user_id}`},c,m,!1,t.RemoteLoadingCtrl);t.webrtc.dataChannel.send(JSON.stringify({type:"background",data:p}))}catch(l){t.p5toast.show({text:`${t.lang.text.voidDraw.FailedGetBG}: ${l}`}),console.log("\ubc30\uacbd \uadf8\ub9bc \uacf5\uc720\ud558\uae30 \uc624\ub958: ",l)}t.RemoteLoadingCtrl.dismiss(),t.p5SetDrawable(!0)})}CreateOnMessageLink(){this.webrtc.dataChannelOnMsgAct=r=>{let t=JSON.parse(r);switch(t.type){case"drawline":this.p5DrawingStack=t.data,this.p5updateRemoteCurve(t.data),this.p5voidDraw.redraw();break;case"background":this.p5voidDraw.loadImage(t.data,l=>{this.p5BaseImage=l,this.p5ImageCanvas.image(this.p5BaseImage,0,0),this.p5ImageCanvas.redraw(),this.p5SetCanvasViewportInit()},l=>{console.error("\uadf8\ub9bc\ud310 \ubc30\uacbd \uc774\ubbf8\uc9c0 \ubd88\ub7ec\uc624\uae30 \uc624\ub958: ",l),this.p5ImageCanvas.redraw(),this.p5SetCanvasViewportInit()}),this.RemoteLoadingCtrl.dismiss();break;case"draw":switch(t.act){case"start":this.p5RemoteDrawStart(t.data);break;case"moved":this.p5RemoteDrawing(t.data);break;case"cancel":this.p5CancelCurrentDraw();break;case"crop":this.p5setCropPos(t.cropPX,t.cropPY),this.p5setCropSize(t.cropSX,t.cropSY),this.isCropMode=!0,this.p5apply_crop(!1);break;case"end":this.p5RemoteDrawingEnd(t.data)}break;case"same":"history_act"===t.act&&this.p5history_act(t.data,!0)}},this.webrtc.dataChannelOnCloseAct=()=>{this.CancelRemoteAct()}}change_line_weight(){this.p5set_line_weight()}open_crop_tool(){this.p5open_crop_tool()}dismiss_draw(){if(this.isCropMode)this.p5apply_crop();else{if("voiddraw-remote"==this.navParams.dismiss)return void this.navCtrl.pop();this.mainLoading.present(),this.WithoutSave=!1,this.p5save_image()}}ionSelectCancel(){this.p5voidDraw&&this.p5SetDrawable&&!this.isDrawServerCreated&&this.p5SetDrawable(!0)}RemoveShortCut(){this.p5voidDraw&&this.p5SetDrawable&&this.p5SetDrawable(!1),delete this.global.p5KeyShortCut.HistoryAct,delete this.global.p5KeyShortCut.AddAct,delete this.global.p5KeyShortCut.DeleteAct,delete this.global.p5KeyShortCut.SKeyAct,delete this.global.p5KeyShortCut.FKeyAct,delete this.global.p5KeyShortCut.Escape}ionViewWillLeave(){this.WillLeaveHere=!0,this.RemoveShortCut(),this.global.RestoreShortCutAct("void-draw")}ionViewDidLeave(){this.WithoutSave&&this.mainLoading.remove()}init_gen_qrcode(){var r=this;return(0,V.A)(function*(){let t=r.QRNavParams.address;r.SelectedAddress=`${yield r.global.GetHeaderAddress()}?voidDraw=${t},${r.QRNavParams.channel},${r.Port||""},${r.username||""},${r.password||""}`.replace(" ","%20"),r.QRCodeSRC=r.global.readasQRCodeFromString(r.SelectedAddress)})()}copy_address(r){this.global.WriteValueToClipboard("text/plain",r)}}return(g=T).\u0275fac=function(r){return new(r||g)(i.rXU(Pe.y),i.rXU(R.hG),i.rXU(R.Xi),i.rXU(Ve.z3),i.rXU(Me.n),i.rXU(He.X),i.rXU(Ne.G),i.rXU(Ee.j),i.rXU(ae.Ix),i.rXU(ae.nX),i.rXU(Le.q9))},g.\u0275cmp=i.VBU({type:g,selectors:[["app-void-draw"]],viewQuery:function(r,t){if(1&r&&(i.GBs($e,5),i.GBs(Oe,5)),2&r){let l;i.mGM(l=i.lsd())&&(t.RemoteDraw=l.first),i.mGM(l=i.lsd())&&(t.AddrQRShare=l.first)}},decls:20,vars:6,consts:[["RemoteDraw",""],["AddrQRShare",""],[1,"ion-no-border"],["slot","start"],["defaultHref",""],["slot","end","name","clipboard-outline",1,"top_icon",2,"width","24px","height","24px",3,"click"],["class","shortcut_hint","style","left: auto; right: 4px; top: 0px; padding: 2px 8px; border-radius: 8px;",4,"ngIf"],["slot","end","name","save-outline",1,"top_icon",2,"width","24px","height","24px",3,"click"],["oncontextmenu","return false;"],["hidden",""],["value","local",3,"ionChange","ionCancel","label"],["value","local"],[3,"value",4,"ngFor","ngForOf"],[1,"full_screen",2,"display","flex","overflow","hidden","background-color","black",3,"id"],[1,"transparent-modal"],[1,"shortcut_hint",2,"left","auto","right","4px","top","0px","padding","2px 8px","border-radius","8px"],[3,"value"],[2,"display","flex","justify-content","center","align-items","center","height","100%"],[2,"width","400px","min-height","455px","background-color","var(--chatroom-background)","text-align","center","padding","16px"],["style","width: 100%; height: auto; cursor: copy; margin-bottom: 8px;","alt","QuickLink",3,"src","click",4,"ngIf"],["button","",3,"click"],[1,"ion-text-center"],["alt","QuickLink",2,"width","100%","height","auto","cursor","copy","margin-bottom","8px",3,"click","src"]],template:function(r,t){if(1&r){const l=i.RV6();i.j41(0,"ion-header",2)(1,"ion-toolbar")(2,"ion-title"),i.EFF(3),i.k0s(),i.j41(4,"ion-buttons",3),i.nrm(5,"ion-back-button",4),i.k0s(),i.j41(6,"ion-icon",5),i.bIt("click",function(){return i.eBV(l),i.Njj(t.p5save_image(!0,!0))}),i.k0s(),i.DNE(7,Be,2,0,"div",6),i.j41(8,"ion-icon",7),i.bIt("click",function(){return i.eBV(l),i.Njj(t.p5save_image(!0))}),i.k0s()()(),i.j41(9,"ion-content",8)(10,"div",9)(11,"ion-select",10,0),i.bIt("ionChange",function(s){return i.eBV(l),i.Njj(t.RemoteBridgeServerSelected(s))})("ionCancel",function(){return i.eBV(l),i.Njj(t.ionSelectCancel())}),i.j41(13,"ion-select-option",11),i.EFF(14),i.k0s(),i.DNE(15,Xe,2,2,"ion-select-option",12),i.k0s()(),i.nrm(16,"div",13),i.j41(17,"ion-modal",14,1),i.DNE(19,je,6,2,"ng-template"),i.k0s()()}2&r&&(i.R7$(3),i.JRh(t.lang.text.ChatRoom.voidDraw),i.R7$(4),i.Y8G("ngIf",t.global.ShowHint),i.R7$(4),i.Y8G("label",t.lang.text.voidDraw.ConnectToAddress),i.R7$(3),i.JRh(t.lang.text.voidDraw.InternalConn),i.R7$(),i.Y8G("ngForOf",t.ServerList),i.R7$(),i.Y8G("id",t.voidDrawId))},dependencies:[le.Sq,le.bT,R.QW,R.W9,R.eU,R.iq,R.uz,R.he,R.Nm,R.Ip,R.BC,R.ai,R.Sb,R.Je,R.el]}),T})()}];let Ue=(()=>{var g;class T{}return(g=T).\u0275fac=function(r){return new(r||g)},g.\u0275mod=i.$C({type:g}),g.\u0275inj=i.G2t({imports:[ae.iI.forChild(Ge),ae.iI]}),T})(),Fe=(()=>{var g;class T{}return(g=T).\u0275fac=function(r){return new(r||g)},g.\u0275mod=i.$C({type:g}),g.\u0275inj=i.G2t({imports:[le.MD,Ie.YN,R.bv,Ue]}),T})()}}]);