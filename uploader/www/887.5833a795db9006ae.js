"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[887],{887:(st,_e,x)=>{x.r(_e),x.d(_e,{MainPageModule:()=>it});var ce=x(177),Ee=x(4341),O=x(5374),be=x(9858),z=x(467),ee=x(482),ye=x(4237),Ae=x(92),de=x(8326),De=x(617),t=x(3953),Me=x(4234),Be=x(8065),Oe=x(755),$e=x(3307),Ne=x(5547),Ve=x(9900);const Le=["LocalToRemoteSel"];function Ge(h,k){1&h&&t.nrm(0,"ion-icon",14)}function Ue(h,k){1&h&&t.nrm(0,"ion-icon",15)}function ze(h,k){1&h&&(t.j41(0,"div",16),t.EFF(1,"A"),t.k0s())}function He(h,k){if(1&h){const p=t.RV6();t.j41(0,"div")(1,"div",17),t.bIt("click",function(){t.eBV(p);const _=t.XpG();return t.Njj(_.nakama.open_add_todo_page())}),t.nrm(2,"ion-icon",18),t.j41(3,"div")(4,"ion-label",19),t.EFF(5),t.k0s()()()()}if(2&h){const p=t.XpG();t.R7$(5),t.JRh(p.lang.text.Main.NoTodo)}}function Xe(h,k){if(1&h){const p=t.RV6();t.j41(0,"div")(1,"ion-item",21),t.bIt("click",function(){const _=t.eBV(p).$implicit,e=t.XpG(2);return t.Njj(e.TodoServerSelected(_))}),t.j41(2,"ion-label"),t.EFF(3),t.k0s()()()}if(2&h){const p=k.$implicit;t.R7$(3),t.JRh(p.name)}}function Ye(h,k){if(1&h&&(t.j41(0,"ion-content")(1,"ion-item-divider")(2,"ion-label"),t.EFF(3),t.k0s()(),t.DNE(4,Xe,4,1,"div",20),t.k0s()),2&h){const p=t.XpG();t.R7$(3),t.JRh(p.lang.text.Main.MigrateRemote),t.R7$(),t.Y8G("ngForOf",p.SelectableTodoServer)}}function We(h,k){1&h&&(t.j41(0,"div",25),t.EFF(1,"`"),t.k0s())}function Je(h,k){if(1&h&&(t.j41(0,"div",25),t.EFF(1),t.k0s()),2&h){const p=t.XpG(2).index;t.R7$(),t.SpI("",p+1," ")}}function Ke(h,k){if(1&h){const p=t.RV6();t.j41(0,"span")(1,"button",26),t.bIt("click",function(){t.eBV(p);const _=t.XpG().$implicit,e=t.XpG(2);return t.Njj(e.ChangeFilterValue(_.value))})("contextmenu",function(){t.eBV(p);const _=t.XpG().$implicit,e=t.XpG(2);return t.Njj(e.FilterContextAct(_))}),t.DNE(2,Je,2,1,"div",24),t.EFF(3),t.k0s()()}if(2&h){const p=t.XpG(),o=p.$implicit,_=p.index,e=t.XpG(2);t.R7$(),t.Aen("background-color: "+(o.color||"#8888")+"; "+(e.CurrentFilterValue==o.value?"border: 4px solid var(--ion-color-secondary); margin: -4px 4px 4px -4px;":"")),t.Y8G("id","filterSel_"+_),t.R7$(),t.Y8G("ngIf",e.global.ShowHint&&e.global.portalHint),t.R7$(),t.SpI(" ",e.lang.text.TodoDetail[o.name]," ")}}function Qe(h,k){if(1&h){const p=t.RV6();t.j41(0,"span")(1,"input",27),t.bIt("input",function(_){t.eBV(p);const e=t.XpG().$implicit,V=t.XpG(2);return t.Njj(V.GetFilterInput(_,e.name))})("blur",function(){t.eBV(p);const _=t.XpG(3);return t.Njj(_.global.toggleBlockMainShortcut(!1))})("focus",function(){t.eBV(p);const _=t.XpG(3);return t.Njj(_.global.toggleBlockMainShortcut(!0))}),t.k0s()()}if(2&h){const p=t.XpG().$implicit,o=t.XpG(2);t.R7$(),t.Y8G("placeholder",o.lang.text.TodoDetail[p.name])}}function Ze(h,k){if(1&h&&(t.j41(0,"span"),t.DNE(1,Ke,4,5,"span",10)(2,Qe,2,1,"span",10),t.k0s()),2&h){const p=k.$implicit;t.R7$(),t.Y8G("ngIf",!p.type),t.R7$(),t.Y8G("ngIf","input"==p.type)}}function qe(h,k){if(1&h){const p=t.RV6();t.j41(0,"div",22)(1,"button",23),t.bIt("click",function(){t.eBV(p);const _=t.XpG();return t.Njj(_.SwitchTargetFilter())}),t.DNE(2,We,2,0,"div",24),t.EFF(3),t.k0s(),t.DNE(4,Ze,3,2,"span",20),t.k0s()}if(2&h){const p=t.XpG();t.R7$(2),t.Y8G("ngIf",p.global.ShowHint&&p.global.portalHint),t.R7$(),t.SpI(" ",p.lang.text.TodoDetail[p.TargetFilterDisplayName]," "),t.R7$(),t.Y8G("ngForOf",p.AllCategories[p.TargetFilterName])}}var C=function(h){return h[h.None=0]="None",h[h.Deadline=1]="Deadline",h[h.Importance=2]="Importance",h[h.Color=3]="Color",h[h.Creator=4]="Creator",h[h.InputText=5]="InputText",h}(C||{});const et=[{path:"",component:(()=>{var h;class k{constructor(o,_,e,V,c,s,H,X,F){this.global=o,this.lang=_,this.nakama=e,this.statusBar=V,this.indexed=c,this.alertCtrl=s,this.p5loading=H,this.noti=X,this.p5toast=F,this.isPlayingCanvas={loop:!0},this.TargetFilterDisplayName="FilterCat_0",this.TargetFilterName=0,this.AllCategories={},this.CurrentFilterValue=null,this.SelectableTodoServer=[],this.isEmptyTodo=!1}ngOnInit(){this.global.PortalBottonTabAct.Todo=()=>{this.ViewInitFunc&&this.ViewInitFunc()}}toggle_session(){this.nakama.toggle_all_session(),this.global.p5todo.redraw()}toggleCanvasPlaying(){this.isPlayingCanvas.loop=!this.isPlayingCanvas.loop,this.isPlayingCanvas.loop?this.global.p5todo.loop():this.global.p5todo.noLoop()}SwitchTargetFilter(o){switch(this.TargetFilterName=null!=o?o:(this.TargetFilterName+1)%6,this.TargetFilterName){case C.None:this.TargetFilterDisplayName="FilterCat_0";break;case C.Importance:this.TargetFilterDisplayName="Importance";break;case C.Color:this.TargetFilterDisplayName="CustomColor";break;case C.Deadline:this.TargetFilterDisplayName="Deadline";break;case C.Creator:this.TargetFilterDisplayName="FilterByCreator";break;case C.InputText:this.TargetFilterDisplayName="AsString"}this.CurrentFilterValue=null,this.global.p5FilteringTodos&&this.global.p5FilteringTodos(C.None,this.TargetFilterDisplayName)}ChangeFilterValue(o){this.CurrentFilterValue=this.CurrentFilterValue==o?null:o,this.global.p5FilteringTodos()}FilterContextAct(o){return this.global.p5FilterContextMenu(o),!1}CreateTodoManager(){var o=this;setTimeout(()=>{"DesktopPWA"!=Ae.aH&&this.toggleCanvasPlaying()},8e3);let _=document.getElementById("todo");this.global.p5todo&&this.global.p5todo.remove(),this.global.p5todo=new de(e=>{let F,he,ae,xe,ue,V=this.statusBar,c={},s=[],H=[],X=[],Y=e.createVector(0,0),me=e.createVector(0,0),S=e.createVector(0,0),j=1,M=e.createVector(0,0),te=this.nakama,Te=this.indexed,N=[],A=!1,J=this.isPlayingCanvas;this.GetFilterInput=(m,a)=>{if("InputPlaceHolder"===a){const l=m.target.value;for(let u=0,d=s.length;u<d;u++){var r;let y=!1;const T=c[s[u]].json;if(T.title){if(T.title.indexOf(l)>=0&&(y=!0),y){c[s[u]].isHidden=!y;continue}(null===(r=T.description)||void 0===r?void 0:r.indexOf(l))>=0&&(y=!0),c[s[u]].isHidden=!y}}}this.isPlayingCanvas.loop||e.redraw()},e.setup=(0,z.A)(function*(){let m=e.createCanvas(_.clientWidth,_.clientHeight);m.parent(_),m.id("p5todo"),m.elt.oncontextmenu=function(){var r=(0,z.A)(function*(l){for(let u=s.length-1;u>=0;u--){const d=c[s[u]];if("AddButton"!=d.json.id&&d.position.dist(G(l.offsetX,l.offsetY))<d.EllipseSize/2){let T="";try{let I;try{I=`todo/${d.json.id}_${d.json.remote.isOfficial}_${d.json.remote.target}/thumbnail.png`}catch{I=`todo/${d.json.id}/thumbnail.png`}let f=yield Te.loadBlobFromUserPath(I,"image/png");const i=URL.createObjectURL(f);T=`<div style="text-align: center"><img src="${i}" alt="todo_image" style="border-radius: 2px"></div>`,setTimeout(()=>{URL.revokeObjectURL(i)},100)}catch{}o.alertCtrl.create({header:d.json.title,message:new De.Vk(T+`<div>${d.json.description||""}</div>`),buttons:[{text:o.lang.text.TodoDetail.TodoComplete,handler:()=>{!function(){var f=(0,z.A)(function*(){try{yield te.doneTodo(d.json)}catch(i){console.log("\ud560 \uc77c \uc644\ub8cc \uc624\ub958: ",i)}});return function(){return f.apply(this,arguments)}}()()}},{text:o.lang.text.TodoDetail.remove,cssClass:"redfont",handler:()=>{!function(){var f=(0,z.A)(function*(){try{yield te.deleteTodoFromStorage(!0,d.json)}catch(i){console.log("\ud560 \uc77c \uc0ad\uc81c \uc624\ub958: ",i)}});return function(){return f.apply(this,arguments)}}()()}}]}).then(I=>{Re(),I.onDidDismiss().then(()=>{A=!1}),A=!0,I.present()});break}}});return function(l){return r.apply(this,arguments)}}(),e.smooth(),e.noStroke(),e.pixelDensity(1),e.ellipseMode(e.CENTER),e.rectMode(e.CENTER),e.textAlign(e.CENTER,e.CENTER),e.textSize(20),e.textLeading(28),e.textWrap(e.CHAR),e.imageMode(e.CENTER);let a=Number(localStorage.getItem("p5todoScale")||1);at(),o.ViewInitFunc=ge,j=a,localStorage.setItem("p5todoScale",`${j}`),o.global.p5todoStopCanvas=()=>{A=!0,e.noLoop()},o.global.p5todoPlayCanvas=()=>{A=!1,e.windowResized(),o.isPlayingCanvas.loop&&e.loop()},o.global.p5todoAddtodo=r=>{let l=JSON.parse(r),u=l.id;if(l.remote&&(u+=`_${l.remote.isOfficial}_${l.remote.target}`),!l.removed){if(l.done){for(let d=s.length-1;d>=0;d--)if(s[d]==u)return void c[s[d]].makeDone()}else c[u]?(c[u].json=l,c[u].initialize()):c[u]=new ke(l);o.isPlayingCanvas.loop||(he=c[u],e.loop()),ae()}},ae=()=>{s=Object.keys(c),o.isEmptyTodo=!s.length,o.isEmptyTodo||(c.AddButton?1==s.length&&c.AddButton.makeDone():(c.AddButton=new ke("",!0),s=Object.keys(c)))},o.global.p5removeTodo=r=>{let l=JSON.parse(r),u=l.id;l.remote&&(u+=`_${l.remote.isOfficial}_${l.remote.target}`);for(let d=s.length-1;d>=0;d--)if(s[d]==u){c[s[d]].RemoveTodo();break}o.isEmptyTodo=!Object.keys(s).length,ae(),e.redraw()},xe=function(){var r=(0,z.A)(function*(){c={},s.length=0;let l=yield o.indexed.GetFileListFromDB("todo/");for(let u=0,d=l.length;u<d;u++)if(l[u].indexOf("/info.todo")>=0){let y=yield o.indexed.loadTextFromUserPath(l[u]);o.global.p5todoAddtodo(y)}o.isEmptyTodo=!Object.keys(s).length});return function(){return r.apply(this,arguments)}}(),xe(),o.SwitchTargetFilter(o.TargetFilterName),o.AllCategories[C.None]=[],o.AllCategories[C.Importance]=[{name:"Importance_0",color:"#58a19288",value:"0"},{name:"Importance_1",color:"#ddbb4188",value:"1"},{name:"Importance_2",color:"#b9543788",value:"2"}],o.AllCategories[C.Color]=[{name:"ColorFilterRed",color:"#ff000088",value:[-30,30]},{name:"ColorFilterYellow",color:"#ffff0088",value:[30,90]},{name:"ColorFilterGreen",color:"#00ff0088",value:[90,150]},{name:"ColorFilterCyan",color:"#00ffff88",value:[150,210]},{name:"ColorFilterBlue",color:"#0000ff88",value:[210,270]},{name:"ColorFilterMagenta",color:"#ff00ff88",value:[270,330]}],o.AllCategories[C.Deadline]=[{name:"TimeBefore",color:"#bbbbbb88",value:"before"},{name:"TimeIn",color:"#00ff0088",value:"ontime"},{name:"TimeOut",color:"#b9543788",value:"after"},{name:"Yesterday",color:"#45678988",value:"yesterday"},{name:"Today",color:"#789abc88",value:"today"},{name:"Tomorrow",color:"#abcdef88",value:"tomorrow"}],o.AllCategories[C.Creator]=[{name:"CreatorLocal",color:"#bbbbbb88",value:"local"},{name:"CreatorMe",color:"#00ff0088",value:"server"},{name:"Requested",color:"#6789ab88",value:"worker"},{name:"CreatorOther",color:"#ba987688",value:"other"}],o.AllCategories[C.InputText]=[{name:"InputPlaceHolder",color:"#bbbbbb88",type:"input",value:"text"}],o.global.p5FilteringTodos=se,o.global.p5FilterContextMenu=ot});const le=()=>{J.loop||(e.loop(),ue&&clearTimeout(ue),ue=setTimeout(()=>{J.loop||e.noLoop()},4e3))};let Ce;const se=(m,a)=>{switch(a&&(Ce=a),null!=m?m:this.TargetFilterName){case C.None:for(let l=0,u=s.length;l<u;l++)c[s[l]].isHidden=!1;break;case C.Importance:if(this.CurrentFilterValue){for(let l=0,u=s.length;l<u;l++)if("AddButton"==c[s[l]].json.id)c[s[l]].isHidden=!1;else{const d=c[s[l]].json.importance!=this.CurrentFilterValue;c[s[l]].isHidden=d,d&&c[s[l]].Repositioning()}le()}else se(C.None);break;case C.Color:for(let l=0,u=s.length;l<u;l++){let d;e.push(),e.colorMode(e.HSB);try{d=e.color(c[s[l]].json.custom_color)}catch{}if(!d)switch(c[s[l]].json.importance){case"0":d=e.color("#58a192");break;case"1":d=e.color("#ddbb41");break;case"2":d=e.color("#b95437")}if(e.pop(),this.CurrentFilterValue){if(d){const y=(360+this.CurrentFilterValue[0])%360,T=(360+this.CurrentFilterValue[1])%360,w=e.hue(d);let $=!1;$=y<T?!(y<w&&w<T):T<w&&w<y,c[s[l]].isHidden=$,$&&c[s[l]].Repositioning()}}else c[s[l]].isHidden=!1}le();break;case C.Deadline:if(this.CurrentFilterValue){for(let l=0,u=s.length;l<u;l++)if("AddButton"==c[s[l]].json.id)c[s[l]].isHidden=!1;else{let d=!1;switch(this.CurrentFilterValue){case"before":d=!(c[s[l]].json.startFrom&&c[s[l]].json.startFrom>Date.now());break;case"ontime":d=!((c[s[l]].json.startFrom||0)<Date.now()&&(c[s[l]].json.limit||c[s[l]].json.written)>Date.now());break;case"after":d=!(c[s[l]].json.limit<=Date.now());break;case"yesterday":{const y=new Date;y.setDate(y.getDate()-1),y.setHours(0,0,0,0);const T=new Date;T.setDate(T.getDate()-1),T.setHours(23,59,59,999),d=!(c[s[l]].json.limit>y&&c[s[l]].json.limit<=T)}break;case"today":{const y=new Date;y.setHours(0,0,0,0);const T=new Date;T.setHours(23,59,59,999),d=!(c[s[l]].json.limit>y&&c[s[l]].json.limit<=T)}break;case"tomorrow":{const y=new Date;y.setDate(y.getDate()+1),y.setHours(0,0,0,0);const T=new Date;T.setDate(T.getDate()+1),T.setHours(23,59,59,999),d=!(c[s[l]].json.limit>y&&c[s[l]].json.limit<=T)}}c[s[l]].isHidden=d,d&&c[s[l]].Repositioning()}le()}else se(C.None);break;case C.Creator:if(this.CurrentFilterValue){for(let l=0,u=s.length;l<u;l++)if("AddButton"==c[s[l]].json.id)c[s[l]].isHidden=!1;else{let d=!1;switch(this.CurrentFilterValue){case"local":d=c[s[l]].json.storeAt!=this.CurrentFilterValue;break;case"server":d=void 0===c[s[l]].json.remote;break;case"worker":d=!(void 0!==c[s[l]].json.workers&&c[s[l]].json.is_me);break;case"other":d=c[s[l]].json.is_me||"local"==c[s[l]].json.storeAt}c[s[l]].isHidden=d,d&&c[s[l]].Repositioning()}le()}else se(C.None)}e.redraw()},ot=m=>{"FilterByCreator"===this.TargetFilterDisplayName&&"local"===m.value&&(this.SelectableTodoServer=te.get_all_server_info(!0,!0),this.SelectableTodoServer.length&&(this.global.toggleBlockMainShortcut(!0),this.LocalToRemoteSel.onDidDismiss().then(()=>{this.global.toggleBlockMainShortcut(!1)}),this.LocalToRemoteSel.present()))};this.TodoServerSelected=function(){var m=(0,z.A)(function*(a){const r=a.isOfficial,l=a.target,u="migrateTodo";let d=[];for(let w=s.length-1;w>=0;w--)"AddButton"!=c[s[w]].json.id&&"local"==c[s[w]].json.storeAt&&d.push(c[s[w]]);for(;d.length;){const w=d.shift(),$=JSON.stringify(w.json),I=JSON.parse($),f=JSON.parse($),i=JSON.parse($);i.storeAt=`${r}/${l}`,i.remote=a;try{yield o.p5loading.update({id:u,message:`${o.lang.text.TodoDetail.ApplyingTodo}: ${i.title}`,forceEnd:null});let q=!!i.attach.length;delete i.display_store,delete i.display_creator;let U={};try{U.apache_port=a.apache_port,U.cdn_port=a.cdn_port}catch{U={}}for(let n=0,g=f.attach.length;n<g;n++){try{let b=f.attach[n].filename,v=yield o.indexed.loadBlobFromUserPath(f.attach[n].path,f.attach[n].type),D=`tmp_files/todo/${b}`;yield o.indexed.saveBlobToUserPath(v,D),i.attach[n].path=D,i.attach[n].blob=v}catch{if(f.attach[n].url){let v=f.attach[n].filename,E=yield(yield fetch(f.attach[n].url)).blob(),W=`tmp_files/todo/${v}`;yield o.indexed.saveBlobToUserPath(E,W),i.attach[n].path=W,i.attach[n].blob=E,yield o.global.remove_file_from_storage(i.attach[n].url,U)}}delete i.attach[n].thumbnail,delete i.attach[n].alt_path,delete i.attach[n].url,delete i.attach[n].exist}if(yield o.nakama.deleteTodoFromStorage(!0,I,void 0,u),i.remote)try{let n=yield o.nakama.getRemoteTodoCounter(i.remote.isOfficial,i.remote.target);i.id=`RemoteTodo_${n}`}catch{}else i.id=new Date(i.create_at).toISOString().replace(/[:|.|\/]/g,"_");i.noti_id&&(o.nakama.RemoveLocalPushSchedule(i),o.nakama.removeRegisteredId(i.noti_id),o.noti.ClearNoti(i.noti_id)),i.noti_id=o.nakama.get_noti_id();let oe=!1;try{f.attach.forEach(b=>{delete b.exist,delete b.thumbnail,delete b.base64,delete b.blob});let n=JSON.stringify(f.attach),g=JSON.parse(JSON.stringify(i.attach));g.forEach(b=>{delete b.exist,delete b.thumbnail,delete b.base64,delete b.blob}),g=JSON.stringify(g),oe=n!=g}catch{oe=!0}if(q&&oe){if(f)try{for(let g=0,b=f.attach.length;g<b;g++){for(let v=0,D=i.attach.length;v<D;v++)if(i.attach[v].path==f.attach[g].path){f.attach[g].exist=!0,f.attach[g].index=v;break}(!f.attach[g].exist||f.attach[g].exist&&!i.attach[f.attach[g].index])&&(f.attach[g].url?""!==f.attach[g].type&&o.global.remove_file_from_storage(f.attach[g].url,U):yield o.indexed.removeFileFromUserPath(f.attach[g].path))}}catch{}let n;for(let g=0,b=i.attach.length;g<b;g++){let v,D=!1;try{if(n)throw"already exist";v=yield o.indexed.loadBlobFromUserPath(`${i.attach[g].path}_thumbnail.png`,"image/png"),D=!0}catch{}if(!i.attach[g].exist||!n&&"image"==i.attach[g].viewer){try{D||(v=yield o.indexed.loadBlobFromUserPath(i.attach[g].path,i.attach[g].type))}catch{}try{if(1!=i.CDN)throw"FFS \uc0ac\uc6a9 \uc21c\uc704\uc5d0 \uc5c6\uc74c";let E;if(E=yield o.global.try_upload_to_user_custom_fs(i.attach[g],o.nakama.users.self.display_name,u,i.title),!E)throw"\uc5c5\ub85c\ub4dc \uc2e4\ud328";delete i.attach[g].partsize,delete i.attach[g].size,i.attach[g].url=E}catch{try{i.attach[g].path=`todo/${i.id}_${i.remote.isOfficial}_${i.remote.target}/${i.attach[g].filename}`}catch{i.attach[g].path=`todo/${i.id}/${i.attach[g].filename}`}try{v||(v=yield o.indexed.loadBlobFromUserPath(i.attach[g].path,i.attach[g].type)),yield o.indexed.saveBlobToUserPath(v,i.attach[g].path)}catch{}}}else delete i.attach[g].exist;if(!n&&("image"==i.attach[g].viewer||D))try{n=URL.createObjectURL(v)}catch{}}o.p5loading.update({id:u,image:n||null}),n&&(yield new Promise(g=>{new de(b=>{b.setup=()=>{b.noCanvas(),b.loadImage(n,v=>{v.width>v.height?v.resize(v.width/v.height*128,128):v.resize(128,v.height/v.width*128);let E=b.createCanvas(128,128);E.hide(),b.smooth(),b.pixelDensity(1),b.image(v,-(v.width-128)/2,-(v.height-128)/2);let re,W=E.elt.toDataURL("image/png").replace("image/png","image/octet-stream");try{re=`todo/${i.id}_${i.remote.isOfficial}_${i.remote.target}/thumbnail.png`}catch{re=`todo/${i.id}/thumbnail.png`}o.indexed.saveBase64ToUserPath(W,re).then(lt=>{g()}),URL.revokeObjectURL(n),b.remove()},v=>{console.error("Todo-\ub4f1\ub85d\ub41c \uc774\ubbf8\uc9c0 \ubd88\ub7ec\uc624\uae30 \uc2e4\ud328: ",v),g(),URL.revokeObjectURL(n),b.remove()})}})}))}if(!q&&oe&&f){let n;try{n=`todo/${i.id}_${i.remote.isOfficial}_${i.remote.target}/thumbnail.png`}catch{n=`todo/${i.id}/thumbnail.png`}if(yield o.indexed.removeFileFromUserPath(n),f.attach)for(let g=0,b=f.attach.length;g<b;g++)f.attach[g].url?""!==f.attach[g].type&&o.global.remove_file_from_storage(f.attach[g].url,U):yield o.indexed.removeFileFromUserPath(f.attach[g].path)}if(i.attach.forEach(n=>{URL.revokeObjectURL(n.thumbnail),delete n.thumbnail,delete n.exist,delete n.base64}),i.written=(new Date).getTime(),i.startFrom){let n=new Date(i.startFrom).getTime();(new Date).getTime()>n?delete i.startFrom:i.startFrom=n}if(i.limit=new Date(i.limit).getTime(),o.nakama.set_todo_notification(i),i.remote&&!i.remote.creator_id&&(i.remote.creator_id=o.nakama.servers[i.remote.isOfficial][i.remote.target].session.user_id),i.attach.forEach(n=>{URL.revokeObjectURL(n.thumbnail),delete n.thumbnail,delete n.exist,delete n.base64}),q&&oe&&f)for(let n=0,g=f.attach.length;n<g;n++){for(let b=0,v=i.attach.length;b<v;b++)if(i.attach[b].path==f.attach[n].path){f.attach[n].exist=!0,f.attach[n].index=b;break}if(!f.attach[n].exist||f.attach[n].exist&&!i.attach[f.attach[n].index])if(f.attach[n].url)""!==f.attach[n].type&&o.global.remove_file_from_storage(f.attach[n].url,U);else try{yield o.nakama.sync_remove_file(f.attach[n].path,i.remote.isOfficial,i.remote.target,"todo_attach")}catch{}}for(let n=0,g=i.attach.length;n<g;n++)if(i.attach[n].url)delete i.attach[n].path,delete i.attach[n].size,delete i.attach[n].partsize;else try{if(2==i.CDN)throw"ForceSQL";!i.attach[n].blob.size&&i.attach[n].url&&(i.attach[n].blob=yield(yield fetch(i.attach[n].url)).blob());let b=o.nakama.servers[i.remote.isOfficial][i.remote.target].info.address,v=o.nakama.servers[i.remote.isOfficial][i.remote.target].info.useSSL?"https:":"http:",D=`${o.nakama.users.self.display_name}/${i.id}`;try{D=`${i.remote.creator_id}/${i.id}`}catch{}let E=yield o.global.upload_file_to_storage(i.attach[n],{user_id:D,apache_port:U.apache_port,cdn_port:U.cdn_port},v,b,1==i.CDN,u,i.title);if(!E)throw"\ub9c1\ud06c \ub9cc\ub4e4\uae30 \uc2e4\ud328";delete i.attach[n].size,delete i.attach[n].partsize,i.attach[n].url=E}catch(b){console.log("cdn \uc5c5\ub85c\ub4dc \ucc98\ub9ac \uc2e4\ud328: ",b),"ForceSQL"==b&&i.attach[n].url&&(i.attach[n].blob=yield(yield fetch(i.attach[n].url)).blob());try{yield o.nakama.sync_save_file(i.attach[n],i.remote.isOfficial,i.remote.target,"todo_attach")}catch{}}let pe,Ie=yield o.nakama.servers[i.remote.isOfficial][i.remote.target].client.writeStorageObjects(o.nakama.servers[i.remote.isOfficial][i.remote.target].session,[{collection:"server_todo",key:i.id,permission_read:2,permission_write:1,value:i}]);yield o.nakama.updateRemoteCounter(i.remote.isOfficial,i.remote.target),yield o.nakama.servers[i.remote.isOfficial][i.remote.target].client.rpc(o.nakama.servers[i.remote.isOfficial][i.remote.target].session,"send_noti_fn",{receiver_id:o.nakama.servers[i.remote.isOfficial][i.remote.target].session.user_id,title:"Manage_todo_add",content:{type:"add",collection:Ie.acks[0].collection,key:Ie.acks[0].key},code:ye.I.MANAGE_TODO,persistent:!1}),i.is_me=!0,o.global.p5todoAddtodo&&o.global.p5todoAddtodo(JSON.stringify(i));try{pe=`todo/${i.id}_${i.remote.isOfficial}_${i.remote.target}/info.todo`}catch{pe=`todo/${i.id}/info.todo`}yield o.indexed.saveTextFileToUserPath(JSON.stringify(i),pe),o.p5loading.update({id:u,message:`${o.lang.text.TodoDetail.ApplyingTodo}: ${i.title}`,progress:1,forceEnd:1e3})}catch(q){var y,T;console.error("\ud574\uc57c\ud560 \uc77c\uc774 \uc11c\ubc84\uc5d0 \uc804\uc1a1\ub418\uc9c0 \uc54a\uc74c: ",q),null===(y=(T=o.global).p5todoAddtodo)||void 0===y||y.call(T,JSON.stringify(I)),o.p5toast.show({text:o.lang.text.TodoDetail.CanAddToServer}),o.p5loading.update({id:u,message:`${o.lang.text.TodoDetail.ApplyingTodo}: ${i.title}`,forceEnd:1e3})}}});return function(a){return m.apply(this,arguments)}}();const at=()=>{M.x=e.width/2,M.y=e.height/2,S.x=0,S.y=0,j=1,localStorage.setItem("p5todoScale",`${j}`),this.isPlayingCanvas.loop||e.redraw()};let P={Act:!1,lerp:0,Scale:e.createVector(),CamPos:e.createVector(),CamScale:0};const ge=()=>{P.Act=!0,P.Scale.x=M.x,P.Scale.y=M.y,P.CamPos.x=S.x,P.CamPos.y=S.y,P.CamScale=j,this.isPlayingCanvas.loop||e.loop()};e.draw=()=>{e.clear(255,255,255,255),e.push(),e.translate(M),e.scale(j),e.translate(S);for(let m=0,a=s.length;m<a;m++)c[s[m]].display();for(let m=X.length-1;m>=0;m--)X[m].display(),X[m].lifeTime<0&&X.splice(m,1);for(let m=H.length-1;m>=0;m--)H[m].DoneAnim();e.pop(),this.isPlayingCanvas.loop&&(me.x=80*-e.accelerationX,me.y=80*e.accelerationY),P.Act&&(P.lerp+=.07,M.x=e.lerp(P.Scale.x,e.width/2,ie(P.lerp)),M.y=e.lerp(P.Scale.y,e.height/2,ie(P.lerp)),S.x=e.lerp(P.CamPos.x,0,ie(P.lerp)),S.y=e.lerp(P.CamPos.y,0,ie(P.lerp)),j=e.lerp(P.CamScale,1,ie(P.lerp)),localStorage.setItem("p5todoScale",`${j}`),P.lerp>=1&&(P.Act=!1,P.lerp=0,M.x=e.width/2,M.y=e.height/2,S.x=0,S.y=0,j=1,localStorage.setItem("p5todoScale",`${j}`),this.isPlayingCanvas.loop||e.noLoop()))};let ie=m=>e.sin(m*e.PI/2);e.windowResized=()=>{A||setTimeout(()=>{let m=S.x/e.width,a=S.y/e.height;e.resizeCanvas(_.clientWidth,_.clientHeight),M.x=e.width/2,M.y=e.height/2,S.x=m*e.width,S.y=a*e.height},50)};let K=!0;class ke{constructor(a,r=!1){if(this.isAddButton=!1,this.EllipseSize=96,this.Velocity=e.createVector(0,0),this.Accel=e.createVector(0,0),this.isGrabbed=!1,this.TextColor=e.color(ee.ud?255:0),this.ProgressWeight=8,this.LerpProgress=0,this.isHidden=!1,this.LifeTime=1,this.json=a,r)return this.isAddButton=r,this.position=Y.copy(),this.defaultColor=e.color(ee.ud?"#bbb":"#888"),void(this.json={id:"AddButton",written:0,limit:1,longSide:53,shortSide:11});this.Repositioning(),this.initialize()}Repositioning(){const a=e.max(e.width,e.height)||1,r=e.createVector(a/e.min(1,j),0).setHeading(e.random(-e.PI,e.PI));this.position=r}initialize(){if(!this.json.custom_color)switch(this.json.importance){case"0":this.defaultColor=e.color("#58a192");break;case"1":this.defaultColor=e.color("#ddbb41");break;case"2":this.defaultColor=e.color("#b95437")}let r,a=Number(this.json.importance);switch(a){case 0:this.EllipseSize=96;break;case 1:this.EllipseSize=104;break;case 2:this.EllipseSize=112}if(!N[a]){N[a]=e.createImage(this.EllipseSize,this.EllipseSize),N[a].loadPixels();let l=e.createVector(N[a].width/2,N[a].height/2);for(let u=0,d=N[a].height;u<d;u++)for(let y=0,T=N[a].width;y<T;y++){let w=e.createVector(y,u);l.dist(w)<this.EllipseSize/2-1&&N[a].set(y,u,e.color(255,80))}N[a].updatePixels()}try{r=`todo/${this.json.id}_${this.json.remote.isOfficial}_${this.json.remote.target}/thumbnail.png`}catch{r=`todo/${this.json.id}/thumbnail.png`}Te.loadBlobFromUserPath(r,"").then(l=>{const u=URL.createObjectURL(l);e.loadImage(u,d=>{this.ThumbnailImage=d,this.ThumbnailImage.mask(N[a]),URL.revokeObjectURL(u)})}).catch(l=>{this.ThumbnailImage=null})}display(){if(e.push(),this.isGrabbed||(this.CalcPosition(),this.OnCollider(),this.position=this.position.add(this.Velocity)),e.translate(this.position),this.LerpProgress=e.map(Date.now(),this.json.startFrom||this.json.written,this.json.limit,0,1,!0),(this.isAddButton||this.json.written>this.json.limit)&&(this.LerpProgress=1),this.isHidden?e.fill(128,40):e.fill("FilterByCreator"==Ce&&this.json.remote?V.colors[V.groupServer[this.json.remote.isOfficial][this.json.remote.target]||"offline"]+e.hex(e.floor(e.lerp(34,96,this.LerpProgress)),2):(this.json.custom_color||this.defaultColor.toString("#rrggbb"))+e.hex(e.floor(e.lerp(34,96,this.LerpProgress)),2)),e.ellipse(0,0,this.EllipseSize,this.EllipseSize),!this.isHidden&&this.ThumbnailImage&&e.image(this.ThumbnailImage,0,0,this.EllipseSize,this.EllipseSize),e.push(),!this.isHidden){e.noFill(),this.isAddButton?(e.push(),e.noStroke(),e.fill(255),e.rect(0,0,this.json.shortSide,this.json.longSide),e.rect(0,0,this.json.longSide,this.json.shortSide),e.pop()):(e.stroke(this.json.custom_color||this.defaultColor),e.strokeWeight(this.ProgressWeight)),e.rotate(-e.PI/2);let a=this.EllipseSize-this.ProgressWeight;this.LerpProgress<1?e.arc(0,0,a,a,0,this.LerpProgress*e.TWO_PI):e.circle(0,0,a)}if(e.pop(),!this.isHidden){let a=.9*this.EllipseSize;this.TextColor=e.color(ee.ud?255:0,0==this.LerpProgress?128:255),e.fill(this.TextColor),e.text(this.json.title,0,0,a,a)}e.pop()}CalcPosition(){let a=this.position.dist(Y),r=e.map(a,0,this.EllipseSize/8,0,1,!0),l=e.map(r,this.EllipseSize/4,0,1,.95,!0);this.Accel.x=r,this.Accel.y=0;let u=this.position.copy().sub(me).heading()-e.PI;this.Accel=this.Accel.setHeading(u),this.Velocity.add(this.Accel).mult(l)}OnCollider(){for(let a=0,r=s.length;a<r;a++)if(c[s[a]]!=this){let l=c[s[a]],u=this.position.dist(l.position),d=this.EllipseSize/2+l.EllipseSize/2;u<d&&(J.loop||he==this&&(he=null,e.noLoop()),this.ReflectBounce(l,u/d),l.ReflectBounce(this,u/d))}}ReflectBounce(a,r){let l=de.Vector.sub(this.position,a.position);this.Velocity.add(l.mult(1-r)).mult(.85)}makeDone(){var a=this;return(0,z.A)(function*(){a.LifeTime=1,yield new Promise(r=>setTimeout(r,500)),a.Velocity=Y.copy(),a.Accel=Y.copy(),a.OriginalEllipseSize=a.EllipseSize,a.OriginalProgWeight=a.ProgressWeight,a.json.done=!0,H.push(a),J.loop||e.loop()})()}DoneAnim(){var a=this;return(0,z.A)(function*(){if(J.loop||e.loop(),a.LifeTime-=.04,a.EllipseSize=a.OriginalEllipseSize*a.LifeTime,a.ProgressWeight=a.OriginalProgWeight*a.LifeTime,a.LifeTime<.5&&X.push(new je(a.position,a.json.custom_color||a.defaultColor)),a.TextColor=e.color(ee.ud?255:0,(0==a.LerpProgress?128:255)*a.LifeTime),a.isAddButton&&(a.json.longSide*=a.LifeTime,a.json.shortSide*=a.LifeTime),a.LifeTime<0){J.loop||setTimeout(()=>e.noLoop(),1e3),a.RemoveTodo(),ae();for(let r=0;r<20;r++)X.push(new je(a.position,a.json.custom_color||a.defaultColor))}})()}Clicked(){K&&!A&&!this.json.done&&(this.isAddButton?te.open_add_todo_page():te.open_add_todo_page(JSON.stringify(this.json)))}RemoveTodo(){let a=this.json.id;this.json.remote&&(a+=`_${this.json.remote.isOfficial}_${this.json.remote.target}`);for(let r=s.length-1;r>=0;r--)if(s[r]==a){s.splice(r,1);break}for(let r=H.length-1;r>=0;r--)if(H[r]=this){H.splice(r,1);break}delete c[a]}}class je{constructor(a,r){this.RectSize=4,this.rotate=0,this.pos=a.copy(),e.randomSeed(e.random(-255,255)),this.lifeTime=e.random(180,255),this.vel=e.createVector(e.random(-75,75),e.random(-40,-80)),this.acc=e.createVector(0,e.random(-1,-3)),e.push(),e.colorMode(e.HSB);let l=e.hue(r),u=e.saturation(r),d=e.brightness(r);this.color=e.color(e.random(l-20,l+20),e.random(u-20,u+20),e.random(d-20,d+20),this.lifeTime/255),e.pop(),this.RectSize=e.random(3,4),this.rotate=e.random(-e.PI,e.PI)}display(){this.color.setAlpha(this.lifeTime/255),e.fill(this.color),this.CalcPhysics(),e.push(),e.translate(this.pos),e.rotate(this.rotate),e.rect(0,0,this.RectSize,this.RectSize),e.pop(),this.lifeTime--}CalcPhysics(){this.acc.y+=.07,this.vel.add(this.acc),this.pos.add(this.vel.copy().div(100))}}let ne,B,Pe,L,fe=0;e.mousePressed=m=>{let a=m.target==document.getElementById("p5todo");if(!A&&a)switch(K=!0,m.which){case 1:B=e.createVector(e.mouseX,e.mouseY),L=S.copy(),ne=e.createVector(e.mouseX,e.mouseY);for(let r=s.length-1;r>=0;r--)if(c[s[r]].position.dist(G())<c[s[r]].EllipseSize/2){c[s[r]].isGrabbed=!0,F=c[s[r]],B=G();break}break;case 2:ge()}},e.mouseDragged=m=>{let a=m.target==document.getElementById("p5todo");if(!A&&a&&1===(this.isPlayingCanvas.loop||e.redraw(),m.which))try{ne=e.createVector(e.mouseX,e.mouseY);let r=0;F?(F.position=G(),r=B.dist(G())):(S=L.copy().add(ne.sub(B).div(j)),r=L.dist(S)),r>15&&(K=!1)}catch{}},e.mouseReleased=m=>{let a=m.target==document.getElementById("p5todo");!A&&a&&1===m.which&&(ne=null,we())};let G=(m,a)=>{let r=e.createVector(m||e.mouseX,a||e.mouseY);return r.sub(M),r.div(j),r.sub(S),r};e.mouseWheel=m=>{let a=m.target==document.getElementById("p5todo");!A&&a&&(this.isPlayingCanvas.loop||e.redraw(),j*=m.deltaY<0?1.1:.9,localStorage.setItem("p5todoScale",`${j}`))};let R=[],Q=!1;const Z=56;e.touchStarted=m=>{let a=m.target==document.getElementById("p5todo");if(!A&&a)switch(K=!0,R=m.touches,Q=!0,R.length){case 1:Fe();break;case 2:let r=e.createVector(R[0].clientX,R[0].clientY-Z),l=e.createVector(R[1].clientX,R[1].clientY-Z);K=!1,fe=r.dist(l),B=r.copy().add(l).div(2),L=S.copy(),Pe=j,F&&(F.isGrabbed=!1,F.Velocity=Y.copy(),F.Accel=Y.copy(),F=null);break;default:Q=!1,ge()}},e.touchMoved=m=>{let a=m.target==document.getElementById("p5todo");if(!A&&a){switch(this.isPlayingCanvas.loop||e.redraw(),R=m.touches,R.length){case 1:{if(!Q)return;let r=m.changedTouches[0],l=e.createVector(r.clientX,r.clientY-Z),u=0;F?(F.position=G(),u=B.dist(G(l.x,l.y))):(S=L.copy().add(l.sub(B).div(j)),u=L.dist(S)),u>15&&(K=!1)}break;case 2:{if(!Q)return;let r=e.createVector(R[0].clientX,R[0].clientY-Z),l=e.createVector(R[1].clientX,R[1].clientY-Z),u=r.copy().add(l).div(2);j=r.dist(l)/fe*Pe,localStorage.setItem("p5todoScale",`${j}`),S=L.copy().add(u.sub(B).div(j))}}return!1}},e.touchEnded=m=>{let a=m.target==document.getElementById("p5todo");if(!A&&a)switch(R=m.touches,R.length){case 0:we(),Q=!1;break;case 1:if(!Q)return;Fe(),fe=0}};let Fe=()=>{B=e.createVector(R[0].clientX,R[0].clientY-Z),L=S.copy();for(let m=s.length-1;m>=0;m--)if(c[s[m]].position.dist(G(B.x,B.y))<c[s[m]].EllipseSize/2){c[s[m]].isGrabbed=!0,F=c[s[m]];break}},Re=()=>{F&&(F.isGrabbed=!1,F.Velocity=Y.copy(),F.Accel=Y.copy(),F=null)},we=()=>{Re(),B=null;try{if(L.dist(S)<15)for(let a=s.length-1;a>=0;a--)if(c[s[a]].position.dist(G())<c[s[a]].EllipseSize/2){c[s[a]].Clicked();break}}catch{}}})}ionViewDidEnter(){document.getElementById("p5todo")||this.global.p5todo?this.global.p5todoPlayCanvas():this.CreateTodoManager(),this.try_add_shortcut()}try_add_shortcut(){this.global.p5KeyShortCut?(this.global.p5KeyShortCut.AddAct=()=>{this.nakama.open_add_todo_page()},this.global.p5KeyShortCut.Backquote=()=>{this.SwitchTargetFilter()},this.global.p5KeyShortCut.Digit=o=>{this.AllCategories[this.TargetFilterName].length>o&&this.ChangeFilterValue(this.AllCategories[this.TargetFilterName][o].value)}):setTimeout(()=>{this.try_add_shortcut()},100)}ionViewWillLeave(){this.global.p5todoStopCanvas&&this.global.p5todoStopCanvas(),this.global.p5KeyShortCut&&(delete this.global.p5KeyShortCut.AddAct,delete this.global.p5KeyShortCut.Backquote,delete this.global.p5KeyShortCut.Digit)}}return(h=k).\u0275fac=function(o){return new(o||h)(t.rXU(ee.z3),t.rXU(Me.y),t.rXU(ye.X),t.rXU(Be.j),t.rXU(Oe.n),t.rXU(O.hG),t.rXU($e.f),t.rXU(Ne.r),t.rXU(Ve.G))},h.\u0275cmp=t.VBU({type:h,selectors:[["app-main"]],viewQuery:function(o,_){if(1&o&&t.GBs(Le,5),2&o){let e;t.mGM(e=t.lsd())&&(_.LocalToRemoteSel=e.first)}},decls:18,vars:8,consts:[["LocalToRemoteSel",""],[1,"ion-no-border"],[1,"play_button",3,"click"],["button","","style","width: 24px; height: 24px;","name","play-circle",4,"ngIf"],["button","","style","width: 24px; height: 24px;","name","pause-circle",4,"ngIf"],[1,"add_button",3,"click"],["class","shortcut_hint shortcut_top_add",4,"ngIf"],["button","","name","add-circle-outline",2,"width","24px","height","24px"],[1,"header_online_circle",3,"click"],["oncontextmenu","return false;"],[4,"ngIf"],["dismissOnSelect",""],["id","todo",1,"full_screen",2,"overflow","hidden"],["style","position: absolute; top: 16px; left: 16px;",4,"ngIf"],["button","","name","play-circle",2,"width","24px","height","24px"],["button","","name","pause-circle",2,"width","24px","height","24px"],[1,"shortcut_hint","shortcut_top_add"],[1,"disconnect_info",3,"click"],["color","medium","name","create-outline",2,"width","60px","height","60px"],["color","medium"],[4,"ngFor","ngForOf"],["button","",3,"click"],[2,"position","absolute","top","16px","left","16px"],[1,"FilterSwitchButton",3,"click"],["class","shortcut_hint shortcut_todo_categories",4,"ngIf"],[1,"shortcut_hint","shortcut_todo_categories"],[1,"FilterSwitchButton",3,"click","contextmenu","id"],["type","text",3,"input","blur","focus","placeholder"]],template:function(o,_){if(1&o){const e=t.RV6();t.j41(0,"ion-header",1)(1,"ion-toolbar")(2,"ion-title"),t.EFF(3),t.k0s(),t.j41(4,"div",2),t.bIt("click",function(){return t.eBV(e),t.Njj(_.toggleCanvasPlaying())}),t.DNE(5,Ge,1,0,"ion-icon",3)(6,Ue,1,0,"ion-icon",4),t.k0s(),t.j41(7,"div",5),t.bIt("click",function(){return t.eBV(e),t.Njj(_.nakama.open_add_todo_page())}),t.DNE(8,ze,2,0,"div",6),t.nrm(9,"ion-icon",7),t.k0s(),t.j41(10,"div",8),t.bIt("click",function(){return t.eBV(e),t.Njj(_.toggle_session())}),t.k0s()()(),t.j41(11,"ion-content",9),t.DNE(12,He,6,1,"div",10),t.j41(13,"ion-popover",11,0),t.DNE(15,Ye,5,2,"ng-template"),t.k0s(),t.j41(16,"div",12),t.DNE(17,qe,5,3,"div",13),t.k0s()()}2&o&&(t.R7$(3),t.JRh(_.lang.text.Main.Title),t.R7$(2),t.Y8G("ngIf",!_.isPlayingCanvas.loop),t.R7$(),t.Y8G("ngIf",_.isPlayingCanvas.loop),t.R7$(2),t.Y8G("ngIf",_.global.ShowHint),t.R7$(2),t.Aen("background-color: "+_.statusBar.colors[_.statusBar.settings.groupServer]+"; cursor: pointer;"),t.R7$(2),t.Y8G("ngIf",_.isEmptyTodo),t.R7$(5),t.Y8G("ngIf",!_.isEmptyTodo))},dependencies:[ce.Sq,ce.bT,O.W9,O.eU,O.iq,O.uz,O.Dg,O.he,O.BC,O.ai,O.CF],styles:[".play_button[_ngcontent-%COMP%]{position:absolute;right:116px;top:16px;cursor:pointer}.add_button[_ngcontent-%COMP%]{position:absolute;right:68px;top:16px;cursor:pointer}.FilterSwitchButton[_ngcontent-%COMP%]{padding:8px;border-radius:8px;font-size:16px;background-color:#8888;margin-right:8px;margin-bottom:8px;color:var(--default-text-color-direction)}"]}),k})()},{path:"add-todo-menu",loadChildren:()=>Promise.all([x.e(2076),x.e(8163)]).then(x.bind(x,8163)).then(h=>h.AddTodoMenuPageModule)}];let tt=(()=>{var h;class k{}return(h=k).\u0275fac=function(o){return new(o||h)},h.\u0275mod=t.$C({type:h}),h.\u0275inj=t.G2t({imports:[be.iI.forChild(et),be.iI]}),k})(),it=(()=>{var h;class k{}return(h=k).\u0275fac=function(o){return new(o||h)},h.\u0275mod=t.$C({type:h}),h.\u0275inj=t.G2t({imports:[ce.MD,Ee.YN,O.bv,tt]}),k})()}}]);