"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[4020],{4020:(J,w,p)=>{p.d(w,{j:()=>W});var f=p(467),R=p(8326),x=p(5402),b=p(482),m=p(3953),N=p(9900),M=p(755),B=p(4234),L=p(4237);!function k(){("http:"!=window.location.protocol||0==window.location.host.indexOf("localhost"))&&p.e(925).then(p.t.bind(p,925,23))}();let W=(()=>{var E;class T{constructor(t,e,n,i,s){this.p5toast=t,this.indexed=e,this.lang=n,this.nakama=i,this.global=s,this.Peers={},this.OnUse=!1,this.StatusText="",this.nakama.WebRTCService=this,this.global.WebRTCService=this}initialize(t,e){var n=this;return(0,f.A)(function*(){if(n.OnUse&&"data"!=t)throw n.p5toast.show({text:n.lang.text.WebRTCDevManager.AlreadyCalling}),n.lang.text.WebRTCDevManager.AlreadyCalling;if("data"!=t&&("http:"==window.location.protocol&&0!=window.location.host.indexOf("localhost")||!(yield x.R.requestAudioRecordingPermission()).value))throw n.lang.text.WebRTCDevManager.SecurityError;if(yield n.close_webrtc(e),n.Peers[e]||(n.Peers[e]={}),n.Peers[e].TypeIn=t,n.Peers[e].IceCandidates=[],n.Peers[e].ReceivedOfferPart="",n.Peers[e].ReceivedAnswerPart="","data"!=t){n.createP5_panel(e);try{var i,s;n.localMedia=document.createElement(t),n.localMedia.id="webrtc_video",n.localMedia.style.width="100%",n.localMedia.style.height="fit-content",n.localMedia.autoplay=!0,"video"==t&&(n.localMedia.playsInline=!0),n.localMedia.muted=!0,document.body.appendChild(n.localMedia),n.remoteMedia=document.createElement(t),n.remoteMedia.id="webrtc_video_remote",n.remoteMedia.style.width="100%",n.remoteMedia.style.height="fit-content",n.remoteMedia.autoplay=!0,"video"==t&&(n.remoteMedia.playsInline=!0),document.body.appendChild(n.remoteMedia);let o,a,r=yield n.getDeviceList(),d=Number(null!==(i=localStorage.getItem("VideoInputDev"))&&void 0!==i?i:NaN),u=Number(null!==(s=localStorage.getItem("AudioInputDev"))&&void 0!==s?s:NaN);for(let c=0,g=r.length,P=0,_=0;c<g&&(!o||!a);c++)!o&&"audioinput"==r[c].kind&&(Number.isNaN(u)?(o=r[c].deviceId,localStorage.setItem("AudioInputDev",`${_}`)):_==u&&(o=r[c].deviceId),_++),!a&&"videoinput"==r[c].kind&&(Number.isNaN(d)?(a=r[c].deviceId,localStorage.setItem("AudioInputDev",`${P}`)):P==d&&(a=r[c].deviceId),P++);let h={};"video"==t?(h.video=!0,a&&(h.video={deviceId:a})):h.video=!1,h.audio=!0,o&&(h.audio={deviceId:o}),n.localStream=yield navigator.mediaDevices.getUserMedia(h),n.localMedia.srcObject=n.localStream}catch(r){console.log("navigator.getUserMedia error: ",r),yield n.close_webrtc(e),n.p5toast.show({text:`${n.lang.text.WebRTCDevManager.InitErr}: ${r}`})}}yield n.createCall(e),n.p5callButton&&(n.p5callButton.elt.disabled=!1)})()}WEBRTC_INIT_REQ_SIGNAL(t,e){let n=JSON.stringify(this.Peers[e].LocalOffer);this.Peers[e].LocalOfferPartArray=n.match(/(.{1,64})/g),this.WEBRTC_REPLY_INIT_SIGNAL_PART(t,e)}WEBRTC_REPLY_INIT_SIGNAL_PART(t,e){if(t.client&&t.client.readyState==t.client.OPEN){let n=this.Peers[e].LocalOfferPartArray.shift();t.client.send(n?JSON.stringify({type:"socket_react",channel:t.channel,act:"WEBRTC_REPLY_INIT_SIGNAL",data_str:n}):JSON.stringify({type:"socket_react",channel:t.channel,act:"WEBRTC_REPLY_INIT_SIGNAL",data_str:"EOL"}))}}WEBRTC_REPLY_INIT_SIGNAL(t,e,n){"EOL"==t?(this.createRemoteOfferFromAnswer(JSON.parse(this.Peers[n].ReceivedOfferPart),n),this.Peers[n].ReceivedOfferPart=""):(this.Peers[n].ReceivedOfferPart+=t,e.client&&e.client.readyState==e.client.OPEN&&e.client.send(JSON.stringify({type:"socket_react",channel:e.channel,act:"WEBRTC_REPLY_INIT_SIGNAL_PART"})))}WEBRTC_RECEIVE_ANSWER(t,e,n){"EOL"==t?(this.ReceiveRemoteAnswer(JSON.parse(this.Peers[n].ReceivedAnswerPart),e,n),this.Peers[n].ReceivedAnswerPart=""):this.Peers[n].ReceivedAnswerPart+=t}WEBRTC_ICE_CANDIDATES(t,e,n){this.ReceiveIceCandidate(JSON.parse(t),e,n)}WEBRTC_NEGOCIATENEEDED(t,e){"EOL"==t?(this.createRemoteOfferFromAnswer(JSON.parse(this.Peers[e].ReceivedOfferPart),e),this.Peers[e].ReceivedOfferPart="",this.CreateAnswer(void 0,e)):this.Peers[e].ReceivedOfferPart+=t}createP5_panel(t){var e=this;this.OnUse=!0,this.p5canvas&&(clearTimeout(this.p5waitingAct),this.p5waitingAct=null,this.p5callButton&&this.p5callButton.remove(),this.p5callButton=null,this.p5hangup=null,this.p5canvas.remove()),this.p5canvas=new R(n=>{let i,s,o,a,d,u,h,c,g=1;n.setup=()=>{let l,O=()=>{this.Peers[t].JoinInited?(l.stop(.1),clearTimeout(this.p5waitingAct)):(l&&l.stop(.1),l=new R.Oscillator(380,"sine"),l.start(),l.amp(1,.15),l.amp(0,.75),this.p5waitingAct=setTimeout(()=>{O()},1200))};this.p5waitingAct=setTimeout(()=>{O()},0),this.p5hangup=()=>{l.stop(.1),clearTimeout(this.p5waitingAct),l=new R.Oscillator(380,"sine"),l.start(),l.freq(250,.35),l.amp(1,.15),l.amp(0,.25),l.amp(1,.35),l.amp(0,.45)},n.noCanvas(),i=n.createDiv(),i.id("outterDiv"),i.style("position: absolute; left: 50%; top: 0px; z-index: 1"),i.style("transform: translateX(-50%)"),i.style("width: fit-content; height: fit-content"),i.style("padding: 8px 16px;"),i.style("display: flex; justify-content: center;"),o=n.createDiv(),o.parent(i),o.style("display: flex; justify-content: center;"),o.style("width: fit-content; height: fit-content"),o.style("border-radius: 32px"),o.style("background: var(--toast-background-color)"),o.style("padding: 6px 12px"),s=n.createDiv(),s.parent(o),s.id("webrtc_content"),s.style("display: flex; justify-content: center;"),s.style("flex-direction","column"),s.style("width: fit-content; height: fit-content"),s.style("word-break: break-all"),s.style("background: var(--toast-background-color)"),s.style("border-radius: 32px"),s.style("padding: 6px 12px"),s.style("color: "+(b.ud?"white":"black")),D(),a=n.createDiv(),a.parent(s),a.id("webrtc_content"),a.style("display: flex; justify-content: center;"),a.style("align-self","center"),a.style("width: fit-content; height: fit-content"),this.p5callButton=n.createButton('<ion-icon style="width: 32px; height: 32px;" name="call-outline"></ion-icon>'),this.p5callButton.parent(a),this.p5callButton.style("padding","0px"),this.p5callButton.style("margin","4px"),this.p5callButton.style("border-radius","16px"),this.p5callButton.style("width","40px"),this.p5callButton.style("height","40px"),this.p5callButton.mouseClicked(()=>{this.CreateAnswer(void 0,t)}),this.p5callButton.elt.disabled=!0,this.p5callButton=this.p5callButton,d=n.createButton('<ion-icon style="width: 32px; height: 32px;" name="mic-outline"></ion-icon>'),d.parent(a),d.style("padding","0px"),d.style("margin","4px"),d.style("border-radius","16px"),d.style("width","40px"),d.style("height","40px"),d.mouseClicked(()=>{const y=this.localStream.getAudioTracks();for(let C=0,v=y.length;C<v;C++)y[C].enabled=!1;u.show(),d.hide()}),u=n.createButton('<ion-icon style="width: 32px; height: 32px;" name="mic-off-outline"></ion-icon>'),u.parent(a),u.style("background-color","grey"),u.style("padding","0px"),u.style("margin","4px"),u.style("border-radius","16px"),u.style("width","40px"),u.style("height","40px"),u.mouseClicked(()=>{const y=this.localStream.getAudioTracks();for(let C=0,v=y.length;C<v;C++)y[C].enabled=!0;d.show(),u.hide()}),u.hide(),h=n.createButton('<ion-icon style="width: 32px; height: 32px;" name="settings-outline"></ion-icon>'),h.parent(a),h.style("padding","0px"),h.style("margin","4px"),h.style("border-radius","16px"),h.style("width","40px"),h.style("height","40px"),h.mouseClicked((0,f.A)(function*(){h.elt.disabled=!0;let y=yield e.getDeviceList();e.global.PageDismissAct["webrtc-manage"]=function(){var C=(0,f.A)(function*(v){h.elt.disabled=!1;try{let A={};"video"==e.Peers[t].TypeIn&&v.data.videoinput&&(A.video={deviceId:{exact:v.data.videoinput.deviceId}}),v.data.audioinput&&(A.audio={deviceId:{exact:v.data.audioinput.deviceId}}),e.localStream.getTracks().forEach(S=>S.stop()),e.localStream=yield navigator.mediaDevices.getUserMedia(A),e.localMedia.srcObject=e.localStream,e.Peers[t].PeerConnection.getSenders().forEach(S=>{S.track&&S.replaceTrack(e.localStream.getTracks()[0])}),e.CreateOffer(t)}catch(A){console.log("\ubbf8\ub514\uc5b4 \uc2a4\ud2b8\ub9bc \ubcc0\uacbd \uc624\ub958: ",A)}e.global.RestoreShortCutAct("webrtc-manage"),delete e.global.PageDismissAct["webrtc-manage"]});return function(v){return C.apply(this,arguments)}}(),e.global.StoreShortCutAct("webrtc-manage"),e.global.ActLikeModal("webrtc-manage-io-dev",{list:JSON.parse(JSON.stringify(y)),typein:e.Peers[t].TypeIn,dismiss:"webrtc-manage"})})),c=n.createButton('<ion-icon style="width: 32px; height: 32px;" name="close-circle-outline"></ion-icon>'),c.parent(a),c.style("background-color","red"),c.style("padding","0px"),c.style("margin","4px"),c.style("border-radius","16px"),c.style("width","40px"),c.style("height","40px"),c.mouseClicked((0,f.A)(function*(){yield e.close_webrtc(t)}))};let _=!1;n.draw=()=>{g>0&&(g-=.03),D(),this.OnUse||this.p5hangup&&!_&&(this.p5hangup(),i.hide(),setTimeout(()=>{this.OnUse||(clearTimeout(this.p5waitingAct),this.p5waitingAct=null,this.p5callButton.remove(),this.p5callButton=null,this.p5hangup=null,this.p5canvas.remove())},1e3),_=!0)};let D=()=>{let l=n.lerpColor(n.color("#"+(b.ud?"30564e88":"b9543788")),n.color("#ffd94ebb"),g).levels,O=4*g;o.style(`padding: ${O}px ${O}px`),s.style(`padding: ${n.lerp(6,2,g)}px ${n.lerp(12,8,g)}px`),o.style(`background: rgba(${l[0]}, ${l[1]}, ${l[2]}, ${l[3]/255})`)}})}getDeviceList(){return(0,f.A)(function*(){return yield navigator.mediaDevices.enumerateDevices()})()}createCall(t){var e=this;return(0,f.A)(function*(){let n;e.Peers[t].isConnected=!0;try{let i=yield e.indexed.loadTextFromUserPath("servers/webrtc_server.json");n={},n.iceServers=JSON.parse(i)}catch{}(!n||!n.iceServers||!n.iceServers.length)&&(e.p5toast.show({text:e.lang.text.WebRTCDevManager.NoRegServer}),n=null),e.Peers[t].PeerConnection=new RTCPeerConnection(n),e.Peers[t].PeerConnection.onicecandidate=i=>e.handleConnection(i,t),e.Peers[t].PeerConnection.oniceconnectionstatechange=i=>{console.log("ICE Connection state: ",e.Peers[t].PeerConnection.iceConnectionState)},e.Peers[t].PeerConnection.onconnectionstatechange=function(){var i=(0,f.A)(function*(s){switch(s.target.connectionState){case"failed":case"disconnected":yield e.close_webrtc(t);break;case"connected":e.p5waitingAct&&clearTimeout(e.p5waitingAct);break;default:console.log("\uc5f0\uacb0 \uc0c1\ud0dc \ubcc0\uacbd\ub428: ",s.target.connectionState)}});return function(s){return i.apply(this,arguments)}}(),"data"!=e.Peers[t].TypeIn?(e.localStream.getTracks().forEach(i=>e.Peers[t].PeerConnection.addTrack(i,e.localStream)),e.Peers[t].PeerConnection.ontrack=i=>{e.remoteMedia.srcObject=i.streams[0]}):e.createDataChannel(void 0,t),e.Peers[t].PeerConnection.ondatachannel=i=>{e.Peers[t].dataChannel=i.channel},e.Peers[t].PeerConnection.onnegotiationneeded=function(){var i=(0,f.A)(function*(s){e.Peers[t].JoinInited&&(yield e.Peers[t].PeerConnection.createOffer({offerToReceiveVideo:!0}).then(r=>e.createdOffer(r,t)).catch(r=>e.setSessionDescriptionError(r)))});return function(s){return i.apply(this,arguments)}}()})()}createDataChannel(t,e){this.Peers[e].dataChannel=this.Peers[e].PeerConnection.createDataChannel(t),this.createDataChannelListener(e)}createDataChannelListener(t){this.Peers[t].dataChannel.onopen=e=>{this.Peers[t].dataChannelOpenAct&&this.Peers[t].dataChannelOpenAct()},this.Peers[t].dataChannel.onclose=e=>{this.Peers[t].dataChannelOnCloseAct&&this.Peers[t].dataChannelOnCloseAct(),this.Peers[t].dataChannelOpenAct=null,this.Peers[t].dataChannelOnMsgAct=null,this.Peers[t].dataChannelOnCloseAct=null},this.Peers[t].dataChannel.onmessage=e=>{this.Peers[t].dataChannelOnMsgAct&&this.Peers[t].dataChannelOnMsgAct(e.data)}}CreateOffer(t){this.p5callButton&&this.p5callButton.hide(),this.Peers[t].PeerConnection.createOffer({offerToReceiveVideo:!0}).then(e=>this.createdOffer(e,t)).catch(e=>this.setSessionDescriptionError(e))}handleConnection(t,e){let n=t.candidate;n&&this.Peers[e].IceCandidates.push(new RTCIceCandidate(n))}ReceiveIceCandidate(t,e,n){var i=this;this.ReplyIceCandidate&&clearTimeout(this.ReplyIceCandidate),this.ReplyIceCandidate=setTimeout((0,f.A)(function*(){var s;for(let o=0,a=null===(r=i.Peers)||void 0===r||null===(r=r[n])||void 0===r||null===(r=r.IceCandidates)||void 0===r?void 0:r.length;o<a;o++){var r;e.client&&e.client.readyState==e.client.OPEN&&e.client.send(JSON.stringify({type:"socket_react",act:"WEBRTC_ICE_CANDIDATES",channel:e.channel,data_str:JSON.stringify(i.Peers[n].IceCandidates[o])})),yield new Promise(d=>setTimeout(d,i.global.WebsocketRetryTerm))}null!==(s=i.Peers)&&void 0!==s&&null!==(s=s[n])&&void 0!==s&&s.IceCandidates&&(i.Peers[n].IceCandidates.length=0)}),800),this.Peers[n].PeerConnection.addIceCandidate(t).then(()=>{console.log("Success to add new ice candidate")}).catch(s=>{console.error("failed to add ice candidate: ",s)})}createdOffer(t,e){this.Peers[e].LocalOffer=t,this.Peers[e].PeerConnection.setLocalDescription(t).then(()=>{this.setLocalDescriptionSuccess(this.Peers[e].PeerConnection)}).catch(n=>this.setSessionDescriptionError(n))}createRemoteOfferFromAnswer(t,e){this.Peers[e].PeerConnection.setRemoteDescription(t).then(()=>{this.setRemoteDescriptionSuccess(this.Peers[e].PeerConnection)}).catch(n=>this.setSessionDescriptionError(n))}CreateAnswer(t,e){this.Peers[e].PeerConnection.createAnswer().then(n=>this.createdAnswer(n,t,e)).catch(n=>this.setSessionDescriptionError(n))}setLocalDescriptionSuccess(t){this.setDescriptionSuccess(t,"setLocalDescription")}setRemoteDescriptionSuccess(t){this.setDescriptionSuccess(t,"setRemoteDescription")}createdAnswer(t,e,n){var i=this;return(0,f.A)(function*(){i.p5callButton&&i.p5callButton.hide(),i.Peers[n].LocalAnswer=t,i.Peers[n].PeerConnection.setLocalDescription(t).then(()=>{i.setLocalDescriptionSuccess(i.Peers[n].PeerConnection)}).catch(o=>i.setSessionDescriptionError(o));let r=JSON.stringify(t).match(/(.{1,64})/g);for(let o=0,a=r.length;o<a;o++)e.client&&e.client.readyState==e.client.OPEN&&(e.client.send(JSON.stringify({type:"socket_react",act:"WEBRTC_RECEIVE_ANSWER",channel:e.channel,data_str:r[o]})),yield new Promise(d=>setTimeout(d,i.global.WebsocketRetryTerm)));e.client&&e.client.readyState==e.client.OPEN&&e.client.send(JSON.stringify({type:"socket_react",act:"WEBRTC_RECEIVE_ANSWER",channel:e.channel,data_str:"EOL"})),i.Peers[n].JoinInited=!0})()}ReceiveRemoteAnswer(t,e,n){var i=this;return(0,f.A)(function*(){i.Peers[n].PeerConnection.setRemoteDescription(t).then(()=>{i.setRemoteDescriptionSuccess(i.Peers[n].PeerConnection)}).catch(s=>i.setSessionDescriptionError(s));for(let s=0,r=i.Peers[n].IceCandidates.length;s<r;s++)e.client&&e.client.readyState==e.client.OPEN&&(e.client.send(JSON.stringify({type:"socket_react",channel:e.channel,act:"WEBRTC_ICE_CANDIDATES",data_str:JSON.stringify(i.Peers[n].IceCandidates[s])})),yield new Promise(o=>setTimeout(o,i.global.WebsocketRetryTerm)));i.Peers[n].IceCandidates.length=0})()}setSessionDescriptionError(t){console.error(`Failed to create session description: ${t}.`)}setDescriptionSuccess(t,e){console.log(`Local ${e} complete.`)}HangUpCall(t){this.Peers[t].isConnected=!1,this.Peers[t].PeerConnection&&(this.Peers[t].PeerConnection.close(),this.Peers[t].PeerConnection.onicecandidate=null,this.Peers[t].PeerConnection.oniceconnectionstatechange=null,this.Peers[t].PeerConnection.onconnectionstatechange=null,this.Peers[t].PeerConnection.ontrack=null,this.Peers[t].PeerConnection.ondatachannel=null,this.Peers[t].PeerConnection.onnegotiationneeded=null),this.Peers[t].PeerConnection=null}close_webrtc(t){var e=this;return(0,f.A)(function*(){var n,i;e.Peers[t]&&(e.HangUpCall(t),yield null===(n=(i=e.Peers[t]).HangUpCallBack)||void 0===n?void 0:n.call(i),"data"!=e.Peers[t].TypeIn&&(e.OnUse=!1,e.p5hangup&&e.p5hangup(),e.localMedia&&e.localMedia.remove(),e.remoteMedia&&e.remoteMedia.remove(),e.localStream&&(e.localStream.getVideoTracks().forEach(s=>s.stop()),e.localStream.getAudioTracks().forEach(s=>s.stop())),e.localMedia=null,e.localStream=null,e.remoteMedia=null),e.Peers[t].dataChannel&&(e.Peers[t].dataChannel.onopen=null,e.Peers[t].dataChannel.onclose=null,e.Peers[t].dataChannel.onmessage=null),delete e.Peers[t])})()}}return(E=T).\u0275fac=function(t){return new(t||E)(m.KVO(N.G),m.KVO(M.n),m.KVO(B.y),m.KVO(L.X),m.KVO(b.z3))},E.\u0275prov=m.jDH({token:E,factory:E.\u0275fac,providedIn:"root"}),T})()}}]);