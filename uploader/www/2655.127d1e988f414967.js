"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[2655],{2655:(it,ve,b)=>{b.r(ve),b.d(ve,{VoidDrawPageModule:()=>je});var oe=b(177),De=b(4341),y=b(5374),ee=b(9858),P=b(467),fe=b(8326),_e=b(92),a=b(3953),Te=b(4234),Ae=b(3656),Ie=b(482),We=b(755),Pe=b(4237),Le=b(9900),Ve=b(4020);const Me=["RemoteDraw"],Oe=["AddrQRShare"];function He(g,_){1&g&&(a.j41(0,"div",14),a.EFF(1,"Shift + S"),a.k0s())}function Ne(g,_){if(1&g&&(a.j41(0,"ion-select-option",15),a.EFF(1),a.k0s()),2&g){const w=_.$implicit;a.Y8G("value",w),a.R7$(),a.JRh(w.info.name)}}function Ee(g,_){if(1&g){const w=a.RV6();a.j41(0,"img",21),a.bIt("click",function(){a.eBV(w);const t=a.XpG(2);return a.Njj(t.copy_address(t.SelectedAddress))}),a.k0s()}if(2&g){const w=a.XpG(2);a.Y8G("src",w.QRCodeSRC,a.B4B)}}function Be(g,_){if(1&g){const w=a.RV6();a.j41(0,"div",16)(1,"div",17),a.DNE(2,Ee,1,1,"img",18),a.j41(3,"ion-item",19),a.bIt("click",function(){a.eBV(w);const t=a.XpG();return a.Njj(t.copy_address(t.QRNavParams.channel))}),a.j41(4,"ion-label",20),a.EFF(5),a.k0s()()()()}if(2&g){const w=a.XpG();a.R7$(2),a.Y8G("ngIf",w.QRCodeSRC),a.R7$(3),a.JRh(w.QRNavParams.channel)}}const Xe=[{path:"",component:(()=>{var g;class _{constructor(o,t,i,e,n,u,c,D,V,S,m){this.lang=o,this.alertCtrl=t,this.loadingCtrl=i,this.global=e,this.indexed=n,this.nakama=u,this.p5toast=c,this.webrtc=D,this.router=V,this.route=S,this.navCtrl=m,this.isMobile=!1,this.p5DrawingStack=[],this.isCropMode=!1,this.HasConnectedPeer=!1,this.ServerList=[],this.isDrawServerCreated=!1,this.ReadyToShareAct=!1,this.RemoteBackgroundImage="",this.WillLeaveHere=!1,this.WithoutSave=!0}ngOnDestroy(){this.route.queryParams.unsubscribe(),this.global.PageDismissAct[this.navParams.dismiss]&&this.global.PageDismissAct[this.navParams.dismiss]({}),this.p5ActualCanvas&&(this.p5ActualCanvas.remove(),this.p5ActualCanvas=null),this.p5ImageCanvas&&(this.p5ImageCanvas.remove(),this.p5ImageCanvas=null),this.p5voidDraw&&this.p5voidDraw.remove(),this.IceWebRTCWsClient&&this.IceWebRTCWsClient.close(),this.CancelRemoteAct()}ngOnInit(){var o=this;this.route.queryParams.subscribe(function(){var t=(0,P.A)(function*(i){try{const e=o.router.getCurrentNavigation().extras.state;if(!e)throw"\ud398\uc774\uc9c0 \ubcf5\uadc0";o.navParams=e||{},yield new Promise(n=>setTimeout(n,100)),o.create_new_canvas({width:e.width,height:e.height,path:e.path,type:e.type}),e.remote&&setTimeout(()=>{o.CreateRemoteLocalClient(e.remote.address,e.remote.channel)},1e3)}catch(e){console.log("\uadf8\ub9bc\ud310 \uc815\ubcf4 \ubc1b\uc9c0 \ubabb\ud568: ",e)}});return function(i){return t.apply(this,arguments)}}())}ionViewDidEnter(){var o=this;return(0,P.A)(function*(){o.global.StoreShortCutAct("void-draw"),o.AddShortCut(),o.mainLoading=yield o.loadingCtrl.create({message:o.lang.text.voidDraw.UseThisImage}),o.isMobile="DesktopPWA"!=_e.aH})()}AddShortCut(){delete this.global.p5KeyShortCut.Digit,this.global.p5KeyShortCut.HistoryAct=o=>{switch(o){case"Z":this.p5history_act(-1);break;case"X":this.p5history_act(1);break;case"C":this.isCropMode?this.p5apply_crop():this.p5change_color();break;case"V":this.p5set_line_weight()}},this.global.p5KeyShortCut.AddAct=()=>{this.ClickRemoteAddButton()},this.global.p5KeyShortCut.SKeyAct=o=>{o.shiftKey?this.p5save_image(!0):this.open_crop_tool()},this.global.p5KeyShortCut.DeleteAct=()=>{this.isCropMode?this.p5apply_crop():this.dismiss_draw()},this.global.p5KeyShortCut.FKeyAct=()=>{},this.global.p5KeyShortCut.Escape=()=>{this.isDrawServerCreated?this.CancelRemoteAct():this.navCtrl.pop()}}CancelRemoteAct(){this.ReadyToShareAct=!1,this.RemoteLoadingCtrl&&this.RemoteLoadingCtrl.dismiss(),this.isDrawServerCreated=!1,this.p5SetDrawable(!0),this.webrtc.close_webrtc(!1)}create_new_canvas(o){o.width=o.width||432,o.height=o.height||432,this.p5ActualCanvas&&(this.p5ActualCanvas.remove(),this.p5ActualCanvas=null),this.p5ImageCanvas&&(this.p5ImageCanvas.remove(),this.p5ImageCanvas=null),this.p5voidDraw&&this.p5voidDraw.remove(),this.create_p5voidDraw(o)}create_p5voidDraw(o){var t=this;let i=document.getElementById("voidDraw");this.isCropMode=!1,this.p5voidDraw=new fe(e=>{let n,u,c,D,V,S,m,ne,T=e.createColorPicker("#000"),U=Math.min(o.width,o.height)/100,se=1;e.setup=(0,P.A)(function*(){T.style("position","absolute"),e.pixelDensity(1),e.noLoop(),e.noFill(),e.imageMode(e.CENTER),e.createCanvas(i.clientWidth,i.clientHeight).parent(i),A.x=e.width/2,A.y=e.height/2,t.p5set_line_weight=()=>{t.alertCtrl.create({header:t.lang.text.voidDraw.changeWeight,inputs:[{label:t.lang.text.voidDraw.weight,name:"weight",placeholder:`${se}`,type:"number"}],buttons:[{text:t.lang.text.voidDraw.apply,handler:C=>{C.weight&&(se=Number(C.weight))}}]}).then(C=>{H=!1,C.onWillDismiss().then(()=>{H=!0}),C.present()})},t.p5change_color=()=>{T.elt.click()},t.p5save_image=(C=!1)=>{new fe(p=>{p.setup=()=>{let B=p.createCanvas(n.width,n.height);p.pixelDensity(1),c&&p.image(c,0,0),n&&p.image(n,0,0);let ke=B.elt.toDataURL("image/png").replace("image/png","image/octet-stream"),we=`voidDraw_${p.year()}-${p.nf(p.month(),2)}-${p.nf(p.day(),2)}_${p.nf(p.hour(),2)}-${p.nf(p.minute(),2)}-${p.nf(p.second(),2)}.png`;if(C){t.p5toast.show({text:`${t.lang.text.ContentViewer.DownloadThisFile}: ${we}`});let re=p.createA(ke,null);re.elt.download=we,re.hide(),re.parent(i),re.elt.click()}else t.navParams.dismiss&&t.global.PageDismissAct[t.navParams.dismiss]({data:{name:we,img:ke,loadingCtrl:t.mainLoading}}),t.navCtrl.pop();p.remove()}})},t.p5history_act=(C,p=!1)=>{switch(L=e.min(e.max(0,L+C),t.p5DrawingStack.length),C){case 1:t.p5DrawingStack.length&&(S.style.fill="var(--ion-color-dark)"),L==t.p5DrawingStack.length&&(m.style.fill="var(--ion-color-medium)"),G(n,t.p5DrawingStack[L-1]);break;case-1:t.p5DrawingStack.length&&(m.style.fill="var(--ion-color-dark)"),L<1?(S.style.fill="var(--ion-color-medium)",n.clear(255,255,255,255),e.redraw()):ie()}!p&&t.ReadyToShareAct&&t.webrtc.dataChannel.send(JSON.stringify({type:"same",act:"history_act",data:C}))},t.p5open_crop_tool=()=>{t.isCropMode?(t.isCropMode=!1,e.redraw()):(t.isCropMode=!0,d.x=n.width,d.y=n.height,N.x=0,N.y=0,e.redraw()),ne()},t.p5apply_crop=(C=!0)=>{if(C&&t.isMobile&&N.div(f),n.resizeCanvas(d.x,d.y),u=e.createVector(n.width/2,n.height/2),C&&I.sub(N),ie(),c.resizeCanvas(d.x,d.y),c.push(),c.background(t.navParams.isDarkMode?26:255),c.translate(I),t.p5BaseImage&&c.image(t.p5BaseImage,0,0),c.pop(),c.redraw(),t.isCropMode=!1,ne(),t.p5SetCanvasViewportInit(),C&&t.ReadyToShareAct){let p=t.p5getCropPos(),B=t.p5getCropSize();t.webrtc.dataChannel.send(JSON.stringify({type:"draw",act:"crop",cropPX:p.x,cropPY:p.y,cropSX:B.x,cropSY:B.y}))}},t.p5SetDrawable=et,D=e.createElement("table"),D.style("position: absolute; top: 0px;"),D.style(`width: 100%; height: ${W}px;`),D.style("background-color: var(--voidDraw-menu-background);"),D.parent(i);let s=D.elt.insertRow(0),l=s.insertCell(0);l.innerHTML=t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">A</div><ion-icon style="width: 27px; height: 27px" name="wifi-outline"></ion-icon></div>':'<ion-icon style="width: 27px; height: 27px" name="wifi-outline"></ion-icon>',l.style.textAlign="center",l.style.cursor="pointer",l.onclick=()=>{t.ClickRemoteAddButton()};let k=s.insertCell(1);k.innerHTML=t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">S</div><ion-icon style="width: 27px; height: 27px" name="crop"></ion-icon></div>':'<ion-icon style="width: 27px; height: 27px" name="crop"></ion-icon>',k.style.textAlign="center",k.style.cursor="pointer",k.onclick=()=>{t.open_crop_tool()};let x=s.insertCell(2);x.innerHTML=t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">D</div><ion-icon style="width: 27px; height: 27px" name="checkmark"></ion-icon></div>':'<ion-icon style="width: 27px; height: 27px" name="checkmark"></ion-icon>',x.style.textAlign="center",x.style.cursor="pointer",x.onclick=()=>{t.dismiss_draw()},ne=()=>{x.innerHTML=t.isCropMode?t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">D</div><ion-icon style="width: 27px; height: 27px" name="cut-sharp"></ion-icon></div>':'<ion-icon style="width: 27px; height: 27px" name="cut-sharp"></ion-icon>':t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">D</div><ion-icon style="width: 27px; height: 27px" name="checkmark"></ion-icon></div>':'<ion-icon style="width: 27px; height: 27px" name="checkmark"></ion-icon>'},V=e.createElement("table"),V.style("position: absolute; bottom: 0px;"),V.style(`width: 100%; height: ${W}px;`),V.style("background-color: var(--voidDraw-menu-background);"),V.parent(i);let E=V.elt.insertRow(0),K=E.insertCell(0);K.innerHTML=t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">Z</div><ion-icon id="undoIcon" style="width: 27px; height: 27px" name="arrow-undo"></ion-icon></div>':'<ion-icon id="undoIcon" style="width: 27px; height: 27px" name="arrow-undo"></ion-icon>',S=document.getElementById("undoIcon"),S.style.fill="var(--ion-color-medium)",K.style.textAlign="center",K.style.cursor="pointer",K.onclick=()=>{t.p5history_act(-1)};let Z=E.insertCell(1);Z.innerHTML=t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">X</div><ion-icon id="redoIcon" style="width: 27px; height: 27px" name="arrow-redo"></ion-icon></div>':'<ion-icon id="redoIcon" style="width: 27px; height: 27px" name="arrow-redo"></ion-icon>',m=document.getElementById("redoIcon"),m.style.fill="var(--ion-color-medium)",Z.style.textAlign="center",Z.style.cursor="pointer",Z.onclick=()=>{t.p5history_act(1)};let Y=E.insertCell(2);Y.innerHTML=t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">C</div><ion-icon style="width: 27px; height: 27px" name="color-palette"></ion-icon></div>':'<ion-icon style="width: 27px; height: 27px" name="color-palette"></ion-icon>',T.style("width: 0px; height: 0px; opacity: 0;"),T.parent(Y),T.elt.oninput=()=>{let C=T.color().levels,p=`#${e.hex(C[0],2)}${e.hex(C[1],2)}${e.hex(C[2],2)}`;Y.childNodes[0].style.color=p},o.path&&(T.value("#ff0000"),T.elt.oninput()),Y.style.textAlign="center",Y.style.cursor="pointer",Y.onclick=()=>{T.elt.click()};let q=E.insertCell(3);if(q.innerHTML=t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">V</div><ion-icon style="width: 27px; height: 27px" name="pencil"></ion-icon></div>':'<ion-icon style="width: 27px; height: 27px" name="pencil"></ion-icon>',q.style.textAlign="center",q.style.cursor="pointer",q.onclick=()=>{t.change_line_weight()},t.p5SetCanvasViewportInit=()=>{e.resizeCanvas(i.clientWidth,i.clientHeight),ce=A.copy(),de=f,he=j.copy(),M=0,le=!0,e.loop()},n=e.createGraphics(o.width,o.height),u=e.createVector(n.width/2,n.height/2),n.pixelDensity(1),n.noLoop(),n.noFill(),t.p5ActualCanvas=n,c=e.createGraphics(o.width,o.height),c.pixelDensity(1),c.noLoop(),c.noFill(),c.background(t.navParams.isDarkMode?26:255),t.p5ImageCanvas=c,o.path){let C=yield t.indexed.loadBlobFromUserPath(o.path,o.type),p=URL.createObjectURL(C);e.loadImage(p,B=>{t.p5BaseImage=B,c.image(t.p5BaseImage,0,0),c.redraw(),URL.revokeObjectURL(p),setTimeout(()=>{t.p5SetCanvasViewportInit()},100)},B=>{console.error("\uadf8\ub9bc\ud310 \ubc30\uacbd \uc774\ubbf8\uc9c0 \ubd88\ub7ec\uc624\uae30 \uc624\ub958: ",B),c.redraw(),URL.revokeObjectURL(p),setTimeout(()=>{t.p5SetCanvasViewportInit()},100)})}else c.redraw(),setTimeout(()=>{t.p5SetCanvasViewportInit()},100);o.width<o.height&&(U/=f),t.p5getCropPos=Ge,t.p5setCropPos=be,t.p5getCropSize=Fe,t.p5setCropSize=Ue,t.p5RemoteDrawStart=Qe,t.p5RemoteDrawing=Ke,t.p5RemoteDrawingEnd=Ze,t.p5updateRemoteCurve=ze,t.p5CancelCurrentDraw=()=>{v=null,e.redraw()},t.navParams.scrollHeight&&be(0,-t.navParams.scrollHeight)});let A=e.createVector(),f=1,j=e.createVector(0,0),I=e.createVector(),N=e.createVector(),d=e.createVector(),le=!1,M=0,ce=e.createVector(0,0),de=0,he=e.createVector(0,0),Ge=()=>I,Fe=()=>d,be=(r,s)=>{I.x=r,I.y=s,c.translate(r,s),e.redraw()},Ue=(r,s)=>{d.x=r,d.y=s,c.translate(r,s),e.redraw()},$=r=>e.sin(r*e.PI/2);e.draw=()=>{if(le){M+=.07,M>=1&&(le=!1,M=1,e.noLoop()),j.x=e.lerp(he.x,e.width/2,$(M)),j.y=e.lerp(he.y,e.height/2,$(M)),A.x=e.lerp(ce.x,0,$(M)),A.y=e.lerp(ce.y,0,$(M));let r=i.clientHeight-112;f=e.lerp(de,i.clientWidth/r<n.width/n.height?i.clientWidth/n.width:r/n.height,$(M))}if(e.clear(255,255,255,255),e.push(),e.translate(j),e.scale(f),e.translate(A),e.image(c,0,0),n&&e.image(n,0,0),this.isCropMode)e.push(),e.translate(-n.width/2,-n.height/2),e.translate(N),e.noStroke(),e.fill(0,100),e.rect(0,0,d.x,d.y),e.stroke(255,0,0),e.strokeWeight(8),e.beginShape(e.LINES),e.vertex(0,0),e.vertex(d.x,0),e.vertex(d.x,0),e.vertex(d.x,.8*d.y),e.vertex(0,0),e.vertex(0,d.y),e.vertex(0,d.y),e.vertex(.8*d.x,d.y),e.stroke(255,255,0),e.vertex(.8*d.x,d.y),e.vertex(d.x,d.y),e.vertex(d.x,.8*d.y),e.vertex(d.x,d.y),e.endShape(),e.pop();else{if(h&&h.pos&&h.pos.length){e.push(),e.translate(I),e.stroke(h.color),e.strokeWeight(h.weight),e.beginShape();for(let r=0,s=h.pos.length;r<s;r++)e.curveVertex(h.pos[r].x-u.x,h.pos[r].y-u.y);e.endShape(),e.pop()}if(this.ReadyToShareAct&&v&&v.pos&&v.pos.length){e.push(),e.translate(I),e.stroke(v.color),e.strokeWeight(v.weight),e.beginShape();for(let r=0,s=v.pos.length;r<s;r++)e.curveVertex(v.pos[r].x-u.x,v.pos[r].y-u.y);e.endShape(),e.pop()}}e.pop()},this.p5DrawingStack=[],this.p5ClearCurrentDraw=()=>{h={},this.p5DrawingStack.length=0,L=0,ie(),e.redraw()};let L=0,ie=()=>{n.clear(255,255,255,255);for(let r=0;r<L;r++)G(n,this.p5DrawingStack[r])},G=(r,s=h)=>{if(s.color){r.push(),r.translate(I),r.stroke(s.color),r.strokeWeight(s.weight),r.beginShape();for(let l=0,k=s.pos.length;l<k;l++)r.curveVertex(s.pos[l].x,s.pos[l].y);r.endShape(),r.pop(),r.redraw(),e.redraw()}},ze=r=>{for(let s=0,l=r.length;s<l;s++)G(n,r[s]);L=this.p5DrawingStack.length};e.windowResized=()=>{setTimeout(()=>{this.p5SetCanvasViewportInit()},0)};let h={},v={},Qe=r=>{v=r,e.redraw()},Ke=r=>{v&&v.pos&&v.pos.push(r),e.redraw()},Ze=r=>{v.pos.push(r),v.pos.push(r),this.p5DrawingStack.length=L,v&&(this.p5DrawingStack.push(v),G(n,v)),L=this.p5DrawingStack.length,v=null,e.redraw()};const W=56;let ge,F,pe,ue,ye,J,Ce,me=0,ae=!1,O=!1;e.mousePressed=r=>{if(H){if(e.mouseY<W||e.mouseY>e.height-W)return void(O=!0);switch(r.which){case 1:this.isCropMode?Se():Re();break;case 3:F=e.createVector(e.mouseX,e.mouseY),J=A.copy(),ge=e.createVector(e.mouseX,e.mouseY);break;case 2:this.p5SetCanvasViewportInit()}}};let Se=(r,s)=>{let l=X(r,s),k=N.copy().add(d).sub(e.createVector(n.width/2,n.height/2)),x=l.dist(k),E=.2*e.max(d.x,d.y);ae=x<E,ae?(ue=e.createVector(e.mouseX,e.mouseY),Ce=d.copy()):pe=e.createVector(e.mouseX,e.mouseY).sub(N.mult(f))},Re=(r,s)=>{S.style.fill="var(--ion-color-dark)",m.style.fill="var(--ion-color-medium)";let l=X(r,s);l.sub(I),l.add(u);let k={x:l.x,y:l.y},x=T.color().levels,E=`#${e.hex(x[0],2)}${e.hex(x[1],2)}${e.hex(x[2],2)}`;h={pos:[],color:E,weight:U*se},h.pos.push(k),h.pos.push(k),this.ReadyToShareAct&&this.webrtc.dataChannel.send(JSON.stringify({type:"draw",act:"start",data:h})),e.redraw()};e.mouseDragged=r=>{if(H)switch(r.which){case 1:if(this.isCropMode&&!O){let s=e.createVector(e.mouseX,e.mouseY);ae?d=Ce.copy().add(ue.copy().sub(s).div(-f)):N=pe.copy().sub(s).div(-f),e.redraw()}else{let s=X();s.sub(I),s.add(u);let l={x:s.x,y:s.y};h&&h.pos&&h.pos.push(l),this.ReadyToShareAct&&this.webrtc.dataChannel.send(JSON.stringify({type:"draw",act:"moved",data:l})),e.redraw()}break;case 3:ge=e.createVector(e.mouseX,e.mouseY),A=J.copy().add(ge.sub(F).div(f)),e.redraw()}},e.mouseWheel=r=>{H&&(e.mouseY<W||e.mouseY>e.height-W?O=!0:(qe(X()),f*=r.deltaY<0?1.1:.9,e.redraw()))},e.mouseReleased=r=>{if(H){if(1===r.which&&!this.isCropMode&&!O){let s=X();s.sub(I),s.add(u);let l={x:s.x,y:s.y};if(h)try{h.pos.push(l),h.pos.push(l),this.ReadyToShareAct&&this.webrtc.dataChannel.send(JSON.stringify({type:"draw",act:"end",data:l}))}catch{}xe()}O=!1}};let qe=r=>{j=e.createVector(e.mouseX,e.mouseY),A=r.mult(-1)},X=(r,s)=>{let l=e.createVector(r||e.mouseX,s||e.mouseY);return l.sub(j),l.div(f),l.sub(A),l},R=[],z=!1,H=!0,et=r=>{H=r};e.touchStarted=r=>{if(H){if(R=r.touches,r.changedTouches[0].clientY<W||r.changedTouches[0].clientY>e.height-W)return void(O=!0);switch(z=!0,R.length){case 1:this.isCropMode?Se(r.changedTouches[0].clientX,r.changedTouches[0].clientY-W):Re(r.changedTouches[0].clientX,r.changedTouches[0].clientY-W);break;case 2:let s=e.createVector(R[0].clientX,R[0].clientY-56),l=e.createVector(R[1].clientX,R[1].clientY-56);me=s.dist(l),F=s.copy().add(l).div(2),J=A.copy(),ye=f,h=null,this.ReadyToShareAct&&this.webrtc.dataChannel.send(JSON.stringify({type:"draw",act:"cancel"}));break;default:z=!1,this.p5SetCanvasViewportInit()}}},e.touchMoved=r=>{if(H&&z){switch(R=r.touches,R.length){case 1:if(this.isCropMode&&!O){let s=e.createVector(r.changedTouches[0].clientX,r.changedTouches[0].clientY-W);ae?d=Ce.copy().add(ue.copy().sub(s).div(-f)):N=pe.copy().sub(s).div(-f),e.redraw()}else{let s=X(r.changedTouches[0].clientX,r.changedTouches[0].clientY-W);s.sub(I),s.add(u);let l={x:s.x,y:s.y};h&&h.pos&&h.pos.push(l),this.ReadyToShareAct&&this.webrtc.dataChannel.send(JSON.stringify({type:"draw",act:"moved",data:l})),e.redraw()}break;case 2:{let s=e.createVector(R[0].clientX,R[0].clientY-56),l=e.createVector(R[1].clientX,R[1].clientY-56),k=s.copy().add(l).div(2);f=s.dist(l)/me*ye,A=J.copy().add(k.sub(F).div(f)),e.redraw()}}return!1}},e.touchEnded=r=>{if(H&&r.changedTouches){switch(R=r.touches,z=!1,R.length){case 0:if(!this.isCropMode&&!O&&h){let s=X(r.changedTouches[0].clientX,r.changedTouches[0].clientY-W);s.sub(I),s.add(u);let l={x:s.x,y:s.y};h.pos.push(l),h.pos.push(l),this.ReadyToShareAct&&this.webrtc.dataChannel.send(JSON.stringify({type:"draw",act:"end",data:l})),xe()}break;case 1:if(!z)return;tt(),me=0,h=null}O=!1}};let tt=()=>{F=e.createVector(R[0].clientX,R[0].clientY-56),J=A.copy()},xe=()=>{if(this.p5DrawingStack.length=L,h)if(this.p5DrawingStack.push(h),this.p5DrawingStack.length>20){let r=this.p5DrawingStack.shift();G(c,r),ie()}else G(n,h);L=this.p5DrawingStack.length,F=null,O=!1,h=null,e.redraw()}})}ClickRemoteAddButton(){if(this.IceWebRTCWsClient)return this.isDrawServerCreated=!0,this.global.StoreShortCutAct("voiddraw-remote"),this.p5SetDrawable(!1),this.AddrQRShare.onDidDismiss().then(()=>{this.isDrawServerCreated=!1,this.global.RestoreShortCutAct("voiddraw-remote"),this.HasConnectedPeer||this.p5SetDrawable(!0)}),void this.AddrQRShare.present();this.isDrawServerCreated||(this.ServerList=this.nakama.get_all_online_server(),this.ServerList.length?(this.p5SetDrawable(!1),this.RemoteDraw.open()):(this.p5SetDrawable(!1),this.RemoteBridgeServerSelected({detail:{value:"local"}})))}RemoteBridgeServerSelected(o){var t=this;return(0,P.A)(function*(){if(t.isDrawServerCreated)return;let i=o.detail.value;if("local"===i){let e;t.alertCtrl.create({header:t.lang.text.voidDraw.LocalAddrInput,inputs:[{type:"text",placeholder:"(wss://)0.0.0.0"},{type:"text",placeholder:t.lang.text.voidDraw.CreateChannel}],buttons:[{text:t.lang.text.voidDraw.Confirm,handler:n=>{n[0]?(t.InputCustomAddress=n[0],t.p5SetDrawable(!1),e=!0,t.isDrawServerCreated=!0,t.CreateOnMessageLink(),t.CreateOnOpenAct((0,P.A)(function*(){let u=t.p5getCropPos();yield new Promise(c=>setTimeout(c,t.global.WebsocketRetryTerm)),t.IceWebRTCWsClient.send(JSON.stringify({type:"size",width:t.p5ActualCanvas.width,height:t.p5ActualCanvas.height,cropX:u.x,cropY:u.y}))})),t.CreateRemoteLocalClient(n[0],n[1])):t.p5toast.show({text:t.lang.text.voidDraw.InputAddress})}}]}).then(n=>{n.onWillDismiss().then(()=>{t.p5SetDrawable(!0)}),n.onDidDismiss().then(()=>{!e&&!t.WillLeaveHere&&t.global.RestoreShortCutAct("voiddraw-remote-bridge")}),t.global.StoreShortCutAct("voiddraw-remote-bridge"),n.present()})}else t.InputCustomAddress=`${i.info.useSSL?"wss":"ws"}://${i.info.address}`,t.p5SetDrawable(!1),t.isDrawServerCreated=!0,t.CreateOnMessageLink(),t.CreateOnOpenAct((0,P.A)(function*(){let n=t.p5getCropPos();yield new Promise(u=>setTimeout(u,t.global.WebsocketRetryTerm)),t.IceWebRTCWsClient.send(JSON.stringify({type:"size",width:t.p5ActualCanvas.width,height:t.p5ActualCanvas.height,cropX:n.x,cropY:n.y}))})),t.CreateRemoteLocalClient(t.InputCustomAddress,o[1])})()}CreateRemoteLocalClient(o,t){var i=this;let c,e=o.split("://"),n=e.pop().split(":"),u=e.pop();u?u+=":":u=this.global.checkProtocolFromAddress(n[0])?"wss:":"ws:",this.IceWebRTCWsClient=new WebSocket(`${u}//${n[0]}:12013/`),this.AddShortCut(),this.isDrawServerCreated=!0,this.IceWebRTCWsClient.onopen=(0,P.A)(function*(){i.p5toast.show({text:`${i.lang.text.voidDraw.Connected}: ${n[0]}`}),t?(i.IceWebRTCWsClient.send(JSON.stringify({type:"join",channel:t})),yield new Promise(D=>setTimeout(D,i.global.WebsocketRetryTerm)),i.IceWebRTCWsClient.send(JSON.stringify({type:"size_req",channel:t})),i.RemoteLoadingCtrl=yield i.loadingCtrl.create({message:i.lang.text.voidDraw.WaitingConnection}),i.RemoteLoadingCtrl.present()):i.IceWebRTCWsClient.send(JSON.stringify({type:"init"}))}),this.IceWebRTCWsClient.onmessage=function(){var D=(0,P.A)(function*(V){let S,m=JSON.parse(V.data);if(void 0===c)c=m.uid;else if(c==m.uid)return;switch(m.type){case"join":i.HasConnectedPeer=!0,i.p5SetDrawable(!1);break;case"leave":i.HasConnectedPeer=!1,i.p5SetDrawable(!0),i.RemoteLoadingCtrl.dismiss(),i.IceWebRTCWsClient.close();break;case"init_id":i.QRNavParams={address:o,channel:m.id},i.init_gen_qrcode(),i.AddrQRShare.onDidDismiss().then(()=>{i.isDrawServerCreated=!1,i.global.RestoreShortCutAct("voiddraw-remote"),i.HasConnectedPeer||i.p5SetDrawable(!0)}),i.global.StoreShortCutAct("voiddraw-remote"),i.p5SetDrawable(!1),i.AddrQRShare.present(),i.IceWebRTCWsClient.send(JSON.stringify({type:"join",channel:m.id})),S=m.id;break;case"init_req":i.RemoteLoadingCtrl.message=i.lang.text.voidDraw.WebRTC_Init,i.webrtc.initialize("data").then((0,P.A)(function*(){i.webrtc.HangUpCallBack=()=>{i.IceWebRTCWsClient.close()},i.CreateOnMessageLink(),i.CreateOnOpenAct(),i.webrtc.CreateOffer(),yield new Promise(U=>setTimeout(U,i.global.WebsocketRetryTerm)),i.IceWebRTCWsClient.send(JSON.stringify({type:"socket_react",channel:S,act:"WEBRTC_INIT_REQ_SIGNAL"}))}));break;case"size_req":i.AddrQRShare.dismiss(),i.RemoteLoadingCtrl=yield i.loadingCtrl.create({message:i.lang.text.voidDraw.WaitingConnection}),i.RemoteLoadingCtrl.present();let T=i.p5getCropPos();i.IceWebRTCWsClient.send(JSON.stringify({type:"size",width:i.p5ActualCanvas.width,height:i.p5ActualCanvas.height,cropX:T.x,cropY:T.y,channel:S}));break;case"socket_react":switch(m.act){case"WEBRTC_REPLY_INIT_SIGNAL":i.RemoteLoadingCtrl.message=i.lang.text.voidDraw.WebRTC_Reply,i.nakama.socket_reactive[m.act](m.data_str),"EOL"==m.data_str&&(i.RemoteLoadingCtrl.message=i.lang.text.voidDraw.WebRTC_Offer,i.webrtc.CreateAnswer({client:i.IceWebRTCWsClient,channel:S})),i.RemoteLoadingCtrl.message=i.lang.text.voidDraw.WebRTC_Ice;break;case"WEBRTC_ICE_CANDIDATES":i.nakama.socket_reactive[m.act](m.data_str,{client:i.IceWebRTCWsClient,channel:S}),i.RemoteLoadingCtrl.message=i.lang.text.voidDraw.WebRTC_datachannel,i.IceWebRTCWsClient.send(JSON.stringify({type:"init_end",channel:S}));break;case"WEBRTC_INIT_REQ_SIGNAL":i.nakama.socket_reactive[m.act]({client:i.IceWebRTCWsClient,channel:S});break;case"WEBRTC_RECEIVE_ANSWER":i.nakama.socket_reactive[m.act](m.data_str,{client:i.IceWebRTCWsClient,channel:S})}break;case"size":i.create_new_canvas({width:m.width,height:m.height}),i.p5SetDrawable(!1),i.p5setCropPos(m.cropX,m.cropY),i.p5voidDraw.redraw(),i.RemoteLoadingCtrl.message=i.lang.text.voidDraw.WebRTC_Init,i.webrtc.initialize("data").then(()=>{i.webrtc.HangUpCallBack=()=>{i.IceWebRTCWsClient&&i.IceWebRTCWsClient.close()},i.CreateOnOpenAct(),i.CreateOnMessageLink(),i.RemoteLoadingCtrl.message=i.lang.text.voidDraw.WebRTC_Offer,i.webrtc.CreateOffer(),i.IceWebRTCWsClient.send(JSON.stringify({type:"init_req"}))});break;case"init_end":i.RemoteLoadingCtrl.message=i.lang.text.voidDraw.WebRTC_datachannel}});return function(V){return D.apply(this,arguments)}}(),this.IceWebRTCWsClient.onerror=D=>{console.log("\uadf8\ub9bc\ud310 \uae30\ub2a5 \uacf5\uc720 \uc5f0\uacb0 \uc624\ub958: ",D),this.IceWebRTCWsClient.close()},this.IceWebRTCWsClient.onclose=()=>{this.p5toast.show({text:this.lang.text.TodoDetail.Disconnected}),this.RemoteLoadingCtrl.dismiss(),this.AddrQRShare.dismiss(),this.isDrawServerCreated=!1,this.webrtc.close_webrtc(!1),this.IceWebRTCWsClient.onopen=null,this.IceWebRTCWsClient.onclose=null,this.IceWebRTCWsClient.onmessage=null,this.IceWebRTCWsClient.onerror=null,this.IceWebRTCWsClient=null}}CreateOnOpenAct(o=(0,P.A)(function*(){})){var t=this;this.webrtc.dataChannelOpenAct=(0,P.A)(function*(){if(t.ReadyToShareAct=!0,t.RemoteLoadingCtrl&&t.RemoteLoadingCtrl.dismiss(),t.p5ClearCurrentDraw(),o&&(yield o()),t.RemoteLoadingCtrl.message=t.lang.text.voidDraw.WebRTC_ShareBG,t.navParams.path)try{let i=yield t.indexed.loadBlobFromUserPath(t.navParams.path,""),n=(yield t.global.GetBase64ThroughFileReader(i)).match(/(.{1,64})/g);for(let u=0,c=n.length;u<c;u++)t.webrtc.dataChannel.send(JSON.stringify({type:"background",act:"part",data:n[u]}));t.webrtc.dataChannel.send(JSON.stringify({type:"background",act:"EOF"}))}catch(i){console.log("\ubc30\uacbd \uadf8\ub9bc \uacf5\uc720\ud558\uae30 \uc624\ub958: ",i)}t.RemoteLoadingCtrl.dismiss(),t.p5SetDrawable(!0)})}CreateOnMessageLink(){this.webrtc.dataChannelOnMsgAct=o=>{let t=JSON.parse(o);switch(t.type){case"drawline":this.p5DrawingStack=t.data,this.p5updateRemoteCurve(t.data),this.p5voidDraw.redraw();break;case"background":switch(t.act){case"part":this.RemoteLoadingCtrl.message=this.lang.text.voidDraw.WebRTC_ShareBG,this.RemoteBackgroundImage+=t.data;break;case"EOF":this.p5voidDraw.loadImage(this.RemoteBackgroundImage,i=>{this.p5BaseImage=i,this.p5ImageCanvas.image(this.p5BaseImage,0,0),this.p5ImageCanvas.redraw(),this.p5SetCanvasViewportInit(),this.RemoteBackgroundImage=""},i=>{console.error("\uadf8\ub9bc\ud310 \ubc30\uacbd \uc774\ubbf8\uc9c0 \ubd88\ub7ec\uc624\uae30 \uc624\ub958: ",i),this.p5ImageCanvas.redraw(),this.p5SetCanvasViewportInit(),this.RemoteBackgroundImage=""}),this.RemoteLoadingCtrl.dismiss()}break;case"draw":switch(t.act){case"start":this.p5RemoteDrawStart(t.data);break;case"moved":this.p5RemoteDrawing(t.data);break;case"cancel":this.p5CancelCurrentDraw();break;case"crop":this.p5setCropPos(t.cropPX,t.cropPY),this.p5setCropSize(t.cropSX,t.cropSY),this.isCropMode=!0,this.p5apply_crop(!1);break;case"end":this.p5RemoteDrawingEnd(t.data)}break;case"same":"history_act"===t.act&&this.p5history_act(t.data,!0)}},this.webrtc.dataChannelOnCloseAct=()=>{this.CancelRemoteAct()}}change_line_weight(){this.p5set_line_weight()}open_crop_tool(){this.p5open_crop_tool()}dismiss_draw(){"voiddraw-remote"!=this.navParams.dismiss?this.isCropMode?this.p5apply_crop():(this.mainLoading.present(),this.WithoutSave=!1,this.p5save_image()):this.navCtrl.pop()}ionSelectCancel(){this.p5voidDraw&&this.p5SetDrawable&&!this.isDrawServerCreated&&this.p5SetDrawable(!0)}RemoveShortCut(){this.p5voidDraw&&this.p5SetDrawable&&this.p5SetDrawable(!1),delete this.global.p5KeyShortCut.HistoryAct,delete this.global.p5KeyShortCut.AddAct,delete this.global.p5KeyShortCut.DeleteAct,delete this.global.p5KeyShortCut.SKeyAct,delete this.global.p5KeyShortCut.FKeyAct,delete this.global.p5KeyShortCut.Escape}ionViewWillLeave(){this.WillLeaveHere=!0,this.RemoveShortCut(),this.global.RestoreShortCutAct("void-draw")}ionViewDidLeave(){this.WithoutSave&&this.mainLoading.remove()}init_gen_qrcode(){var o=this;return(0,P.A)(function*(){let t=o.QRNavParams.address;o.SelectedAddress=`${yield o.global.GetHeaderAddress(void 0,!0)}?voidDraw=${t},${o.QRNavParams.channel}`.replace(" ","%20"),o.QRCodeSRC=o.global.readasQRCodeFromString(o.SelectedAddress)})()}copy_address(o){this.global.WriteValueToClipboard("text/plain",o)}}return(g=_).\u0275fac=function(o){return new(o||g)(a.rXU(Te.y),a.rXU(y.hG),a.rXU(y.Xi),a.rXU(Ie.z3),a.rXU(We.n),a.rXU(Pe.X),a.rXU(Le.G),a.rXU(Ve.j),a.rXU(ee.Ix),a.rXU(ee.nX),a.rXU(Ae.q9))},g.\u0275cmp=a.VBU({type:g,selectors:[["app-void-draw"]],viewQuery:function(o,t){if(1&o&&(a.GBs(Me,5),a.GBs(Oe,5)),2&o){let i;a.mGM(i=a.lsd())&&(t.RemoteDraw=i.first),a.mGM(i=a.lsd())&&(t.AddrQRShare=i.first)}},decls:19,vars:5,consts:[["RemoteDraw",""],["AddrQRShare",""],[1,"ion-no-border"],["slot","start"],["defaultHref",""],["class","shortcut_hint","style","left: auto; right: 52px; top: 0px; padding: 2px 8px; border-radius: 8px;",4,"ngIf"],["slot","end","name","save-outline",1,"top_icon",2,"width","24px","height","24px",3,"click"],["oncontextmenu","return false;"],["hidden",""],["value","local",3,"ionChange","ionCancel","label"],["value","local"],[3,"value",4,"ngFor","ngForOf"],["id","voidDraw",1,"full_screen",2,"display","flex","overflow","hidden","background-color","black"],[1,"transparent-modal"],[1,"shortcut_hint",2,"left","auto","right","52px","top","0px","padding","2px 8px","border-radius","8px"],[3,"value"],[2,"display","flex","justify-content","center","align-items","center","height","100%"],[2,"width","400px","min-height","455px","background-color","var(--chatroom-background)","text-align","center","padding","16px"],["style","width: 100%; height: auto; cursor: copy; margin-bottom: 8px;","alt","QuickLink",3,"src","click",4,"ngIf"],["button","",3,"click"],[1,"ion-text-center"],["alt","QuickLink",2,"width","100%","height","auto","cursor","copy","margin-bottom","8px",3,"click","src"]],template:function(o,t){if(1&o){const i=a.RV6();a.j41(0,"ion-header",2)(1,"ion-toolbar")(2,"ion-title"),a.EFF(3),a.k0s(),a.j41(4,"ion-buttons",3),a.nrm(5,"ion-back-button",4),a.k0s(),a.DNE(6,He,2,0,"div",5),a.j41(7,"ion-icon",6),a.bIt("click",function(){return a.eBV(i),a.Njj(t.p5save_image(!0))}),a.k0s()()(),a.j41(8,"ion-content",7)(9,"div",8)(10,"ion-select",9,0),a.bIt("ionChange",function(n){return a.eBV(i),a.Njj(t.RemoteBridgeServerSelected(n))})("ionCancel",function(){return a.eBV(i),a.Njj(t.ionSelectCancel())}),a.j41(12,"ion-select-option",10),a.EFF(13),a.k0s(),a.DNE(14,Ne,2,2,"ion-select-option",11),a.k0s()(),a.nrm(15,"div",12),a.j41(16,"ion-modal",13,1),a.DNE(18,Be,6,2,"ng-template"),a.k0s()()}2&o&&(a.R7$(3),a.JRh(t.lang.text.ChatRoom.voidDraw),a.R7$(3),a.Y8G("ngIf",t.global.ShowHint),a.R7$(4),a.Y8G("label",t.lang.text.voidDraw.ConnectToAddress),a.R7$(3),a.JRh(t.lang.text.voidDraw.InternalConn),a.R7$(),a.Y8G("ngForOf",t.ServerList))},dependencies:[oe.Sq,oe.bT,y.QW,y.W9,y.eU,y.iq,y.uz,y.he,y.Nm,y.Ip,y.BC,y.ai,y.Sb,y.Je,y.el]}),_})()}];let Ye=(()=>{var g;class _{}return(g=_).\u0275fac=function(o){return new(o||g)},g.\u0275mod=a.$C({type:g}),g.\u0275inj=a.G2t({imports:[ee.iI.forChild(Xe),ee.iI]}),_})(),je=(()=>{var g;class _{}return(g=_).\u0275fac=function(o){return new(o||g)},g.\u0275mod=a.$C({type:g}),g.\u0275inj=a.G2t({imports:[oe.MD,De.YN,y.bv,Ye]}),_})()}}]);