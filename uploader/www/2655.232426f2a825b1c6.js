"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[2655],{6608:(We,le,u)=>{u.d(le,{n:()=>o});var ce=u(467),pe=u(92),d=u(3953),z=u(482),_=u(3656),J=u(5374),Q=u(4234),Z=u(177);function ue(V,q){if(1&V){const $=d.RV6();d.j41(0,"img",5),d.bIt("click",function(){d.eBV($);const k=d.XpG();return d.Njj(k.copy_address(k.SelectedAddress))}),d.k0s()}if(2&V){const $=d.XpG();d.Y8G("src",$.QRCodeSRC,d.B4B)}}let o=(()=>{var V;class q{constructor(v,k,G){this.global=v,this.navParams=k,this.lang=G}ngOnInit(){}ionViewWillEnter(){var v=this;return(0,ce.A)(function*(){let k=v.navParams.data.address;try{let he=k.split("://").pop(),me=`http://${he}:12000/`;const Ce=new AbortController,we=setTimeout(()=>{Ce.abort()},500);let ve=yield fetch(me,{signal:Ce.signal});if(clearTimeout(we),!ve.ok)throw"\uc8fc\uc18c \uc5c6\uc74c";v.SelectedAddress=`http://${he}:12000${window.sub_path}?voidDraw=${k},${v.navParams.data.channel}`}catch{v.SelectedAddress=`${pe.d2}pjcone_pwa/?voidDraw=${k},${v.navParams.data.channel}`}v.QRCodeSRC=v.global.readasQRCodeFromString(v.SelectedAddress)})()}copy_address(v){this.global.WriteValueToClipboard("text/plain",v)}}return(V=q).\u0275fac=function(v){return new(v||V)(d.rXU(z.z3),d.rXU(_.y8),d.rXU(Q.y))},V.\u0275cmp=d.VBU({type:V,selectors:[["app-link-qr"]],decls:7,vars:2,consts:[[2,"display","flex","justify-content","center","align-items","center","height","100%"],[2,"width","400px","height","455px","background-color","var(--chatroom-background)","text-align","center","padding","16px"],["style","width: 100%; height: auto; cursor: copy;","alt","QuickLink",3,"src","click",4,"ngIf"],["button","",3,"click"],[1,"ion-text-center"],["alt","QuickLink",2,"width","100%","height","auto","cursor","copy",3,"click","src"]],template:function(v,k){1&v&&(d.j41(0,"ion-content")(1,"div",0)(2,"div",1),d.DNE(3,ue,1,1,"img",2),d.j41(4,"ion-item",3),d.bIt("click",function(){return k.copy_address(k.navParams.data.channel)}),d.j41(5,"ion-label",4),d.EFF(6),d.k0s()()()()()),2&v&&(d.R7$(3),d.Y8G("ngIf",k.QRCodeSRC),d.R7$(3),d.JRh(k.navParams.data.channel))},dependencies:[Z.bT,J.W9,J.uz,J.he],styles:["ion-content[_ngcontent-%COMP%]{--background: transparent}"]}),q})()},2655:(We,le,u)=>{u.r(le),u.d(le,{VoidDrawPageModule:()=>Le});var ce=u(177),pe=u(4341),d=u(5374),z=u(9858),_=u(467),J=u(8326),Q=u(92),Z=u(4237),ue=u(6608),o=u(3953),V=u(4234),q=u(3656),$=u(482),v=u(755),k=u(9900),G=u(4020);const he=["RemoteDraw"];function me(w,E){if(1&w&&(o.j41(0,"ion-select-option",10),o.EFF(1),o.k0s()),2&w){const B=E.$implicit;o.Y8G("value",B),o.R7$(),o.JRh(B.info.name)}}const we=[{path:"",component:(()=>{var w;class E{constructor(s,t,i,e,l,m,n,x,b,T,D,C){this.lang=s,this.modalCtrl=t,this.alertCtrl=i,this.loadingCtrl=e,this.global=l,this.indexed=m,this.nakama=n,this.p5toast=x,this.webrtc=b,this.router=T,this.route=D,this.navCtrl=C,this.isMobile=!1,this.p5DrawingStack=[],this.isCropMode=!1,this.ServerList=[],this.isDrawServerCreated=!1,this.ReadyToShareAct=!1,this.RemoteBackgroundImage="",this.WillLeaveHere=!1,this.WithoutSave=!0}ngOnDestroy(){this.route.queryParams.unsubscribe(),this.global.PageDismissAct[this.navParams.dismiss]&&this.global.PageDismissAct[this.navParams.dismiss]({}),this.p5ActualCanvas&&(this.p5ActualCanvas.remove(),this.p5ActualCanvas=null),this.p5ImageCanvas&&(this.p5ImageCanvas.remove(),this.p5ImageCanvas=null),this.p5voidDraw&&this.p5voidDraw.remove(),this.IceWebRTCWsClient&&this.IceWebRTCWsClient.close(),this.CancelRemoteAct()}ngOnInit(){var s=this;this.route.queryParams.subscribe(function(){var t=(0,_.A)(function*(i){try{const e=s.router.getCurrentNavigation().extras.state;if(!e)throw"\ud398\uc774\uc9c0 \ubcf5\uadc0";s.navParams=e||{},yield new Promise(l=>setTimeout(l,100)),s.create_new_canvas({width:e.width,height:e.height,path:e.path}),e.remote&&setTimeout(()=>{s.CreateRemoteLocalClient(e.remote.address,e.remote.channel)},1e3)}catch(e){console.log("\uadf8\ub9bc\ud310 \uc815\ubcf4 \ubc1b\uc9c0 \ubabb\ud568: ",e)}});return function(i){return t.apply(this,arguments)}}())}ionViewDidEnter(){var s=this;return(0,_.A)(function*(){s.global.StoreShortCutAct("void-draw"),s.AddShortCut(),s.mainLoading=yield s.loadingCtrl.create({message:s.lang.text.voidDraw.UseThisImage}),s.isMobile="DesktopPWA"!=Q.aH})()}AddShortCut(){delete this.global.p5KeyShortCut.Digit,this.global.p5KeyShortCut.HistoryAct=s=>{switch(s){case"Z":this.p5history_act(-1);break;case"X":this.p5history_act(1);break;case"C":this.isCropMode?this.p5apply_crop():this.p5change_color();break;case"V":this.p5set_line_weight()}},this.global.p5KeyShortCut.AddAct=()=>{this.ClickRemoteAddButton()},this.global.p5KeyShortCut.SKeyAct=()=>{this.open_crop_tool()},this.global.p5KeyShortCut.DeleteAct=()=>{this.isCropMode?this.p5apply_crop():this.dismiss_draw()},this.global.p5KeyShortCut.FKeyAct=()=>{},this.global.p5KeyShortCut.Escape=()=>{this.isDrawServerCreated?this.CancelRemoteAct():this.navCtrl.pop()}}CancelRemoteAct(){this.ReadyToShareAct=!1,this.RemoteLoadingCtrl&&this.RemoteLoadingCtrl.dismiss(),this.isDrawServerCreated=!1,this.p5SetDrawable(!0),this.webrtc.close_webrtc(!1)}create_new_canvas(s){s.width=s.width||432,s.height=s.height||432,this.p5ActualCanvas&&(this.p5ActualCanvas.remove(),this.p5ActualCanvas=null),this.p5ImageCanvas&&(this.p5ImageCanvas.remove(),this.p5ImageCanvas=null),this.p5voidDraw&&this.p5voidDraw.remove(),this.create_p5voidDraw(s)}create_p5voidDraw(s){var t=this;let i=document.getElementById("voidDraw");this.isCropMode=!1,this.p5voidDraw=new J(e=>{let l,m,n,x,b,T,D,C,ye,I=e.createColorPicker("#000"),ee=Math.min(s.width,s.height)/100,fe=1;e.setup=(0,_.A)(function*(){I.style("position","absolute"),e.pixelDensity(1),e.noLoop(),e.noFill(),e.imageMode(e.CENTER),x=e.createCanvas(i.clientWidth,i.clientHeight),x.parent(i),L.x=e.width/2,L.y=e.height/2,t.p5set_line_weight=()=>{t.alertCtrl.create({header:t.lang.text.voidDraw.changeWeight,inputs:[{label:t.lang.text.voidDraw.weight,name:"weight",placeholder:`${fe}`,type:"number"}],buttons:[{text:t.lang.text.voidDraw.apply,handler:h=>{h.weight&&(fe=Number(h.weight))}}]}).then(h=>{X=!1,h.onWillDismiss().then(()=>{X=!0}),h.present()})},t.p5change_color=()=>{I.elt.click()},t.p5save_image=()=>{new J(h=>{h.setup=()=>{let A=h.createCanvas(l.width,l.height);h.pixelDensity(1),n&&h.image(n,0,0),l&&h.image(l,0,0);let N=A.elt.toDataURL("image/png").replace("image/png","image/octet-stream");t.navParams.dismiss&&t.global.PageDismissAct[t.navParams.dismiss]({data:{name:`voidDraw_${h.year()}-${h.nf(h.month(),2)}-${h.nf(h.day(),2)}_${h.nf(h.hour(),2)}-${h.nf(h.minute(),2)}-${h.nf(h.second(),2)}.png`,img:N,loadingCtrl:t.mainLoading}}),t.navCtrl.pop(),h.remove()}})},t.p5history_act=(h,A=!1)=>{switch(M=e.min(e.max(0,M+h),t.p5DrawingStack.length),h){case 1:t.p5DrawingStack.length&&(D.style.fill="var(--ion-color-dark)"),M==t.p5DrawingStack.length&&(C.style.fill="var(--ion-color-medium)"),ie(l,t.p5DrawingStack[M-1]);break;case-1:t.p5DrawingStack.length&&(C.style.fill="var(--ion-color-dark)"),M<1?(D.style.fill="var(--ion-color-medium)",l.clear(255,255,255,255),e.redraw()):be()}!A&&t.ReadyToShareAct&&t.webrtc.dataChannel.send(JSON.stringify({type:"same",act:"history_act",data:h}))},t.p5open_crop_tool=()=>{t.isCropMode?(t.isCropMode=!1,e.redraw()):(t.isCropMode=!0,g.x=l.width,g.y=l.height,U.x=0,U.y=0,e.redraw()),ye()},t.p5apply_crop=(h=!0)=>{if(h&&t.isMobile&&U.div(S),l.resizeCanvas(g.x,g.y),m=e.createVector(l.width/2,l.height/2),h&&P.sub(U),be(),n.resizeCanvas(g.x,g.y),n.push(),n.background(t.navParams.isDarkMode?26:255),n.translate(P),t.p5BaseImage&&n.image(t.p5BaseImage,0,0),n.pop(),n.redraw(),t.isCropMode=!1,ye(),t.p5SetCanvasViewportInit(),h&&t.ReadyToShareAct){let A=t.p5getCropPos(),N=t.p5getCropSize();t.webrtc.dataChannel.send(JSON.stringify({type:"draw",act:"crop",cropPX:A.x,cropPY:A.y,cropSX:N.x,cropSY:N.y}))}},t.p5SetDrawable=Ye,b=e.createElement("table"),b.style("position: absolute; top: 0px;"),b.style(`width: 100%; height: ${W}px;`),b.style("background-color: var(--voidDraw-menu-background);"),b.parent(i);let a=b.elt.insertRow(0),r=a.insertCell(0);r.innerHTML=t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">A</div><ion-icon style="width: 27px; height: 27px" name="wifi-outline"></ion-icon></div>':'<ion-icon style="width: 27px; height: 27px" name="wifi-outline"></ion-icon>',r.style.textAlign="center",r.style.cursor="pointer",r.onclick=()=>{t.ClickRemoteAddButton()};let c=a.insertCell(1);c.innerHTML=t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">S</div><ion-icon style="width: 27px; height: 27px" name="crop"></ion-icon></div>':'<ion-icon style="width: 27px; height: 27px" name="crop"></ion-icon>',c.style.textAlign="center",c.style.cursor="pointer",c.onclick=()=>{t.open_crop_tool()};let y=a.insertCell(2);y.innerHTML=t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">D</div><ion-icon style="width: 27px; height: 27px" name="checkmark"></ion-icon></div>':'<ion-icon style="width: 27px; height: 27px" name="checkmark"></ion-icon>',y.style.textAlign="center",y.style.cursor="pointer",y.onclick=()=>{t.dismiss_draw()},ye=()=>{y.innerHTML=t.isCropMode?t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">D</div><ion-icon style="width: 27px; height: 27px" name="cut-sharp"></ion-icon></div>':'<ion-icon style="width: 27px; height: 27px" name="cut-sharp"></ion-icon>':t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">D</div><ion-icon style="width: 27px; height: 27px" name="checkmark"></ion-icon></div>':'<ion-icon style="width: 27px; height: 27px" name="checkmark"></ion-icon>'},T=e.createElement("table"),T.style("position: absolute; bottom: 0px;"),T.style(`width: 100%; height: ${W}px;`),T.style("background-color: var(--voidDraw-menu-background);"),T.parent(i);let O=T.elt.insertRow(0),Y=O.insertCell(0);Y.innerHTML=t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">Z</div><ion-icon id="undoIcon" style="width: 27px; height: 27px" name="arrow-undo"></ion-icon></div>':'<ion-icon id="undoIcon" style="width: 27px; height: 27px" name="arrow-undo"></ion-icon>',D=document.getElementById("undoIcon"),D.style.fill="var(--ion-color-medium)",Y.style.textAlign="center",Y.style.cursor="pointer",Y.onclick=()=>{t.p5history_act(-1)};let se=O.insertCell(1);se.innerHTML=t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">X</div><ion-icon id="redoIcon" style="width: 27px; height: 27px" name="arrow-redo"></ion-icon></div>':'<ion-icon id="redoIcon" style="width: 27px; height: 27px" name="arrow-redo"></ion-icon>',C=document.getElementById("redoIcon"),C.style.fill="var(--ion-color-medium)",se.style.textAlign="center",se.style.cursor="pointer",se.onclick=()=>{t.p5history_act(1)};let F=O.insertCell(2);F.innerHTML=t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">C</div><ion-icon style="width: 27px; height: 27px" name="color-palette"></ion-icon></div>':'<ion-icon style="width: 27px; height: 27px" name="color-palette"></ion-icon>',I.style("width: 0px; height: 0px; opacity: 0;"),I.parent(F),I.elt.oninput=()=>{let h=I.color().levels,A=`#${e.hex(h[0],2)}${e.hex(h[1],2)}${e.hex(h[2],2)}`;F.childNodes[0].style.color=A},s.path&&(I.value("#ff0000"),I.elt.oninput()),F.style.textAlign="center",F.style.cursor="pointer",F.onclick=()=>{I.elt.click()};let ne=O.insertCell(3);if(ne.innerHTML=t.global.ShowHint?'<div><div class="shortcut_hint shortcut_voiddraw">V</div><ion-icon style="width: 27px; height: 27px" name="pencil"></ion-icon></div>':'<ion-icon style="width: 27px; height: 27px" name="pencil"></ion-icon>',ne.style.textAlign="center",ne.style.cursor="pointer",ne.onclick=()=>{t.change_line_weight()},t.p5SetCanvasViewportInit=()=>{x.hide(),e.resizeCanvas(i.clientWidth,i.clientHeight),te.x=e.width/2,te.y=e.height/2,L.x=0,L.y=0;let h=i.clientHeight-112;S=i.clientWidth/h<l.width/l.height?i.clientWidth/l.width:h/l.height,x.show(),e.redraw()},l=e.createGraphics(s.width,s.height),m=e.createVector(l.width/2,l.height/2),l.pixelDensity(1),l.noLoop(),l.noFill(),t.p5ActualCanvas=l,n=e.createGraphics(s.width,s.height),n.pixelDensity(1),n.noLoop(),n.noFill(),n.background(t.navParams.isDarkMode?26:255),t.p5ImageCanvas=n,s.path){let h=yield t.indexed.loadBlobFromUserPath(s.path,""),A=URL.createObjectURL(h);e.loadImage(A,N=>{t.p5BaseImage=N,n.image(t.p5BaseImage,0,0),n.redraw(),URL.revokeObjectURL(A),t.p5SetCanvasViewportInit()},N=>{console.error("\uadf8\ub9bc\ud310 \ubc30\uacbd \uc774\ubbf8\uc9c0 \ubd88\ub7ec\uc624\uae30 \uc624\ub958: ",N),n.redraw(),URL.revokeObjectURL(A),t.p5SetCanvasViewportInit()})}else n.redraw(),t.p5SetCanvasViewportInit();s.width<s.height&&(ee/=S),t.p5getCropPos=Me,t.p5setCropPos=xe,t.p5getCropSize=Oe,t.p5setCropSize=Ve,t.p5RemoteDrawStart=He,t.p5RemoteDrawing=Xe,t.p5RemoteDrawingEnd=Ne,t.p5updateRemoteCurve=Be,t.p5CancelCurrentDraw=()=>{f=null,e.redraw()},t.navParams.scrollHeight&&xe(0,-t.navParams.scrollHeight)});let L=e.createVector(),S=1,te=e.createVector(0,0),P=e.createVector(),U=e.createVector(),g=e.createVector(),Me=()=>P,Oe=()=>g,xe=(a,r)=>{P.x=a,P.y=r,n.translate(a,r),e.redraw()},Ve=(a,r)=>{g.x=a,g.y=r,n.translate(a,r),e.redraw()};e.draw=()=>{if(e.clear(255,255,255,255),e.push(),e.translate(te),e.scale(S),e.translate(L),e.image(n,0,0),l&&e.image(l,0,0),this.isCropMode)e.push(),e.translate(-l.width/2,-l.height/2),e.translate(U),e.noStroke(),e.fill(0,100),e.rect(0,0,g.x,g.y),e.stroke(255,0,0),e.strokeWeight(8),e.beginShape(e.LINES),e.vertex(0,0),e.vertex(g.x,0),e.vertex(g.x,0),e.vertex(g.x,.8*g.y),e.vertex(0,0),e.vertex(0,g.y),e.vertex(0,g.y),e.vertex(.8*g.x,g.y),e.stroke(255,255,0),e.vertex(.8*g.x,g.y),e.vertex(g.x,g.y),e.vertex(g.x,.8*g.y),e.vertex(g.x,g.y),e.endShape(),e.pop();else{if(p&&p.pos&&p.pos.length){e.push(),e.translate(P),e.stroke(p.color),e.strokeWeight(p.weight),e.beginShape();for(let a=0,r=p.pos.length;a<r;a++)e.curveVertex(p.pos[a].x-m.x,p.pos[a].y-m.y);e.endShape(),e.pop()}if(this.ReadyToShareAct&&f&&f.pos&&f.pos.length){e.push(),e.translate(P),e.stroke(f.color),e.strokeWeight(f.weight),e.beginShape();for(let a=0,r=f.pos.length;a<r;a++)e.curveVertex(f.pos[a].x-m.x,f.pos[a].y-m.y);e.endShape(),e.pop()}}e.pop()},this.p5DrawingStack=[],this.p5ClearCurrentDraw=()=>{p={},this.p5DrawingStack.length=0,M=0,be(),e.redraw()};let M=0,be=()=>{l.clear(255,255,255,255);for(let a=0;a<M;a++)ie(l,this.p5DrawingStack[a])},ie=(a,r=p)=>{if(r.color){a.push(),a.translate(P),a.stroke(r.color),a.strokeWeight(r.weight),a.beginShape();for(let c=0,y=r.pos.length;c<y;c++)a.curveVertex(r.pos[c].x,r.pos[c].y);a.endShape(),a.pop(),a.redraw(),e.redraw()}},Be=a=>{for(let r=0,c=a.length;r<c;r++)ie(l,a[r]);M=this.p5DrawingStack.length};e.windowResized=()=>{setTimeout(()=>{this.p5SetCanvasViewportInit()},0)};let p={},f={},He=a=>{f=a,e.redraw()},Xe=a=>{f&&f.pos&&f.pos.push(a),e.redraw()},Ne=a=>{f.pos.push(a),f.pos.push(a),this.p5DrawingStack.length=M,f&&(this.p5DrawingStack.push(f),ie(l,f)),M=this.p5DrawingStack.length,f=null,e.redraw()};const W=56;let Se,K,De,Re,Ae,ae,ke,_e=0,ge=!1,H=!1;e.mousePressed=a=>{if(X){if(e.mouseY<W||e.mouseY>e.height-W)return void(H=!0);switch(a.which){case 1:this.isCropMode?Te():Ie();break;case 3:K=e.createVector(e.mouseX,e.mouseY),ae=L.copy(),Se=e.createVector(e.mouseX,e.mouseY);break;case 2:this.p5SetCanvasViewportInit()}}};let Te=(a,r)=>{let c=j(a,r),y=U.copy().add(g).sub(e.createVector(l.width/2,l.height/2)),O=c.dist(y),Y=.2*e.max(g.x,g.y);ge=O<Y,ge?(Re=e.createVector(e.mouseX,e.mouseY),ke=g.copy()):De=e.createVector(e.mouseX,e.mouseY).sub(U.mult(S))},Ie=(a,r)=>{D.style.fill="var(--ion-color-dark)",C.style.fill="var(--ion-color-medium)";let c=j(a,r);c.sub(P),c.add(m);let y={x:c.x,y:c.y},O=I.color().levels,Y=`#${e.hex(O[0],2)}${e.hex(O[1],2)}${e.hex(O[2],2)}`;p={pos:[],color:Y,weight:ee*fe},p.pos.push(y),p.pos.push(y),this.ReadyToShareAct&&this.webrtc.dataChannel.send(JSON.stringify({type:"draw",act:"start",data:p})),e.redraw()};e.mouseDragged=a=>{if(X)switch(a.which){case 1:if(this.isCropMode&&!H){let r=e.createVector(e.mouseX,e.mouseY);ge?g=ke.copy().add(Re.copy().sub(r).div(-S)):U=De.copy().sub(r).div(-S),e.redraw()}else{let r=j();r.sub(P),r.add(m);let c={x:r.x,y:r.y};p&&p.pos&&p.pos.push(c),this.ReadyToShareAct&&this.webrtc.dataChannel.send(JSON.stringify({type:"draw",act:"moved",data:c})),e.redraw()}break;case 3:Se=e.createVector(e.mouseX,e.mouseY),L=ae.copy().add(Se.sub(K).div(S)),e.redraw()}},e.mouseWheel=a=>{X&&(e.mouseY<W||e.mouseY>e.height-W?H=!0:(Ue(j()),S*=a.deltaY<0?1.1:.9,e.redraw()))},e.mouseReleased=a=>{if(X){if(1===a.which&&!this.isCropMode&&!H){let r=j();r.sub(P),r.add(m);let c={x:r.x,y:r.y};if(p)try{p.pos.push(c),p.pos.push(c),this.ReadyToShareAct&&this.webrtc.dataChannel.send(JSON.stringify({type:"draw",act:"end",data:c}))}catch{}Pe()}H=!1}};let Ue=a=>{te=e.createVector(e.mouseX,e.mouseY),L=a.mult(-1)},j=(a,r)=>{let c=e.createVector(a||e.mouseX,r||e.mouseY);return c.sub(te),c.div(S),c.sub(L),c},R=[],re=!1,X=!0,Ye=a=>{X=a};e.touchStarted=a=>{if(X){if(R=a.touches,a.changedTouches[0].clientY<W||a.changedTouches[0].clientY>e.height-W)return void(H=!0);switch(re=!0,R.length){case 1:this.isCropMode?Te(a.changedTouches[0].clientX,a.changedTouches[0].clientY-W):Ie(a.changedTouches[0].clientX,a.changedTouches[0].clientY-W);break;case 2:let r=e.createVector(R[0].clientX,R[0].clientY-56),c=e.createVector(R[1].clientX,R[1].clientY-56);_e=r.dist(c),K=r.copy().add(c).div(2),ae=L.copy(),Ae=S,p=null,this.ReadyToShareAct&&this.webrtc.dataChannel.send(JSON.stringify({type:"draw",act:"cancel"}));break;default:re=!1,this.p5SetCanvasViewportInit()}}},e.touchMoved=a=>{if(X&&re){switch(R=a.touches,R.length){case 1:if(this.isCropMode&&!H){let r=e.createVector(a.changedTouches[0].clientX,a.changedTouches[0].clientY-W);ge?g=ke.copy().add(Re.copy().sub(r).div(-S)):U=De.copy().sub(r).div(-S),e.redraw()}else{let r=j(a.changedTouches[0].clientX,a.changedTouches[0].clientY-W);r.sub(P),r.add(m);let c={x:r.x,y:r.y};p&&p.pos&&p.pos.push(c),this.ReadyToShareAct&&this.webrtc.dataChannel.send(JSON.stringify({type:"draw",act:"moved",data:c})),e.redraw()}break;case 2:{let r=e.createVector(R[0].clientX,R[0].clientY-56),c=e.createVector(R[1].clientX,R[1].clientY-56),y=r.copy().add(c).div(2);S=r.dist(c)/_e*Ae,L=ae.copy().add(y.sub(K).div(S)),e.redraw()}}return!1}},e.touchEnded=a=>{if(X&&a.changedTouches){switch(R=a.touches,re=!1,R.length){case 0:if(!this.isCropMode&&!H&&p){let r=j(a.changedTouches[0].clientX,a.changedTouches[0].clientY-W);r.sub(P),r.add(m);let c={x:r.x,y:r.y};p.pos.push(c),p.pos.push(c),this.ReadyToShareAct&&this.webrtc.dataChannel.send(JSON.stringify({type:"draw",act:"end",data:c})),Pe()}break;case 1:if(!re)return;$e(),_e=0,p=null}H=!1}};let $e=()=>{K=e.createVector(R[0].clientX,R[0].clientY-56),ae=L.copy()},Pe=()=>{this.p5DrawingStack.length=M,p&&(this.p5DrawingStack.push(p),ie(l,p)),M=this.p5DrawingStack.length,K=null,H=!1,p=null,e.redraw()}})}ClickRemoteAddButton(){this.isDrawServerCreated||(this.ServerList=this.nakama.get_all_online_server(),this.ServerList.length?(this.p5SetDrawable(!1),this.RemoteDraw.open()):this.RemoteBridgeServerSelected({detail:{value:"local"}}))}RemoteBridgeServerSelected(s){var t=this;return(0,_.A)(function*(){if(t.isDrawServerCreated)return;let i=s.detail.value;if("local"===i){let e;t.alertCtrl.create({header:t.lang.text.voidDraw.LocalAddrInput,inputs:[{type:"text",placeholder:"(wss://)0.0.0.0"},{type:"text",placeholder:t.lang.text.voidDraw.CreateChannel}],buttons:[{text:t.lang.text.voidDraw.Confirm,handler:n=>{n[0]?(t.InputCustomAddress=n[0],t.p5SetDrawable(!1),e=!0,t.isDrawServerCreated=!0,t.CreateOnMessageLink(),t.CreateOnOpenAct(!1,(0,_.A)(function*(){let x=t.p5getCropPos();t.nakama.VoidDrawInitCallBack=null,yield new Promise(b=>setTimeout(b,t.global.WebsocketRetryTerm)),t.IceWebRTCWsClient.send(JSON.stringify({type:"size",width:t.p5ActualCanvas.width,height:t.p5ActualCanvas.height,cropX:x.x,cropY:x.y}))})),t.CreateRemoteLocalClient(n[0],n[1])):t.p5toast.show({text:t.lang.text.voidDraw.InputAddress})}}]}).then(n=>{n.onWillDismiss().then(()=>{t.p5SetDrawable(!0)}),n.onDidDismiss().then(()=>{!e&&!t.WillLeaveHere&&t.global.RestoreShortCutAct("voiddraw-remote-bridge")}),t.global.StoreShortCutAct("voiddraw-remote-bridge"),n.present()})}else{t.RemoteLoadingCtrl=yield t.loadingCtrl.create({message:t.lang.text.voidDraw.WaitingConnection}),t.RemoteLoadingCtrl.present();let l=i.info.isOfficial,m=i.info.target;t.webrtc.CurrentMatch=t.nakama.self_match[l][m],t.isDrawServerCreated=!0,t.RemoteLoadingCtrl.message=t.lang.text.voidDraw.WebRTC_Waiting,t.webrtc.initialize("data",void 0,{isOfficial:l,target:m}).then(()=>{t.CreateOnMessageLink(),t.CreateOnOpenAct(!1,(0,_.A)(function*(){let n=t.p5getCropPos();t.nakama.VoidDrawInitCallBack=null,yield t.nakama.servers[l][m].socket.sendMatchState(t.nakama.self_match[l][m].match_id,Z.I.VOIDDRAW_INIT,encodeURIComponent(JSON.stringify({type:"size",width:t.p5ActualCanvas.width,height:t.p5ActualCanvas.height,cropX:n.x,cropY:n.y})))})),t.webrtc.CreateOffer(),t.nakama.VoidDrawInitCallBack=n=>{t.create_new_canvas({width:n.width,height:n.height}),t.p5setCropPos(n.cropX,n.cropY),t.p5SetDrawable(!0),t.p5voidDraw.redraw()},t.webrtc.InitReplyCallback=(0,_.A)(function*(){t.CreateOnOpenAct(!0),t.RemoteLoadingCtrl.message=t.lang.text.voidDraw.WebRTC_Offer,t.webrtc.CreateAnswer()}),t.nakama.servers[l][m].socket.sendMatchState(t.nakama.self_match[l][m].match_id,Z.I.WEBRTC_INIT_REQ_SIGNAL,encodeURIComponent(""))})}})()}CreateRemoteLocalClient(s,t){var i=this;let n,x,e=s.split("://"),l=e.pop().split(":"),m=e.pop();m?m+=":":m=this.global.checkProtocolFromAddress(l[0])?"wss:":"ws:",this.IceWebRTCWsClient=new WebSocket(`${m}//${l[0]}:12013/`),this.AddShortCut(),this.isDrawServerCreated=!0,this.IceWebRTCWsClient.onopen=(0,_.A)(function*(){i.p5toast.show({text:`${i.lang.text.voidDraw.Connected}: ${l[0]}`}),t?(i.IceWebRTCWsClient.send(JSON.stringify({type:"join",channel:t})),yield new Promise(b=>setTimeout(b,i.global.WebsocketRetryTerm)),i.IceWebRTCWsClient.send(JSON.stringify({type:"size_req",channel:t})),i.RemoteLoadingCtrl=yield i.loadingCtrl.create({message:i.lang.text.voidDraw.WaitingConnection}),i.RemoteLoadingCtrl.present(),i.p5SetDrawable(!1)):i.IceWebRTCWsClient.send(JSON.stringify({type:"init"}))}),this.IceWebRTCWsClient.onmessage=function(){var b=(0,_.A)(function*(T){let D,C=JSON.parse(T.data);if(void 0===x)x=C.uid;else if(x==C.uid)return;switch(C.type){case"init_id":n=yield i.modalCtrl.create({component:ue.n,componentProps:{address:s,channel:C.id},cssClass:"transparent-modal"}),n.onWillDismiss().then(()=>{i.global.RestoreShortCutAct("voiddraw-remote"),i.p5SetDrawable(!0)}),i.global.StoreShortCutAct("voiddraw-remote"),i.p5SetDrawable(!1),n.present(),i.IceWebRTCWsClient.send(JSON.stringify({type:"join",channel:C.id})),D=C.id;break;case"init_req":i.p5SetDrawable(!1),i.RemoteLoadingCtrl.message=i.lang.text.voidDraw.WebRTC_Init,i.webrtc.initialize("data").then((0,_.A)(function*(){i.CreateOnMessageLink(),i.CreateOnOpenAct(!1,(0,_.A)(function*(){i.nakama.VoidDrawInitCallBack=null})),i.webrtc.CreateOffer(),yield new Promise(ee=>setTimeout(ee,i.global.WebsocketRetryTerm)),i.IceWebRTCWsClient.send(JSON.stringify({type:"socket_react",channel:D,act:"WEBRTC_INIT_REQ_SIGNAL"}))}));break;case"size_req":n&&n.dismiss(),i.RemoteLoadingCtrl=yield i.loadingCtrl.create({message:i.lang.text.voidDraw.WaitingConnection}),i.RemoteLoadingCtrl.present();let I=i.p5getCropPos();i.IceWebRTCWsClient.send(JSON.stringify({type:"size",width:i.p5ActualCanvas.width,height:i.p5ActualCanvas.height,cropX:I.x,cropY:I.y,channel:D}));break;case"socket_react":switch(C.act){case"WEBRTC_REPLY_INIT_SIGNAL":i.RemoteLoadingCtrl.message=i.lang.text.voidDraw.WebRTC_Reply,i.nakama.socket_reactive[C.act](C.data_str),"EOL"==C.data_str&&(i.RemoteLoadingCtrl.message=i.lang.text.voidDraw.WebRTC_Offer,i.webrtc.CreateAnswer({client:i.IceWebRTCWsClient,channel:D})),i.RemoteLoadingCtrl.message=i.lang.text.voidDraw.WebRTC_Ice;break;case"WEBRTC_ICE_CANDIDATES":i.nakama.socket_reactive[C.act](C.data_str,{client:i.IceWebRTCWsClient,channel:D}),i.RemoteLoadingCtrl.dismiss(),i.p5SetDrawable(!0),i.IceWebRTCWsClient.send(JSON.stringify({type:"init_end",channel:D}));break;case"WEBRTC_INIT_REQ_SIGNAL":i.nakama.socket_reactive[C.act]({client:i.IceWebRTCWsClient,channel:D});break;case"WEBRTC_RECEIVE_ANSWER":i.nakama.socket_reactive[C.act](C.data_str,{client:i.IceWebRTCWsClient,channel:D})}break;case"size":i.create_new_canvas({width:C.width,height:C.height}),i.p5setCropPos(C.cropX,C.cropY),i.p5SetDrawable(!1),i.p5voidDraw.redraw(),i.RemoteLoadingCtrl.message=i.lang.text.voidDraw.WebRTC_Init,i.webrtc.initialize("data").then(()=>{i.CreateOnOpenAct(!0),i.CreateOnMessageLink(),i.RemoteLoadingCtrl.message=i.lang.text.voidDraw.WebRTC_Offer,i.webrtc.CreateOffer(),i.IceWebRTCWsClient.send(JSON.stringify({type:"init_req"}))});break;case"init_end":i.p5SetDrawable(!0)}});return function(T){return b.apply(this,arguments)}}(),this.IceWebRTCWsClient.onerror=b=>{if(console.log("\uadf8\ub9bc\ud310 \uae30\ub2a5 \uacf5\uc720 \uc5f0\uacb0 \uc624\ub958: ",b),0==this.InputCustomAddress.indexOf("wss://")&&("DesktopPWA"==Q.aH||"MobilePWA"==Q.aH)){let T=this.InputCustomAddress.split("://");this.global.open_link(`https://${T.pop()}:9001`),this.InputCustomAddress=null}this.IceWebRTCWsClient.close(),this.p5toast.show({text:`${this.lang.text.TodoDetail.Disconnected}: ${b}`})},this.IceWebRTCWsClient.onclose=()=>{n&&n.dismiss(),this.isDrawServerCreated=!1,this.webrtc.close_webrtc(!1),this.IceWebRTCWsClient.onopen=null,this.IceWebRTCWsClient.onclose=null,this.IceWebRTCWsClient.onmessage=null,this.IceWebRTCWsClient.onerror=null}}CreateOnOpenAct(s=!1,t=(0,_.A)(function*(){})){var i=this;this.webrtc.dataChannelOpenAct=(0,_.A)(function*(){if(i.p5SetDrawable(!0),i.ReadyToShareAct=!0,i.RemoteLoadingCtrl&&i.RemoteLoadingCtrl.dismiss(),i.p5ClearCurrentDraw(),!s&&(t&&(yield t()),i.navParams.path))try{let e=yield i.indexed.loadBlobFromUserPath(i.navParams.path,""),m=(yield i.global.GetBase64ThroughFileReader(e)).match(/(.{1,64})/g);for(let n=0,x=m.length;n<x;n++)yield i.webrtc.dataChannel.send(JSON.stringify({type:"background",act:"part",data:m[n]}));yield i.webrtc.dataChannel.send(JSON.stringify({type:"background",act:"EOF"}))}catch(e){console.log("\ubc30\uacbd \uadf8\ub9bc \uacf5\uc720\ud558\uae30 \uc624\ub958: ",e)}})}CreateOnMessageLink(){this.webrtc.dataChannelOnMsgAct=s=>{let t=JSON.parse(s);switch(t.type){case"drawline":this.p5DrawingStack=t.data,this.p5updateRemoteCurve(t.data),this.p5voidDraw.redraw();break;case"background":switch(t.act){case"part":this.RemoteBackgroundImage+=t.data;break;case"EOF":this.p5voidDraw.loadImage(this.RemoteBackgroundImage,i=>{this.p5BaseImage=i,this.p5ImageCanvas.image(this.p5BaseImage,0,0),this.p5ImageCanvas.redraw(),this.p5SetCanvasViewportInit(),this.RemoteBackgroundImage=""},i=>{console.error("\uadf8\ub9bc\ud310 \ubc30\uacbd \uc774\ubbf8\uc9c0 \ubd88\ub7ec\uc624\uae30 \uc624\ub958: ",i),this.p5ImageCanvas.redraw(),this.p5SetCanvasViewportInit(),this.RemoteBackgroundImage=""})}break;case"draw":switch(t.act){case"start":this.p5RemoteDrawStart(t.data);break;case"moved":this.p5RemoteDrawing(t.data);break;case"cancel":this.p5CancelCurrentDraw();break;case"crop":this.p5setCropPos(t.cropPX,t.cropPY),this.p5setCropSize(t.cropSX,t.cropSY),this.isCropMode=!0,this.p5apply_crop(!1);break;case"end":this.p5RemoteDrawingEnd(t.data)}break;case"same":"history_act"===t.act&&this.p5history_act(t.data,!0)}},this.webrtc.dataChannelOnCloseAct=()=>{this.ReadyToShareAct=!1,this.isDrawServerCreated=!1,this.RemoteLoadingCtrl&&this.RemoteLoadingCtrl.dismiss(),this.p5SetDrawable(!0),this.p5toast.show({text:this.lang.text.TodoDetail.Disconnected}),this.nakama.VoidDrawInitCallBack=null}}change_line_weight(){this.p5set_line_weight()}open_crop_tool(){this.p5open_crop_tool()}dismiss_draw(){this.isCropMode?this.p5apply_crop():(this.mainLoading.present(),this.WithoutSave=!1,this.p5save_image())}ionSelectCancel(){this.p5voidDraw&&this.p5SetDrawable&&!this.isDrawServerCreated&&this.p5SetDrawable(!0)}RemoveShortCut(){this.p5voidDraw&&this.p5SetDrawable&&this.p5SetDrawable(!1),delete this.global.p5KeyShortCut.HistoryAct,delete this.global.p5KeyShortCut.AddAct,delete this.global.p5KeyShortCut.DeleteAct,delete this.global.p5KeyShortCut.SKeyAct,delete this.global.p5KeyShortCut.FKeyAct,delete this.global.p5KeyShortCut.Escape}ionViewWillLeave(){this.WillLeaveHere=!0,this.RemoveShortCut(),this.global.RestoreShortCutAct("void-draw")}ionViewDidLeave(){this.WithoutSave&&this.mainLoading.remove()}}return(w=E).\u0275fac=function(s){return new(s||w)(o.rXU(V.y),o.rXU(d.W3),o.rXU(d.hG),o.rXU(d.Xi),o.rXU($.z3),o.rXU(v.n),o.rXU(Z.X),o.rXU(k.G),o.rXU(G.j),o.rXU(z.Ix),o.rXU(z.nX),o.rXU(q.q9))},w.\u0275cmp=o.VBU({type:w,selectors:[["app-void-draw"]],viewQuery:function(s,t){if(1&s&&o.GBs(he,5),2&s){let i;o.mGM(i=o.lsd())&&(t.RemoteDraw=i.first)}},decls:14,vars:4,consts:[["RemoteDraw",""],[1,"ion-no-border"],["slot","start"],["defaultHref",""],["oncontextmenu","return false;"],["hidden",""],["value","local",3,"ionChange","ionCancel","label"],["value","local"],[3,"value",4,"ngFor","ngForOf"],["id","voidDraw",1,"full_screen",2,"display","flex","overflow","hidden","background-color","black"],[3,"value"]],template:function(s,t){if(1&s){const i=o.RV6();o.j41(0,"ion-header",1)(1,"ion-toolbar")(2,"ion-title"),o.EFF(3),o.k0s(),o.j41(4,"ion-buttons",2),o.nrm(5,"ion-back-button",3),o.k0s()()(),o.j41(6,"ion-content",4)(7,"div",5)(8,"ion-select",6,0),o.bIt("ionChange",function(l){return o.eBV(i),o.Njj(t.RemoteBridgeServerSelected(l))})("ionCancel",function(){return o.eBV(i),o.Njj(t.ionSelectCancel())}),o.j41(10,"ion-select-option",7),o.EFF(11),o.k0s(),o.DNE(12,me,2,2,"ion-select-option",8),o.k0s()(),o.nrm(13,"div",9),o.k0s()}2&s&&(o.R7$(3),o.JRh(t.lang.text.ChatRoom.voidDraw),o.R7$(5),o.Y8G("label",t.lang.text.voidDraw.ConnectToAddress),o.R7$(3),o.JRh(t.lang.text.voidDraw.InternalConn),o.R7$(),o.Y8G("ngForOf",t.ServerList))},dependencies:[ce.Sq,d.QW,d.W9,d.eU,d.Nm,d.Ip,d.BC,d.ai,d.Je,d.el]}),E})()},{path:"link-qr",loadChildren:()=>u.e(3746).then(u.bind(u,3746)).then(w=>w.LinkQrPageModule)}];let ve=(()=>{var w;class E{}return(w=E).\u0275fac=function(s){return new(s||w)},w.\u0275mod=o.$C({type:w}),w.\u0275inj=o.G2t({imports:[z.iI.forChild(we),z.iI]}),E})(),Le=(()=>{var w;class E{}return(w=E).\u0275fac=function(s){return new(s||w)},w.\u0275mod=o.$C({type:w}),w.\u0275inj=o.G2t({imports:[ce.MD,pe.YN,d.bv,ve]}),E})()}}]);