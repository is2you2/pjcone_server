"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[4020],{4020:(X,B,u)=>{u.d(B,{j:()=>H});var g=u(467),O=u(8326),U=u(5402),b=u(482),J=u(92),E=u(3953),j=u(9900),V=u(755),K=u(4234),G=u(4237);!function Y(){("http:"!=window.location.protocol||0==window.location.host.indexOf("localhost"))&&u.e(925).then(u.t.bind(u,925,23))}();let H=(()=>{var S;class M{constructor(t,e,i,n,s){this.p5toast=t,this.indexed=e,this.lang=i,this.nakama=n,this.global=s,this.Peers={},this.OnUse=!1,this.StatusText="",this.nakama.WebRTCService=this,this.global.WebRTCService=this}initialize(t,e){var i=this;return(0,g.A)(function*(){if(i.OnUse&&"data"!=t)throw i.p5toast.show({text:i.lang.text.WebRTCDevManager.AlreadyCalling}),i.lang.text.WebRTCDevManager.AlreadyCalling;if("data"!=t&&("http:"==window.location.protocol&&0!=window.location.host.indexOf("localhost")||!(yield U.R.requestAudioRecordingPermission()).value))throw i.lang.text.WebRTCDevManager.SecurityError;if(yield i.close_webrtc(e),i.Peers[e]||(i.Peers[e]={}),i.Peers[e].TypeIn=t,i.Peers[e].IceCandidates=[],i.Peers[e].ReceivedOfferPart="",i.Peers[e].ReceivedAnswerPart="","data"!=t){i.createP5_panel(e);try{i.localMedia||(i.localMedia=document.createElement(t),i.localMedia.id="webrtc_video",i.localMedia.style.width="0px",i.localMedia.style.height="0px",i.localMedia.autoplay=!0,"video"==t&&(i.localMedia.playsInline=!0),i.localMedia.muted=!0,document.body.appendChild(i.localMedia)),i.remoteMedia=document.createElement(t),i.remoteMedia.id="webrtc_video_remote",i.remoteMedia.style.width="0px",i.remoteMedia.style.height="0px",i.remoteMedia.autoplay=!0,"video"==t&&(i.remoteMedia.playsInline=!0),document.body.appendChild(i.remoteMedia);const n=yield i.getMediaConst(t);if(!i.localStream){try{i.localStream=yield navigator.mediaDevices.getUserMedia(n)}catch{"DesktopPWA"==J.aH&&(i.localStream=yield navigator.mediaDevices.getDisplayMedia())}i.localMedia.srcObject=i.localStream}}catch(n){console.log("navigator.getUserMedia error: ",n),yield i.close_webrtc(e),i.p5toast.show({text:`${i.lang.text.WebRTCDevManager.InitErr}: ${n}`})}}yield i.createCall(e)})()}getMediaConst(t){var e=this;return(0,g.A)(function*(){var i,n;let r,a,s=yield e.getDeviceList(),v=Number(null!==(i=localStorage.getItem("VideoInputDev"))&&void 0!==i?i:NaN),f=Number(null!==(n=localStorage.getItem("AudioInputDev"))&&void 0!==n?n:NaN);for(let c=0,T=s.length,_=0,P=0;c<T&&(!r||!a);c++)!r&&"audioinput"==s[c].kind&&(Number.isNaN(f)?(r=s[c].deviceId,localStorage.setItem("AudioInputDev",`${P}`)):P==f&&(r=s[c].deviceId),P++),!a&&"videoinput"==s[c].kind&&(Number.isNaN(v)?(a=s[c].deviceId,localStorage.setItem("AudioInputDev",`${_}`)):_==v&&(a=s[c].deviceId),_++);let d={};return"video"==t?(d.video=!0,a&&(d.video={deviceId:a})):d.video=!1,d.audio=!0,r&&(d.audio={deviceId:r}),d})()}WEBRTC_INIT_REQ_SIGNAL(t,e){const i=JSON.stringify(this.Peers[e].LocalOffer);this.Peers[e].LocalOfferPartArray=i.match(/(.{1,64})/g),this.WEBRTC_REPLY_INIT_SIGNAL_PART(t,e)}WEBRTC_REPLY_INIT_SIGNAL_PART(t,e){if(t.client&&t.client.readyState==t.client.OPEN){const i=this.Peers[e].LocalOfferPartArray.shift();t.client.send(i?JSON.stringify({type:"socket_react",channel:t.channel,act:"WEBRTC_REPLY_INIT_SIGNAL",data_str:i}):JSON.stringify({type:"socket_react",channel:t.channel,act:"WEBRTC_REPLY_INIT_SIGNAL",data_str:"EOL"}))}}WEBRTC_RECEIVE_ANSWER_PART(t,e){if(t.client&&t.client.readyState==t.client.OPEN){const i=this.Peers[e].LocalAnswerPartArray.shift();i?t.client.send(JSON.stringify({type:"socket_react",channel:t.channel,act:"WEBRTC_RECEIVE_ANSWER",data_str:i})):(t.client.send(JSON.stringify({type:"socket_react",channel:t.channel,act:"WEBRTC_RECEIVE_ANSWER",data_str:"EOL"})),this.Peers[e].JoinInited=!0)}}WEBRTC_REPLY_INIT_SIGNAL(t,e,i){"EOL"==t?(this.createRemoteOfferFromAnswer(JSON.parse(this.Peers[i].ReceivedOfferPart),i),delete this.Peers[i].ReceivedOfferPart,this.Peers[i].JoinInited=!0):(this.Peers[i].ReceivedOfferPart+=t,e.client&&e.client.readyState==e.client.OPEN&&e.client.send(JSON.stringify({type:"socket_react",channel:e.channel,act:"WEBRTC_REPLY_INIT_SIGNAL_PART"})))}WEBRTC_RECEIVE_ANSWER(t,e,i){"EOL"==t?(this.ReceiveRemoteAnswer(JSON.parse(this.Peers[i].ReceivedAnswerPart),e,i),delete this.Peers[i].ReceivedAnswerPart):(this.Peers[i].ReceivedAnswerPart+=t,e.client&&e.client.readyState==e.client.OPEN&&e.client.send(JSON.stringify({type:"socket_react",channel:e.channel,act:"WEBRTC_RECEIVE_ANSWER_PART"})))}WEBRTC_ICE_CANDIDATES(t,e,i){this.ReceiveIceCandidate(JSON.parse(t),e,i)}createP5_panel(t){var e=this;this.OnUse=!0,this.p5canvas&&(clearTimeout(this.p5waitingAct),this.p5waitingAct=null,this.p5hangup=null,this.p5canvas.remove()),this.p5canvas=new O(i=>{let n,s,r,a,v,f,d,c,P,C,T=!0,_=!0,A=1;i.setup=()=>{if("http:"!=window.location.protocol||0==window.location.host.indexOf("localhost")){let o,l=()=>{this.Peers[t].JoinInited?(o.stop(.1),clearTimeout(this.p5waitingAct)):(o&&o.stop(.1),o=new O.Oscillator(380,"sine"),o.start(),o.amp(1,.15),o.amp(0,.75),this.p5waitingAct=setTimeout(()=>{l()},1200))};this.p5waitingAct=setTimeout(()=>{l()},0),this.p5hangup=()=>{o.stop(.1),clearTimeout(this.p5waitingAct),o=new O.Oscillator(380,"sine"),o.start(),o.freq(250,.35),o.amp(1,.15),o.amp(0,.25),o.amp(1,.35),o.amp(0,.45)}}i.noCanvas(),n=i.createDiv(),n.id("outterDiv"),n.style("position: absolute; left: 50%; top: 0px; z-index: 1"),n.style("transform: translateX(-50%)"),n.style("width: fit-content; height: fit-content"),n.style("padding: 8px 16px;"),n.style("display: flex; justify-content: center;"),r=i.createDiv(),r.parent(n),r.style("display: flex; justify-content: center;"),r.style("width: fit-content; height: fit-content"),r.style("border-radius: 32px"),r.style("background: var(--toast-background-color)"),r.style("padding: 6px 12px"),s=i.createDiv(),s.parent(r),s.id("webrtc_content"),s.style("display: flex; justify-content: center;"),s.style("flex-direction","column"),s.style("width: fit-content; height: fit-content"),s.style("word-break: break-all"),s.style("background: var(--toast-background-color)"),s.style("border-radius: 32px"),s.style("padding: 6px 12px"),s.style("color: "+(b.ud?"white":"black")),k(),a=i.createDiv(),a.parent(s),a.id("webrtc_content"),a.style("display: flex; justify-content: center;"),a.style("align-self","center"),a.style("width: fit-content; height: fit-content"),d=i.createButton('<ion-icon style="width: 32px; height: 32px;" name="mic-outline"></ion-icon>'),d.parent(a),d.style("padding","0px"),d.style("margin","4px"),d.style("border-radius","16px"),d.style("width","40px"),d.style("height","40px"),d.mouseClicked(()=>{const o=this.localStream.getAudioTracks();for(let l=0,p=o.length;l<p;l++)o[l].enabled=!1;c.show(),d.hide(),T=!1}),c=i.createButton('<ion-icon style="width: 32px; height: 32px;" name="mic-off-outline"></ion-icon>'),c.parent(a),c.style("background-color","grey"),c.style("padding","0px"),c.style("margin","4px"),c.style("border-radius","16px"),c.style("width","40px"),c.style("height","40px"),c.mouseClicked(()=>{const o=this.localStream.getAudioTracks();for(let l=0,p=o.length;l<p;l++)o[l].enabled=!0;d.show(),c.hide(),T=!0}),c.hide(),"video"==this.Peers[t].TypeIn&&(v=i.createButton('<ion-icon style="width: 32px; height: 32px;" name="videocam-outline"></ion-icon>'),v.parent(a),v.style("padding","0px"),v.style("margin","4px"),v.style("border-radius","16px"),v.style("width","40px"),v.style("height","40px"),v.mouseClicked(()=>{const o=this.localStream.getVideoTracks();for(let l=0,p=o.length;l<p;l++)o[l].enabled=!1;f.show(),v.hide(),_=!1}),f=i.createButton('<ion-icon style="width: 32px; height: 32px;" name="videocam-off-outline"></ion-icon>'),f.parent(a),f.style("background-color","grey"),f.style("padding","0px"),f.style("margin","4px"),f.style("border-radius","16px"),f.style("width","40px"),f.style("height","40px"),f.mouseClicked(()=>{const o=this.localStream.getVideoTracks();for(let l=0,p=o.length;l<p;l++)o[l].enabled=!0;v.show(),f.hide(),_=!0}),f.hide()),P=i.createButton('<ion-icon style="width: 32px; height: 32px;" name="settings-outline"></ion-icon>'),P.parent(a),P.style("padding","0px"),P.style("margin","4px"),P.style("border-radius","16px"),P.style("width","40px"),P.style("height","40px"),P.mouseClicked((0,g.A)(function*(){P.elt.disabled=!0;let o=yield e.getDeviceList();e.global.PageDismissAct["webrtc-manage"]=function(){var l=(0,g.A)(function*(p){P.elt.disabled=!1;try{var x;if(!Object.keys(p).length)throw"\uc7a5\uce58 \ubcc0\uacbd \uc815\ubcf4\uac00 \ube44\uc5b4\uc788\uc74c";let R={};"video"==e.Peers[t].TypeIn&&p.data.videoinput&&(R.video={deviceId:{exact:p.data.videoinput.deviceId}}),p.data.audioinput&&(R.audio={deviceId:{exact:p.data.audioinput.deviceId}}),e.localStream.getTracks().forEach(h=>h.stop()),e.localStream="video"==e.Peers[t].TypeIn&&null!==(x=p.data.videoinput)&&void 0!==x&&x.useScr?yield navigator.mediaDevices.getDisplayMedia():yield navigator.mediaDevices.getUserMedia(R);const L=e.localStream.getAudioTracks();for(let h=0,y=L.length;h<y;h++)L[h].enabled=T;const W=e.localStream.getVideoTracks();for(let h=0,y=W.length;h<y;h++)W[h].enabled=_;e.localMedia.srcObject=e.localStream;const z=e.Peers[t].PeerConnection.getSenders();for(let h of z){var w,D;if("video"==(null===(w=h.track)||void 0===w?void 0:w.kind)){const y=e.localStream.getVideoTracks()[0];h?yield h.replaceTrack(y):e.Peers[t].PeerConnection.addTrack(y,e.localStream)}if("audio"==(null===(D=h.track)||void 0===D?void 0:D.kind)){const y=e.localStream.getAudioTracks()[0];h?yield h.replaceTrack(y):e.Peers[t].PeerConnection.addTrack(y,e.localStream)}}e.CreateOffer(t)}catch(R){console.log("\ubbf8\ub514\uc5b4 \uc2a4\ud2b8\ub9bc \ubcc0\uacbd \uc624\ub958: ",R)}e.global.RestoreShortCutAct("webrtc-manage"),delete e.global.PageDismissAct["webrtc-manage"]});return function(p){return l.apply(this,arguments)}}(),e.global.StoreShortCutAct("webrtc-manage"),e.global.ActLikeModal("webrtc-manage-io-dev",{list:JSON.parse(JSON.stringify(o)),typein:e.Peers[t].TypeIn,dismiss:"webrtc-manage"})})),C=i.createButton('<ion-icon style="width: 32px; height: 32px;" name="close-circle-outline"></ion-icon>'),C.parent(a),C.style("background-color","red"),C.style("padding","0px"),C.style("margin","4px"),C.style("border-radius","16px"),C.style("width","40px"),C.style("height","40px"),C.mouseClicked((0,g.A)(function*(){yield e.close_webrtc(t)}))};let N=!1;i.draw=()=>{A>0&&(A-=.03),k(),this.OnUse||this.p5hangup&&!N&&(this.p5hangup(),n.hide(),setTimeout(()=>{this.OnUse||(clearTimeout(this.p5waitingAct),this.p5waitingAct=null,this.p5hangup=null,this.p5canvas.remove())},1e3),N=!0)};let k=()=>{let o=i.lerpColor(i.color("#"+(b.ud?"30564e88":"b9543788")),i.color("#ffd94ebb"),A).levels,l=4*A;r.style(`padding: ${l}px ${l}px`),s.style(`padding: ${i.lerp(6,2,A)}px ${i.lerp(12,8,A)}px`),r.style(`background: rgba(${o[0]}, ${o[1]}, ${o[2]}, ${o[3]/255})`)}})}getDeviceList(){return(0,g.A)(function*(){return yield navigator.mediaDevices.enumerateDevices()})()}createCall(t){var e=this;return(0,g.A)(function*(){let i;e.Peers[t].isConnected=!0;try{let n=yield e.indexed.loadTextFromUserPath("servers/webrtc_server.json");i={},i.iceServers=JSON.parse(n)}catch{}(!i||!i.iceServers||!i.iceServers.length)&&(e.p5toast.show({text:e.lang.text.WebRTCDevManager.NoRegServer}),i=null),e.Peers[t].PeerConnection=new RTCPeerConnection(i),e.Peers[t].PeerConnection.onicecandidate=n=>e.handleConnection(n,t),e.Peers[t].PeerConnection.oniceconnectionstatechange=n=>{console.log("ICE Connection state: ",e.Peers[t].PeerConnection.iceConnectionState)},e.Peers[t].PeerConnection.onconnectionstatechange=function(){var n=(0,g.A)(function*(s){switch(s.target.connectionState){case"failed":case"disconnected":yield e.close_webrtc(t);break;case"connected":e.p5waitingAct&&clearTimeout(e.p5waitingAct);break;default:console.log("\uc5f0\uacb0 \uc0c1\ud0dc \ubcc0\uacbd\ub428: ",s.target.connectionState)}});return function(s){return n.apply(this,arguments)}}(),"data"!=e.Peers[t].TypeIn?(e.localStream.getTracks().forEach(n=>e.Peers[t].PeerConnection.addTrack(n,e.localStream)),e.Peers[t].PeerConnection.ontrack=n=>{e.remoteMedia.srcObject=n.streams[0]}):e.createDataChannel(void 0,t),e.Peers[t].PeerConnection.ondatachannel=n=>{e.Peers[t].dataChannel=n.channel},e.Peers[t].PeerConnection.onnegotiationneeded=function(){var n=(0,g.A)(function*(s){if(e.Peers[t].JoinInited){yield e.Peers[t].PeerConnection.createOffer({offerToReceiveVideo:!0}).then(a=>e.createdOffer(a,t)).catch(a=>e.setSessionDescriptionError(a));const r=JSON.stringify(e.Peers[t].LocalOffer);e.Peers[t].LocalOfferPartArray=r.match(/(.{1,64})/g),e.WEBRTC_REPLY_INIT_SIGNAL_PART({client:e.Peers[t].signalingChannel,channel:e.Peers[t].signalChannelId},t)}});return function(s){return n.apply(this,arguments)}}()})()}createDataChannel(t,e){this.Peers[e].dataChannel=this.Peers[e].PeerConnection.createDataChannel(t),this.createDataChannelListener(e)}createDataChannelListener(t){this.Peers[t].dataChannel.onopen=e=>{this.Peers[t].dataChannelOpenAct&&this.Peers[t].dataChannelOpenAct()},this.Peers[t].dataChannel.onclose=e=>{var i,n;this.Peers[t]&&(null===(i=(n=this.Peers[t]).dataChannelOnCloseAct)||void 0===i||i.call(n),this.Peers[t].dataChannelOpenAct=null,this.Peers[t].dataChannelOnMsgAct=null,this.Peers[t].dataChannelOnCloseAct=null)},this.Peers[t].dataChannel.onmessage=e=>{this.Peers[t].dataChannelOnMsgAct&&this.Peers[t].dataChannelOnMsgAct(e.data)}}CreateOffer(t){this.Peers[t].PeerConnection.createOffer({offerToReceiveVideo:!0}).then(e=>this.createdOffer(e,t)).catch(e=>this.setSessionDescriptionError(e))}handleConnection(t,e){let i=t.candidate;i&&this.Peers[e].IceCandidates.push(new RTCIceCandidate(i))}ReceiveIceCandidate(t,e,i){var n=this;this.ReplyIceCandidate&&clearTimeout(this.ReplyIceCandidate),this.ReplyIceCandidate=setTimeout((0,g.A)(function*(){for(;null!==(s=n.Peers[i])&&void 0!==s&&null!==(s=s.IceCandidates)&&void 0!==s&&s.length;){var s;const r=n.Peers[i].IceCandidates.shift();e.client&&e.client.readyState==e.client.OPEN&&e.client.send(JSON.stringify({type:"socket_react",act:"WEBRTC_ICE_CANDIDATES",channel:e.channel,data_str:JSON.stringify(r)})),yield new Promise(a=>setTimeout(a,n.global.WebsocketRetryTerm))}}),800),this.Peers[i].PeerConnection.addIceCandidate(t).then(()=>{console.log("Success to add new ice candidate")}).catch(s=>{console.error("failed to add ice candidate: ",s)})}createdOffer(t,e){this.Peers[e].LocalOffer=t,this.Peers[e].PeerConnection.setLocalDescription(t).then(()=>{this.setLocalDescriptionSuccess(this.Peers[e].PeerConnection)}).catch(i=>this.setSessionDescriptionError(i))}createRemoteOfferFromAnswer(t,e){this.Peers[e].PeerConnection.setRemoteDescription(t).then(()=>{this.setRemoteDescriptionSuccess(this.Peers[e].PeerConnection)}).catch(i=>this.setSessionDescriptionError(i))}CreateAnswer(t,e){this.Peers[e].PeerConnection.createAnswer().then(i=>this.createdAnswer(i,t,e)).catch(i=>this.setSessionDescriptionError(i))}setLocalDescriptionSuccess(t){this.setDescriptionSuccess(t,"setLocalDescription")}setRemoteDescriptionSuccess(t){this.setDescriptionSuccess(t,"setRemoteDescription")}createdAnswer(t,e,i){var n=this;return(0,g.A)(function*(){n.Peers[i].LocalAnswer=t,n.Peers[i].PeerConnection.setLocalDescription(t).then(()=>{n.setLocalDescriptionSuccess(n.Peers[i].PeerConnection)}).catch(r=>n.setSessionDescriptionError(r));const s=JSON.stringify(t);n.Peers[i].LocalAnswerPartArray=s.match(/(.{1,64})/g),n.WEBRTC_RECEIVE_ANSWER_PART(e,i)})()}ReceiveRemoteAnswer(t,e,i){var n=this;return(0,g.A)(function*(){for(n.Peers[i].PeerConnection.setRemoteDescription(t).then(()=>{n.setRemoteDescriptionSuccess(n.Peers[i].PeerConnection)}).catch(r=>n.setSessionDescriptionError(r));null!==(s=n.Peers[i])&&void 0!==s&&null!==(s=s.IceCandidates)&&void 0!==s&&s.length;){var s;const r=n.Peers[i].IceCandidates.shift();e.client&&e.client.readyState==e.client.OPEN&&(e.client.send(JSON.stringify({type:"socket_react",channel:e.channel,act:"WEBRTC_ICE_CANDIDATES",data_str:JSON.stringify(r)})),yield new Promise(a=>setTimeout(a,n.global.WebsocketRetryTerm)))}})()}setSessionDescriptionError(t){console.error(`Failed to create session description: ${t}.`)}setDescriptionSuccess(t,e){console.log(`Local ${e} complete.`)}HangUpCall(t){this.Peers[t]&&(this.Peers[t].isConnected=!1,this.Peers[t].PeerConnection&&(this.Peers[t].PeerConnection.close(),this.Peers[t].PeerConnection.onicecandidate=null,this.Peers[t].PeerConnection.oniceconnectionstatechange=null,this.Peers[t].PeerConnection.onconnectionstatechange=null,this.Peers[t].PeerConnection.ontrack=null,this.Peers[t].PeerConnection.ondatachannel=null,this.Peers[t].PeerConnection.onnegotiationneeded=null),this.Peers[t].PeerConnection=null)}close_webrtc(t){var e=this;return(0,g.A)(function*(){var i,n,s,r;e.HangUpCall(t),yield null===(i=e.Peers[t])||void 0===i||null===(n=i.HangUpCallBack)||void 0===n?void 0:n.call(i),"data"!=(null===(s=e.Peers[t])||void 0===s?void 0:s.TypeIn)&&(e.OnUse=!1,e.p5hangup&&e.p5hangup()),e.global.videoPIP||(e.localMedia&&e.localMedia.remove(),e.remoteMedia&&e.remoteMedia.remove(),e.localStream&&(e.localStream.getVideoTracks().forEach(a=>a.stop()),e.localStream.getAudioTracks().forEach(a=>a.stop())),e.localMedia=null,e.localStream=null,e.remoteMedia=null),null!==(r=e.Peers[t])&&void 0!==r&&r.dataChannel&&(e.Peers[t].dataChannel.onopen=null,e.Peers[t].dataChannel.onclose=null,e.Peers[t].dataChannel.onmessage=null),delete e.Peers[t]})()}}return(S=M).\u0275fac=function(t){return new(t||S)(E.KVO(j.G),E.KVO(V.n),E.KVO(K.y),E.KVO(G.X),E.KVO(b.z3))},S.\u0275prov=E.jDH({token:S,factory:S.\u0275fac,providedIn:"root"}),M})()}}]);