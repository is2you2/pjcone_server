"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[6524],{6524:(It,T,r)=>{r.r(T),r.d(T,{InstantCallPageModule:()=>bt});var y=r(177),A=r(4341),c=r(5374),S=r(9858),f=r(467),k=r(617),E=r(5402),j=r(8326),G=r(92),P=r(482),t=r(3953),W=r(4234),N=r(4020),V=r(345),D=r(4237),B=r(9900),$=r(3307),X=r(3656),F=r(7476),O=r(5547);const Y=["InstantCallServer"];function U(a,o){if(1&a){const n=t.RV6();t.j41(0,"ion-icon",8),t.bIt("click",function(){t.eBV(n);const e=t.XpG();return t.Njj(e.toggleMainVideoExtend())}),t.k0s()}}function L(a,o){1&a&&t.nrm(0,"div",9)}function J(a,o){if(1&a&&(t.j41(0,"ion-select-option",18),t.EFF(1),t.k0s()),2&a){const n=o.$implicit;t.Y8G("value",n),t.R7$(),t.JRh(n.info.name)}}function Q(a,o){if(1&a){const n=t.RV6();t.j41(0,"ion-item")(1,"ion-select",15,0),t.bIt("ionChange",function(e){t.eBV(n);const l=t.XpG(2);return t.Njj(l.SelectAddressTarget(e))}),t.j41(3,"ion-select-option",16),t.EFF(4),t.k0s(),t.DNE(5,J,2,2,"ion-select-option",17),t.k0s()()}if(2&a){const n=t.XpG(2);t.R7$(),t.Y8G("label",n.lang.text.AddGroup.SelectServer),t.R7$(3),t.JRh(n.lang.text.voidDraw.InternalConn),t.R7$(),t.Y8G("ngForOf",n.ServerList)}}function H(a,o){if(1&a){const n=t.RV6();t.j41(0,"ion-item")(1,"ion-input",19),t.mxI("ngModelChange",function(e){t.eBV(n);const l=t.XpG(2);return t.DH7(l.UserInputCustomAddress,e)||(l.UserInputCustomAddress=e),t.Njj(e)}),t.k0s(),t.j41(2,"ion-icon",20),t.bIt("click",function(){t.eBV(n);const e=t.XpG(2);return t.Njj(e.global.open_custom_site(e.UserInputCustomAddress))}),t.k0s()()}if(2&a){const n=t.XpG(2);t.R7$(),t.Y8G("label",n.lang.text.voidDraw.InputAddress),t.R50("ngModel",n.UserInputCustomAddress)}}function z(a,o){if(1&a){const n=t.RV6();t.j41(0,"ion-item")(1,"ion-input",21),t.mxI("ngModelChange",function(e){t.eBV(n);const l=t.XpG(2);return t.DH7(l.Port,e)||(l.Port=e),t.Njj(e)}),t.k0s()()}if(2&a){const n=t.XpG(2);t.R7$(),t.Y8G("label",n.lang.text.GroupServer.WebRTCPort),t.R50("ngModel",n.Port),t.Y8G("placeholder",n.lang.text.Settings.joinDedi_placeholder+" (3478)")}}function q(a,o){if(1&a){const n=t.RV6();t.j41(0,"ion-item")(1,"ion-input",21),t.mxI("ngModelChange",function(e){t.eBV(n);const l=t.XpG(2);return t.DH7(l.signalPort,e)||(l.signalPort=e),t.Njj(e)}),t.k0s()()}if(2&a){const n=t.XpG(2);t.R7$(),t.Y8G("label",n.lang.text.GroupServer.SquarePort),t.R50("ngModel",n.signalPort),t.Y8G("placeholder",n.lang.text.Settings.joinDedi_placeholder+" (12013)")}}function K(a,o){if(1&a){const n=t.RV6();t.j41(0,"ion-item")(1,"ion-input",21),t.mxI("ngModelChange",function(e){t.eBV(n);const l=t.XpG(2);return t.DH7(l.Username,e)||(l.Username=e),t.Njj(e)}),t.k0s()()}if(2&a){const n=t.XpG(2);t.R7$(),t.Y8G("label",n.lang.text.WebRTCDevManager.Username),t.R50("ngModel",n.Username),t.Y8G("placeholder",n.lang.text.Settings.joinDedi_placeholder+" (username)")}}function Z(a,o){if(1&a){const n=t.RV6();t.j41(0,"ion-item")(1,"ion-input",21),t.mxI("ngModelChange",function(e){t.eBV(n);const l=t.XpG(2);return t.DH7(l.Password,e)||(l.Password=e),t.Njj(e)}),t.k0s()()}if(2&a){const n=t.XpG(2);t.R7$(),t.Y8G("label",n.lang.text.WebRTCDevManager.Credential),t.R50("ngModel",n.Password),t.Y8G("placeholder",n.lang.text.Settings.joinDedi_placeholder+" (password)")}}function tt(a,o){if(1&a){const n=t.RV6();t.j41(0,"div",10),t.DNE(1,Q,6,3,"ion-item",7)(2,H,3,2,"ion-item",7)(3,z,2,3,"ion-item",7)(4,q,2,3,"ion-item",7)(5,K,2,3,"ion-item",7)(6,Z,2,3,"ion-item",7),t.j41(7,"ion-item",11)(8,"ion-toggle",12),t.mxI("ngModelChange",function(e){t.eBV(n);const l=t.XpG();return t.DH7(l.global.useVideo,e)||(l.global.useVideo=e),t.Njj(e)}),t.EFF(9),t.k0s()(),t.j41(10,"ion-item",13),t.bIt("click",function(){t.eBV(n);const e=t.XpG();return t.Njj(e.LinkToServer())}),t.j41(11,"ion-label",14),t.EFF(12),t.k0s()()()}if(2&a){const n=t.XpG();t.R7$(),t.Y8G("ngIf",n.ServerList.length),t.R7$(),t.Y8G("ngIf",n.NeedInputCustomAddress),t.R7$(),t.Y8G("ngIf",n.NeedInputCustomAddress),t.R7$(),t.Y8G("ngIf",n.NeedInputCustomAddress),t.R7$(),t.Y8G("ngIf",n.NeedInputCustomAddress),t.R7$(),t.Y8G("ngIf",n.NeedInputCustomAddress),t.R7$(2),t.R50("ngModel",n.global.useVideo),t.R7$(),t.JRh(n.lang.text.InstantCall.useVideo),t.R7$(3),t.JRh(n.lang.text.voidDraw.ConnectToAddress)}}function et(a,o){if(1&a){const n=t.RV6();t.j41(0,"img",24),t.bIt("click",function(){t.eBV(n);const e=t.XpG(2);return t.Njj(e.copy_qr_address())}),t.k0s()}if(2&a){const n=t.XpG(2);t.Y8G("src",n.QRCodeSRC,t.B4B)}}function nt(a,o){if(1&a){const n=t.RV6();t.j41(0,"div"),t.DNE(1,et,1,1,"img",22),t.j41(2,"ion-item",13),t.bIt("click",function(){t.eBV(n);const e=t.XpG();return t.Njj(e.copy_qr_address())}),t.j41(3,"ion-label",14),t.EFF(4),t.k0s()(),t.j41(5,"ion-item",13),t.bIt("click",function(){t.eBV(n);const e=t.XpG();return t.Njj(e.OpenDevManager())}),t.j41(6,"ion-label",23),t.EFF(7),t.k0s()()()}if(2&a){const n=t.XpG();t.R7$(),t.Y8G("ngIf",n.QRCodeSRC),t.R7$(3),t.JRh(n.QRCodeAsString),t.R7$(3),t.JRh(n.lang.text.WebRTCDevManager.ManageInput)}}function it(a,o){if(1&a&&(t.j41(0,"div")(1,"div")(2,"div",25),t.nrm(3,"ion-icon",26),t.j41(4,"div")(5,"ion-label",27),t.EFF(6),t.k0s()()()(),t.nrm(7,"div",28),t.k0s()),2&a){const n=t.XpG();t.R7$(3),t.Y8G("name",n.global.useVideo?"videocam-outline":"call-outline"),t.R7$(3),t.JRh(n.webrtc.StatusText||n.lang.text.InstantCall.Waiting)}}function at(a,o){if(1&a&&(t.j41(0,"span"),t.EFF(1),t.k0s()),2&a){const n=t.XpG().$implicit;t.Aen("color: #"+n.color),t.R7$(),t.JRh(" "+n.text)}}function lt(a,o){if(1&a&&(t.j41(0,"b"),t.EFF(1),t.k0s()),2&a){const n=t.XpG(2).$implicit;t.R7$(),t.SpI("",n.target,":")}}function st(a,o){if(1&a&&(t.j41(0,"span"),t.EFF(1),t.k0s()),2&a){const n=t.XpG().$implicit;t.R7$(),t.JRh(n.text)}}function ot(a,o){if(1&a){const n=t.RV6();t.j41(0,"a",45),t.bIt("click",function(){t.eBV(n);const e=t.XpG().$implicit,l=t.XpG(6);return t.Njj(l.nakama.open_url_link(e.text))}),t.EFF(1),t.k0s()}if(2&a){const n=t.XpG().$implicit;t.Y8G("href",n.text,t.B4B),t.R7$(),t.JRh(n.text)}}function rt(a,o){if(1&a&&(t.j41(0,"span"),t.DNE(1,st,2,1,"span",7)(2,ot,2,2,"a",44),t.k0s()),2&a){const n=o.$implicit;t.R7$(),t.Y8G("ngIf",!n.href),t.R7$(),t.Y8G("ngIf",n.href)}}function ct(a,o){if(1&a&&(t.j41(0,"span"),t.DNE(1,rt,3,2,"span",35),t.k0s()),2&a){const n=t.XpG(2).$implicit;t.Aen(n.isSystem?"color: var(--arcade-fix-system-color)":""),t.R7$(),t.Y8G("ngForOf",n.text)}}function dt(a,o){if(1&a&&(t.j41(0,"span",43)(1,"span"),t.DNE(2,lt,2,1,"b",7),t.k0s(),t.DNE(3,ct,2,3,"span",41),t.k0s()),2&a){const n=t.XpG().$implicit;t.R7$(),t.Aen("color: #"+n.color),t.R7$(),t.Y8G("ngIf",n.target),t.R7$(),t.Y8G("ngIf",n.text)}}function gt(a,o){if(1&a&&(t.j41(0,"p"),t.DNE(1,at,2,3,"span",41)(2,dt,4,4,"span",42),t.k0s()),2&a){const n=o.$implicit;t.R7$(),t.Y8G("ngIf",!n.target),t.R7$(),t.Y8G("ngIf",n.target)}}function ht(a,o){if(1&a){const n=t.RV6();t.j41(0,"div",31)(1,"div",32)(2,"div",33)(3,"div",34),t.DNE(4,gt,3,2,"p",35),t.k0s()(),t.j41(5,"table",36)(6,"tr")(7,"td",37)(8,"ion-input",38),t.bIt("ionFocus",function(){t.eBV(n);const e=t.XpG(2);return e.auto_scroll_down(120),t.Njj(e.global.toggleBlockMainShortcut(!0))})("ionBlur",function(){t.eBV(n);const e=t.XpG(2);return t.Njj(e.global.toggleBlockMainShortcut(!1))})("keyup.enter",function(){t.eBV(n);const e=t.XpG(2);return t.Njj(e.send())}),t.mxI("ngModelChange",function(e){t.eBV(n);const l=t.XpG(2);return t.DH7(l.global.instCallLog.text,e)||(l.global.instCallLog.text=e),t.Njj(e)}),t.k0s()(),t.j41(9,"td")(10,"ion-button",39),t.bIt("click",function(){t.eBV(n);const e=t.XpG(2);return t.Njj(e.send())}),t.nrm(11,"ion-icon",40),t.k0s()()()()()()}if(2&a){const n=t.XpG(2);t.R7$(2),t.Y8G("id",n.webrtcActId+"_log"),t.R7$(2),t.Y8G("ngForOf",n.global.instCallLog.logs),t.R7$(4),t.Y8G("id",n.webrtcActId+"_input")("disabled",n.global.DisableChatInput)("placeholder",n.lang.text.ChatRoom.input_placeholder),t.R50("ngModel",n.global.instCallLog.text),t.R7$(2),t.Y8G("disabled",n.global.DisableChatInput)}}function ut(a,o){if(1&a&&(t.j41(0,"div")(1,"div",29),t.DNE(2,ht,12,7,"div",30),t.k0s()()),2&a){const n=t.XpG();t.R7$(),t.Y8G("id",n.webrtcActId),t.R7$(),t.Y8G("ngIf",n.global.ShowChatInterface)}}const _t=[{path:"",component:(()=>{var a;class o{constructor(i,e,l,d,h,p,g,u,s,m,I,C){this.global=i,this.lang=e,this.webrtc=l,this.title=d,this.nakama=h,this.router=p,this.route=g,this.p5toast=u,this.p5loading=s,this.navCtrl=m,this.floatbutton=I,this.noti=C,this.webrtcActId="instcall",this.UserInputCustomAddress="",this.NeedInputCustomAddress=!1,this.isQuickJoin=!1,this.AlreadyExistServer=!1,this.isCustomServer=!1,this.PageOut=!1,this.CallClosed=!1}ngOnInit(){var i=this;this.ServerList=this.nakama.get_all_online_server(),setTimeout(()=>{this.InstantCallServer?(this.InstantCallServer.value=this.ServerList[0]||"local",this.SelectAddressTarget({detail:{value:this.InstantCallServer.value}})):this.NeedInputCustomAddress=!0},0),this.route.queryParams.subscribe(e=>{const l=this.router.getCurrentNavigation().extras.state;l&&(this.UserInputCustomAddress=l.address,this.ChannelId=l.channel,this.Port=l.port,this.signalPort=l.square_port,this.Username=l.username,this.Password=l.password,this.isQuickJoin=l.quick,this.global.useVideo=l.useVideo,this.LinkToServer(!0))}),this.webrtc.StatusText||(this.webrtc.StatusText=this.lang.text.InstantCall.Waiting),this.global.windowOnFocusAct["instant-call"]=()=>{!function(){var l=(0,f.A)(function*(){if(i.global.videoPIP&&i.webrtc.localMedia)try{if(i.PageOut)throw"\ud398\uc774\uc9c0\ub97c \ubc97\uc5b4\ub0a8";yield i.webrtc.localMedia.requestPictureInPicture(),i.webrtc.remoteMedia&&(i.webrtc.remoteMedia.style.width="100%",i.webrtc.remoteMedia.style.height="100%",i.toggleMainVideoExtend(!1),document.getElementById("instc_remote").appendChild(i.webrtc.remoteMedia))}catch{}});return function(){return l.apply(this,arguments)}}()()},this.global.WindowOnBlurAct["instant-call"]=()=>{!function(){var l=(0,f.A)(function*(){if(i.global.videoPIP&&i.webrtc.remoteMedia)try{yield i.webrtc.remoteMedia.requestPictureInPicture(),i.webrtc.remoteMedia.style.width="0px",i.webrtc.remoteMedia.style.height="0px",i.webrtc.remoteMedia.style.objectFit="none",document.body.appendChild(i.webrtc.remoteMedia)}catch{}});return function(){return l.apply(this,arguments)}}()()}}SelectAddressTarget(i){if("local"===(this.title.setTitle(`Project: ${this.lang.text.InstantCall.Title}`),this.Port=void 0,this.signalPort=void 0,i.detail.value))this.UserInputCustomAddress="",this.NeedInputCustomAddress=!0;else{let e=i.detail.value.info;this.UserInputCustomAddress=`${e.useSSL?"wss":"ws"}://${e.address}`,this.Port=e.webrtc_port,12013!=e.square_port&&(this.signalPort=e.square_port),this.NeedInputCustomAddress=!1}}LinkToServer(i=!1){var e=this;if(this.webrtc.StatusText=this.lang.text.InstantCall.Waiting,E.R.requestAudioRecordingPermission(),i&&!this.ChannelId)return this.p5toast.show({text:this.lang.text.InstantCall.MissingInfo}),void this.navCtrl.pop();let g,d=this.UserInputCustomAddress.split("://"),h=d.pop(),p=d.pop();p||(p=this.global.checkProtocolFromAddress(h)?"wss":"ws"),this.isCustomServer=i||!this.InstantCallServer||"local"==this.InstantCallServer.value,this.isCustomServer&&this.nakama.SaveWebRTCServer({urls:[`stun:${h}:${this.Port||3478}`,`turn:${h}:${this.Port||3478}`],username:this.Username||"username",credential:this.Password||"password"}).then(u=>this.AlreadyExistServer=u),this.global.InstantCallWSClient=new WebSocket(`${p}://${h}:${this.signalPort||12013}`),this.global.InstantCallWSClient.onopen=(0,f.A)(function*(){if(e.global.WaitingConnect=!0,e.p5loading.toast(e.lang.text.InstantCall.Waiting,e.webrtcActId),e.global.useVideo)try{document.pictureInPictureElement&&document.pictureInPictureElement!=e.webrtc.localMedia&&document.exitPictureInPicture(),localStorage.removeItem("VideoInputDev"),localStorage.removeItem("AudioInputDev"),localStorage.removeItem("AudioOutputDev"),e.webrtc.localMedia=document.createElement("video"),e.webrtc.localMedia.id="webrtc_video",e.webrtc.localMedia.style.width="0px",e.webrtc.localMedia.style.height="0px",e.webrtc.localMedia.autoplay=!0,e.webrtc.localMedia.playsInline=!0,e.webrtc.localMedia.muted=!0,e.webrtc.localMedia.style.borderRadius="16px",document.body.appendChild(e.webrtc.localMedia);const u=yield e.webrtc.getMediaConst("video");try{e.webrtc.localStream=yield navigator.mediaDevices.getUserMedia(u)}catch{"DesktopPWA"==G.aH&&(e.webrtc.localStream=yield navigator.mediaDevices.getDisplayMedia())}e.webrtc.localMedia.srcObject=e.webrtc.localStream,setTimeout(()=>{e.global.videoPIP=!0;const s=function(){var C=(0,f.A)(function*(){try{yield e.webrtc.localMedia.requestPictureInPicture()}catch{e.PageOut||setTimeout(()=>{s()},500)}});return function(){return C.apply(this,arguments)}}();s();let m=!1;const I=()=>{var C;e.webrtc.remoteMedia?(e.webrtc.remoteMedia.style.width="100%",e.webrtc.remoteMedia.style.height="100%",e.toggleMainVideoExtend(!1),null===(C=document.getElementById("instc_remote"))||void 0===C||C.appendChild(e.webrtc.remoteMedia),m=!0):setTimeout(()=>{!e.PageOut&&!m&&I()},500)};I()},1e3)}catch(u){return console.log("navigator.getUserMedia error: ",u),yield e.webrtc.close_webrtc(e.webrtcActId),e.p5toast.show({text:`${e.lang.text.WebRTCDevManager.InitErr}: ${u}`}),void(e.global.WaitingConnect=!1)}e.ChannelId?(e.global.InstantCallSend(JSON.stringify({type:"join",channel:e.ChannelId,quick:e.isQuickJoin})),yield new Promise(u=>setTimeout(u,e.global.WebsocketRetryTerm)),e.webrtc.StatusText=e.lang.text.InstantCall.Connecting,e.global.PeerConnected=!0,localStorage.removeItem("VideoInputDev"),localStorage.removeItem("AudioInputDev"),localStorage.removeItem("AudioOutputDev"),e.webrtc.initialize(e.global.useVideo?"video":"audio",e.webrtcActId).then(()=>{e.webrtc.Peers[e.webrtcActId].HangUpCallBack=()=>{e.global.InstantCallWSClient&&e.global.InstantCallWSClient.close(1e3,"hangup_webrtc")},e.webrtc.Peers[e.webrtcActId].signalChannelId=e.ChannelId,e.webrtc.Peers[e.webrtcActId].signalingChannel=e.global.InstantCallWSClient,e.ShowWaiting(),e.webrtc.CreateOffer(e.webrtcActId),e.webrtc.StatusText=e.lang.text.InstantCall.Connecting,e.global.PeerConnected=!0,e.global.InstantCallSend(JSON.stringify({type:"init_req"})),e.global.windowOnFocusAct["instant-call"]()})):e.global.InstantCallSend(JSON.stringify({type:"initInfo",act:"instc",max:2}))}),this.global.InstantCallWSClient.onmessage=u=>{let s=JSON.parse(u.data);if(void 0===g)g=s.uid;else if(g==s.uid&&"text"!=s.type)return;switch(s.type){case"text":{var m;let _=s.msg.split(" "),v=[],b="";const w=g==s.uid,R=w?s.name||this.lang.text.MinimalChat.name_me:s.name||this.lang.text.MinimalChat.name_stranger_group,M=s.uid?(s.uid.replace(/[^5-79a-b]/g,"")+"abcdef").substring(0,6):P.ud?"888888":"444444";for(let x=0,mt=_.length;x<mt;x++)0==_[x].indexOf("http://")||0==_[x].indexOf("https://")?(v.push({text:" "+b+" "}),b="",v.push({href:!0,text:_[x]})):b+=" "+_[x];b&&v.push({text:" "+b}),this.global.instCallLog.logs.push({color:M,text:v,target:R,isMe:w}),null===(m=this.floatbutton.Buttons["instant-call"])||void 0===m||m.style(`background-color: #${M}88`),this.noti.PushLocal({id:15,title:R,body:s.msg,smallIcon_ln:"voidDraw",bgcolor:M},this.webrtcActId,()=>window.focus()),this.auto_scroll_down()}break;case"join":this.global.ShowChatInterface=!0,this.global.DisableChatInput=!1,this.global.instCallLog.logs.length=0,this.global.instCallLog.text="",setTimeout(()=>{var _;const b=g==s.uid?s.name||this.lang.text.MinimalChat.name_me:s.name||this.lang.text.MinimalChat.name_stranger_group,w=s.uid?(s.uid.replace(/[^5-79a-b]/g,"")+"abcdef").substring(0,6):P.ud?"888888":"444444";this.global.instCallLog.logs.push({color:w,text:[{text:" "+this.lang.text.MinimalChat.user_join}],target:b,isSystem:!0}),this.auto_scroll_down(),null===(_=this.floatbutton.Buttons["instant-call"])||void 0===_||_.style(`background-color: #${w}88`)},100);break;case"leave":{var I;this.global.DisableChatInput=!0;const v=g==s.uid?s.name||this.lang.text.MinimalChat.name_me:s.name||this.lang.text.MinimalChat.name_stranger_group,b=s.uid?(s.uid.replace(/[^5-79a-b]/g,"")+"abcdef").substring(0,6):P.ud?"888888":"444444";this.global.instCallLog.logs.push({color:b,text:[{text:" "+this.lang.text.MinimalChat.user_out}],target:v,isSystem:!0}),this.auto_scroll_down(),null===(I=this.floatbutton.Buttons["instant-call"])||void 0===I||I.style(`background-color: #${b}88`),this.global.InstantCallWSClient.close(1e3,"leave_pair")}break;case"init_id":const C=s.socketId;this.global.InstantCallSend(JSON.stringify({type:"join",channel:s.id,customInput:this.NeedInputCustomAddress})),this.ChannelId=s.id,this.global.GetHeaderAddress().then(_=>{this.QRCodeAsString=`${_}?token=${this.UserInputCustomAddress},${12013==this.Port?"":this.Port||""},${s.socketId}`,this.QRCodeSRC=this.global.readasQRCodeFromString(this.QRCodeAsString),this.global.InstantCallSend(JSON.stringify({type:"update_reqInfo",socketId:C,keys:["channel_id","port","username","password","useVideo"],channel_id:this.ChannelId,port:this.Port,username:this.Username,password:this.Password,useVideo:this.global.useVideo}))});break;case"expired":setTimeout(()=>{this.global.InstantCallWSClient.close(1e3,"expired")},500);break;case"block":console.warn("\uc774\ubbf8 \uc5f0\uacb0\ub41c \ud1b5\ud654\uac00 \uc788\uc74c"),this.global.InstantCallWSClient.close(1e3,"block");break;case"init_req":this.webrtc.StatusText=this.lang.text.InstantCall.Connecting,this.global.PeerConnected=!0,this.webrtc.initialize(this.global.useVideo?"video":"audio",this.webrtcActId).then((0,f.A)(function*(){e.webrtc.Peers[e.webrtcActId].HangUpCallBack=()=>{e.global.InstantCallWSClient&&e.global.InstantCallWSClient.close(1e3,"hangup_callback")},e.webrtc.Peers[e.webrtcActId].signalChannelId=e.ChannelId,e.webrtc.Peers[e.webrtcActId].signalingChannel=e.global.InstantCallWSClient,e.ShowWaiting(),e.webrtc.CreateOffer(e.webrtcActId),yield new Promise(_=>setTimeout(_,e.global.WebsocketRetryTerm)),e.global.InstantCallSend(JSON.stringify({type:"socket_react",channel:e.ChannelId,act:"WEBRTC_INIT_REQ_SIGNAL"})),e.global.windowOnFocusAct["instant-call"]()}));break;case"socket_react":switch(s.act){case"WEBRTC_REPLY_INIT_SIGNAL_PART":this.webrtc.WEBRTC_REPLY_INIT_SIGNAL_PART({client:this.global.InstantCallWSClient,channel:this.ChannelId},this.webrtcActId);break;case"WEBRTC_RECEIVE_ANSWER_PART":this.webrtc.WEBRTC_RECEIVE_ANSWER_PART({client:this.global.InstantCallWSClient,channel:this.ChannelId},this.webrtcActId);break;case"WEBRTC_REPLY_INIT_SIGNAL":this.webrtc.WEBRTC_REPLY_INIT_SIGNAL(s.data_str,{client:this.global.InstantCallWSClient,channel:this.ChannelId},this.webrtcActId),"EOL"==s.data_str&&this.webrtc.CreateAnswer({client:this.global.InstantCallWSClient,channel:this.ChannelId},this.webrtcActId);break;case"WEBRTC_ICE_CANDIDATES":this.webrtc.WEBRTC_ICE_CANDIDATES(s.data_str,{client:this.global.InstantCallWSClient,channel:this.ChannelId},this.webrtcActId),this.global.InstantCallSend(JSON.stringify({type:"init_end",channel:this.ChannelId})),this.global.InitEnd=!0,this.webrtc.StatusText=this.lang.text.InstantCall.Connected;break;case"WEBRTC_INIT_REQ_SIGNAL":this.webrtc.WEBRTC_INIT_REQ_SIGNAL({client:this.global.InstantCallWSClient,channel:this.ChannelId},this.webrtcActId);break;case"WEBRTC_RECEIVE_ANSWER":this.webrtc.WEBRTC_RECEIVE_ANSWER(s.data_str,{client:this.global.InstantCallWSClient,channel:this.ChannelId},this.webrtcActId)}break;case"init_end":this.global.InitEnd=!0,this.webrtc.StatusText=this.lang.text.InstantCall.Connected}},this.global.InstantCallWSClient.onerror=u=>{console.error("\uc989\uc11d \ud1b5\ud654 \uc6f9\uc18c\ucf13 \uc624\ub958: ",u),this.global.InstantCallWSClient.close(1e3,"error")},this.global.InstantCallWSClient.onclose=u=>{this.p5toast.show("expired"==u.reason?{text:this.lang.text.InstantCall.ExpiredChannel}:{text:this.lang.text.InstantCall.CallEnd}),this.global.videoPIP&&document.pictureInPictureElement&&document.exitPictureInPicture(),this.global.videoPIP=!1,this.floatbutton.RemoveFloatButton("instant-call"),this.global.WaitingConnect=!1,this.global.InitEnd=!1,this.global.PeerConnected=!1,this.global.InstantCallWSClient.onopen=null,this.global.InstantCallWSClient.onclose=null,this.global.InstantCallWSClient.onmessage=null,this.global.InstantCallWSClient.onerror=null,this.global.InstantCallWSClient=null,this.webrtc.close_webrtc(this.webrtcActId),this.CallClosed=!0,this.PageOut||this.navCtrl.pop()}}toggleMainVideoExtend(i=!0){i&&(this.global.isOthersVideoExtended=!this.global.isOthersVideoExtended),this.webrtc.remoteMedia.style.objectFit=this.global.isOthersVideoExtended?"cover":"contain"}OpenDevManager(){var i=this;return(0,f.A)(function*(){let e=yield i.webrtc.getDeviceList();i.global.PageDismissAct["webrtc-manage"]=function(){var l=(0,f.A)(function*(d){try{var h;if(!Object.keys(d).length)throw"\uc7a5\uce58 \ubcc0\uacbd \uc815\ubcf4\uac00 \ube44\uc5b4\uc788\uc74c";let p={};i.global.useVideo&&d.data.videoinput&&(p.video={deviceId:{exact:d.data.videoinput.deviceId}}),d.data.audioinput&&(p.audio={deviceId:{exact:d.data.audioinput.deviceId}}),i.webrtc.localStream.getTracks().forEach(g=>g.stop()),i.webrtc.localStream=i.global.useVideo&&null!==(h=d.data.videoinput)&&void 0!==h&&h.useScr?yield navigator.mediaDevices.getDisplayMedia():yield navigator.mediaDevices.getUserMedia(p),i.webrtc.localMedia.srcObject=i.webrtc.localStream}catch(p){console.log("\ubbf8\ub514\uc5b4 \uc2a4\ud2b8\ub9bc \ubcc0\uacbd \uc624\ub958: ",p)}i.global.RestoreShortCutAct("webrtc-manage"),delete i.global.PageDismissAct["webrtc-manage"]});return function(d){return l.apply(this,arguments)}}(),i.global.StoreShortCutAct("webrtc-manage"),i.global.ActLikeModal("webrtc-manage-io-dev",{list:JSON.parse(JSON.stringify(e)),typein:i.global.useVideo?"video":"audio",dismiss:"webrtc-manage"})})()}copy_qr_address(i=this.QRCodeAsString){this.global.WriteValueToClipboard("text/plain",i)}ShowWaiting(){this.QRCodeSRC=void 0,this.QRCodeAsString="",!this.p5canvas&&(this.p5canvas=new j(i=>{let e=document.getElementById("InstantCallCanvasDiv"),l=1;i.setup=()=>{i.pixelDensity(1),i.createCanvas(e.clientWidth,e.clientHeight).parent(e),i.noStroke()};class d{constructor(){this.color={r:0,g:0,b:0},this.size=1,this.targetSize=100,this.opacity=200,this.pos=i.createVector(0,0),this.dir=i.createVector(i.random(-1.4,1.4),i.random(-2,-4)),this.color.r=i.random(0,255),this.color.g=i.random(0,255),this.color.b=i.random(0,255),this.targetSize=i.random(80,150)}display(){this.size<this.targetSize&&(this.size+=6),this.size>this.targetSize&&(this.size=this.targetSize),i.push(),i.fill(this.color.r,this.color.g,this.color.b,this.opacity),i.circle(this.pos.x,this.pos.y,this.size*l),i.pop(),this.pos.add(this.dir),this.dir.y+=.04,this.opacity-=1}}let h=[],p=!0;i.draw=()=>{p&&(h.push(new d),p=!1,setTimeout(()=>{p=!0},500)),i.clear(),i.push(),i.translate(i.width/2,i.height/2);for(let g=h.length-1;g>=0;g--)h[g].display(),h[g].opacity<=0&&h.splice(g,1);i.pop(),this.global.InitEnd&&(l-=.02),l<=0&&i.remove()},i.windowResized=()=>{i.resizeCanvas(e.clientWidth,e.clientHeight)}}))}ionViewWillEnter(){this.noti.Current=this.webrtcActId,this.floatbutton.RemoveFloatButton("instant-call"),this.PageOut=!1,this.p5canvas&&this.p5canvas.windowResized(),this.global.StoreShortCutAct("instant-call"),this.global.p5KeyShortCut.Escape=()=>{this.navCtrl.pop()},this.CallClosed&&this.navCtrl.pop(),this.global.videoPIP&&this.webrtc.localMedia&&this.webrtc.localMedia.requestPictureInPicture(),this.webrtc.remoteMedia&&(this.webrtc.remoteMedia.style.width="100%",this.webrtc.remoteMedia.style.height="100%",this.toggleMainVideoExtend(!1),document.getElementById("instc_remote").appendChild(this.webrtc.remoteMedia));const i=document.getElementById(this.webrtcActId+"_log");i&&this.global.InitEnd&&i.scrollTo({top:i.scrollHeight,behavior:"smooth"})}ionViewWillLeave(){if(this.noti.Current="",this.title.setTitle("Project: Cone"),this.PageOut=!0,this.global.WaitingConnect||this.global.InitEnd){const i=this.floatbutton.AddFloatButton("instant-call","call-outline");null==i||i.mouseClicked(()=>{this.global.SelectArcadeTab(),this.navCtrl.navigateForward("portal/arcade/instant-call",{animation:k.NC})})}this.webrtc.remoteMedia&&(this.global.videoPIP&&this.webrtc.remoteMedia.requestPictureInPicture(),this.webrtc.remoteMedia.style.width="0px",this.webrtc.remoteMedia.style.height="0px",this.webrtc.remoteMedia.style.objectFit="none",document.body.appendChild(this.webrtc.remoteMedia)),delete this.global.p5KeyShortCut.Escape,this.global.RestoreShortCutAct("instant-call")}ngOnDestroy(){this.p5canvas&&this.p5canvas.remove(),this.isCustomServer&&!this.AlreadyExistServer&&this.nakama.RemoveWebRTCServer(this.UserInputCustomAddress.split("://").pop()),!this.global.InitEnd&&!this.global.PeerConnected&&this.global.InstantCallWSClient&&this.global.InstantCallWSClient.close(1e3),this.route.queryParams.unsubscribe(),delete this.global.windowOnFocusAct["instant-call"],delete this.global.WindowOnBlurAct["instant-call"]}auto_scroll_down(i){const e=document.getElementById(this.webrtcActId+"_log");e&&setTimeout(()=>{const l=e.scrollHeight;l<e.scrollTop+e.clientHeight+120&&e.scrollTo({top:l,behavior:"smooth"})},i||0)}send(){this.auto_scroll_down();let i={type:"text",msg:this.global.instCallLog.text};i.msg.trim()&&(i.name=this.nakama.users.self.display_name,this.global.InstantCallSend(JSON.stringify(i)),this.global.instCallLog.text="",this.auto_scroll_down())}}return(a=o).\u0275fac=function(i){return new(i||a)(t.rXU(P.z3),t.rXU(W.y),t.rXU(N.j),t.rXU(V.hE),t.rXU(D.X),t.rXU(S.Ix),t.rXU(S.nX),t.rXU(B.G),t.rXU($.f),t.rXU(X.q9),t.rXU(F.u),t.rXU(O.r))},a.\u0275cmp=t.VBU({type:a,selectors:[["app-instant-call"]],viewQuery:function(i,e){if(1&i&&t.GBs(Y,5),2&i){let l;t.mGM(l=t.lsd())&&(e.InstantCallServer=l.first)}},decls:13,vars:7,consts:[["InstantCallServer",""],[1,"ion-no-border"],["slot","start"],["defaultHref","portal/arcade"],["slot","end","name","expand-outline","class","top_icon","style","width: 24px; height: 24px;",3,"click",4,"ngIf"],["id","InstantCallCanvasDiv","style","position: absolute; width: 100%; height: 100%; overflow: hidden; pointer-events: none;",4,"ngIf"],["style","flex: 0 1 auto;",4,"ngIf"],[4,"ngIf"],["slot","end","name","expand-outline",1,"top_icon",2,"width","24px","height","24px",3,"click"],["id","InstantCallCanvasDiv",2,"position","absolute","width","100%","height","100%","overflow","hidden","pointer-events","none"],[2,"flex","0 1 auto"],["button",""],[2,"pointer-events","none",3,"ngModelChange","ngModel"],["button","",3,"click"],[1,"ion-text-center"],["value","local",2,"pointer-events","none",3,"ionChange","label"],["value","local"],[3,"value",4,"ngFor","ngForOf"],[3,"value"],["placeholder","(wss://)0.0.0.0",1,"ion-text-right",3,"ngModelChange","label","ngModel"],["slot","end","name","open-outline",3,"click"],[1,"ion-text-right",3,"ngModelChange","label","ngModel","placeholder"],["style","width: 100%; height: auto; cursor: copy;","alt","QRCode",3,"src","click",4,"ngIf"],["color","secondary",1,"ion-text-center"],["alt","QRCode",2,"width","100%","height","auto","cursor","copy",3,"click","src"],[1,"disconnect_info"],["color","medium",2,"width","60px","height","60px",3,"name"],["color","medium"],["id","instc_remote",2,"position","absolute","display","flex","width","100%","height","100%"],[1,"full_screen",2,"display","block","overflow","hidden","background-color","black",3,"id"],["style","display: flex; justify-content: center; align-items: center; width: 100%; position: absolute; bottom: 0px; color: var(--arcade-fix-color);",4,"ngIf"],[2,"display","flex","justify-content","center","align-items","center","width","100%","position","absolute","bottom","0px","color","var(--arcade-fix-color)"],[2,"width","100%","max-width","650px","overflow-y","hidden"],[2,"width","100%","height","fit-content","max-height","84px","overflow-y","scroll","padding","8px","background","linear-gradient(to top, var(--voidDraw-chat-bg-transparent), transparent)",3,"id"],[2,"pointer-events","none","user-select","none"],[4,"ngFor","ngForOf"],[2,"width","100%","background-color","var(--voidDraw-chat-bg-transparent)"],[2,"width","100%"],["type","text",2,"margin-left","16px",3,"ionFocus","ionBlur","keyup.enter","ngModelChange","id","disabled","placeholder","ngModel"],["expand","block","fill","clear",3,"click","disabled"],["name","send"],[3,"style",4,"ngIf"],["class","default_text",4,"ngIf"],[1,"default_text"],["target","_system","onclick","return false;",3,"href","click",4,"ngIf"],["target","_system","onclick","return false;",3,"click","href"]],template:function(i,e){1&i&&(t.j41(0,"ion-header",1)(1,"ion-toolbar")(2,"ion-title"),t.EFF(3),t.k0s(),t.j41(4,"ion-buttons",2),t.nrm(5,"ion-back-button",3),t.k0s(),t.DNE(6,U,1,0,"ion-icon",4),t.k0s()(),t.j41(7,"ion-content"),t.DNE(8,L,1,0,"div",5)(9,tt,13,9,"div",6)(10,nt,8,3,"div",7)(11,it,8,2,"div",7)(12,ut,3,2,"div",7),t.k0s()),2&i&&(t.R7$(3),t.JRh(e.lang.text.InstantCall.Title),t.R7$(3),t.Y8G("ngIf",e.global.useVideo&&e.global.InitEnd),t.R7$(2),t.Y8G("ngIf",e.global.WaitingConnect),t.R7$(),t.Y8G("ngIf",!e.global.WaitingConnect),t.R7$(),t.Y8G("ngIf",e.QRCodeAsString&&e.global.WaitingConnect),t.R7$(),t.Y8G("ngIf",!e.QRCodeAsString&&(e.global.WaitingConnect||e.global.InitEnd)),t.R7$(),t.Y8G("ngIf",e.global.InitEnd||e.global.ShowChatInterface))},dependencies:[y.Sq,y.bT,A.BC,A.vS,c.Jm,c.QW,c.W9,c.eU,c.iq,c.$w,c.uz,c.he,c.Nm,c.Ip,c.BC,c.BY,c.ai,c.hB,c.Je,c.Gw,c.el],styles:["ion-input[_ngcontent-%COMP%]{--highlight-color-valid: var(--ion-color-primary)}p[_ngcontent-%COMP%]{margin:8px 0 0}"]}),o})()}];let pt=(()=>{var a;class o{}return(a=o).\u0275fac=function(i){return new(i||a)},a.\u0275mod=t.$C({type:a}),a.\u0275inj=t.G2t({imports:[S.iI.forChild(_t),S.iI]}),o})(),bt=(()=>{var a;class o{}return(a=o).\u0275fac=function(i){return new(i||a)},a.\u0275mod=t.$C({type:a}),a.\u0275inj=t.G2t({imports:[y.MD,A.YN,c.bv,pt]}),o})()}}]);